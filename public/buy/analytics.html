<!DOCTYPE html>
<html>

<head>
    <title>TandoorBaaz Analytics Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .metric-card {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .metric-label {
            font-size: 1rem;
            color: #6c757d;
        }

        .insight-card {
            border-left: 4px solid #0d6efd;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        
        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-md-6 d-flex align-items-center">
                <h2><i class="bi bi-graph-up"></i> TandoorBaaz Analytics</h2>
                <div class="dropdown ms-3">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="restaurantDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-shop"></i> Switch Restaurant
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="restaurantDropdown">
                        <li><a class="dropdown-item" href="?kitchen=tandoorbaaz">TandoorBaaz</a></li>
                        <li><a class="dropdown-item" href="?kitchen=eros">Eros Kitchen</a></li>
                        <li><a class="dropdown-item" href="?kitchen=spice">Spice Junction</a></li>
                        <li><a class="dropdown-item" href="?kitchen=royal">Royal Cuisine</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <a id="backToOrdersLink" href="showorders.html" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i> Back to Orders
                </a>
                <button class="btn btn-success ms-2" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="date-filter">
                            <label for="dateRange" class="form-label">Date Range:</label>
                            <select id="dateRange" class="form-select" onchange="handleDateRangeChange()">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="last7" selected>Last 7 Days</option>
                                <option value="last30">Last 30 Days</option>
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6" id="customDateContainer" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Start Date:</label>
                                <input type="date" id="startDate" class="form-control" onchange="handleCustomDateChange()">
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">End Date:</label>
                                <input type="date" id="endDate" class="form-control" onchange="handleCustomDateChange()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Sales Statistics Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-dark text-white">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Real-time Sales Statistics</h5>
                        <div>
                            <select id="salesPeriodSelect" class="form-select form-select-sm d-inline-block me-2" style="width: auto;" onchange="changeSalesPeriod(this.value)">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                            <div id="salesCustomDateRange" class="d-none d-inline-block me-2">
                                <input type="date" id="salesStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                                <input type="date" id="salesEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                                <button class="btn btn-sm btn-light" onclick="applySalesDateRange()">Apply</button>
                            </div>
                            <button class="btn btn-sm btn-outline-light" onclick="updateSalesStats()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="p-3 bg-success bg-opacity-25 rounded">
                                    <h6 class="text-white">Delivered Sales</h6>
                                    <h3 class="mb-0" id="completedSales">₹0</h3>
                                    <small class="text-white-50" id="completedOrdersCount">0 orders</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-warning bg-opacity-25 rounded">
                                    <h6 class="text-white">Pending Sales</h6>
                                    <h3 class="mb-0" id="pendingSales">₹0</h3>
                                    <small class="text-white-50" id="pendingOrdersCount">0 orders</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-danger bg-opacity-25 rounded">
                                    <h6 class="text-white">Cancelled Sales</h6>
                                    <h3 class="mb-0" id="cancelledSales">₹0</h3>
                                    <small class="text-white-50" id="cancelledOrdersCount">0 orders</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-primary bg-opacity-25 rounded">
                                    <h6 class="text-white">Total Sales</h6>
                                    <h3 class="mb-0" id="totalSales">₹0</h3>
                                    <small class="text-white-50" id="totalOrdersCount">0 orders</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card bg-light">
                    <div class="card-body">
                        <div class="metric-value text-primary" id="totalOrders">0</div>
                        <div class="metric-label">Total Orders</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card bg-light">
                    <div class="card-body">
                        <div class="metric-value text-success" id="totalRevenue">₹0</div>
                        <div class="metric-label">Total Revenue</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card bg-light">
                    <div class="card-body">
                        <div class="metric-value text-warning" id="avgOrderValue">₹0</div>
                        <div class="metric-label">Avg. Order Value</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card bg-light">
                    <div class="card-body">
                        <div class="metric-value text-danger" id="delayedOrdersPercent">0%</div>
                        <div class="metric-label">Delayed Orders</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Insights -->
        <div class="card mb-4 insight-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Smart Insights</h5>
            </div>
            <div class="card-body" id="smartInsights">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Analyzing your data...</span>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Orders by Day</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="ordersByDayChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Orders by Hour</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="ordersByHourChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Delay Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="delayAnalysisChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Popular Items</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="popularItemsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics Tabs -->
        <div class="card mt-4">
            <div class="card-header">
                <ul class="nav nav-pills" id="detailedAnalyticsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">Orders</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="delays-tab" data-bs-toggle="tab" data-bs-target="#delays" type="button" role="tab">Delays</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">Items</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="detailedAnalyticsContent">
                    <div class="tab-pane fade show active" id="orders" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Date</th>
                                        <th>Items</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Delay</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <!-- Orders will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="delays" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Date</th>
                                        <th>Expected Time</th>
                                        <th>Actual Time</th>
                                        <th>Delay (min)</th>
                                        <th>Delay Level</th>
                                    </tr>
                                </thead>
                                <tbody id="delaysTableBody">
                                    <!-- Delays will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="items" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Portion</th>
                                        <th>Quantity Sold</th>
                                        <th>Revenue</th>
                                        <th>Avg. Delay</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <!-- Items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration and Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyAEKHWdRyzI8WyBeGeesjDrM-nEzOXCuNk",
            authDomain: "billion1-a9324.firebaseapp.com",
            projectId: "billion1-a9324",
            storageBucket: "billion1-a9324.appspot.com",
            messagingSenderId: "443716692865",
            appId: "1:443716692865:web:96813fe32a44f8342cd680",
            measurementId: "G-FE7NFHY5PG"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Global variable to store Firebase server date
        let FIREBASE_SERVER_DATE = new Date().toISOString();
        
        // Fetch server time from Firebase
        async function fetchServerTime() {
            try {
                const timeDoc = await db.collection('utility').doc('serverTime').get();
                if (timeDoc.exists && timeDoc.data().timestamp) {
                    const timestamp = timeDoc.data().timestamp;
                    if (typeof timestamp.toDate === 'function') {
                        FIREBASE_SERVER_DATE = timestamp.toDate().toISOString();
                    } else {
                        FIREBASE_SERVER_DATE = new Date().toISOString();
                    }
                } else {
                    console.log('No server time document found, using local time');
                    FIREBASE_SERVER_DATE = new Date().toISOString();
                }
                console.log('Firebase server date:', FIREBASE_SERVER_DATE);
            } catch (error) {
                console.error('Error fetching server time:', error);
                FIREBASE_SERVER_DATE = new Date().toISOString();
            }
        }
        
        // Sales period state
        let salesPeriod = {
            type: 'today',
            startDate: null,
            endDate: null,
            orders: []
        };
        
        // Helper function to format date for input fields
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Function to handle sales period change
        window.changeSalesPeriod = function(periodType) {
            console.log('Changing sales period to:', periodType);
            salesPeriod.type = periodType;
            
            // Show/hide custom date range inputs
            if (periodType === 'custom') {
                document.getElementById('salesCustomDateRange').classList.remove('d-none');
                document.getElementById('salesCustomDateRange').classList.add('d-inline-block');
                
                // Set default dates if not already set
                if (!document.getElementById('salesStartDate').value) {
                    // Use Firebase server date as reference
                    const firebaseDate = new Date(FIREBASE_SERVER_DATE);
                    const lastWeek = new Date(firebaseDate);
                    lastWeek.setDate(firebaseDate.getDate() - 7);
                    
                    document.getElementById('salesStartDate').value = formatDateForInput(lastWeek);
                    document.getElementById('salesEndDate').value = formatDateForInput(firebaseDate);
                }
            } else {
                document.getElementById('salesCustomDateRange').classList.add('d-none');
                document.getElementById('salesCustomDateRange').classList.remove('d-inline-block');
                
                // Update sales stats for the selected period
                updateSalesStats();
            }
        }
        
        // Function to apply custom date range for sales statistics
        window.applySalesDateRange = function() {
            const startDateStr = document.getElementById('salesStartDate').value;
            const endDateStr = document.getElementById('salesEndDate').value;
            
            if (!startDateStr || !endDateStr) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Update sales stats with the custom date range
            updateSalesStats();
        }
        
        // Function to update sales statistics
        window.updateSalesStats = async function() {
            // Show loading indicator
            document.getElementById('completedSales').textContent = 'Loading...';
            document.getElementById('pendingSales').textContent = 'Loading...';
            document.getElementById('cancelledSales').textContent = 'Loading...';
            document.getElementById('totalSales').textContent = 'Loading...';
            
            try {
                // Determine date range based on selected period
                let startDate, endDate;
                
                // Use the global Firebase server date
                const firebaseServerDate = new Date(FIREBASE_SERVER_DATE);
                console.log('Sales stats: Firebase server date:', firebaseServerDate.toISOString());
                
                switch (salesPeriod.type) {
                    case 'today':
                        startDate = new Date(firebaseServerDate);
                        startDate.setHours(0, 0, 0, 0);
                        
                        endDate = new Date(firebaseServerDate);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'yesterday':
                        startDate = new Date(firebaseServerDate);
                        startDate.setDate(startDate.getDate() - 1);
                        startDate.setHours(0, 0, 0, 0);
                        
                        endDate = new Date(firebaseServerDate);
                        endDate.setDate(endDate.getDate() - 1);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'week':
                        startDate = new Date(firebaseServerDate);
                        startDate.setDate(startDate.getDate() - startDate.getDay());
                        startDate.setHours(0, 0, 0, 0);
                        
                        endDate = new Date(firebaseServerDate);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'month':
                        startDate = new Date(firebaseServerDate.getFullYear(), firebaseServerDate.getMonth(), 1);
                        startDate.setHours(0, 0, 0, 0);
                        
                        endDate = new Date(firebaseServerDate);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'custom':
                        const startDateStr = document.getElementById('salesStartDate').value;
                        const endDateStr = document.getElementById('salesEndDate').value;
                        
                        if (!startDateStr || !endDateStr) {
                            alert('Please select both start and end dates');
                            return;
                        }
                        
                        startDate = new Date(startDateStr);
                        startDate.setHours(0, 0, 0, 0);
                        
                        endDate = new Date(endDateStr);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    default:
                        startDate = new Date(firebaseServerDate);
                        startDate.setHours(0, 0, 0, 0);
                        
                        endDate = new Date(firebaseServerDate);
                        endDate.setHours(23, 59, 59, 999);
                }
                
                // Fetch orders from Firestore for the selected date range
                const ordersToProcess = await loadOrdersForDateRange(startDate, endDate);
                
                // Initialize counters
                let completedSales = 0;
                let completedCount = 0;
                let pendingSales = 0;
                let pendingCount = 0;
                let cancelledSales = 0;
                let cancelledCount = 0;
                let totalSales = 0;
                let totalCount = 0;
                
                // Process all orders
                ordersToProcess.forEach(order => {
                    const orderTotal = parseFloat(order.total) || 0;
                    totalCount++;
                    
                    // Categorize by status (simplified to only 3 statuses)
                    if (order.status === 'delivered') {
                        completedSales += orderTotal;
                        completedCount++;
                        totalSales += orderTotal; // Add to total sales
                    } else if (order.status === 'cancelled') {
                        cancelledSales += orderTotal;
                        cancelledCount++;
                        // Cancelled orders are not added to total sales
                    } else {
                        // Only pending status remains
                        pendingSales += orderTotal;
                        pendingCount++;
                        // Pending orders are part of potential sales but not confirmed
                    }
                });
                
                // Update the UI
                document.getElementById('completedSales').textContent = `₹${completedSales.toFixed(2)}`;
                document.getElementById('completedOrdersCount').textContent = `${completedCount} order${completedCount !== 1 ? 's' : ''}`;
                
                document.getElementById('pendingSales').textContent = `₹${pendingSales.toFixed(2)}`;
                document.getElementById('pendingOrdersCount').textContent = `${pendingCount} order${pendingCount !== 1 ? 's' : ''}`;
                
                document.getElementById('cancelledSales').textContent = `₹${cancelledSales.toFixed(2)}`;
                document.getElementById('cancelledOrdersCount').textContent = `${cancelledCount} order${cancelledCount !== 1 ? 's' : ''}`;
                
                document.getElementById('totalSales').textContent = `₹${totalSales.toFixed(2)}`;
                document.getElementById('totalOrdersCount').textContent = `${totalCount} order${totalCount !== 1 ? 's' : ''}`;
            } catch (error) {
                console.error('Error updating sales stats:', error);
                alert('Error loading sales statistics: ' + error.message);
                
                // Reset UI
                document.getElementById('completedSales').textContent = '₹0';
                document.getElementById('pendingSales').textContent = '₹0';
                document.getElementById('cancelledSales').textContent = '₹0';
                document.getElementById('totalSales').textContent = '₹0';
            }
        }
        
        // Function to load orders for a specific date range (for sales statistics)
        async function loadOrdersForDateRange(startDate, endDate) {
            console.log(`Loading orders for date range: ${startDate.toISOString()} to ${endDate.toISOString()}`);
            try {
                const snapshot = await db.collection('bot_orders')
                    .where('createdAt', '>=', startDate)
                    .where('createdAt', '<=', endDate)
                    .get();
                
                console.log(`Found ${snapshot.docs.length} orders in date range`);
                
                return snapshot.docs.map(doc => {
                    const data = doc.data();
                    
                    // Convert Firestore timestamps to JavaScript Date objects
                    let createdAtDate = null;
                    if (data.createdAt) {
                        if (typeof data.createdAt.toDate === 'function') {
                            createdAtDate = data.createdAt.toDate();
                        } else if (data.createdAt instanceof Date) {
                            createdAtDate = data.createdAt;
                        } else {
                            createdAtDate = new Date(FIREBASE_SERVER_DATE);
                        }
                    } else {
                        createdAtDate = new Date(FIREBASE_SERVER_DATE);
                    }
                    
                    // Convert updatedAt timestamp
                    let updatedAtDate = null;
                    if (data.updatedAt) {
                        if (typeof data.updatedAt.toDate === 'function') {
                            updatedAtDate = data.updatedAt.toDate();
                        } else if (data.updatedAt instanceof Date) {
                            updatedAtDate = data.updatedAt;
                        } else {
                            updatedAtDate = new Date(FIREBASE_SERVER_DATE);
                        }
                    } else {
                        updatedAtDate = new Date(FIREBASE_SERVER_DATE);
                    }
                    
                    return {
                        docId: doc.id,
                        ...data,
                        createdAt: createdAtDate,
                        updatedAt: updatedAtDate,
                        // Ensure these fields exist with defaults if missing
                        status: data.status || 'pending',
                        customerDetails: data.customerDetails || { 
                            name: 'Unknown',
                            phone: 'Unknown'
                        },
                        total: data.total || '0'
                    };
                });
            } catch (error) {
                console.error('Error loading orders for date range:', error);
                return [];
            }
        }
        const db = firebase.firestore();

        // Application State
        let state = {
            currentRestaurant: 'tandoorbaaz', // Default restaurant
            restaurantName: 'TandoorBaaz', // Display name
            analytics: {
                orders: [],
                dateRange: {
                    start: null,
                    end: null,
                    type: 'last7'
                }
            },
            charts: {}
        };
        
        // Get restaurant from URL parameters
        function getRestaurantFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const kitchen = urlParams.get('kitchen');
            
            if (kitchen) {
                // Map URL parameter to restaurant info
                const restaurantMap = {
                    'tandoorbaaz': { id: 'tandoorbaaz', name: 'TandoorBaaz' },
                    'eros': { id: 'eros', name: 'Eros Kitchen' },
                    'spice': { id: 'spice', name: 'Spice Junction' },
                    'royal': { id: 'royal', name: 'Royal Cuisine' }
                    // Add more restaurants as needed
                };
                
                if (restaurantMap[kitchen]) {
                    return restaurantMap[kitchen];
                }
            }
            
            // Default restaurant
            return { id: 'tandoorbaaz', name: 'TandoorBaaz' };
        }

        // Check if we need to create indexes for the restaurant-based queries
        async function checkAndCreateIndexes() {
            try {
                // Try to run a query that would require the index
                await db.collection('order_analytics')
                    .where('restaurant', '==', state.currentRestaurant)
                    .where('completedAt', '>=', new Date())
                    .orderBy('completedAt', 'desc')
                    .limit(1)
                    .get();
                
                console.log('Index for restaurant + completedAt exists');
                return true;
            } catch (error) {
                // If error contains "index not found", show a message with the link to create the index
                if (error.message.includes('index') && error.message.includes('not found')) {
                    console.error('Index not found:', error);
                    
                    // Extract the URL to create the index from the error message
                    const urlMatch = error.message.match(/(https:\/\/console\.firebase\.google\.com\/[^\s]+)/);
                    if (urlMatch && urlMatch[1]) {
                        const indexUrl = urlMatch[1];
                        alert(`This feature requires a Firestore index. Please open this URL to create it: ${indexUrl}`);
                        window.open(indexUrl, '_blank');
                    } else {
                        alert('This feature requires a Firestore index. Please check the console for details.');
                    }
                    return false;
                }
                
                console.error('Error checking index:', error);
                return false;
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            // Set restaurant from URL
            const restaurant = getRestaurantFromURL();
            state.currentRestaurant = restaurant.id;
            state.restaurantName = restaurant.name;
            
            // Update page title with restaurant name
            document.title = `${state.restaurantName} Analytics Dashboard`;
            
            // Update header with restaurant name
            const headerElement = document.querySelector('h2');
            if (headerElement) {
                headerElement.textContent = `${state.restaurantName} Analytics`;
            }
            
            // Update back button link to include restaurant parameter
            const backButton = document.getElementById('backToOrdersLink');
            if (backButton) {
                backButton.href = `showorders.html?kitchen=${state.currentRestaurant}`;
            }
            
            initDateRange();
            
            // Check if we have the required indexes before loading data
            await checkAndCreateIndexes();
            
            loadAnalyticsData();
        });

        // Date Range Functions
        function initDateRange() {
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            state.analytics.dateRange.start = sevenDaysAgo;
            state.analytics.dateRange.end = today;
            
            // Set default values for custom date inputs
            document.getElementById('startDate').valueAsDate = sevenDaysAgo;
            document.getElementById('endDate').valueAsDate = today;
        }

        function handleDateRangeChange() {
            const rangeType = document.getElementById('dateRange').value;
            state.analytics.dateRange.type = rangeType;
            
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            const customDateContainer = document.getElementById('customDateContainer');
            
            if (rangeType === 'custom') {
                customDateContainer.style.display = 'block';
                handleCustomDateChange();
                return;
            } else {
                customDateContainer.style.display = 'none';
            }
            
            let startDate = new Date();
            
            switch (rangeType) {
                case 'today':
                    startDate = new Date();
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'yesterday':
                    startDate = new Date();
                    startDate.setDate(today.getDate() - 1);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'last7':
                    startDate = new Date();
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'last30':
                    startDate = new Date();
                    startDate.setDate(today.getDate() - 30);
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    today.setDate(endOfLastMonth.getDate());
                    break;
            }
            
            state.analytics.dateRange.start = startDate;
            state.analytics.dateRange.end = today;
            
            loadAnalyticsData();
        }

        function handleCustomDateChange() {
            const startDate = document.getElementById('startDate').valueAsDate;
            const endDate = document.getElementById('endDate').valueAsDate;
            
            if (startDate && endDate) {
                // Set end date to end of day
                endDate.setHours(23, 59, 59, 999);
                
                state.analytics.dateRange.start = startDate;
                state.analytics.dateRange.end = endDate;
                
                loadAnalyticsData();
            }
        }

        // Data Loading Functions
        async function loadAnalyticsData() {
            try {
                const { start, end } = state.analytics.dateRange;
                
                // Query the order_analytics collection for the current restaurant
                let query = db.collection('order_analytics')
                    .where('restaurant', '==', state.currentRestaurant)
                    .where('completedAt', '>=', start)
                    .where('completedAt', '<=', end)
                    .orderBy('completedAt', 'desc');
                
                const snapshot = await query.get();
                
                // Process the data
                state.analytics.orders = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Convert Firestore timestamps to JS Date objects
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    if (data.completedAt && data.completedAt.toDate) {
                        data.completedAt = data.completedAt.toDate();
                    }
                    return { id: doc.id, ...data };
                });
                
                // Update the UI
                updateAnalyticsUI();
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                alert('Error loading analytics data: ' + error.message);
            }
        }

        function refreshData() {
            loadAnalyticsData();
            updateSalesStats(); // Also refresh the real-time sales statistics
        }

        // UI Update Functions
        function updateAnalyticsUI() {
            updateKeyMetrics();
            updateCharts();
            updateDetailedTables();
            generateSmartInsights();
        }

        function updateKeyMetrics() {
            const orders = state.analytics.orders;
            
            // Total Orders
            document.getElementById('totalOrders').textContent = orders.length;
            
            // Total Revenue
            const totalRevenue = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
            document.getElementById('totalRevenue').textContent = '₹' + totalRevenue.toLocaleString();
            
            // Average Order Value
            const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;
            document.getElementById('avgOrderValue').textContent = '₹' + avgOrderValue.toFixed(0);
            
            // Delayed Orders Percentage
            const delayedOrders = orders.filter(order => order.wasDelayed);
            const delayedPercentage = orders.length > 0 ? (delayedOrders.length / orders.length) * 100 : 0;
            document.getElementById('delayedOrdersPercent').textContent = delayedPercentage.toFixed(1) + '%';
        }

        function updateCharts() {
            createOrdersByDayChart();
            createOrdersByHourChart();
            createDelayAnalysisChart();
            createPopularItemsChart();
        }

        function createOrdersByDayChart() {
            const orders = state.analytics.orders;
            const ctx = document.getElementById('ordersByDayChart').getContext('2d');
            
            // Group orders by day of week
            const dayLabels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const ordersByDay = Array(7).fill(0);
            const revenueByDay = Array(7).fill(0);
            
            orders.forEach(order => {
                if (order.createdAt) {
                    const dayOfWeek = order.createdAt.getDay();
                    ordersByDay[dayOfWeek]++;
                    revenueByDay[dayOfWeek] += (order.totalAmount || 0);
                }
            });
            
            // Destroy existing chart if it exists
            if (state.charts.ordersByDay) {
                state.charts.ordersByDay.destroy();
            }
            
            // Create new chart
            state.charts.ordersByDay = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [
                        {
                            label: 'Number of Orders',
                            data: ordersByDay,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Revenue (₹)',
                            data: revenueByDay,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Orders'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Revenue (₹)'
                            }
                        }
                    }
                }
            });
        }

        function createOrdersByHourChart() {
            const orders = state.analytics.orders;
            const ctx = document.getElementById('ordersByHourChart').getContext('2d');
            
            // Group orders by hour of day
            const hourLabels = Array.from({ length: 24 }, (_, i) => i + ':00');
            const ordersByHour = Array(24).fill(0);
            
            orders.forEach(order => {
                if (order.createdAt) {
                    const hourOfDay = order.createdAt.getHours();
                    ordersByHour[hourOfDay]++;
                }
            });
            
            // Destroy existing chart if it exists
            if (state.charts.ordersByHour) {
                state.charts.ordersByHour.destroy();
            }
            
            // Create new chart
            state.charts.ordersByHour = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Orders by Hour',
                        data: ordersByHour,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Orders'
                            }
                        }
                    }
                }
            });
        }

        function createDelayAnalysisChart() {
            const orders = state.analytics.orders;
            const ctx = document.getElementById('delayAnalysisChart').getContext('2d');
            
            // Group orders by delay level
            const delayLevels = [0, 1, 2, 3, 4, 5, '5+'];
            const ordersByDelayLevel = Array(7).fill(0);
            
            orders.forEach(order => {
                const delayLevel = order.delayLevel || 0;
                if (delayLevel > 5) {
                    ordersByDelayLevel[6]++; // 5+
                } else {
                    ordersByDelayLevel[delayLevel]++;
                }
            });
            
            // Destroy existing chart if it exists
            if (state.charts.delayAnalysis) {
                state.charts.delayAnalysis.destroy();
            }
            
            // Create new chart
            state.charts.delayAnalysis = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: delayLevels.map(level => `Level ${level}`),
                    datasets: [{
                        data: ordersByDelayLevel,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',  // Level 0 - On time
                            'rgba(255, 205, 86, 0.7)',  // Level 1
                            'rgba(255, 159, 64, 0.7)',  // Level 2
                            'rgba(255, 99, 132, 0.7)',  // Level 3
                            'rgba(201, 77, 77, 0.7)',   // Level 4
                            'rgba(153, 50, 50, 0.7)',   // Level 5
                            'rgba(116, 27, 27, 0.7)'    // Level 5+
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(201, 77, 77, 1)',
                            'rgba(153, 50, 50, 1)',
                            'rgba(116, 27, 27, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = Math.round((value / orders.length) * 100);
                                    return `${label}: ${value} orders (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createPopularItemsChart() {
            const orders = state.analytics.orders;
            const ctx = document.getElementById('popularItemsChart').getContext('2d');
            
            // Aggregate items across all orders
            const itemsMap = {};
            
            orders.forEach(order => {
                if (order.itemsSummary && Array.isArray(order.itemsSummary)) {
                    order.itemsSummary.forEach(item => {
                        const key = item.name;
                        if (!itemsMap[key]) {
                            itemsMap[key] = {
                                name: item.name,
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        itemsMap[key].quantity += (item.quantity || 0);
                        itemsMap[key].revenue += (item.price * item.quantity) || 0;
                    });
                }
            });
            
            // Sort items by quantity and take top 5
            const topItems = Object.values(itemsMap)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);
            
            // Destroy existing chart if it exists
            if (state.charts.popularItems) {
                state.charts.popularItems.destroy();
            }
            
            // Create new chart
            state.charts.popularItems = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topItems.map(item => item.name),
                    datasets: [{
                        label: 'Quantity Sold',
                        data: topItems.map(item => item.quantity),
                        backgroundColor: 'rgba(153, 102, 255, 0.5)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity Sold'
                            }
                        }
                    }
                }
            });
        }

        function updateDetailedTables() {
            updateOrdersTable();
            updateDelaysTable();
            updateItemsTable();
        }

        function updateOrdersTable() {
            const orders = state.analytics.orders;
            const tableBody = document.getElementById('ordersTableBody');
            
            let html = '';
            
            orders.forEach(order => {
                const orderDate = order.createdAt ? order.createdAt.toLocaleString() : 'N/A';
                const orderNumber = order.orderNumber ? order.orderNumber.toString().slice(-4) : 'N/A';
                const itemsCount = order.totalItems || 0;
                const amount = order.totalAmount ? '₹' + order.totalAmount.toLocaleString() : 'N/A';
                const status = order.finalStatus || 'N/A';
                
                let delayBadge = '';
                if (order.delayMinutes > 0) {
                    const delayClass = order.delayLevel > 2 ? 'danger' : (order.delayLevel > 0 ? 'warning' : 'success');
                    delayBadge = `<span class="badge bg-${delayClass}">${order.delayMinutes} min</span>`;
                } else {
                    delayBadge = '<span class="badge bg-success">On time</span>';
                }
                
                html += `
                <tr>
                    <td>#${orderNumber}</td>
                    <td>${orderDate}</td>
                    <td>${itemsCount} items</td>
                    <td>${amount}</td>
                    <td><span class="badge bg-${status === 'delivered' ? 'success' : 'secondary'}">${status}</span></td>
                    <td>${delayBadge}</td>
                </tr>
                `;
            });
            
            if (orders.length === 0) {
                html = '<tr><td colspan="6" class="text-center">No orders found in the selected date range.</td></tr>';
            }
            
            tableBody.innerHTML = html;
        }

        function updateDelaysTable() {
            const orders = state.analytics.orders.filter(order => order.delayMinutes > 0);
            const tableBody = document.getElementById('delaysTableBody');
            
            let html = '';
            
            orders.sort((a, b) => b.delayMinutes - a.delayMinutes).forEach(order => {
                const orderDate = order.createdAt ? order.createdAt.toLocaleString() : 'N/A';
                const orderNumber = order.orderNumber ? order.orderNumber.toString().slice(-4) : 'N/A';
                const expectedTime = order.expectedMinutes + ' min';
                const actualTime = order.totalMinutes + ' min';
                const delayMinutes = order.delayMinutes + ' min';
                
                let delayLevelBadge = '';
                const delayClass = order.delayLevel > 3 ? 'danger' : (order.delayLevel > 1 ? 'warning' : 'info');
                delayLevelBadge = `<span class="badge bg-${delayClass}">Level ${order.delayLevel}</span>`;
                
                html += `
                <tr>
                    <td>#${orderNumber}</td>
                    <td>${orderDate}</td>
                    <td>${expectedTime}</td>
                    <td>${actualTime}</td>
                    <td>${delayMinutes}</td>
                    <td>${delayLevelBadge}</td>
                </tr>
                `;
            });
            
            if (orders.length === 0) {
                html = '<tr><td colspan="6" class="text-center">No delayed orders found in the selected date range.</td></tr>';
            }
            
            tableBody.innerHTML = html;
        }

        function updateItemsTable() {
            const orders = state.analytics.orders;
            const tableBody = document.getElementById('itemsTableBody');
            
            // Aggregate items data
            const itemsMap = {};
            
            orders.forEach(order => {
                if (order.itemsSummary && Array.isArray(order.itemsSummary)) {
                    order.itemsSummary.forEach(item => {
                        const key = `${item.name}-${item.portion}`;
                        if (!itemsMap[key]) {
                            itemsMap[key] = {
                                name: item.name,
                                portion: item.portion,
                                quantity: 0,
                                revenue: 0,
                                delayMinutes: [],
                                orderCount: 0
                            };
                        }
                        itemsMap[key].quantity += (item.quantity || 0);
                        itemsMap[key].revenue += (item.price * item.quantity) || 0;
                        itemsMap[key].delayMinutes.push(order.delayMinutes || 0);
                        itemsMap[key].orderCount++;
                    });
                }
            });
            
            // Calculate average delay for each item
            Object.values(itemsMap).forEach(item => {
                const totalDelay = item.delayMinutes.reduce((sum, delay) => sum + delay, 0);
                item.avgDelay = item.orderCount > 0 ? (totalDelay / item.orderCount).toFixed(1) : 0;
            });
            
            // Sort items by quantity sold (descending)
            const sortedItems = Object.values(itemsMap).sort((a, b) => b.quantity - a.quantity);
            
            let html = '';
            
            sortedItems.forEach(item => {
                const revenue = '₹' + item.revenue.toLocaleString();
                const avgDelayBadge = getDelayBadge(item.avgDelay);
                
                html += `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.portion}</td>
                    <td>${item.quantity}</td>
                    <td>${revenue}</td>
                    <td>${avgDelayBadge}</td>
                </tr>
                `;
            });
            
            if (sortedItems.length === 0) {
                html = '<tr><td colspan="5" class="text-center">No items data found in the selected date range.</td></tr>';
            }
            
            tableBody.innerHTML = html;
        }

        function getDelayBadge(avgDelay) {
            const delay = parseFloat(avgDelay);
            let badgeClass = 'success';
            
            if (delay > 15) {
                badgeClass = 'danger';
            } else if (delay > 5) {
                badgeClass = 'warning';
            } else if (delay > 0) {
                badgeClass = 'info';
            }
            
            return `<span class="badge bg-${badgeClass}">${avgDelay} min</span>`;
        }

        function generateSmartInsights() {
            const orders = state.analytics.orders;
            const insightsContainer = document.getElementById('smartInsights');
            
            if (orders.length === 0) {
                insightsContainer.innerHTML = '<div class="alert alert-info">No data available for the selected date range.</div>';
                return;
            }
            
            // Calculate key metrics for insights
            const totalOrders = orders.length;
            const delayedOrders = orders.filter(order => order.delayMinutes > 0);
            const delayedPercentage = (delayedOrders.length / totalOrders) * 100;
            
            // Calculate busiest day
            const ordersByDay = Array(7).fill(0);
            orders.forEach(order => {
                if (order.createdAt) {
                    const dayOfWeek = order.createdAt.getDay();
                    ordersByDay[dayOfWeek]++;
                }
            });
            const busiestDayIndex = ordersByDay.indexOf(Math.max(...ordersByDay));
            const busiestDay = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][busiestDayIndex];
            
            // Calculate busiest hour
            const ordersByHour = Array(24).fill(0);
            orders.forEach(order => {
                if (order.createdAt) {
                    const hourOfDay = order.createdAt.getHours();
                    ordersByHour[hourOfDay]++;
                }
            });
            const busiestHourIndex = ordersByHour.indexOf(Math.max(...ordersByHour));
            const busiestHour = `${busiestHourIndex}:00 - ${busiestHourIndex + 1}:00`;
            
            // Calculate most delayed item
            const itemDelays = {};
            orders.forEach(order => {
                if (order.itemsSummary && Array.isArray(order.itemsSummary)) {
                    order.itemsSummary.forEach(item => {
                        const key = item.name;
                        if (!itemDelays[key]) {
                            itemDelays[key] = {
                                name: key,
                                delays: [],
                                count: 0
                            };
                        }
                        itemDelays[key].delays.push(order.delayMinutes || 0);
                        itemDelays[key].count++;
                    });
                }
            });
            
            // Calculate average delay for each item
            Object.values(itemDelays).forEach(item => {
                item.avgDelay = item.count > 0 ? 
                    item.delays.reduce((sum, delay) => sum + delay, 0) / item.count : 0;
            });
            
            const mostDelayedItems = Object.values(itemDelays)
                .filter(item => item.count >= 3) // Only consider items with at least 3 orders
                .sort((a, b) => b.avgDelay - a.avgDelay);
            
            const mostDelayedItem = mostDelayedItems.length > 0 ? mostDelayedItems[0] : null;
            
            // Generate insights HTML
            let insightsHTML = '<div class="row">';
            
            // Insight 1: Order Volume
            insightsHTML += `
            <div class="col-md-4">
                <div class="alert alert-primary">
                    <h6><i class="bi bi-graph-up"></i> Order Volume</h6>
                    <p>You processed <strong>${totalOrders} orders</strong> in the selected period.</p>
                    <p>Your busiest day is <strong>${busiestDay}</strong> with ${ordersByDay[busiestDayIndex]} orders.</p>
                    <p>Peak hour: <strong>${busiestHour}</strong> with ${ordersByHour[busiestHourIndex]} orders.</p>
                </div>
            </div>
            `;
            
            // Insight 2: Delay Analysis
            insightsHTML += `
            <div class="col-md-4">
                <div class="alert alert-${delayedPercentage > 30 ? 'danger' : (delayedPercentage > 15 ? 'warning' : 'success')}">
                    <h6><i class="bi bi-clock-history"></i> Delay Analysis</h6>
                    <p><strong>${delayedPercentage.toFixed(1)}%</strong> of your orders were delayed.</p>
                    <p>Average delay: <strong>${delayedOrders.length > 0 ? 
                        (delayedOrders.reduce((sum, order) => sum + order.delayMinutes, 0) / delayedOrders.length).toFixed(1) : 0} minutes</strong>.</p>
                    ${mostDelayedItem ? 
                        `<p>Most delayed item: <strong>${mostDelayedItem.name}</strong> (avg. ${mostDelayedItem.avgDelay.toFixed(1)} min delay)</p>` : ''}
                </div>
            </div>
            `;
            
            // Insight 3: Recommendations
            insightsHTML += `
            <div class="col-md-4">
                <div class="alert alert-info">
                    <h6><i class="bi bi-lightbulb"></i> Recommendations</h6>
                    <ul class="mb-0">
                        ${delayedPercentage > 20 ? 
                            `<li>Consider adding more staff during ${busiestDay} and ${busiestHour}.</li>` : ''}
                        ${mostDelayedItem && mostDelayedItem.avgDelay > 10 ? 
                            `<li>Optimize preparation process for ${mostDelayedItem.name}.</li>` : ''}
                        ${delayedPercentage > 30 ? 
                            `<li>Review order preparation workflow to reduce delays.</li>` : ''}
                        ${delayedPercentage < 10 ? 
                            `<li>Great job keeping orders on time! Consider increasing capacity.</li>` : ''}
                        <li>Monitor trends over time to identify seasonal patterns.</li>
                    </ul>
                </div>
            </div>
            `;
            
            insightsHTML += '</div>';
            
            insightsContainer.innerHTML = insightsHTML;
        }
    </script>
</body>

</html>