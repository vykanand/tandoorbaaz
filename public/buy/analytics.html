<!DOCTYPE html>
<html lang="en">

<head>
    <title>TandoorBaaz Accounting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --purple-color: #6f42c1;
            --light-color: #f8f9fa;
            --background-color: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --card-border-radius: 12px;
            --transition-speed: 0.3s;
            --ease-out: cubic-bezier(0.25, 0.1, 0.25, 1);
            --ease-in: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Global Styles */
        body {
            background-color: var(--background-color);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .container-fluid {
            padding: 1rem;
        }

        /* Card Styles */
        .card {
            border: none;
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            transition: all var(--transition-speed) var(--ease-out);
            background: white;
            backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.95);
            margin-bottom: 1rem;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: none;
            border-bottom: none;
            padding: 1rem;
        }

        .card-header h5 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Summary section styles */
        .summary-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .summary-card h3 {
            font-size: 2.2rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .summary-card .card-body {
            padding: 1.5rem;
            border-radius: 15px;
        }

        .summary-card .card-title {
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .summary-card .badge {
            border-radius: 20px;
            padding: 0.5rem 0.8rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Table Styles */
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }

        /* Status Badges */
        .badge-paid-cash {
            background-color: var(--success-color);
        }

        .badge-paid-online {
            background-color: var(--purple-color);
        }

        .badge-pending {
            background-color: var(--warning-color);
            color: #212529;
        }

        .badge-delivered {
            background-color: var(--info-color);
        }

        .badge-preparing {
            background-color: #fd7e14;
            color: white;
        }

        /* Date Range Picker */
        .date-range-picker {
            display: flex;
            gap: 1.25rem;
            margin-bottom: 1.75rem;
            flex-wrap: wrap;
            background: linear-gradient(to right, rgba(248, 249, 250, 0.7), rgba(233, 236, 239, 0.7));
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .date-range-picker::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--purple-color));
        }
        
        .date-range-picker:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .date-range-picker .input-group {
            flex: 1;
            min-width: 200px;
            transition: all 0.3s ease;
        }
        
        .date-range-picker .input-group:hover {
            transform: translateY(-3px);
        }

        .date-range-picker .input-group-text {
            background: linear-gradient(135deg, var(--primary-color), var(--purple-color));
            color: white;
            border: none;
            border-radius: 10px 0 0 10px;
            padding: 0.6rem 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .date-range-picker .form-control {
            border-radius: 0 10px 10px 0;
            border: none;
            padding: 0.6rem 1rem;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            background-color: white;
        }
        
        .date-range-picker .form-control:focus {
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
            transform: translateY(-1px);
        }
        
        .date-range-picker .d-flex {
            flex: 1;
            min-width: 300px;
            justify-content: flex-start;
            align-items: center;
        }
        
        .date-range-picker .btn {
            border-radius: 10px;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .date-range-picker .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0.4), rgba(255,255,255,0.1));
            transition: all 0.5s ease;
            z-index: -1;
        }
        
        .date-range-picker .btn:hover::before {
            left: 100%;
        }
        
        .date-range-picker .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .date-range-picker .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--purple-color));
            border: none;
        }
        
        .date-range-picker .btn-outline-secondary {
            border: 1px solid rgba(108, 117, 125, 0.3);
            background: white;
            color: #495057;
        }
        
        .date-range-picker .btn-outline-secondary:hover {
            background: rgba(108, 117, 125, 0.05);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .date-picker-header {
            width: 100%;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .date-picker-header h6 {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .date-picker-header small {
            opacity: 0.8;
            font-size: 0.85rem;
            margin-left: 1.5rem;
        }
        
        /* Calendar animation */
        @keyframes calendar-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .date-range-picker .input-group-text i {
            transition: all 0.3s ease;
        }
        
        .date-range-picker .input-group:hover .input-group-text i {
            animation: calendar-pulse 1s ease infinite;
            color: rgba(255, 255, 255, 0.95);
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-controls .form-select,
        .filter-controls .form-control {
            min-width: 150px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Tab Navigation */
        .nav-tabs {
            border-bottom: none;
            margin-bottom: 1rem;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            color: #495057;
            margin-right: 0.5rem;
            transition: all 0.2s ease;
        }

        .nav-tabs .nav-link:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: rgba(13, 110, 253, 0.1);
            border-bottom: 3px solid var(--primary-color);
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 1.5rem;
        }

        /* Cart-specific analytics */
        .cart-analytics-card {
            border-left: 4px solid var(--primary-color);
        }

        /* Responsive Table Styles */
        .table-responsive {
            border-radius: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: var(--card-shadow);
        }

        /* Mobile table scrolling */
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: scroll;
                scrollbar-width: thin;
                scrollbar-color: #6c757d #f8f9fa;
            }
            
            .table-responsive::-webkit-scrollbar {
                height: 6px;
            }
            
            .table-responsive::-webkit-scrollbar-track {
                background: #f8f9fa;
                border-radius: 3px;
            }
            
            .table-responsive::-webkit-scrollbar-thumb {
                background: #6c757d;
                border-radius: 3px;
            }
            
            .table-responsive::-webkit-scrollbar-thumb:hover {
                background: #495057;
            }

            /* Ensure table maintains minimum width for readability */
            .table {
                min-width: 600px;
            }

            /* Table cell adjustments for mobile */
            .table th,
            .table td {
                white-space: nowrap;
                min-width: 80px;
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }
            
            /* Action buttons column minimum width */
            .table th:last-child,
            .table td:last-child {
                min-width: 120px;
            }
            
            /* Comments column adjustments */
            .table td:nth-child(7) {
                max-width: 200px;
                white-space: normal;
                word-wrap: break-word;
            }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0.5rem;
            }

            .card {
                margin-bottom: 0.75rem;
                border-radius: 10px;
            }

            .summary-card h3 {
                font-size: 1.5rem;
            }

            .date-range-picker {
                flex-direction: column;
                gap: 1rem;
                padding: 1.25rem;
                margin-bottom: 1.25rem;
            }
            
            .date-range-picker .input-group {
                width: 100%;
            }
            
            .date-range-picker .d-flex {
                width: 100%;
                flex-wrap: wrap;
                gap: 0.75rem;
                margin-top: 0.5rem;
                justify-content: center;
            }
            
            .date-range-picker .btn {
                flex: 1 1 calc(50% - 0.75rem);
                min-width: 120px;
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
            
            @media (max-width: 480px) {
                .date-range-picker {
                    padding: 1rem;
                    gap: 0.75rem;
                }
                
                .date-range-picker .btn {
                    flex: 1 1 100%;
                }
                
                .date-range-picker .input-group-text {
                    padding: 0.5rem 0.75rem;
                }
                
                .date-range-picker .form-control {
                    padding: 0.5rem 0.75rem;
                    font-size: 0.9rem;
                }
                
                /* Smaller table elements for very small screens */
                .table {
                    min-width: 550px;
                }
                
                .table th,
                .table td {
                    padding: 0.4rem 0.6rem;
                    font-size: 0.85rem;
                    min-width: 70px;
                }
                
                .table th:last-child,
                .table td:last-child {
                    min-width: 100px;
                }
            }

            .filter-controls {
                flex-direction: column;
                gap: 0.5rem;
            }

            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }

            .chart-container {
                height: 250px;
            }

            .btn-group-sm > .btn, .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            border-bottom: 2px solid var(--light-color);
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 2px solid var(--light-color);
            padding: 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Status indicators */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-cash {
            background-color: var(--success-color);
        }

        .status-online {
            background-color: var(--purple-color);
        }

        .status-pending {
            background-color: var(--warning-color);
        }

        .status-delivered {
            background-color: var(--info-color);
        }

        .status-preparing {
            background-color: #fd7e14;
        }

        /* Bottom navigation for mobile */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 0.5rem;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            color: #6c757d;
            text-decoration: none;
            padding: 0.5rem;
        }

        .mobile-nav-item.active {
            color: var(--primary-color);
        }

        .mobile-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
                justify-content: space-around;
            }

            body {
                padding-bottom: 70px;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-4">
        <!-- Accounting Summary Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-white d-flex justify-content-between align-items-center"
                        style="background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);">
                        <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Accounting Summary</h5>
                        <div class="d-flex align-items-center">
                            <div id="networkStatus" class="me-3">
                                <span class="badge bg-success">Online</span>
                            </div>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-outline-light me-2" onclick="exportToCSV()"
                                    style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <i class="bi bi-file-earmark-excel"></i> <span class="d-none d-md-inline">Export</span>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="loadOrders()"
                                    style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <i class="bi bi-arrow-clockwise"></i> <span class="d-none d-md-inline">Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Date Range Picker -->
                        <div class="date-range-picker">
                            <div class="date-picker-header mb-3 d-none d-md-block">
                                <h6 class="mb-0 text-primary"><i class="bi bi-calendar-range"></i> Select Date Range</h6>
                                <small class="text-muted">Filter your data by specific time periods</small>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text" title="Start Date">
                                    <i class="bi bi-calendar-event"></i>
                                </span>
                                <input type="date" id="startDate" class="form-control" 
                                    onchange="applyDateFilter()" placeholder="Start Date">
                                <label for="startDate" class="visually-hidden">Start Date</label>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text" title="End Date">
                                    <i class="bi bi-calendar-event-fill"></i>
                                </span>
                                <input type="date" id="endDate" class="form-control" 
                                    onchange="applyDateFilter()" placeholder="End Date">
                                <label for="endDate" class="visually-hidden">End Date</label>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-primary" onclick="resetDateFilter()" title="Show today's data">
                                    <i class="bi bi-calendar-check"></i> Today
                                </button>
                                <button class="btn btn-outline-secondary" onclick="setLastWeek()" title="Show last week's data">
                                    <i class="bi bi-calendar-week"></i> Last Week
                                </button>
                                <button class="btn btn-outline-secondary" onclick="setLastMonth()" title="Show last month's data">
                                    <i class="bi bi-calendar-month"></i> Last Month
                                </button>
                                <button class="btn btn-outline-secondary" onclick="loadAllOrders()" title="Show all orders">
                                    <i class="bi bi-calendar-range"></i> All Orders
                                </button>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title"><i class="bi bi-calendar-check"></i> Total Orders</h6>
                                        <h3 id="totalOrdersCount" class="mb-0">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge bg-primary">Total Sale: ₹<span
                                                    id="totalSalesAmount">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #d1e7dd 0%, #a3cfbb 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-cash"></i> Cash Payments</h6>
                                        <h3 id="cashPaymentsCount" class="mb-0 text-dark">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge bg-success">Value: ₹<span
                                                    id="cashPaymentsTotal">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #e2d9f3 0%, #c5b3e6 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-credit-card"></i> Online
                                            Payments</h6>
                                        <h3 id="onlinePaymentsCount" class="mb-0 text-dark">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge" style="background-color: #6f42c1;">Value: ₹<span
                                                    id="onlinePaymentsTotal">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #fff3cd 0%, #ffda6a 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-hourglass-split"></i> Pending
                                            Orders</h6>
                                        <h3 id="pendingOrdersCount" class="mb-0 text-dark">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge" style="background-color: #fd7e14;">Value: ₹<span
                                                    id="pendingOrdersTotal">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Summary Cards -->
                        <div class="row">
                            <div class="col-md-4 col-sm-6 mb-3">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #cfe2ff 0%, #9ec5fe 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-cart-check"></i> Delivered Orders</h6>
                                        <h3 id="deliveredOrdersCount" class="mb-0 text-dark">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge bg-info">Value: ₹<span
                                                    id="deliveredOrdersTotal">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-sm-6 mb-3">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #f8d7da 0%, #f5c2c7 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-shop"></i> Cart Performance</h6>
                                        <h3 id="topCartName" class="mb-0 text-dark">-</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge bg-danger">Orders: <span id="topCartCount">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-sm-6 mb-3">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #fff8e1 0%, #ffe082 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-graph-up"></i> Average Order Value</h6>
                                        <h3 id="averageOrderValue" class="mb-0 text-dark">₹0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge" style="background-color: #ff9800;">Daily Orders: <span
                                                    id="dailyOrdersCount">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Payment Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="paymentDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Cart Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="cartPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table Section with Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                        <h5 class="mb-0"><i class="bi bi-table"></i> Orders Analysis</h5>
                        <div class="filter-controls">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search orders..."
                                    onkeyup="applyFilters()">
                            </div>
                            <select id="cartFilter" class="form-select" onchange="applyFilters()">
                                <option value="all">All Carts</option>
                                <!-- Cart options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs" id="ordersTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-orders-tab" data-bs-toggle="tab"
                                    data-bs-target="#all-orders" type="button" role="tab" aria-controls="all-orders"
                                    aria-selected="true" onclick="setStatusFilter('all')">
                                    <i class="bi bi-list-ul"></i> All Orders
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="cash-orders-tab" data-bs-toggle="tab"
                                    data-bs-target="#cash-orders" type="button" role="tab" aria-controls="cash-orders"
                                    aria-selected="false" onclick="setStatusFilter('paid (cash)')">
                                    <i class="bi bi-cash"></i> Cash Payments
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="online-orders-tab" data-bs-toggle="tab"
                                    data-bs-target="#online-orders" type="button" role="tab" aria-controls="online-orders"
                                    aria-selected="false" onclick="setStatusFilter('paid(online)')">
                                    <i class="bi bi-credit-card"></i> Online Payments
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pending-orders-tab" data-bs-toggle="tab"
                                    data-bs-target="#pending-orders" type="button" role="tab" aria-controls="pending-orders"
                                    aria-selected="false" onclick="setStatusFilter('pending')">
                                    <i class="bi bi-hourglass-split"></i> Pending
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="delivered-orders-tab" data-bs-toggle="tab"
                                    data-bs-target="#delivered-orders" type="button" role="tab" aria-controls="delivered-orders"
                                    aria-selected="false" onclick="setStatusFilter('delivered')">
                                    <i class="bi bi-check2-circle"></i> Delivered
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="ordersTabContent">
                            <!-- All Orders Tab -->
                            <div class="tab-pane fade show active" id="all-orders" role="tabpanel" aria-labelledby="all-orders-tab">
                                <div class="table-responsive mt-3">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th onclick="sortTable('id')" style="cursor: pointer;">
                                                    Order ID <i id="sortIcon-id" class="bi bi-arrow-down-up"></i>
                                                </th>
                                                <th onclick="sortTable('date')" style="cursor: pointer;">
                                                    Date <i id="sortIcon-date" class="bi bi-arrow-down-up"></i>
                                                </th>
                                                <th onclick="sortTable('customer')" style="cursor: pointer;">
                                                    Customer <i id="sortIcon-customer" class="bi bi-arrow-down-up"></i>
                                                </th>
                                                <th onclick="sortTable('total')" style="cursor: pointer;">
                                                    Total <i id="sortIcon-total" class="bi bi-arrow-down-up"></i>
                                                </th>
                                                <th onclick="sortTable('status')" style="cursor: pointer;">
                                                    Status <i id="sortIcon-status" class="bi bi-arrow-down-up"></i>
                                                </th>
                                                <th onclick="sortTable('cartName')" style="cursor: pointer;">
                                                    Cart Name <i id="sortIcon-cartName" class="bi bi-arrow-down-up"></i>
                                                </th>
                                                <th onclick="sortTable('comments')" style="cursor: pointer;">
                                                    Comments <i id="sortIcon-comments" class="bi bi-arrow-down-up"></i>
                                                </th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersTableBody">
                                            <!-- Orders will be populated here -->
                                        </tbody>
                                    </table>
                                    </div>
                                        <!-- Pagination for All Orders -->
                                <nav aria-label="All Orders Pagination">
                                    <ul class="pagination pagination-sm justify-content-center" id="allOrdersPagination">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </nav>
                            </div>

                            <!-- Cash Payments Tab -->
                            <div class="tab-pane fade" id="cash-orders" role="tabpanel" aria-labelledby="cash-orders-tab">
                                <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
                                    <h6 class="mb-0"><span class="status-indicator status-cash"></span> Cash Payment Orders</h6>
                                    <div>
                                        <span class="badge bg-success">Total: ₹<span id="cashTabTotal">0</span></span>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Order ID</th>
                                                <th>Date</th>
                                                <th>Customer</th>
                                                <th>Total</th>
                                                <th>Cart Name</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cashOrdersTableBody">
                                            <!-- Cash orders will be populated here -->
                                        </tbody>
                                    </table>
                                    </div>
                                        <!-- Pagination for Cash Orders -->
                                <nav aria-label="Cash Orders Pagination">
                                            <ul class="pagination pagination-sm justify-content-center" id="cashOrdersPagination">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </nav>
                            </div>

                            <!-- Online Payments Tab -->
                            <div class="tab-pane fade" id="online-orders" role="tabpanel" aria-labelledby="online-orders-tab">
                                <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
                                    <h6 class="mb-0"><span class="status-indicator status-online"></span> Online Payment Orders</h6>
                                    <div>
                                        <span class="badge" style="background-color: #6f42c1;">Total: ₹<span id="onlineTabTotal">0</span></span>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Order ID</th>
                                                <th>Date</th>
                                                <th>Customer</th>
                                                <th>Total</th>
                                                <th>Cart Name</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="onlineOrdersTableBody">
                                            <!-- Online orders will be populated here -->
                                        </tbody>
                                    </table>
                                    </div>
                                        <!-- Pagination for Online Orders -->
                                <nav aria-label="Online Orders Pagination">
                                            <ul class="pagination pagination-sm justify-content-center" id="onlineOrdersPagination">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </nav>
                            </div>

                            <!-- Pending Orders Tab -->
                            <div class="tab-pane fade" id="pending-orders" role="tabpanel" aria-labelledby="pending-orders-tab">
                                <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
                                    <h6 class="mb-0"><span class="status-indicator status-pending"></span> Pending Orders</h6>
                                    <div>
                                        <span class="badge" style="background-color: #fd7e14;">Total: ₹<span id="pendingTabTotal">0</span></span>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Order ID</th>
                                                <th>Date</th>
                                                <th>Customer</th>
                                                <th>Total</th>
                                                <th>Cart Name</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pendingOrdersTableBody">
                                            <!-- Pending orders will be populated here -->
                                        </tbody>
                                    </table>
                                    </div>
                                        <!-- Pagination for Pending Orders -->
                                <nav aria-label="Pending Orders Pagination">
                                            <ul class="pagination pagination-sm justify-content-center" id="pendingOrdersPagination">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </nav>
                            </div>

                            <!-- Delivered Orders Tab -->
                            <div class="tab-pane fade" id="delivered-orders" role="tabpanel" aria-labelledby="delivered-orders-tab">
                                <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
                                    <h6 class="mb-0"><span class="status-indicator status-delivered"></span> Delivered Orders</h6>
                                    <div>
                                        <span class="badge bg-info">Total: ₹<span id="deliveredTabTotal">0</span></span>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Order ID</th>
                                                <th>Date</th>
                                                <th>Customer</th>
                                                <th>Total</th>
                                                <th>Payment</th>
                                                <th>Cart Name</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deliveredOrdersTableBody">
                                            <!-- Delivered orders will be populated here -->
                                        </tbody>
                                    </table>
                                    </div>
                                        <!-- Pagination for Delivered Orders -->
                                            <nav aria-label="Delivered Orders Pagination">
                                    <ul class="pagination pagination-sm justify-content-center" id="deliveredOrdersPagination">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Analytics Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-shop"></i> Cart Performance Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="cartAnalyticsContainer">
                            <!-- Cart analytics cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Item Profitability Analysis Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Menu Item Profitability Analysis</h5>
                        <div class="d-flex gap-2">
                            <select id="menuItemSortBy" class="form-select form-select-sm" style="width: auto;">
                                <option value="quantity">Sort by Quantity</option>
                                <option value="revenue" selected>Sort by Revenue</option>
                                <option value="name">Sort by Name</option>
                            </select>
                            <select id="menuItemLimit" class="form-select form-select-sm" style="width: auto;">
                                <option value="10">Top 10</option>
                                <option value="20" selected>Top 20</option>
                                <option value="50">Top 50</option>
                                <option value="0">All Items</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Quantity Sold</th>
                                        <th>Revenue</th>
                                        <th>% of Total Revenue</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="menuItemsTableBody">
                                    <!-- Menu items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination for Menu Items -->
                        <nav aria-label="Menu Items Pagination">
                            <ul class="pagination pagination-sm justify-content-center" id="menuItemsPagination">
                                     <!-- Pagination buttons will be generated here -->
                             </ul>
                         </nav>
                         <div class="chart-container mt-4">
                             <canvas id="menuItemsChart"></canvas>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation Bar -->
    <div class="mobile-nav">
        <a href="#" class="mobile-nav-item active" onclick="scrollToSection('summary')">
            <i class="bi bi-graph-up"></i>
            <span>Summary</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="scrollToSection('orders')">
            <i class="bi bi-table"></i>
            <span>Orders</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="scrollToSection('carts')">
            <i class="bi bi-shop"></i>
            <span>Carts</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="resetDateFilter()">
            <i class="bi bi-calendar-check"></i>
            <span>Today</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="loadOrders()">
            <i class="bi bi-arrow-clockwise"></i>
            <span>Refresh</span>
        </a>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrderModalLabel">Edit Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <input type="hidden" id="editOrderId">
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">Customer Phone</label>
                            <input type="text" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCartName" class="form-label">Cart Name</label>
                            <input type="text" class="form-control" id="editCartName">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerComments" class="form-label">Customer Comments</label>
                            <textarea class="form-control" id="editCustomerComments" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editOrderStatus" class="form-label">Status</label>
                            <select class="form-select" id="editOrderStatus">
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="paid(online)">Paid (Online)</option>
                                <option value="paid (cash)">Paid (Cash)</option>
                                <option value="delivered">Delivered</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Order Items</label>
                            <div id="editOrderItems" class="list-group mb-3">
                                <!-- Order items will be populated here -->
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <strong>Total:</strong>
                                <h5 class="mb-0">₹<span id="editOrderTotal">0</span></h5>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrderChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Order ID:</strong> <span id="detailsOrderId"></span></p>
                            <p><strong>Date:</strong> <span id="detailsOrderDate"></span></p>
                            <p><strong>Status:</strong> <span id="detailsOrderStatus"></span></p>
                            <p><strong>Cart Name:</strong> <span id="detailsCartName"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Customer Phone:</strong> <span id="detailsCustomerPhone"></span></p>
                            <p><strong>Comments:</strong> <span id="detailsCustomerComments"></span></p>
                            <p><strong>Total:</strong> ₹<span id="detailsOrderTotal"></span></p>
                        </div>
                    </div>
                    <h6>Order Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Portion</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="detailsOrderItems">
                                <!-- Order items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="openEditModal(currentOrderId)">Edit
                        Order</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEKHWdRyzI8WyBeGeesjDrM-nEzOXCuNk",
            authDomain: "billion1-a9324.firebaseapp.com",
            projectId: "billion1-a9324",
            storageBucket: "billion1-a9324.appspot.com",
            messagingSenderId: "443716692865",
            appId: "1:443716692865:web:96813fe32a44f8342cd680",
            measurementId: "G-FE7NFHY5PG"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence({synchronizeTabs: true})
          .catch(function(err) {
              if (err.code == 'failed-precondition') {
                  // Multiple tabs open, persistence can only be enabled in one tab at a time
                  console.warn('Firebase persistence could not be enabled: Multiple tabs open');
              } else if (err.code == 'unimplemented') {
                  // The current browser does not support all of the features required for persistence
                  console.warn('Firebase persistence not supported in this browser');
              }
          });

        // Application State
        let state = {
            allOrders: [],
            filteredOrders: [],
            sortField: 'date',
            sortDirection: 'desc',
            startDate: null,
            endDate: null,
            statusFilter: 'all',
            cartFilter: 'all',
            searchQuery: '',
            isOffline: false,
            retryCount: 0,
            cartStats: {},
            paymentChartInstance: null,
            cartChartInstance: null,
            menuItemsChartInstance: null,
            // Pagination state
            pagination: {
                allOrders: { currentPage: 1, itemsPerPage: 10 },
                cashOrders: { currentPage: 1, itemsPerPage: 10 },
                onlineOrders: { currentPage: 1, itemsPerPage: 10 },
                pendingOrders: { currentPage: 1, itemsPerPage: 10 },
                deliveredOrders: { currentPage: 1, itemsPerPage: 10 },
                menuItems: { currentPage: 1, itemsPerPage: 15 }
            },
            // Store current menu items for pagination
            currentMenuItems: []
        };
        
        // Network status monitoring
        function updateNetworkStatus() {
            const isOnline = navigator.onLine;
            const networkStatusElement = document.getElementById('networkStatus');
            
            if (isOnline) {
                if (networkStatusElement) {
                    networkStatusElement.innerHTML = '<span class="badge bg-success">Online</span>';
                }
                if (state.isOffline) {
                    // We were offline but now we're back online, try to reload data
                    state.isOffline = false;
                    loadOrders();
                }
            } else {
                if (networkStatusElement) {
                    networkStatusElement.innerHTML = '<span class="badge bg-danger">Offline</span>';
                }
                state.isOffline = true;
            }
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);

        let currentOrderId = null;
        let editOrderModal = null;
        let orderDetailsModal = null;

        // Simple Pagination Logic
        const Paginator = {
            // Get paginated data
            paginate(data, tableType) {
                const paginationState = state.pagination[tableType];
                const startIndex = (paginationState.currentPage - 1) * paginationState.itemsPerPage;
                const endIndex = startIndex + paginationState.itemsPerPage;
                return data.slice(startIndex, endIndex);
            },

            // Get total pages
            getTotalPages(data, tableType) {
                const itemsPerPage = state.pagination[tableType].itemsPerPage;
                return Math.ceil(data.length / itemsPerPage);
            },

            // Go to specific page
            goToPage(tableType, page) {
                const totalPages = this.getTotalPages(this.getDataForTable(tableType), tableType);
                if (page >= 1 && page <= totalPages) {
                    state.pagination[tableType].currentPage = page;
                    this.renderTable(tableType);
                    this.renderPagination(tableType);
                }
            },

            // Go to next page
            nextPage(tableType) {
                const totalPages = this.getTotalPages(this.getDataForTable(tableType), tableType);
                if (state.pagination[tableType].currentPage < totalPages) {
                    state.pagination[tableType].currentPage++;
                    this.renderTable(tableType);
                    this.renderPagination(tableType);
                }
            },

            // Go to previous page
            prevPage(tableType) {
                if (state.pagination[tableType].currentPage > 1) {
                    state.pagination[tableType].currentPage--;
                    this.renderTable(tableType);
                    this.renderPagination(tableType);
                }
            },

            // Get data for specific table type
            getDataForTable(tableType) {
                switch (tableType) {
                    case 'allOrders':
                        return state.filteredOrders;
                    case 'cashOrders':
                        return state.filteredOrders.filter(order => order.status === 'paid (cash)');
                    case 'onlineOrders':
                        return state.filteredOrders.filter(order => order.status === 'paid(online)');
                    case 'pendingOrders':
                        return state.filteredOrders.filter(order => order.status === 'pending' || order.status === 'preparing');
                    case 'deliveredOrders':
                        return state.filteredOrders.filter(order => order.status === 'delivered');
                    case 'menuItems':
                        return state.currentMenuItems || []; // Will store current menu items data
                    default:
                        return [];
                }
            },

            // Render pagination controls
            renderPagination(tableType) {
                const paginationContainer = document.getElementById(`${tableType}Pagination`);
                if (!paginationContainer) return;

                const data = this.getDataForTable(tableType);
                const totalPages = this.getTotalPages(data, tableType);
                const currentPage = state.pagination[tableType].currentPage;
                
                if (totalPages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }

                let paginationHTML = '';

                // Previous button
                paginationHTML += `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="Paginator.prevPage('${tableType}'); return false;" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                `;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    // Show first page, last page, current page, and pages around current
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        paginationHTML += `
                            <li class="page-item ${currentPage === i ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="Paginator.goToPage('${tableType}', ${i}); return false;">${i}</a>
                            </li>
                        `;
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        // Show ellipsis
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                }

                // Next button
                paginationHTML += `
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="Paginator.nextPage('${tableType}'); return false;" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                `;

                paginationContainer.innerHTML = paginationHTML;
            },

            // Render specific table with pagination
            renderTable(tableType) {
                switch (tableType) {
                    case 'allOrders':
                        renderAllOrdersTable();
                        break;
                    case 'cashOrders':
                        renderCashOrdersTable();
                        break;
                    case 'onlineOrders':
                        renderOnlineOrdersTable();
                        break;
                    case 'pendingOrders':
                        renderPendingOrdersTable();
                        break;
                    case 'deliveredOrders':
                        renderDeliveredOrdersTable();
                        break;
                    case 'menuItems':
                        renderMenuItemsTable();
                        break;
                }
            }
        };

        // Render just the menu items table (for pagination)
        function renderMenuItemsTable() {
            const tableBody = document.getElementById('menuItemsTableBody');
            const paginatedItems = Paginator.paginate(state.currentMenuItems, 'menuItems');
            
            // Clear table
            tableBody.innerHTML = '';
            
            // Populate table
            if (paginatedItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No menu items data available</td></tr>';
                return;
            }
            
            paginatedItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Determine trend icon and color
                let trendIcon, trendColor;
                if (item.trend > 5) {
                    trendIcon = 'bi-arrow-up-circle-fill';
                    trendColor = 'text-success';
                } else if (item.trend < -5) {
                    trendIcon = 'bi-arrow-down-circle-fill';
                    trendColor = 'text-danger';
                } else {
                    trendIcon = 'bi-dash-circle-fill';
                    trendColor = 'text-secondary';
                }
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>₹${item.revenue.toFixed(2)}</td>
                    <td>${item.percentageOfTotal.toFixed(1)}%</td>
                    <td>
                        <span class="${trendColor}">
                            <i class="bi ${trendIcon}"></i>
                            ${item.trend.toFixed(1)}%
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize modals
            editOrderModal = new bootstrap.Modal(document.getElementById('editOrderModal'));
            orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));

            // Check network status
            updateNetworkStatus();

            // Set default date range to today
            resetDateFilter();
            
            // Add event listeners for menu item analysis controls
            document.getElementById('menuItemSortBy').addEventListener('change', function() {
                if (state.filteredOrders.length > 0) {
                    updateMenuItemsAnalysis();
                }
            });
            
            document.getElementById('menuItemLimit').addEventListener('change', function() {
                if (state.filteredOrders.length > 0) {
                    updateMenuItemsAnalysis();
                }
            });

            // Load orders
            loadOrders();
        });

        // Load orders from Firestore
        async function loadOrders() {
            // Show loading indicator
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading orders...</p></td></tr>';
            
            try {
                // Update network status first
                updateNetworkStatus();
                
                // If we're offline, show cached data with a message
                if (state.isOffline && state.allOrders.length > 0) {
                    // We have cached data to show
                    showOfflineAlert("You're currently offline. Showing cached data.");
                    applyFilters();
                    return;
                } else if (state.isOffline && state.allOrders.length === 0) {
                    // We're offline with no cached data
                    showOfflineAlert("You're currently offline. No cached data available.");
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="alert alert-warning"><i class="bi bi-wifi-off"></i> You are offline. Please check your internet connection and try again.</div></td></tr>';
                    return;
                }
                
                let query = db.collection('bot_orders');

                try {
                    // Apply date filters if set
                    if (state.startDate) {
                        console.log("Start date filter:", state.startDate);
                        query = query.where('createdAt', '>=', state.startDate);
                    }
                    if (state.endDate) {
                        // Add one day to include the end date fully
                        const endDatePlusOne = new Date(state.endDate);
                        endDatePlusOne.setDate(endDatePlusOne.getDate() + 1);
                        console.log("End date filter:", endDatePlusOne);
                        query = query.where('createdAt', '<', endDatePlusOne);
                    }
                } catch (dateError) {
                    console.error("Error applying date filters:", dateError);
                    // If date filtering fails, try without filters
                    query = db.collection('bot_orders');
                }

                // Order by creation date
                query = query.orderBy('createdAt', 'desc');

                console.log("Fetching orders with query:", query);
                // Get the snapshot
                const snapshot = await query.get();
                console.log("Fetched orders:", snapshot.size);
                
                // Reset retry count on success
                state.retryCount = 0;
                
                // Hide any offline alerts
                hideOfflineAlert();
                
                // Process orders
                state.allOrders = snapshot.docs.map(doc => {
                    const data = doc.data();
                    
                    // Process createdAt to ensure it's a Date object
                    let createdAtDate = null;
                    if (data.createdAt) {
                        if (typeof data.createdAt.toDate === 'function') {
                            createdAtDate = data.createdAt.toDate();
                        } else if (data.createdAt instanceof Date) {
                            createdAtDate = data.createdAt;
                        }
                    }

                    return {
                        docId: doc.id,
                        ...data,
                        createdAt: createdAtDate,
                        // Ensure items is always an array
                        items: Array.isArray(data.items) ? data.items : []
                    };
                });

                // Apply filters and update UI
                applyFilters();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                
                // Update offline status
                state.isOffline = navigator.onLine ? false : true;
                updateNetworkStatus();
                
                // Show error in the table
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Error loading orders: ${error.message}
                    </div>
                    <button class="btn btn-primary mt-3" onclick="loadOrders()">
                        <i class="bi bi-arrow-clockwise"></i> Try Again
                    </button>
                </td></tr>`;
                
                // Show error alert
                showOfflineAlert(`Error loading orders: ${error.message}`);
                
                // If we have cached data, still show it
                if (state.allOrders.length > 0) {
                    showOfflineAlert("Showing previously loaded orders.");
                    applyFilters();
                }
            }
        }
        
        // Show offline alert
        function showOfflineAlert(message) {
            // Remove any existing alerts
            hideOfflineAlert();
            
            // Create new alert
            const alertDiv = document.createElement('div');
            alertDiv.id = 'offlineAlert';
            alertDiv.className = 'alert alert-warning alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-wifi-off me-2"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert at the top of the page
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
        }
        
        // Hide offline alert
        function hideOfflineAlert() {
            const existingAlert = document.getElementById('offlineAlert');
            if (existingAlert) {
                existingAlert.remove();
            }
        }

        // Apply filters to orders
        function applyFilters() {
            // Get filter values
            const statusFilter = state.statusFilter || 'all';
            const cartFilter = document.getElementById('cartFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();

            // Update state
            state.cartFilter = cartFilter;
            state.searchQuery = searchQuery;

            // Filter orders
            state.filteredOrders = state.allOrders.filter(order => {
                // Status filter
                if (statusFilter !== 'all') {
                    if (statusFilter === 'pending' && order.status !== 'pending' && order.status !== 'preparing') {
                        return false;
                    } else if (statusFilter !== 'pending' && order.status !== statusFilter) {
                        return false;
                    }
                }

                // Cart filter
                if (cartFilter !== 'all' && order.cartName !== cartFilter) {
                    return false;
                }

                // Search query
                if (searchQuery) {
                    const orderIdMatch = order.id && order.id.toString().includes(searchQuery);
                    const docIdMatch = order.docId && order.docId.toLowerCase().includes(searchQuery);
                    const phoneMatch = order.customerDetails && order.customerDetails.phone && 
                                      order.customerDetails.phone.toLowerCase().includes(searchQuery);
                    const commentsMatch = order.customerDetails && order.customerDetails.comments && 
                                         order.customerDetails.comments.toLowerCase().includes(searchQuery);
                    const cartMatch = order.cartName && order.cartName.toLowerCase().includes(searchQuery);
                    const statusMatch = order.status && order.status.toLowerCase().includes(searchQuery);
                    
                    if (!orderIdMatch && !docIdMatch && !phoneMatch && !commentsMatch && !cartMatch && !statusMatch) {
                        return false;
                    }
                }

                return true;
            });

            // Sort orders
            sortOrders();

            // Reset pagination on filter change
            Object.keys(state.pagination).forEach(tableType => {
                state.pagination[tableType].currentPage = 1;
            });

            // Update UI
            updateSummaryStats();
            renderOrdersTable();
        }

        // Sort orders based on current sort field and direction
        function sortOrders() {
            state.filteredOrders.sort((a, b) => {
                let valueA, valueB;

                switch (state.sortField) {
                    case 'id':
                        valueA = a.id ? a.id.toString() : a.docId;
                        valueB = b.id ? b.id.toString() : b.docId;
                        break;
                    case 'date':
                        valueA = a.createdAt ? a.createdAt.getTime() : 0;
                        valueB = b.createdAt ? b.createdAt.getTime() : 0;
                        break;
                    case 'customer':
                        valueA = a.customerDetails && a.customerDetails.phone ? a.customerDetails.phone : '';
                        valueB = b.customerDetails && b.customerDetails.phone ? b.customerDetails.phone : '';
                        break;
                    case 'total':
                        valueA = parseFloat(a.total || 0);
                        valueB = parseFloat(b.total || 0);
                        break;
                    case 'status':
                        valueA = a.status || '';
                        valueB = b.status || '';
                        break;
                    case 'comments':
                        valueA = a.customerDetails && a.customerDetails.comments ? a.customerDetails.comments : '';
                        valueB = b.customerDetails && b.customerDetails.comments ? b.customerDetails.comments : '';
                        break;
                    default:
                        valueA = a.createdAt ? a.createdAt.getTime() : 0;
                        valueB = b.createdAt ? b.createdAt.getTime() : 0;
                }

                // Compare values based on sort direction
                if (state.sortDirection === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
        }

        // Sort table by column
        function sortTable(field) {
            // If clicking the same field, toggle direction
            if (state.sortField === field) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortField = field;
                state.sortDirection = 'asc';
            }

            // Reset all sort icons
            document.querySelectorAll('[id^="sortIcon-"]').forEach(icon => {
                icon.className = 'bi bi-arrow-down-up';
            });

            // Update the clicked column's icon
            const sortIcon = document.getElementById(`sortIcon-${field}`);
            sortIcon.className = state.sortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down';

            // Sort and render
            sortOrders();
            renderOrdersTable();
        }

        // Render orders table (now calls all individual table renderers)
        function renderOrdersTable() {
            // Populate cart filter if not already populated
            populateCartFilter();
            
            // Render all tables with pagination
            renderAllOrdersTable();
            renderCashOrdersTable();
            renderOnlineOrdersTable();
            renderPendingOrdersTable();
            renderDeliveredOrdersTable();
            
            // Render pagination for all tables
            Paginator.renderPagination('allOrders');
            Paginator.renderPagination('cashOrders');
            Paginator.renderPagination('onlineOrders');
            Paginator.renderPagination('pendingOrders');
            Paginator.renderPagination('deliveredOrders');
        }

        // Render All Orders Table with pagination
        function renderAllOrdersTable() {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';
            
            const paginatedData = Paginator.paginate(state.filteredOrders, 'allOrders');
            
            if (paginatedData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="8" class="text-center">No orders found</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            paginatedData.forEach(order => {
                const orderDate = order.createdAt ? formatDate(order.createdAt) : 'N/A';
                let statusBadgeClass = getStatusBadgeClass(order.status);
                let itemsDisplay = getItemsDisplay(order.items);
                
                const mainRow = document.createElement('tr');
                mainRow.innerHTML = `
                    <td>${(order.id ? order.id.toString() : order.docId.slice(-4))}</td>
                    <td>${orderDate}</td>
                    <td>${order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A'}</td>
                    <td>₹${parseFloat(order.total || 0).toFixed(2)}</td>
                    <td><span class="badge ${statusBadgeClass}">${order.status || 'N/A'}</span></td>
                    <td>${order.cartName || 'N/A'}</td>
                    <td>
                        <div>${order.customerDetails && order.customerDetails.comments ? order.customerDetails.comments : 'N/A'}</div>
                        <small class="text-muted">${itemsDisplay}</small>
                    </td>
                    <td>${getFullActionButtons(order.docId)}</td>
                `;
                tableBody.appendChild(mainRow);
            });
        }

        // Render Cash Orders Table with pagination
        function renderCashOrdersTable() {
            const tableBody = document.getElementById('cashOrdersTableBody');
            tableBody.innerHTML = '';
            
            const cashOrders = state.filteredOrders.filter(order => order.status === 'paid (cash)');
            const paginatedData = Paginator.paginate(cashOrders, 'cashOrders');
            
            if (paginatedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No cash payment orders found</td></tr>`;
                return;
            }
            
            paginatedData.forEach(order => {
                const orderDate = order.createdAt ? formatDate(order.createdAt) : 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${(order.id ? order.id.toString() : order.docId.slice(-4))}</td>
                    <td>${orderDate}</td>
                    <td>${order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A'}</td>
                    <td>₹${parseFloat(order.total || 0).toFixed(2)}</td>
                    <td>${order.cartName || 'N/A'}</td>
                    <td>${getSimpleActionButtons(order.docId)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render Online Orders Table with pagination
        function renderOnlineOrdersTable() {
            const tableBody = document.getElementById('onlineOrdersTableBody');
            tableBody.innerHTML = '';
            
            const onlineOrders = state.filteredOrders.filter(order => order.status === 'paid(online)');
            const paginatedData = Paginator.paginate(onlineOrders, 'onlineOrders');
            
            if (paginatedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No online payment orders found</td></tr>`;
                return;
            }
            
            paginatedData.forEach(order => {
                const orderDate = order.createdAt ? formatDate(order.createdAt) : 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${(order.id ? order.id.toString() : order.docId.slice(-4))}</td>
                    <td>${orderDate}</td>
                    <td>${order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A'}</td>
                    <td>₹${parseFloat(order.total || 0).toFixed(2)}</td>
                    <td>${order.cartName || 'N/A'}</td>
                    <td>${getSimpleActionButtons(order.docId)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render Pending Orders Table with pagination
        function renderPendingOrdersTable() {
            const tableBody = document.getElementById('pendingOrdersTableBody');
            tableBody.innerHTML = '';
            
            const pendingOrders = state.filteredOrders.filter(order => order.status === 'pending' || order.status === 'preparing');
            const paginatedData = Paginator.paginate(pendingOrders, 'pendingOrders');
            
            if (paginatedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No pending orders found</td></tr>`;
                return;
            }
            
            paginatedData.forEach(order => {
                const orderDate = order.createdAt ? formatDate(order.createdAt) : 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${(order.id ? order.id.toString() : order.docId.slice(-4))}</td>
                    <td>${orderDate}</td>
                    <td>${order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A'}</td>
                    <td>₹${parseFloat(order.total || 0).toFixed(2)}</td>
                    <td>${order.cartName || 'N/A'}</td>
                    <td>${getSimpleActionButtons(order.docId)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render Delivered Orders Table with pagination
        function renderDeliveredOrdersTable() {
            const tableBody = document.getElementById('deliveredOrdersTableBody');
            tableBody.innerHTML = '';
            
            const deliveredOrders = state.filteredOrders.filter(order => order.status === 'delivered');
            const paginatedData = Paginator.paginate(deliveredOrders, 'deliveredOrders');
            
            if (paginatedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No delivered orders found</td></tr>`;
                return;
            }
            
            paginatedData.forEach(order => {
                const orderDate = order.createdAt ? formatDate(order.createdAt) : 'N/A';
                const paymentType = order.status === 'paid (cash)' ? 'Cash' : 
                                   (order.status === 'paid(online)' ? 'Online' : 'N/A');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${(order.id ? order.id.toString() : order.docId.slice(-4))}</td>
                    <td>${orderDate}</td>
                    <td>${order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A'}</td>
                    <td>₹${parseFloat(order.total || 0).toFixed(2)}</td>
                    <td>${paymentType}</td>
                    <td>${order.cartName || 'N/A'}</td>
                    <td>${getSimpleActionButtons(order.docId)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Helper functions for table rendering
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'paid (cash)': return 'badge-paid-cash';
                case 'paid(online)': return 'badge-paid-online';
                case 'pending': return 'badge-pending';
                case 'preparing': return 'badge-preparing';
                case 'delivered': return 'badge-delivered';
                default: return 'bg-secondary';
            }
        }

        function getItemsDisplay(items) {
            if (Array.isArray(items) && items.length > 0) {
                return items.map(item => `${item.name} (${item.quantity})`).join(', ');
            }
            return 'No items';
        }

        function getFullActionButtons(docId) {
            return `
                <div class="btn-group">
                    <button class="btn btn-sm btn-info" onclick="showOrderDetails('${docId}')">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="openEditModal('${docId}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteOrder('${docId}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
        }

        function getSimpleActionButtons(docId) {
            return `
                <div class="btn-group">
                    <button class="btn btn-sm btn-info" onclick="showOrderDetails('${docId}')">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="openEditModal('${docId}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            `;
        }
        
        // Populate cart filter dropdown
        function populateCartFilter() {
            const cartFilter = document.getElementById('cartFilter');
            
            // Only populate if not already done
            if (cartFilter.options.length <= 1) {
                // Get unique cart names
                const cartNames = [...new Set(state.allOrders.map(order => order.cartName || 'Unknown'))];
                
                // Clear existing options except the first one
                while (cartFilter.options.length > 1) {
                    cartFilter.remove(1);
                }
                
                // Add cart options
                cartNames.forEach(cartName => {
                    const option = document.createElement('option');
                    option.value = cartName;
                    option.textContent = cartName;
                    cartFilter.appendChild(option);
                });
            }
        }
        
        // Set status filter and update active tab
        function setStatusFilter(status) {
            state.statusFilter = status;
            applyFilters();
        }
        
        // Update cart analytics section
        function updateCartAnalytics() {
            const container = document.getElementById('cartAnalyticsContainer');
            container.innerHTML = '';
            
            // Sort carts by total sales
            const sortedCarts = Object.entries(state.cartStats)
                .sort((a, b) => b[1].total - a[1].total);
            
            // Create a card for each cart
            sortedCarts.forEach(([cartName, stats]) => {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 mb-3';
                
                const card = document.createElement('div');
                card.className = 'card cart-analytics-card h-100';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                // Calculate percentages
                const cashPercent = stats.total > 0 ? (stats.cashTotal / stats.total * 100).toFixed(1) : 0;
                const onlinePercent = stats.total > 0 ? (stats.onlineTotal / stats.total * 100).toFixed(1) : 0;
                const pendingPercent = stats.total > 0 ? (stats.pendingTotal / stats.total * 100).toFixed(1) : 0;
                
                cardBody.innerHTML = `
                    <h5 class="card-title">${cartName}</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Orders:</span>
                        <strong>${stats.count}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Sales:</span>
                        <strong>₹${stats.total.toFixed(2)}</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span><span class="status-indicator status-cash"></span> Cash:</span>
                        <strong>${stats.cashCount} (₹${stats.cashTotal.toFixed(2)}) - ${cashPercent}%</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><span class="status-indicator status-online"></span> Online:</span>
                        <strong>${stats.onlineCount} (₹${stats.onlineTotal.toFixed(2)}) - ${onlinePercent}%</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><span class="status-indicator status-pending"></span> Pending:</span>
                        <strong>${stats.pendingCount} (₹${stats.pendingTotal.toFixed(2)}) - ${pendingPercent}%</strong>
                    </div>
                `;
                
                card.appendChild(cardBody);
                col.appendChild(card);
                container.appendChild(col);
            });
            
            // If no carts, show a message
            if (sortedCarts.length === 0) {
                container.innerHTML = '<div class="col-12 text-center">No cart data available</div>';
            }
        }
        
        // Update charts
        function updateCharts() {
            updatePaymentDistributionChart();
            updateCartPerformanceChart();
            updateMenuItemsAnalysis();
        }
        
        // Analyze menu items profitability
        function updateMenuItemsAnalysis() {
            // Initialize menu items stats
            const menuItemsStats = {};
            let totalRevenue = 0;
            
            // Process all filtered orders
            state.filteredOrders.forEach(order => {
                // Skip orders without items
                if (!order.items || !Array.isArray(order.items)) return;
                
                // Process each item in the order
                order.items.forEach(item => {
                    // Skip if item name or price is missing
                    if (!item.name || !item.price) return;
                    
                    const itemName = item.name.split(' - ')[0]; // Remove size/variant info
                    const quantity = item.quantity || 1;
                    const price = parseFloat(item.price) || 0;
                    const itemTotal = price * quantity;
                    
                    // Add to total revenue
                    totalRevenue += itemTotal;
                    
                    // Update or create item stats
                    if (!menuItemsStats[itemName]) {
                        menuItemsStats[itemName] = {
                            name: itemName,
                            quantity: 0,
                            revenue: 0,
                            orderDates: []
                        };
                    }
                    
                    menuItemsStats[itemName].quantity += quantity;
                    menuItemsStats[itemName].revenue += itemTotal;
                    
                    // Track order date for trend analysis
                    if (order.createdAt) {
                        const orderDate = typeof order.createdAt.toDate === 'function' 
                            ? order.createdAt.toDate() 
                            : new Date(order.createdAt);
                        
                        menuItemsStats[itemName].orderDates.push({
                            date: orderDate,
                            quantity: quantity,
                            revenue: itemTotal
                        });
                    }
                });
            });
            
            // Calculate trends (comparing first half to second half of the period)
            Object.values(menuItemsStats).forEach(item => {
                if (item.orderDates.length > 0) {
                    // Sort dates
                    item.orderDates.sort((a, b) => a.date - b.date);
                    
                    // Split into two periods
                    const midpoint = Math.floor(item.orderDates.length / 2);
                    const firstHalf = item.orderDates.slice(0, midpoint);
                    const secondHalf = item.orderDates.slice(midpoint);
                    
                    // Calculate revenue for each half
                    const firstHalfRevenue = firstHalf.reduce((sum, order) => sum + order.revenue, 0);
                    const secondHalfRevenue = secondHalf.reduce((sum, order) => sum + order.revenue, 0);
                    
                    // Calculate trend percentage (avoid division by zero)
                    if (firstHalfRevenue > 0) {
                        item.trend = ((secondHalfRevenue - firstHalfRevenue) / firstHalfRevenue) * 100;
                    } else if (secondHalfRevenue > 0) {
                        item.trend = 100; // If first half was zero and second half has sales, that's a 100% increase
                    } else {
                        item.trend = 0; // No sales in either period
                    }
                } else {
                    item.trend = 0;
                }
            });
            
            // Calculate percentage of total revenue
            Object.values(menuItemsStats).forEach(item => {
                item.percentageOfTotal = totalRevenue > 0 ? (item.revenue / totalRevenue) * 100 : 0;
            });
            
            // Display the menu items analysis
            displayMenuItemsAnalysis(menuItemsStats, totalRevenue);
        }
        
        // Display menu items profitability analysis
        function displayMenuItemsAnalysis(menuItemsStats, totalRevenue) {
            const tableBody = document.getElementById('menuItemsTableBody');
            const sortBy = document.getElementById('menuItemSortBy').value;
            const limit = parseInt(document.getElementById('menuItemLimit').value);
            
            // Convert to array for sorting
            let menuItems = Object.values(menuItemsStats);
            
            // Sort items based on selected criteria
            switch (sortBy) {
                case 'quantity':
                    menuItems.sort((a, b) => b.quantity - a.quantity);
                    break;
                case 'revenue':
                    menuItems.sort((a, b) => b.revenue - a.revenue);
                    break;
                case 'name':
                    menuItems.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }
            
            // Apply limit if not 0 (all items)
            if (limit > 0) {
                menuItems = menuItems.slice(0, limit);
            }
            
            // Store menu items for pagination
            state.currentMenuItems = menuItems;
            state.pagination.menuItems.currentPage = 1; // Reset to first page when data changes
            
            // Get paginated data
            const paginatedItems = Paginator.paginate(menuItems, 'menuItems');
            
            // Clear table
            tableBody.innerHTML = '';
            
            // Populate table
            if (paginatedItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No menu items data available</td></tr>';
                Paginator.renderPagination('menuItems');
                return;
            }
            
            paginatedItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Determine trend icon and color
                let trendIcon, trendColor;
                if (item.trend > 5) {
                    trendIcon = 'bi-arrow-up-circle-fill';
                    trendColor = 'text-success';
                } else if (item.trend < -5) {
                    trendIcon = 'bi-arrow-down-circle-fill';
                    trendColor = 'text-danger';
                } else {
                    trendIcon = 'bi-dash-circle-fill';
                    trendColor = 'text-secondary';
                }
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>₹${item.revenue.toFixed(2)}</td>
                    <td>${item.percentageOfTotal.toFixed(1)}%</td>
                    <td>
                        <span class="${trendColor}">
                            <i class="bi ${trendIcon}"></i>
                            ${item.trend.toFixed(1)}%
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Render pagination
            Paginator.renderPagination('menuItems');
            
            // Update chart (use all menu items, not just paginated)
            updateMenuItemsChart(menuItems);
        }
        
        // Update menu items chart
        function updateMenuItemsChart(menuItems) {
            const ctx = document.getElementById('menuItemsChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (state.menuItemsChartInstance) {
                state.menuItemsChartInstance.destroy();
            }
            
            // Prepare data for chart (top 10 items by revenue)
            const chartItems = [...menuItems].sort((a, b) => b.revenue - a.revenue).slice(0, 10);
            
            // Create chart
            state.menuItemsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartItems.map(item => item.name),
                    datasets: [
                        {
                            label: 'Revenue (₹)',
                            data: chartItems.map(item => item.revenue),
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Quantity Sold',
                            data: chartItems.map(item => item.quantity),
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Revenue (₹)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Quantity Sold'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Menu Items by Revenue'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw;
                                    return `${label}: ${context.datasetIndex === 0 ? '₹' + value.toFixed(2) : value}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update payment distribution chart
        function updatePaymentDistributionChart() {
            const ctx = document.getElementById('paymentDistributionChart').getContext('2d');
            
            // Prepare data
            const cashTotal = parseFloat(document.getElementById('cashPaymentsTotal').textContent);
            const onlineTotal = parseFloat(document.getElementById('onlinePaymentsTotal').textContent);
            const pendingTotal = parseFloat(document.getElementById('pendingOrdersTotal').textContent);
            const deliveredTotal = parseFloat(document.getElementById('deliveredOrdersTotal').textContent);
            
            const data = {
                labels: ['Cash Payments', 'Online Payments', 'Pending Orders', 'Delivered Orders'],
                datasets: [{
                    data: [cashTotal, onlineTotal, pendingTotal, deliveredTotal],
                    backgroundColor: [
                        'rgba(25, 135, 84, 0.7)',
                        'rgba(111, 66, 193, 0.7)',
                        'rgba(253, 126, 20, 0.7)',
                        'rgba(13, 202, 240, 0.7)'
                    ],
                    borderColor: [
                        'rgb(25, 135, 84)',
                        'rgb(111, 66, 193)',
                        'rgb(253, 126, 20)',
                        'rgb(13, 202, 240)'
                    ],
                    borderWidth: 1
                }]
            };
            
            // Destroy previous chart if exists
            if (state.paymentChartInstance) {
                state.paymentChartInstance.destroy();
            }
            
            // Create new chart
            state.paymentChartInstance = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ₹${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update cart performance chart
        function updateCartPerformanceChart() {
            const ctx = document.getElementById('cartPerformanceChart').getContext('2d');
            
            // Prepare data
            const sortedCarts = Object.entries(state.cartStats)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 5); // Top 5 carts
            
            const labels = sortedCarts.map(([name]) => name);
            const cashData = sortedCarts.map(([, stats]) => stats.cashTotal);
            const onlineData = sortedCarts.map(([, stats]) => stats.onlineTotal);
            const pendingData = sortedCarts.map(([, stats]) => stats.pendingTotal);
            
            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Cash Payments',
                        data: cashData,
                        backgroundColor: 'rgba(25, 135, 84, 0.7)',
                        borderColor: 'rgb(25, 135, 84)',
                        borderWidth: 1
                    },
                    {
                        label: 'Online Payments',
                        data: onlineData,
                        backgroundColor: 'rgba(111, 66, 193, 0.7)',
                        borderColor: 'rgb(111, 66, 193)',
                        borderWidth: 1
                    },
                    {
                        label: 'Pending Orders',
                        data: pendingData,
                        backgroundColor: 'rgba(253, 126, 20, 0.7)',
                        borderColor: 'rgb(253, 126, 20)',
                        borderWidth: 1
                    }
                ]
            };
            
            // Destroy previous chart if exists
            if (state.cartChartInstance) {
                state.cartChartInstance.destroy();
            }
            
            // Create new chart
            state.cartChartInstance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ₹${value.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Scroll to section (for mobile navigation)
        function scrollToSection(section) {
            let targetElement;
            
            switch (section) {
                case 'summary':
                    targetElement = document.querySelector('.container-fluid .row:first-child');
                    break;
                case 'orders':
                    targetElement = document.querySelector('.container-fluid .row:nth-child(3)');
                    break;
                case 'carts':
                    targetElement = document.querySelector('.container-fluid .row:last-child');
                    break;
                default:
                    return;
            }
            
            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop - 20,
                    behavior: 'smooth'
                });
                
                // Update active nav item
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.mobile-nav-item[onclick="scrollToSection('${section}')"]`).classList.add('active');
            }
        }

        // Update summary statistics
        function updateSummaryStats() {
            let totalCount = state.filteredOrders.length;
            let totalSales = 0;
            let pendingCount = 0;
            let pendingTotal = 0;
            let cashPaymentsCount = 0;
            let cashPaymentsTotal = 0;
            let onlinePaymentsCount = 0;
            let onlinePaymentsTotal = 0;
            let deliveredCount = 0;
            let deliveredTotal = 0;
            let cartStats = {};
            let today = new Date();
            today.setHours(0, 0, 0, 0);
            let dailyOrdersCount = 0;

            state.filteredOrders.forEach(order => {
                const orderTotal = parseFloat(order.total || 0);
                totalSales += orderTotal;

                // Count daily orders
                if (order.createdAt && order.createdAt.toDate) {
                    const orderDate = order.createdAt.toDate();
                    orderDate.setHours(0, 0, 0, 0);
                    if (orderDate.getTime() === today.getTime()) {
                        dailyOrdersCount++;
                    }
                }

                // Track cart statistics
                const cartName = order.cartName || 'Unknown';
                if (!cartStats[cartName]) {
                    cartStats[cartName] = {
                        count: 0,
                        total: 0,
                        cashCount: 0,
                        cashTotal: 0,
                        onlineCount: 0,
                        onlineTotal: 0,
                        pendingCount: 0,
                        pendingTotal: 0,
                        deliveredCount: 0,
                        deliveredTotal: 0
                    };
                }
                cartStats[cartName].count++;
                cartStats[cartName].total += orderTotal;

                // Track status-specific stats
                if (order.status === 'pending' || order.status === 'preparing') {
                    pendingCount++;
                    pendingTotal += orderTotal;
                    cartStats[cartName].pendingCount++;
                    cartStats[cartName].pendingTotal += orderTotal;
                } else if (order.status === 'paid (cash)') {
                    cashPaymentsCount++;
                    cashPaymentsTotal += orderTotal;
                    cartStats[cartName].cashCount++;
                    cartStats[cartName].cashTotal += orderTotal;
                } else if (order.status === 'paid(online)') {
                    onlinePaymentsCount++;
                    onlinePaymentsTotal += orderTotal;
                    cartStats[cartName].onlineCount++;
                    cartStats[cartName].onlineTotal += orderTotal;
                } else if (order.status === 'delivered') {
                    deliveredCount++;
                    deliveredTotal += orderTotal;
                    cartStats[cartName].deliveredCount++;
                    cartStats[cartName].deliveredTotal += orderTotal;
                }
            });

            // Store cart stats in state
            state.cartStats = cartStats;

            // Find top performing cart
            let topCart = { name: '-', count: 0 };
            for (const [name, stats] of Object.entries(cartStats)) {
                if (stats.count > topCart.count) {
                    topCart = { name, count: stats.count };
                }
            }

            // Calculate average order value
            const avgOrderValue = totalCount > 0 ? totalSales / totalCount : 0;

            // Update the summary section
            document.getElementById('totalOrdersCount').textContent = totalCount;
            document.getElementById('totalSalesAmount').textContent = totalSales.toFixed(2);
            document.getElementById('pendingOrdersCount').textContent = pendingCount;
            document.getElementById('pendingOrdersTotal').textContent = pendingTotal.toFixed(2);
            document.getElementById('cashPaymentsCount').textContent = cashPaymentsCount;
            document.getElementById('cashPaymentsTotal').textContent = cashPaymentsTotal.toFixed(2);
            document.getElementById('onlinePaymentsCount').textContent = onlinePaymentsCount;
            document.getElementById('onlinePaymentsTotal').textContent = onlinePaymentsTotal.toFixed(2);
            document.getElementById('deliveredOrdersCount').textContent = deliveredCount;
            document.getElementById('deliveredOrdersTotal').textContent = deliveredTotal.toFixed(2);
            document.getElementById('topCartName').textContent = topCart.name;
            document.getElementById('topCartCount').textContent = topCart.count;
            document.getElementById('averageOrderValue').textContent = `₹${avgOrderValue.toFixed(2)}`;
            document.getElementById('dailyOrdersCount').textContent = dailyOrdersCount;

            // Update tab totals
            document.getElementById('cashTabTotal').textContent = cashPaymentsTotal.toFixed(2);
            document.getElementById('onlineTabTotal').textContent = onlinePaymentsTotal.toFixed(2);
            document.getElementById('pendingTabTotal').textContent = pendingTotal.toFixed(2);
            document.getElementById('deliveredTabTotal').textContent = deliveredTotal.toFixed(2);

            // Update cart analytics section
            updateCartAnalytics();

            // Update charts
            updateCharts();
        }

        // Show order details
        function showOrderDetails(orderId) {
            const order = state.allOrders.find(o => o.docId === orderId);
            if (!order) return;

            currentOrderId = orderId;

            // Populate modal with order details
            document.getElementById('detailsOrderId').textContent = order.id ? order.id.toString() : order.docId.slice(-4);
            document.getElementById('detailsOrderDate').textContent = order.createdAt ? formatDate(order.createdAt) : 'N/A';
            document.getElementById('detailsOrderStatus').textContent = order.status || 'N/A';
            document.getElementById('detailsCartName').textContent = order.cartName || 'N/A';
            document.getElementById('detailsCustomerPhone').textContent = order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A';
            document.getElementById('detailsCustomerComments').textContent = order.customerDetails && order.customerDetails.comments ? order.customerDetails.comments : 'N/A';
            document.getElementById('detailsOrderTotal').textContent = parseFloat(order.total || 0).toFixed(2);

            // Populate order items
            const itemsContainer = document.getElementById('detailsOrderItems');
            itemsContainer.innerHTML = '';

            if (Array.isArray(order.items) && order.items.length > 0) {
                order.items.forEach(item => {
                    const row = document.createElement('tr');
                    const itemTotal = (parseFloat(item.price) * parseInt(item.quantity)).toFixed(2);
                    
                    row.innerHTML = `
                        <td>${item.name || 'N/A'}</td>
                        <td>${item.portion || 'N/A'}</td>
                        <td>${item.quantity || '1'}</td>
                        <td>₹${parseFloat(item.price).toFixed(2)}</td>
                        <td>₹${itemTotal}</td>
                    `;
                    
                    itemsContainer.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No items found</td>';
                itemsContainer.appendChild(row);
            }

            // Show the modal
            orderDetailsModal.show();
        }

        // Open edit modal
        function openEditModal(orderId) {
            const order = state.allOrders.find(o => o.docId === orderId);
            if (!order) return;

            // Hide details modal if open
            orderDetailsModal.hide();

            // Populate edit form
            document.getElementById('editOrderId').value = orderId;
            document.getElementById('editCustomerPhone').value = order.customerDetails ? order.customerDetails.phone || '' : '';
            document.getElementById('editCartName').value = order.cartName || '';
            document.getElementById('editCustomerComments').value = order.customerDetails && order.customerDetails.comments ? order.customerDetails.comments : '';
            document.getElementById('editOrderStatus').value = order.status || 'pending';
            document.getElementById('editOrderTotal').textContent = parseFloat(order.total || 0).toFixed(2);

            // Populate order items
            const itemsContainer = document.getElementById('editOrderItems');
            itemsContainer.innerHTML = '';

            if (Array.isArray(order.items) && order.items.length > 0) {
                order.items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-group-item';
                    const itemTotal = (parseFloat(item.price) * parseInt(item.quantity)).toFixed(2);
                    
                    itemDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.name || 'N/A'}</strong> (${item.portion || 'N/A'})
                                <div class="small text-muted">
                                    Quantity: ${item.quantity || '1'} × ₹${parseFloat(item.price).toFixed(2)} = ₹${itemTotal}
                                </div>
                            </div>
                            <div class="input-group input-group-sm" style="max-width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateItemQuantity(${index}, -1)">-</button>
                                <input type="number" class="form-control text-center" id="itemQuantity-${index}" value="${item.quantity}" min="1" onchange="updateItemQuantity(${index}, 0)">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateItemQuantity(${index}, 1)">+</button>
                            </div>
                        </div>
                    `;
                    
                    itemsContainer.appendChild(itemDiv);
                });
            } else {
                itemsContainer.innerHTML = '<div class="list-group-item text-center">No items found</div>';
            }

            // Show the modal
            editOrderModal.show();
        }

        // Update item quantity in edit modal
        function updateItemQuantity(itemIndex, change) {
            const orderId = document.getElementById('editOrderId').value;
            const order = state.allOrders.find(o => o.docId === orderId);
            if (!order || !Array.isArray(order.items) || !order.items[itemIndex]) return;

            const inputElement = document.getElementById(`itemQuantity-${itemIndex}`);
            let newQuantity = parseInt(inputElement.value) + change;
            
            // Ensure quantity is at least 1
            newQuantity = Math.max(1, newQuantity);
            inputElement.value = newQuantity;
            
            // Update the order object
            order.items[itemIndex].quantity = newQuantity;
            
            // Recalculate total
            let newTotal = 0;
            order.items.forEach(item => {
                newTotal += parseFloat(item.price) * parseInt(item.quantity);
            });
            
            // Update total display
            document.getElementById('editOrderTotal').textContent = newTotal.toFixed(2);
        }

        // Save order changes
        async function saveOrderChanges() {
            const orderId = document.getElementById('editOrderId').value;
            const order = state.allOrders.find(o => o.docId === orderId);
            if (!order) return;

            // Get form values
            const customerPhone = document.getElementById('editCustomerPhone').value;
            const cartName = document.getElementById('editCartName').value;
            const customerComments = document.getElementById('editCustomerComments').value;
            const status = document.getElementById('editOrderStatus').value;

            // Update quantities from inputs
            if (Array.isArray(order.items)) {
                order.items.forEach((item, index) => {
                    const quantityInput = document.getElementById(`itemQuantity-${index}`);
                    if (quantityInput) {
                        item.quantity = parseInt(quantityInput.value) || 1;
                    }
                });
            }

            // Recalculate total
            let newTotal = 0;
            if (Array.isArray(order.items)) {
                order.items.forEach(item => {
                    newTotal += parseFloat(item.price) * parseInt(item.quantity);
                });
            }

            try {
                // Prepare update data
                const updateData = {
                    status: status,
                    total: newTotal,
                    cartName: cartName,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    customerDetails: {
                        ...order.customerDetails,
                        phone: customerPhone,
                        comments: customerComments
                    },
                    items: order.items
                };

                // Update in Firestore
                await db.collection('bot_orders').doc(orderId).update(updateData);
                
                // Hide modal
                editOrderModal.hide();
                
                // Reload orders
                loadOrders();
                
                // Show success message
                alert('Order updated successfully');
                
            } catch (error) {
                console.error('Error updating order:', error);
                alert('Error updating order: ' + error.message);
            }
        }

        // Confirm and delete order
        function confirmDeleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                deleteOrder(orderId);
            }
        }

        // Delete order
        async function deleteOrder(orderId) {
            try {
                await db.collection('bot_orders').doc(orderId).delete();
                
                // Reload orders
                loadOrders();
                
                // Show success message
                alert('Order deleted successfully');
                
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Error deleting order: ' + error.message);
            }
        }

        // Apply date filter
        function applyDateFilter() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput.value) {
                state.startDate = new Date(startDateInput.value);
                state.startDate.setHours(0, 0, 0, 0);
            } else {
                state.startDate = null;
            }
            
            if (endDateInput.value) {
                state.endDate = new Date(endDateInput.value);
                state.endDate.setHours(23, 59, 59, 999);
            } else {
                state.endDate = null;
            }
            
            loadOrders();
        }

        // Reset date filter to today
        function resetDateFilter() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayStr = formatDateForInput(today);
            
            document.getElementById('startDate').value = todayStr;
            document.getElementById('endDate').value = todayStr;
            
            state.startDate = today;
            state.endDate = new Date(today);
            state.endDate.setHours(23, 59, 59, 999);
            
            loadOrders();
        }
        
        // Load all orders without date filtering
        function loadAllOrders() {
            // Clear date filters
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            state.startDate = null;
            state.endDate = null;
            
            loadOrders();
        }

        // Set date range to last week
        function setLastWeek() {
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').value = formatDateForInput(lastWeek);
            document.getElementById('endDate').value = formatDateForInput(today);
            
            state.startDate = lastWeek;
            state.endDate = new Date(today);
            state.endDate.setHours(23, 59, 59, 999);
            
            loadOrders();
        }

        // Set date range to last month
        function setLastMonth() {
            const today = new Date();
            const lastMonth = new Date(today);
            lastMonth.setMonth(today.getMonth() - 1);
            
            document.getElementById('startDate').value = formatDateForInput(lastMonth);
            document.getElementById('endDate').value = formatDateForInput(today);
            
            state.startDate = lastMonth;
            state.endDate = new Date(today);
            state.endDate.setHours(23, 59, 59, 999);
            
            loadOrders();
        }

        // Export to CSV
        function exportToCSV() {
            if (state.filteredOrders.length === 0) {
                alert('No orders to export');
                return;
            }

            // Prepare CSV content
            let csvContent = 'Order ID,Date,Customer Phone,Comments,Status,Total,Items\n';
            
            state.filteredOrders.forEach(order => {
                const orderId = order.id ? order.id.toString() : order.docId;
                const date = order.createdAt ? formatDate(order.createdAt) : 'N/A';
                const phone = order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A';
                const comments = order.customerDetails && order.customerDetails.comments ? 
                                 order.customerDetails.comments.replace(/,/g, ' ').replace(/\n/g, ' ') : 'N/A';
                const status = order.status || 'N/A';
                const total = parseFloat(order.total || 0).toFixed(2);
                
                // Format items as a string
                let itemsStr = '';
                if (Array.isArray(order.items) && order.items.length > 0) {
                    itemsStr = order.items.map(item => 
                        `${item.name} (${item.portion}) x${item.quantity} - ₹${parseFloat(item.price).toFixed(2)}`
                    ).join('; ');
                } else {
                    itemsStr = 'No items';
                }
                
                // Add row to CSV
                csvContent += `"${orderId}","${date}","${phone}","${comments}","${status}","${total}","${itemsStr}"\n`;
            });
            
            // Create download link
            const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            
            // Generate filename with date range
            let filename = 'TandoorBaaz_Orders_';
            if (state.startDate && state.endDate) {
                filename += formatDateForFilename(state.startDate) + '_to_' + formatDateForFilename(state.endDate);
            } else {
                filename += formatDateForFilename(new Date());
            }
            filename += '.csv';
            
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Helper function to format date
        function formatDate(date) {
            if (!date) return 'N/A';
            
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            return date.toLocaleDateString('en-IN', options);
        }

        // Helper function to format date for input fields
        function formatDateForInput(date) {
            if (!date) return '';
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // Helper function to format date for filenames
        function formatDateForFilename(date) {
            if (!date) return 'unknown_date';
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}${month}${day}`;
        }
    </script>
</body>

</html>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                