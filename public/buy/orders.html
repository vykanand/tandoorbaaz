<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TandoorBaaz Orders Management</title>
    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const cartName = urlParams.get('cart') || 'default';
        const cartTitle = urlParams.get('title');

        // Update document title with cart name
        document.title = `TandoorBaaz - ${cartName} Orders`;

        // Store information
        const stores = [
            { id: 'samriddhi', name: 'Samriddhi' },
            { id: 'eros', name: 'Eros' }
        ];

        // Function to get store display name
        function getStoreName(storeId) {
            const store = stores.find(s => s.id === storeId);
            return store ? store.name : storeId;
        }

        // Function to create and handle store change modal
        function changeStore(storeId, selectorId) {
            // If no store selected or same store selected, reset the selector and return
            if (!storeId || storeId === cartName) {
                document.getElementById(selectorId).value = cartName;
                return;
            }

            const currentStoreName = getStoreName(cartName);
            const newStoreName = getStoreName(storeId);

            // Create modal element
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal fade';
            confirmModal.id = 'storeChangeConfirmModal';
            confirmModal.setAttribute('tabindex', '-1');
            confirmModal.setAttribute('aria-labelledby', 'storeChangeConfirmModalLabel');
            confirmModal.setAttribute('aria-hidden', 'true');

            // Set modal content
            confirmModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="storeChangeConfirmModalLabel">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>Change Store?
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-2">You are about to switch from:</p>
                            <div class="alert alert-primary mb-3">
                                <strong><i class="bi bi-shop me-2"></i>${currentStoreName}</strong>
                            </div>
                            <p class="mb-2">to:</p>
                            <div class="alert alert-success mb-3">
                                <strong><i class="bi bi-shop me-2"></i>${newStoreName}</strong>
                            </div>
                            <p class="text-danger">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                This will load a different set of orders. Any unsaved changes will be lost.
                            </p>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="confirmStoreChange">
                                <label class="form-check-label" for="confirmStoreChange">
                                    Yes, I want to switch to ${newStoreName}
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelStoreChange">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirmStoreChangeBtn" disabled>
                                Switch to ${newStoreName}
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to document and show it
            document.body.appendChild(confirmModal);
            const modal = new bootstrap.Modal(document.getElementById('storeChangeConfirmModal'));
            modal.show();

            // Handle checkbox change
            document.getElementById('confirmStoreChange').addEventListener('change', function () {
                document.getElementById('confirmStoreChangeBtn').disabled = !this.checked;
            });

            // Handle confirm button click
            document.getElementById('confirmStoreChangeBtn').addEventListener('click', function () {
                if (document.getElementById('confirmStoreChange').checked) {
                    window.location.href = `orders.html?cart=${storeId}`;
                }
            });

            // Handle modal dismissal
            const handleModalHidden = function () {
                document.getElementById(selectorId).value = cartName;
                if (document.body.contains(confirmModal)) {
                    document.body.removeChild(confirmModal);
                }
            };

            // Handle cancel button click
            document.getElementById('cancelStoreChange').addEventListener('click', function () {
                modal._element.addEventListener('hidden.bs.modal', handleModalHidden, { once: true });
            });

            // Clean up modal when hidden
            confirmModal.addEventListener('hidden.bs.modal', handleModalHidden);
        }
    </script>
    <!-- External resources -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- QR Code Modal -->
    <div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrCodeModalLabel">Scan QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="https://i.ibb.co/rfHKcg0R/nishaqr.jpg" alt="QR Code" class="img-fluid rounded" style="max-width: 100%; height: auto;">
                    <p class="mt-3">Scan this QR code to access the menu</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* QR Code Button - Circular style */
        .btn-circle {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50% !important;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .d-flex.gap-2.mb-4 {
                gap: 0.5rem !important;
                padding: 0 0.5rem;
            }
            
            .btn-circle {
                width: 44px;
                height: 44px;
                font-size: 1.25rem;
            }
            
            .btn-primary.flex-grow-1 {
                flex-grow: 1 !important;
            }
        }


        :root {
            /* Core variables */
            --bottom-nav-height: 65px;
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --light-color: #f8f9fa;
            --background-color: #f5f7fa;

            /* UI effects */
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --card-border-radius: 16px;
            --transition-speed: 0.3s;
            --ease-out: cubic-bezier(0.25, 0.1, 0.25, 1);

            /* Gradients */
            --header-gradient: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            --success-gradient: linear-gradient(135deg, #20c997 0%, #198754 100%);
            --warning-gradient: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
            --info-gradient: linear-gradient(135deg, #0dcaf0 0%, #0d6efd 100%);
        }

        /* Global Styles - Mobile First Approach */
        body {
            background-color: var(--background-color);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: #333;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        .container-fluid {
            padding: 0.75rem;
            width: 100%;
        }

        /* Interactive elements */
        button,
        .btn,
        a.btn,
        select,
        input[type="button"],
        input[type="submit"] {
            min-height: 44px;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            touch-action: manipulation;
        }

        /* Card Styles */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            transition: transform var(--transition-speed) var(--ease-out);
            background-color: rgba(255, 255, 255, 0.95);
            margin-bottom: 0.75rem;
        }

        .card-header {
            background: none;
            border-bottom: none;
            padding: 0.75rem;
        }

        .card-header h5 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-body {
            padding: 0.75rem;
        }

        /* Desktop hover effects - only on non-touch devices */
        @media (hover: hover) {
            .card:hover {
                transform: translateY(-5px);
            }
        }

        /* Order Card Styles - Enhanced Modern Design */
        .order-card {
            margin-bottom: 1rem;
            border: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            background: white;
            border-radius: 16px;
            padding: 1rem;
            position: relative;
            overflow: hidden;
            width: 100%;
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Status indicator styling - more modern approach */
        .order-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: var(--light-color);
            transition: all 0.3s ease;
        }

        /* Status indicator at the top */
        .order-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: transparent;
            transition: all 0.3s ease;
        }

        /* Status-specific styling with gradients */
        .order-card.bg-pending::before {
            background: var(--warning-gradient);
        }

        .order-card.bg-paid::before {
            background: var(--success-gradient);
        }

        .order-card.bg-delivered::before {
            background: var(--info-gradient);
        }

        .order-card.bg-pending::after {
            background: var(--warning-gradient);
        }

        .order-card.bg-paid::after {
            background: var(--success-gradient);
        }

        .order-card.bg-delivered::after {
            background: var(--info-gradient);
        }

        /* Delayed order styling - more attention-grabbing */
        .order-card.delayed {
            background-color: rgba(220, 53, 69, 0.15) !important;
            border: 1px solid var(--danger-color) !important;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.5) !important;
            animation: pulse-delay 2s infinite;
        }

        @keyframes pulse-delay {
            0% {
                box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
            }

            50% {
                box-shadow: 0 0 25px rgba(220, 53, 69, 0.7);
            }

            100% {
                box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
            }
        }

        .order-card.delayed::before {
            background: linear-gradient(to bottom, #ff0000, #cc0000) !important;
            width: 8px !important;
        }

        /* Order card components - enhanced */
        .order-card .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .order-card .order-id {
            font-size: 1.1rem;
            font-weight: 700;
            color: #222;
            letter-spacing: -0.5px;
        }

        .order-card .order-time {
            font-size: 0.85rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background-color: rgba(0, 0, 0, 0.03);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .order-card .order-details {
            margin: 0.75rem 0;
            font-size: 0.95rem;
            background-color: rgba(13, 110, 253, 0.03);
            padding: 0.75rem;
            border-radius: 10px;
        }

        /* Order items list - enhanced */
        .order-card .order-items {
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: 12px;
            padding: 0.75rem;
            margin: 0.75rem 0;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .order-card .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
            border-radius: 8px;
        }

        .order-card .order-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .order-card .order-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0.5rem;
            border-bottom: none;
        }

        /* Add subtle animation for new orders */
        .order-card.new-order {
            animation: highlight-new 2s ease-in-out;
        }

        @keyframes highlight-new {
            0% {
                box-shadow: 0 0 0 rgba(13, 110, 253, 0);
            }

            50% {
                box-shadow: 0 0 20px rgba(13, 110, 253, 0.5);
            }

            100% {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            }
        }

        /* Enhanced badge styling */
        .order-card .badge {
            padding: 0.4rem 0.6rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .order-card .badge.bg-warning,
        .order-card .badge.bg-warning-subtle {
            background: var(--warning-gradient) !important;
            color: #000 !important;
        }

        .order-card .badge.bg-success,
        .order-card .badge.bg-success-subtle {
            background: var(--success-gradient) !important;
            color: white !important;
        }

        .order-card .badge.bg-info,
        .order-card .badge.bg-info-subtle {
            background: var(--info-gradient) !important;
            color: white !important;
        }

        .order-card .badge.bg-danger,
        .order-card .badge.bg-danger-subtle {
            background: linear-gradient(135deg, #ff4d4d, #dc3545) !important;
            color: white !important;
        }

        /* Enhanced dish status indicators */
        .dish-status-indicator {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.03);
            transition: all 0.2s ease;
        }

        .dish-status-indicator:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.1);
        }

        /* Action buttons - Enhanced */
        .order-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-direction: column;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .order-actions button {
            width: 100%;
            padding: 0.75rem;
            font-size: 0.95rem;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .order-actions button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.2));
            z-index: -1;
            transition: all 0.3s ease;
        }

        .order-actions button:hover::before {
            opacity: 0.8;
        }

        .order-actions button.btn-primary {
            background: var(--header-gradient);
            border: none;
        }

        .order-actions button.btn-success {
            background: var(--success-gradient);
            border: none;
        }

        .order-actions button.btn-warning {
            background: var(--warning-gradient);
            border: none;
        }

        .order-actions button.btn-outline-danger:hover {
            background: linear-gradient(45deg, #dc3545, #ff4d5a);
            border-color: transparent;
            color: white;
        }

        .order-actions button i {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        .order-actions button:hover i {
            transform: translateY(-2px);
        }

        .order-actions button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        /* Desktop styles for larger screens - Enhanced */
        @media (min-width: 769px) {
            .order-card {
                margin-bottom: 1.5rem;
                padding: 1.5rem;
                border-radius: 20px;
                max-width: none;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
                transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            }

            .order-card:hover {
                transform: translateY(-7px);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            }

            .order-card:hover::before {
                width: 8px;
            }

            .order-card:hover::after {
                height: 6px;
            }

            .order-card::before {
                width: 6px;
            }

            .order-card::after {
                height: 5px;
            }

            .order-card .order-id {
                font-size: 1.25rem;
                letter-spacing: -0.5px;
            }

            .order-card .order-time {
                font-size: 0.95rem;
                padding: 0.3rem 0.6rem;
                border-radius: 8px;
            }

            .order-card .order-details {
                margin: 1rem 0;
                font-size: 1.05rem;
                padding: 1rem;
                border-radius: 12px;
            }

            .order-card .order-items {
                padding: 1rem;
                margin: 1rem 0;
                border-radius: 14px;
                box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.02);
            }

            .order-card .order-item {
                margin-bottom: 0.75rem;
                padding: 0.75rem;
                padding-bottom: 0.75rem;
                font-size: 1.05rem;
                border-radius: 10px;
                transition: all 0.2s ease;
            }

            .order-card .order-item:hover {
                background-color: rgba(0, 0, 0, 0.03);
                transform: translateX(3px);
            }

            /* Status badge effects */
            .order-card:hover .badge {
                transform: scale(1.05);
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }

            .order-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .order-actions button {
                transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            }

            .order-actions button:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
            }
        }

        .order-actions {
            flex-direction: row;
            justify-content: flex-end;
            margin-top: 1rem;
            gap: 0.75rem;
        }

        .order-actions button {
            width: auto;
            padding: 0.6rem 1.25rem;
            font-size: 0.95rem;
            border-radius: 12px;
        }

        /* Desktop hover effects */
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .order-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {

            /* Mobile kitchen list styles */
            #mobileKitchenList {
                padding: 0.5rem !important;
            }

            #mobileKitchenList .kitchen-item {
                margin-bottom: 0.5rem;
            }

            /* Mobile order card styles - Enhanced */
            .order-card {
                margin-bottom: 1rem;
                width: 100%;
                max-width: 100%;
                border-radius: 16px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            }

            .order-card .card-body {
                padding: 0.85rem;
            }

            .order-card .order-header {
                margin-bottom: 0.6rem;
                padding-bottom: 0.6rem;
            }

            .order-card .order-details {
                margin: 0.6rem 0;
                padding: 0.7rem;
                border-radius: 10px;
            }

            .order-card .order-details .d-flex {
                margin-bottom: 0.5rem !important;
                padding: 0.3rem;
                border-radius: 6px;
                transition: background-color 0.2s ease;
            }

            .order-card .order-details .d-flex:active {
                background-color: rgba(0, 0, 0, 0.02);
            }

            .order-card .order-details .d-flex i {
                font-size: 1.1rem;
                color: var(--primary-color);
            }

            .order-card .order-items {
                padding: 0.6rem;
                margin: 0.6rem 0;
                border-radius: 10px;
                background-color: rgba(0, 0, 0, 0.02);
                border: 1px solid rgba(0, 0, 0, 0.04);
            }

            .order-card .order-item {
                margin-bottom: 0.5rem;
                padding: 0.5rem;
                padding-bottom: 0.5rem;
                border-radius: 8px;
                transition: background-color 0.2s ease;
            }

            .order-card .order-item:active {
                background-color: rgba(0, 0, 0, 0.03);
            }

            .order-card .d-flex.justify-content-between.align-items-center.mt-3.mb-3 {
                margin-top: 0.6rem !important;
                margin-bottom: 0.6rem !important;
                padding: 0.5rem;
                background-color: rgba(25, 135, 84, 0.05);
                border-radius: 8px;
            }

            .order-card .fw-bold.fs-5 {
                font-size: 1.1rem !important;
                color: #222;
            }

            .order-actions {
                margin-top: 0.5rem;
                gap: 0.4rem;
            }

            .order-actions .mb-3 {
                margin-bottom: 0.4rem !important;
            }

            .order-actions .form-label {
                margin-bottom: 0.2rem;
                font-size: 0.85rem;
            }

            .order-actions button {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            /* Swipe actions for order cards - Enhanced */
            .order-card-swipe-container {
                position: relative;
                overflow: hidden;
                touch-action: pan-y;
                border-radius: 16px;
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
            }

            .order-card-swipe-container:active {
                transform: scale(0.98);
            }

            .order-card-swipe-actions {
                position: absolute;
                top: 0;
                right: 0;
                height: 100%;
                display: flex;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                border-top-right-radius: 16px;
                border-bottom-right-radius: 16px;
                overflow: hidden;
                box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            }

            .swipe-action-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 80px;
                height: 100%;
                color: white;
                font-size: 1.3rem;
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }

            .swipe-action-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.2));
                opacity: 0;
                transition: opacity 0.2s ease;
            }

            .swipe-action-btn:active::before {
                opacity: 1;
            }

            .swipe-action-complete {
                background: var(--success-gradient);
            }

            .swipe-action-delete {
                background: linear-gradient(135deg, #ff4d4d, #dc3545);
            }

            .swipe-action-btn i {
                transform: scale(1);
                transition: transform 0.2s ease;
            }

            .swipe-action-btn:active i {
                transform: scale(1.2);
            }
        }

        /* Status and Delay Badges - Mobile First */
        .status-badge,
        .delay-badge {
            position: absolute;
            top: 0.5rem;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            right: 0.5rem;
        }

        .delay-badge {
            left: 0.5rem;
            animation: pulse 1.5s infinite;
            /* Faster pulsing */
            background-color: #ff0000 !important;
            /* Bright red background */
            color: white !important;
            /* White text for better contrast */
            font-weight: 700 !important;
            /* Bolder text */
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.7) !important;
            /* Red glow effect */
        }

        /* Desktop styles for larger screens */
        @media (min-width: 769px) {

            .status-badge,
            .delay-badge {
                top: 1rem;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.875rem;
            }

            .status-badge {
                right: 1rem;
            }

            .delay-badge {
                left: 1rem;
            }
        }

        /* Kitchen Item Styles - Mobile First */
        .kitchen-item {
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            border-left: 4px solid #6c757d;
            background: white;
            margin-bottom: 0.6rem;
            transition: all var(--transition-speed) var(--ease-out);
            background: linear-gradient(to right, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.8));
            width: 100%;
            max-width: 100%;
        }

        /* Delayed kitchen item styling */
        .kitchen-item.delayed {
            background: linear-gradient(to right, rgba(220, 53, 69, 0.3), rgba(220, 53, 69, 0.15)) !important;
            /* Stronger red gradient */
            border: 1px solid var(--danger-color) !important;
            border-left: 6px solid #ff0000 !important;
            /* Brighter and thicker left border */
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.4) !important;
            /* Red glow effect */
        }

        .kitchen-item .card-body {
            padding: 0.6rem;
        }

        .kitchen-item h5 {
            font-size: 1rem;
        }

        .kitchen-item .badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }

        .kitchen-item .mt-3 {
            margin-top: 0.6rem !important;
        }

        .kitchen-item .mt-2 {
            margin-top: 0.4rem !important;
        }

        /* Desktop styles for larger screens */
        @media (min-width: 769px) {
            .kitchen-item {
                border-radius: var(--card-border-radius);
                margin-bottom: 1rem;
                border-left: 5px solid #6c757d;
                max-width: none;
            }

            .kitchen-item.delayed {
                border-left: 8px solid #ff0000 !important;
            }

            .kitchen-item .card-body {
                padding: 1.25rem;
            }

            .kitchen-item h5 {
                font-size: 1.25rem;
            }

            .kitchen-item .badge {
                font-size: 0.875rem;
                padding: 0.4rem 0.8rem;
            }

            .kitchen-item .mt-3 {
                margin-top: 1rem !important;
            }

            .kitchen-item .mt-2 {
                margin-top: 0.5rem !important;
            }

            .kitchen-item:hover {
                transform: translateY(-4px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            }

            /* Desktop legend styling */
            #kitchenList .alert.alert-dark {
                margin-bottom: 1rem !important;
                padding: 0.75rem !important;
            }

            #kitchenList .alert.alert-dark h6 {
                font-size: 1rem !important;
            }

            #kitchenList .alert.alert-dark .mb-1 {
                margin-bottom: 0.5rem !important;
            }

            #kitchenList .alert.alert-dark .d-flex.flex-wrap {
                gap: 0.5rem !important;
                font-size: 0.9rem !important;
            }

            #kitchenList .alert.alert-dark .badge {
                padding: 0.4rem 0.8rem;
            }
        }

        /* Store Selector Styling */
        .store-selector {
            border: 2px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .store-selector:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.4);
            border-color: var(--primary-color);
        }

        .store-name {
            color: var(--primary-color);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Status Colors */
        .bg-pending {
            border-left-color: var(--warning-color);
            background-color: rgba(255, 193, 7, 0.05);
        }

        .bg-paid {
            border-left-color: var(--success-color);
            background-color: rgba(25, 135, 84, 0.05);
        }

        .bg-delivered {
            border-left-color: var(--info-color);
            background-color: rgba(13, 202, 240, 0.05);
        }

        /* Animations */
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
            }

            50% {
                opacity: 0.9;
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
            }

            100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        /* Mobile-First Responsive Styles */
        /* Small devices (phones, 576px and down) */
        @media (max-width: 576px) {
            body {
                font-size: 14px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .container-fluid {
                padding: 0.5rem;
                max-width: 100%;
                overflow-x: hidden;
            }

            /* Increase touch targets for better mobile usability */
            button,
            .btn,
            select,
            input,
            a {
                min-height: 44px;
                min-width: 44px;
            }

            /* Adjust card styles for mobile */
            .card {
                margin-bottom: 0.75rem;
                border-radius: 10px;
            }

            .card:hover {
                transform: none;
                /* Remove hover effects on mobile */
            }

            .card-header {
                padding: 0.75rem;
            }

            .card-body {
                padding: 0.75rem;
            }

            /* Order card specific styles */
            .order-card {
                margin-bottom: 0.5rem;
                padding: 0.75rem;
                border-radius: 8px;
            }

            .order-card:hover {
                transform: none;
                /* Remove hover effects on mobile */
                box-shadow: var(--card-shadow);
            }

            /* Make buttons more touch-friendly */
            .order-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
                margin-top: 0.75rem;
            }

            .order-actions button {
                width: 100%;
                padding: 0.75rem;
                font-size: 1rem;
                margin: 0.25rem 0;
                border-radius: 8px;
            }

            /* Adjust badges for mobile */
            .status-badge,
            .delay-badge {
                top: 0.5rem;
                padding: 0.3rem 0.8rem;
                font-size: 0.85rem;
                border-radius: 15px;
            }

            /* Form controls for better touch */
            .form-select,
            .form-control {
                font-size: 1rem;
                padding: 0.75rem;
                border-radius: 8px;
                height: auto;
            }

            /* Summary cards */
            .summary-card {
                margin-bottom: 0.75rem;
                padding: 0.75rem;
            }

            .summary-card:hover {
                transform: none;
                /* Remove hover effects on mobile */
            }

            .summary-card h3 {
                font-size: 1.5rem;
            }

            /* Modal adjustments */
            .modal-content {
                border-radius: 12px;
                margin: 0.5rem;
            }

            .modal-header {
                padding: 0.75rem;
                border-bottom: 2px solid var(--light-color);
            }

            .modal-body {
                padding: 0.75rem;
            }

            .modal-footer {
                padding: 0.75rem;
                border-top: 2px solid var(--light-color);
            }

            /* Kitchen badge adjustments */
            .kitchen-badge {
                padding: 0.4rem 0.6rem;
                margin: 0.25rem;
                font-size: 0.85rem;
            }

            /* Dish status indicator */
            .dish-status-indicator {
                width: 32px;
                height: 32px;
            }
        }

        /* Medium devices (tablets, 768px and down) */
        @media (min-width: 577px) and (max-width: 768px) {
            .container-fluid {
                padding: 0.75rem;
            }

            .card {
                margin-bottom: 1rem;
            }

            .order-card {
                margin-bottom: 0.75rem;
                padding: 1rem;
            }

            .order-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .order-actions button {
                width: 100%;
                margin: 0.25rem 0;
            }

            .summary-card h3 {
                font-size: 1.75rem;
            }
        }

        /* Disable hover effects on touch devices */
        @media (hover: none) {

            .card:hover,
            .order-card:hover,
            .kitchen-item:hover,
            .summary-card:hover,
            .dish-status-indicator:hover {
                transform: none;
                box-shadow: var(--card-shadow);
            }
        }

        /* Form Styles */
        .form-control,
        .form-select {
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1rem;
            transition: all var(--transition-speed) var(--ease-in-out);
            border: 2px solid var(--light-color);
            background: rgba(255, 255, 255, 0.95);
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .kitchen-badge.active {
            transform: scale(1.15);
            box-shadow: 0 0 0 2px #fff, 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 10;
        }

        /* Kitchen badge colors */
        .kitchen-badge[data-portion="half"] {
            background-color: #6f42c1;
            /* Purple for half portions */
        }

        .kitchen-badge[data-portion="full"] {
            background-color: #fd7e14;
            /* Orange for full portions */
        }

        /* Delay comparison row active state */
        .delay-comparison-row {
            transition: all 0.2s ease;
        }

        .delay-comparison-row:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .delay-comparison-row.active {
            box-shadow: inset 0 0 0 2px #0dcaf0;
            position: relative;
            z-index: 2;
        }

        /* Search results count styling */
        #searchResultsCount {
            font-weight: bold;
        }

        /* Search highlight for matching text */
        .search-highlight {
            background-color: rgba(255, 193, 7, 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Summary section styles - Modern Mobile First */
        .summary-card {
            transition: all 0.3s var(--ease-out);
            border: none;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
            background: white;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--primary-color);
            opacity: 0.8;
        }

        .summary-card.total-card::before {
            background: linear-gradient(to right, #6610f2, #0d6efd);
        }

        .summary-card.pending-card::before {
            background: linear-gradient(to right, #fd7e14, #ffc107);
        }

        .summary-card.paid-card::before {
            background: linear-gradient(to right, #20c997, #198754);
        }

        .summary-card.delivered-card::before {
            background: linear-gradient(to right, #0dcaf0, #0d6efd);
        }

        .summary-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #333, #555);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: none;
        }

        .summary-card .card-body {
            padding: 1.25rem;
            border-radius: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px;
        }

        .summary-card .card-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .summary-card .card-title i {
            font-size: 1.25rem;
        }

        .summary-card .badge {
            border-radius: 12px;
            padding: 0.5rem 0.75rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            margin: 0.25rem;
            transition: all 0.2s ease;
        }

        .summary-card .badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Desktop styles for larger screens */
        @media (min-width: 769px) {
            .summary-card {
                border-radius: 24px;
                margin-bottom: 1.5rem;
            }

            .summary-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
            }

            .summary-card h3 {
                font-size: 2.5rem;
            }

            .summary-card .card-body {
                padding: 1.75rem;
                border-radius: 24px;
                min-height: 180px;
            }

            .summary-card .card-title {
                margin-bottom: 1.25rem;
                font-size: 1.2rem;
            }

            .summary-card .badge {
                border-radius: 16px;
                padding: 0.6rem 1rem;
                font-size: 1rem;
            }
        }

        /* Mobile-specific summary card styles */
        @media (max-width: 768px) {
            .summary-card {
                margin-bottom: 1rem;
            }

            .summary-card .card-body {
                padding: 1rem;
                min-height: 130px;
            }

            .summary-card h3 {
                font-size: 1.75rem;
            }

            /* Swipe effect for summary cards on mobile */
            .summary-cards-container {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                /* Firefox */
                padding: 0.5rem 0;
                margin: 0 -0.75rem;
                padding: 0 0.75rem;
            }

            .summary-cards-container::-webkit-scrollbar {
                display: none;
                /* Chrome, Safari, Opera */
            }

            .summary-cards-container .col-md-3 {
                min-width: 85%;
                scroll-snap-align: center;
                padding: 0 0.5rem;
            }

            /* Scroll indicator dots */
            .scroll-indicator {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                margin: 1rem 0;
            }

            .scroll-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #ddd;
                transition: all 0.3s ease;
            }

            .scroll-dot.active {
                background-color: var(--primary-color);
                transform: scale(1.3);
            }
        }

        /* Dish status indicator styles - Mobile First */
        .dish-status-indicator {
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.05);
            margin: 0.25rem;
        }

        .dish-status-indicator .bi-check-all {
            color: #198754 !important;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .dish-status-indicator .bi-circle {
            color: #6c757d;
            font-size: 1.1rem;
        }

        /* Kitchen badge styles - Mobile First */
        .kitchen-badge {
            padding: 0.4rem 0.6rem;
            border-radius: 15px;
            transition: all 0.2s ease;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 0.25rem;
            font-size: 0.85rem;
            display: inline-block;
        }

        /* Desktop styles for larger screens */
        @media (min-width: 769px) {
            .dish-status-indicator {
                width: 24px;
                height: 24px;
            }

            .dish-status-indicator:hover {
                transform: scale(1.2);
                background-color: rgba(0, 0, 0, 0.1);
            }

            .dish-status-indicator .bi-check-all,
            .dish-status-indicator .bi-circle {
                font-size: 1rem;
            }

            .kitchen-badge {
                padding: 0.5rem 0.8rem;
                border-radius: 20px;
                font-size: 0.9rem;
            }

            /* Hide mobile bottom nav on desktop */
            .mobile-bottom-nav {
                display: none;
            }
        }

        /* Mobile Bottom Navigation - Modern Design */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background-color: white;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            /* Higher than sticky elements but lower than FAB */
            padding: 0.25rem;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .mobile-bottom-nav .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
            color: #6c757d;
            text-decoration: none;
            padding: 0.5rem;
            transition: all 0.3s var(--ease-out);
            position: relative;
            border-radius: 12px;
            margin: 0 2px;
        }

        .mobile-bottom-nav .nav-item.active {
            color: var(--primary-color);
            background-color: rgba(13, 110, 253, 0.08);
            transform: translateY(-4px);
        }

        .mobile-bottom-nav .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }

        .mobile-bottom-nav .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            transition: transform 0.2s ease;
        }

        .mobile-bottom-nav .nav-item.active i {
            transform: scale(1.1);
        }

        .mobile-bottom-nav .nav-item span {
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        /* Tab content containers */
        #home-content,
        #summary-content,
        #completed-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Global body styles */
        body {
            background-color: var(--background-color);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: #333;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }

        /* Add padding to the bottom of the page to account for the fixed nav */
        @media (max-width: 768px) {
            body {
                padding-bottom: calc(var(--bottom-nav-height) + 1rem);
                background-color: var(--background-color);
            }

            /* Floating action button for mobile - Modern Design */
            .mobile-fab {
                position: fixed;
                bottom: calc(var(--bottom-nav-height) + 1rem);
                right: 1rem;
                width: 60px;
                height: 60px;
                border-radius: 30px;
                background: var(--primary-color);
                background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 20px rgba(13, 110, 253, 0.4);
                z-index: 9999;
                /* Increased z-index to ensure it stays on top */
                border: none;
                font-size: 1.5rem;
                transition: all 0.3s var(--ease-out);
            }

            .mobile-fab:active {
                transform: scale(0.92);
                box-shadow: 0 2px 10px rgba(13, 110, 253, 0.3);
            }

            .mobile-fab i {
                filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
            }

            /* Improved container spacing for mobile */
            .container-fluid {
                padding: 0.75rem;
                padding-bottom: calc(var(--bottom-nav-height) + 1.5rem);
            }

            /* Improved card styles for mobile */
            .card {
                border-radius: var(--card-border-radius);
                box-shadow: var(--card-shadow);
                border: none;
                overflow: hidden;
                margin-bottom: 1rem;
            }

            /* Improved section headers for mobile */
            .section-header {
                font-size: 1.5rem;
                font-weight: 700;
                margin-bottom: 1rem;
                color: #333;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .section-header i {
                color: var(--primary-color);
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-3">
            <!-- Mobile Tab Content -->
        <div id="home-content">
            <!-- Mobile Search Bar Removed - Now using unified search bar above pending orders list -->

            <!-- Store Selection Dropdown - Mobile -->
            <div class="d-flex justify-content-between align-items-center mb-3 d-md-none">
                <h2 class="section-header mb-0">
                    <i class="bi bi-shop"></i> <span id="storeName-mobile" class="store-name"></span>
                </h2>
                <div class="d-flex gap-2">
                    <select class="form-select store-selector" style="width: auto;" id="storeSelector-mobile"
                        onchange="changeStore(this.value, 'storeSelector-mobile')">
                        <option value="">Select Store</option>
                        <option value="samriddhi">Samriddhi</option>
                        <option value="eros">Eros</option>
                    </select>
                </div>
            </div>

            <!-- Mobile Date Picker -->
            <div class="d-flex justify-content-between align-items-center mb-3 d-md-none">
                <div class="input-group" style="max-width: 200px;">
                    <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                    <input type="date" class="form-control" id="orderDatePicker-mobile" value=""
                        onchange="handleDateChange(this.value)">
                </div>
                <button class="btn btn-outline-secondary btn-sm" onclick="resetDate()">
                    <i class="bi bi-arrow-counterclockwise"></i> Today
                </button>
            </div>

            <!-- Mobile Quick Stats -->
            <div class="d-flex justify-content-between align-items-center mb-3 d-md-none">
                <h2 class="section-header mb-0"><i class="bi bi-hourglass-split"></i> Pending</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm rounded-circle" style="width: 38px; height: 38px;"
                        onclick="loadOrders()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm rounded-circle"
                        style="width: 38px; height: 38px; background: var(--warning-gradient); color: white;">
                        <span id="pendingOrdersCount-mobile">0</span>
                    </button>
                </div>
            </div>

            <!-- Mobile Historical Date Indicator -->
            <div class="alert alert-warning mb-3 historical-date-indicator d-none d-md-none">
                <i class="bi bi-clock-history me-2"></i><span></span>
            </div>

            <!-- Mobile Kitchen List (Priority) -->
            <div class="d-md-none mb-3">
                <div class="card" style="border-radius: 12px;">
                    <div class="card-header text-white d-flex justify-content-between align-items-center p-2"
                        style="background: linear-gradient(135deg, #e83e8c 0%, #fd7e14 100%); border-radius: 12px 12px 0 0;">
                        <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-fire"></i> Priority Cooking</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-1 p-1" style="min-height: 30px;"
                                onclick="speakKitchenList()" title="Narrate cooking list">
                                <i class="bi bi-volume-up"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light p-1" style="min-height: 30px;"
                                onclick="toggleSection('mobileKitchenList')">
                                <i class="bi bi-chevron-down" id="kitchenListToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0" id="mobileKitchenList">
                        <div id="kitchenListMobile"></div>
                    </div>
                </div>
            </div>

            <!-- Desktop Header -->
            <div class="d-none d-md-flex justify-content-between align-items-center mb-4">
                <div>
                    <div class="d-flex align-items-center gap-3 mb-2">
                        <h2><i class="bi bi-shop"></i> <span id="storeName-desktop" class="store-name"></span></h2>
                        <select class="form-select store-selector" style="width: auto;" id="storeSelector-desktop"
                            onchange="changeStore(this.value, 'storeSelector-desktop')">
                            <option value="">Select Store</option>
                            <option value="samriddhi">Samriddhi</option>
                            <option value="eros">Eros</option>
                        </select>
                    </div>
                    <h3>Pending Orders</h3>
                    <small class="text-muted"><i class="bi bi-sort-down"></i> Orders sorted by delay level (most delayed
                        first)</small>
                    <div class="alert alert-warning mt-2 historical-date-indicator d-none">
                        <i class="bi bi-clock-history me-2"></i><span></span>
                    </div>
                </div>
                <div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="input-group me-2" style="width: auto;">
                            <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                            <input type="date" class="form-control" id="orderDatePicker" value=""
                                onchange="handleDateChange(this.value)">
                        </div>
                        <button class="btn btn-outline-secondary me-2" id="resetDateBtn" onclick="resetDate()">
                            <i class="bi bi-arrow-counterclockwise"></i> Today
                        </button>
                    </div>
                    <div>
                        <a href="analytics.html" class="btn btn-info me-2" target="_blank">
                            <i class="bi bi-calculator"></i> Analytics
                        </a>
                        <button id="newOrderBtn" class="btn btn-success me-2" data-bs-toggle="modal"
                            data-bs-target="#addOrderModal">
                            <i class="bi bi-plus-circle"></i> Add Order
                        </button>
                        <button class="btn btn-primary me-2" onclick="loadOrders()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-success btn-circle me-2" data-bs-toggle="modal" data-bs-target="#qrCodeModal" title="QR Code">
                            <i class="bi bi-qr-code-scan"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Desktop Search Bar Removed - Now using unified search bar above pending orders list -->

            <div class="row">
                <!-- Main Content Column -->
                <div class="col-md-8">
                    <!-- Delay Comparison (hidden on mobile, shown in Summary tab) -->
                    <div id="delayComparisonContainer" class="mb-4 d-none d-md-block">
                        <div class="card">
                            <div class="card-header bg-orange text-white d-flex justify-content-between align-items-center"
                                style="background-color: #fd7e14;">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Order Delay Comparison</h5>
                                <div>
                                    <button class="btn btn-sm btn-light me-2" onclick="showDelayComparison()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="delayComparisonTable"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Bar Above Pending Orders (visible on both mobile and desktop) -->
                    <div class="card mb-3">
                        <div class="card-body p-2">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="pendingOrdersSearchInput"
                                    placeholder="Search pending orders by phone or comments...">
                                <button class="btn btn-outline-secondary d-none d-md-block" type="button"
                                    id="clearPendingSearchBtn">
                                    <i class="bi bi-x-circle"></i> Clear
                                </button>
                                <button class="btn btn-outline-secondary d-md-none" type="button"
                                    id="clearPendingSearchBtn-mobile">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                            <div class="form-text mt-2 d-none d-md-block">
                                <span id="pendingSearchResultsCount">0</span> pending orders found
                            </div>
                        </div>
                    </div>

                    <!-- Pending Orders List -->
                    <div id="pendingOrdersList" class="row"></div>
                </div>

                <!-- Kitchen List Column (Desktop Only) -->
                <div class="col-md-4 d-none d-md-block">
                    <div class="card sticky-top" style="top: 20px; z-index: 10;">
                        <div class="card-header text-white d-flex justify-content-between align-items-center"
                            style="background: linear-gradient(135deg, #e83e8c 0%, #fd7e14 100%);">
                            <div>
                                <h5 class="mb-0"><i class="bi bi-fire"></i> Priority Cooking List</h5>
                                <small class="text-light"><i class="bi bi-sort-down"></i> Sorted by delay level (most
                                    delayed first)</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-light me-1" onclick="speakKitchenList()"
                                    style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);" title="Narrate cooking list">
                                    <i class="bi bi-volume-up"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light me-1" onclick="renderKitchenList()"
                                    style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="kitchenList"></div>
                    </div>
                </div>
            </div>

            <!-- Mobile Kitchen List moved to top -->
        </div>

        <!-- SUMMARY TAB: Dashboard and Analytics -->
        <div id="summary-content">
            <h2 class="section-header mb-3"><i class="bi bi-graph-up"></i> <span id="cartNameHeader">Orders
                    Summary</span></h2>

            <!-- Summary Cards - Swipeable on Mobile -->
            <div class="summary-cards-container row d-md-flex">
                <div class="col-md-3 mb-3">
                    <div class="card summary-card h-100 total-card">
                        <div class="card-body text-center">
                            <h6 class="card-title"><i class="bi bi-calendar-check"></i> Total Orders</h6>
                            <h3 id="totalOrdersCount" class="mb-0">0</h3>
                            <div class="d-flex justify-content-center align-items-center mt-3">
                                <span class="badge bg-primary">Total Sale: <span id="totalSalesAmount">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card summary-card h-100 pending-card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-dark"><i class="bi bi-hourglass-split"></i> Pending Orders</h6>
                            <h3 id="pendingOrdersCount" class="mb-0 text-dark">0</h3>
                            <div class="d-flex justify-content-center align-items-center mt-3">
                                <span class="badge" style="background-color: #fd7e14;">Value: <span
                                        id="pendingOrdersTotal">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card summary-card h-100 paid-card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-dark"><i class="bi bi-cash-coin"></i> Paid Orders</h6>
                            <h3 id="paidOrdersCount" class="mb-0 text-dark">0</h3>
                            <div class="d-flex justify-content-between mt-3">
                                <span class="badge bg-success"><i class="bi bi-cash"></i> Cash: <span
                                        id="cashPaymentsTotal">0</span></span>
                                <span class="badge bg-success"><i class="bi bi-credit-card"></i> Online: <span
                                        id="onlinePaymentsTotal">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card summary-card h-100 delivered-card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-dark"><i class="bi bi-truck"></i> Delivered (Unpaid)</h6>
                            <h3 id="deliveredUnpaidCount" class="mb-0 text-dark">0</h3>
                            <div class="d-flex justify-content-center align-items-center mt-3">
                                <span class="badge bg-info text-dark">Value: <span
                                        id="deliveredUnpaidTotal">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scroll indicator dots for mobile -->
            <div class="scroll-indicator d-md-none">
                <div class="scroll-dot active"></div>
                <div class="scroll-dot"></div>
                <div class="scroll-dot"></div>
                <div class="scroll-dot"></div>
            </div>

            <!-- Order Delay Comparison (Mobile) -->
            <div class="card mb-4 mt-4">
                <div class="card-header text-white d-flex justify-content-between align-items-center"
                    style="background: var(--warning-gradient);">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Order Delays</h5>
                    <div>
                        <button class="btn btn-sm btn-light me-2" onclick="showDelayComparison()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleSection('mobileDelaySection')">
                            <i class="bi bi-chevron-down" id="delayToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-2" id="mobileDelaySection" style="display: none;">
                    <div id="delayComparisonTableMobile"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button class="btn btn-primary flex-grow-1" onclick="loadOrders()">
                    <i class="bi bi-arrow-clockwise me-2"></i> Refresh Data
                </button>
                <button class="btn btn-success rounded-circle p-2" data-bs-toggle="modal" data-bs-target="#qrCodeModal" title="QR Code">
                    <i class="bi bi-qr-code-scan fs-5"></i>
                </button>
            </div>
        </div>

        <!-- COMPLETED TAB: Paid and Delivered Orders -->
        <div id="completed-content">
            <h2 class="section-header mb-3"><i class="bi bi-check-circle"></i> Completed Orders</h2>

            <!-- Paid Orders Section -->
            <div class="card mb-4">
                <div class="card-header text-white d-flex justify-content-between align-items-center"
                    style="background: var(--success-gradient);">
                    <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Paid Orders</h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2">
                            <span id="paidOrdersCount-badge">0</span> Orders
                        </span>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleSection('paidOrdersSection')">
                            <i class="bi bi-chevron-down" id="paidOrdersToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="paidOrdersSection" style="display: none;">
                    <div id="paidOrdersList" class="row"></div>
                </div>
            </div>

            <!-- Delivered Orders Section -->
            <div class="card mb-4">
                <div class="card-header text-white d-flex justify-content-between align-items-center"
                    style="background: var(--info-gradient);">
                    <h5 class="mb-0"><i class="bi bi-truck"></i> Delivered Orders (Pending)</h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2">
                            <span id="deliveredOrdersCount-badge">0</span> Orders
                        </span>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleSection('deliveredOrdersSection')">
                            <i class="bi bi-chevron-down" id="deliveredOrdersToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="deliveredOrdersSection" style="display: none;">
                    <div id="deliveredOrdersList" class="row"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button class="btn btn-primary flex-grow-1" onclick="loadOrders()">
                    <i class="bi bi-arrow-clockwise me-2"></i> Refresh Data
                </button>
                <button class="btn btn-success rounded-circle p-2" data-bs-toggle="modal" data-bs-target="#qrCodeModal" title="Scan QR Code">
                    <i class="bi bi-qr-code-scan fs-5"></i>
                </button>
            </div>
        </div>

        <!-- Desktop Layout (Original) -->
        <div class="d-none d-md-block">
            <!-- Order Summary Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header text-white d-flex justify-content-between align-items-center"
                            style="background: var(--header-gradient);">
                            <h5 class="mb-0"><i class="bi bi-graph-up"></i> <span id="cartNameHeader-desktop"
                                    style="margin-left: 5px;">Orders Summary</span></h5>
                            <button class="btn btn-sm btn-outline-light" onclick="loadOrders()"
                                style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Summary Cards for Desktop -->
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="card summary-card h-100 total-card">
                                        <div class="card-body text-center">
                                            <h6 class="card-title"><i class="bi bi-calendar-check"></i> Total Orders
                                            </h6>
                                            <h3 id="totalOrdersCount-desktop" class="mb-0">0</h3>
                                            <div class="d-flex justify-content-center align-items-center mt-3">
                                                <span class="badge bg-primary">Total Sale: <span
                                                        id="totalSalesAmount-desktop">0</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card summary-card h-100 pending-card">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-dark"><i class="bi bi-hourglass-split"></i>
                                                Pending Orders</h6>
                                            <h3 id="pendingOrdersCount-desktop" class="mb-0 text-dark">0</h3>
                                            <div class="d-flex justify-content-center align-items-center mt-3">
                                                <span class="badge" style="background-color: #fd7e14;">Value: <span
                                                        id="pendingOrdersTotal-desktop">0</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card summary-card h-100 paid-card">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-dark"><i class="bi bi-cash-coin"></i> Paid Orders
                                            </h6>
                                            <h3 id="paidOrdersCount-desktop" class="mb-0 text-dark">0</h3>
                                            <div class="d-flex justify-content-between mt-3">
                                                <span class="badge bg-success"><i class="bi bi-cash"></i> Cash: <span
                                                        id="cashPaymentsTotal-desktop">0</span></span>
                                                <span class="badge bg-success"><i class="bi bi-credit-card"></i> Online:
                                                    <span id="onlinePaymentsTotal-desktop">0</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card summary-card h-100 delivered-card">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-dark"><i class="bi bi-truck"></i> Delivered
                                                (Unpaid)</h6>
                                            <h3 id="deliveredUnpaidCount-desktop" class="mb-0 text-dark">0</h3>
                                            <div class="d-flex justify-content-center align-items-center mt-3">
                                                <span class="badge bg-info text-dark">Value: <span
                                                        id="deliveredUnpaidTotal-desktop">0</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Orders Sections -->
            <div class="row mt-4">
                <!-- Paid Orders Section -->
                <div class="col-md-6">
                    <div class="card">
                        <div
                            class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Paid Orders</h5>
                            <button class="btn btn-sm btn-outline-light"
                                onclick="toggleSection('paidOrdersSection-desktop')">
                                <i class="bi bi-chevron-down" id="paidOrdersToggleIcon-desktop"></i>
                            </button>
                        </div>
                        <div class="card-body" id="paidOrdersSection-desktop" style="display: none;">
                            <div id="paidOrdersList-desktop" class="row"></div>
                        </div>
                    </div>
                </div>

                <!-- Delivered Orders Section -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header text-white d-flex justify-content-between align-items-center"
                            style="background: linear-gradient(135deg, #20c997 0%, #0dcaf0 100%);">
                            <h5 class="mb-0"><i class="bi bi-truck"></i> Delivered Orders (Pending)</h5>
                            <button class="btn btn-sm btn-outline-light"
                                onclick="toggleSection('deliveredOrdersSection-desktop')">
                                <i class="bi bi-chevron-down" id="deliveredOrdersToggleIcon-desktop"></i>
                            </button>
                        </div>
                        <div class="card-body" id="deliveredOrdersSection-desktop">
                            <div id="deliveredOrdersList-desktop" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addOrderForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addOrderModalLabel">Add Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Customer Phone</label>
                            <input type="tel" class="form-control" id="customerPhone"
                                placeholder="Enter phone number (optional)">
                        </div>
                        <div class="mb-3">
                            <label for="customerComments" class="form-label">Customer Comments</label>
                            <textarea class="form-control" id="customerComments"
                                placeholder="Enter vehicle or house info (optional)"></textarea>
                        </div>
                        <div id="orderItemsContainer">
                            <!-- Order items will be added here -->
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button type="button" class="btn btn-secondary" id="addOrderItemBtn">Add Menu Item</button>
                            <button type="button" class="btn btn-info" id="addCustomOrderItemBtn">Add Custom
                                Item</button>
                        </div>
                        <div class="mb-3">
                            <strong>Total: <span id="orderTotal">0</span></strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="saveOrderBtn" data-bs-dismiss="modal">Save
                            Order</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editOrderForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editOrderModalLabel">Edit Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">Customer Phone</label>
                            <input type="tel" class="form-control" id="editCustomerPhone"
                                placeholder="Enter phone number (optional)">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerComments" class="form-label">Customer Comments</label>
                            <textarea class="form-control" id="editCustomerComments"
                                placeholder="Enter vehicle or house info (optional)"></textarea>
                        </div>
                        <div id="editOrderItemsContainer">
                            <!-- Edit order items will be added here -->
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button type="button" class="btn btn-secondary" id="editAddOrderItemBtn">Add Menu
                                Item</button>
                            <button type="button" class="btn btn-info" id="editAddCustomOrderItemBtn">Add Custom
                                Item</button>
                        </div>
                        <div class="mb-3">
                            <strong>Total: <span id="editOrderTotal">0</span></strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Update Order</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="vehicleModal" tabindex="-1" aria-labelledby="vehicleModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vehicleModalLabel">Vehicle Number</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="vehicleNumberInput" class="form-control" placeholder="Enter vehicle number">
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveVehicleNumberBtn" class="btn btn-primary">Save Vehicle Number</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="delayAlertModal" tabindex="-1" aria-labelledby="delayAlertModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="delayAlertModalLabel">Delay Alert</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body" id="delayAlertContent">
                    <!-- Delay alert content will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="sendDelayMessage()">Send WhatsApp
                        Message</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration and Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyAEKHWdRyzI8WyBeGeesjDrM-nEzOXCuNk",
            authDomain: "billion1-a9324.firebaseapp.com",
            projectId: "billion1-a9324",
            storageBucket: "billion1-a9324.appspot.com",
            messagingSenderId: "443716692865",
            appId: "1:443716692865:web:96813fe32a44f8342cd680",
            measurementId: "G-FE7NFHY5PG"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Application State 
        let state = {
            currentOrders: [],
            filteredOrders: [],
            searchQuery: '',
            editingOrderId: null,
            vehicleOrderId: null,
            alertedOrders: new Set(),
            currentDelayOrder: null,
            cartName: cartName,
            cartTitle: cartTitle,
            /* COMMENTED OUT - OLD MENU ITEMS (Now using centralized menu.json)
            menuItems: {
                1: {
                    name: "Seekh Kebab",
                    portions: {
                        half: { name: "HALF", price: 109, pieces: 2 },
                        full: { name: "FULL", price: 209, pieces: 4 },
                    },
                    rawMaterial: "keema",
                    gramsPerPiece: 50
                },
                2: {
                    name: "Chicken Tikka",
                    portions: {
                        half: { name: "HALF", price: 149, pieces: 4 },
                        full: { name: "FULL", price: 289, pieces: 8 },
                    },
                    rawMaterial: "tikka",
                    gramsPerPiece: 23.25 // 1kg = 43 pieces, so ~23.25g per piece
                },
                3: {
                    name: "Afghani Chicken Tikka",
                    portions: {
                        half: { name: "HALF", price: 169, pieces: 4 },
                        full: { name: "FULL", price: 329, pieces: 8 },
                    },
                    rawMaterial: "tikka",
                    gramsPerPiece: 23.25
                },
                4: {
                    name: "Tandoori Chicken",
                    portions: {
                        half: { name: "HALF", price: 169, pieces: 4 },
                        full: { name: "FULL", price: 329, pieces: 8 },
                    },
                    rawMaterial: "baccha",
                    gramsPerPiece: 125 // 1kg = 8 pieces, so 125g per piece
                },
                5: {
                    name: "Afghani Chicken",
                    portions: {
                        half: { name: "HALF", price: 199, pieces: 4 },
                        full: { name: "FULL", price: 389, pieces: 8 },
                    },
                    rawMaterial: "baccha",
                    gramsPerPiece: 125
                },
                6: {
                    name: "Chicken Wings",
                    portions: {
                        half: { name: "HALF", price: 129, pieces: 8 },
                        full: { name: "FULL", price: 249, pieces: 16 },
                    },
                    rawMaterial: "wings",
                    gramsPerPiece: 62.5 // 1kg = 16 pieces, so 62.5g per piece
                },
                7: {
                    name: "Chicken Tangdi",
                    portions: {
                        half: { name: "HALF", price: 99, pieces: 2 },
                        full: { name: "FULL", price: 189, pieces: 4 },
                    },
                    rawMaterial: "tangdi",
                    gramsPerPiece: 100 // 1kg = 10 pieces, so 100g per piece
                },
                8: {
                    name: "Afghani Tangdi",
                    portions: {
                        half: { name: "HALF", price: 119, pieces: 2 },
                        full: { name: "FULL", price: 229, pieces: 4 },
                    },
                    rawMaterial: "tangdi",
                    gramsPerPiece: 100
                },
                9: {
                    name: "Masala Chaap",
                    portions: {
                        half: { name: "HALF", price: 69, pieces: 3 },
                        full: { name: "FULL", price: 129, pieces: 6 },
                    },
                    rawMaterial: "chaap",
                    gramsPerPiece: 62.5 // 1kg = 16 pieces, so 62.5g per piece
                },
                10: {
                    name: "Malai Chaap",
                    portions: {
                        half: { name: "HALF", price: 79, pieces: 3 },
                        full: { name: "FULL", price: 149, pieces: 6 },
                    },
                    rawMaterial: "chaap",
                    gramsPerPiece: 62.5
                },
                11: {
                    name: "Afghani Chaap",
                    portions: {
                        half: { name: "HALF", price: 89, pieces: 3 },
                        full: { name: "FULL", price: 169, pieces: 6 },
                    },
                    rawMaterial: "chaap",
                    gramsPerPiece: 62.5
                },
                12: {
                    name: "Paneer Tikka",
                    portions: {
                        half: { name: "HALF", price: 79, pieces: 4 },
                        full: { name: "FULL", price: 149, pieces: 8 },
                    },
                    rawMaterial: "paneer",
                    gramsPerPiece: 31.25 // 1kg = 32 pieces, so 31.25g per piece
                },
                13: {
                    name: "Romali Roti",
                    portions: {
                        piece: { name: "PER PIECE", price: 10, pieces: 1 },
                    },
                    rawMaterial: "other",
                    gramsPerPiece: 0 // Not calculating for roti
                }
            }
            */
            
            // NEW: Load menu from centralized menu.json file
            menuItems: {},
            menuData: null,
            vendors: {},
            ingredients: {}
        };

        // Load centralized menu data
        async function loadMenuData() {
            try {
                console.log('Loading centralized menu data...');
                
                // Try to load from localStorage first
                const savedMenuData = localStorage.getItem('menuData');
                
                if (savedMenuData) {
                    state.menuData = JSON.parse(savedMenuData);
                    console.log('Loaded menu from localStorage');
                } else {
                    // Load from menu.json
                    const response = await fetch('./menu.json');
                    if (response.ok) {
                        state.menuData = await response.json();
                        console.log('Loaded menu from menu.json');
                    } else {
                        throw new Error('Failed to fetch menu.json');
                    }
                }
                
                // Convert dishes to the format expected by orders.html
                const dishes = state.menuData.dishes || [];
                state.menuItems = {};
                
                dishes.forEach(dish => {
                    state.menuItems[dish.id] = {
                        name: dish.name,
                        portions: dish.portions,
                        rawMaterial: dish.rawMaterial,
                        gramsPerPiece: dish.gramsPerPiece,
                        ingredients: dish.ingredients,
                        costPrice: dish.costPrice,
                        category: dish.category
                    };
                });
                
                // Store vendors and ingredients for reference
                state.vendors = {};
                state.ingredients = {};
                
                (state.menuData.vendors || []).forEach(vendor => {
                    state.vendors[vendor.id] = vendor;
                });
                
                (state.menuData.ingredients || []).forEach(ingredient => {
                    state.ingredients[ingredient.id] = ingredient;
                });
                
                console.log('Menu data loaded successfully. Items:', Object.keys(state.menuItems).length);
                
            } catch (error) {
                console.error('Error loading menu data:', error);
                console.warn('Using fallback menu data');
                
                // Fallback to basic menu structure if loading fails
                state.menuItems = {
                    1: { name: "Seekh Kebab", portions: { half: { name: "HALF", price: 109, pieces: 2 }, full: { name: "FULL", price: 209, pieces: 4 } }, rawMaterial: "keema", gramsPerPiece: 50 },
                    2: { name: "Chicken Tikka", portions: { half: { name: "HALF", price: 149, pieces: 4 }, full: { name: "FULL", price: 289, pieces: 8 } }, rawMaterial: "tikka", gramsPerPiece: 23.25 },
                    3: { name: "Paneer Tikka", portions: { half: { name: "HALF", price: 79, pieces: 4 }, full: { name: "FULL", price: 149, pieces: 8 } }, rawMaterial: "paneer", gramsPerPiece: 31.25 },
                    4: { name: "Rumali Roti", portions: { piece: { name: "PER PIECE", price: 10, pieces: 1 } }, rawMaterial: "other", gramsPerPiece: 0 }
                };
            }
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async () => {
            // Load menu data first
            await loadMenuData();
            
            // Update cart title in header if provided in URL
            const cartTitleElements = document.querySelectorAll('[id^="cartNameHeader"]');
            cartTitleElements.forEach(element => {
                if (cartTitle) {
                    // Show the cart title if it exists
                    element.textContent = cartTitle;
                    element.style.display = 'inline';
                } else {
                    // Hide the cart title element if no title is provided
                    element.style.display = 'none';
                }
            });

            initModals();
            initEventListeners();
            initSectionToggles();
            initDatePickers(); // Initialize date pickers

            // Check URL for date parameter
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');

            if (dateParam) {
                // If date parameter exists in URL, use it
                try {
                    const dateFromUrl = new Date(dateParam);
                    if (!isNaN(dateFromUrl.getTime())) {
                        // Valid date, set it in the date pickers
                        const formattedDate = dateFromUrl.toISOString().split('T')[0];
                        document.getElementById('orderDatePicker').value = formattedDate;
                        document.getElementById('orderDatePicker-mobile').value = formattedDate;

                        // Load orders for this date
                        selectedDate = dateFromUrl;
                        loadOrders(dateFromUrl);

                        // Show historical date indicator
                        document.querySelectorAll('.historical-date-indicator').forEach(el => {
                            el.textContent = `Orders for ${dateFromUrl.toLocaleDateString()}`;
                            el.classList.remove('d-none');
                        });
                    } else {
                        // Invalid date, load today's orders
                        loadOrders();
                    }
                } catch (e) {
                    console.error("Error parsing date from URL:", e);
                    loadOrders();
                }
            } else {
                // No date parameter, load today's orders
                loadOrders();
            }

            setInterval(checkDelayedOrders, 300000); // 5 minute checks

            // Update elapsed times every minute
            setInterval(() => {
                updateUI();
            }, 60000);

            // Show delay comparison on page load (now always visible)
            setTimeout(() => {
                showDelayComparison();
                // Setup delay comparison
            }, 2000); // Longer delay to ensure orders are fully loaded

            // Initialize mobile-specific features
            if (window.innerWidth < 768) {
                // Set up summary cards swipe
                const container = document.querySelector('.summary-cards-container');
                if (container) {
                    // Initialize scroll position indicator
                    container.addEventListener('scroll', function () {
                        const scrollPosition = this.scrollLeft;
                        const cardWidth = this.querySelector('.col-md-3').offsetWidth;
                        const activeIndex = Math.round(scrollPosition / cardWidth);

                        document.querySelectorAll('.scroll-dot').forEach((dot, index) => {
                            if (index === activeIndex) {
                                dot.classList.add('active');
                            } else {
                                dot.classList.remove('active');
                            }
                        });
                    });
                }

                // Set home tab as active by default
                switchTab('home');
            }
        });

        function initSectionToggles() {
            // Initialize section toggle icons for mobile
            document.getElementById('paidOrdersToggleIcon').classList.add('bi-chevron-down');
            document.getElementById('deliveredOrdersToggleIcon').classList.add('bi-chevron-down');

            // Initialize section toggle icons for desktop
            if (document.getElementById('paidOrdersToggleIcon-desktop')) {
                document.getElementById('paidOrdersToggleIcon-desktop').classList.add('bi-chevron-down');
            }
            if (document.getElementById('deliveredOrdersToggleIcon-desktop')) {
                document.getElementById('deliveredOrdersToggleIcon-desktop').classList.add('bi-chevron-down');
            }

            // Initialize kitchen list toggle icon for mobile - set to up since it's expanded by default
            if (document.getElementById('kitchenListToggleIcon')) {
                document.getElementById('kitchenListToggleIcon').classList.add('bi-chevron-up');
            }

            // Initialize delay section toggle icon for mobile
            if (document.getElementById('delayToggleIcon')) {
                document.getElementById('delayToggleIcon').classList.add('bi-chevron-down');
            }

            // Initially collapse the completed order sections on both mobile and desktop
            // Set the paid and delivered sections to be collapsed by default
            document.getElementById('paidOrdersSection').style.display = 'none';
            document.getElementById('deliveredOrdersSection').style.display = 'none';

            // Also collapse desktop versions if they exist
            if (document.getElementById('paidOrdersSection-desktop')) {
                document.getElementById('paidOrdersSection-desktop').style.display = 'none';
            }
            if (document.getElementById('deliveredOrdersSection-desktop')) {
                document.getElementById('deliveredOrdersSection-desktop').style.display = 'none';
            }

            // The kitchen list is now expanded by default
            // The delay section is already collapsed by default with style="display: none;"

            // Initialize scroll indicator for summary cards
            initSummaryCardSwipe();
        }

        function initSummaryCardSwipe() {
            // Only run on mobile
            if (window.innerWidth >= 768) return;

            const container = document.querySelector('.summary-cards-container');
            if (!container) return;

            const dots = document.querySelectorAll('.scroll-dot');

            // Update active dot based on scroll position
            container.addEventListener('scroll', () => {
                const scrollPosition = container.scrollLeft;
                const cardWidth = container.querySelector('.col-md-3').offsetWidth;
                const activeIndex = Math.round(scrollPosition / cardWidth);

                // Update active dot
                dots.forEach((dot, index) => {
                    if (index === activeIndex) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            });

            // Make dots clickable
            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    const cardWidth = container.querySelector('.col-md-3').offsetWidth;
                    container.scrollTo({
                        left: index * cardWidth,
                        behavior: 'smooth'
                    });
                });
            });
        }

        function initModals() {
            // Initialize modals with proper options
            state.modals = {
                edit: new bootstrap.Modal(document.getElementById('editOrderModal'), {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                }),
                vehicle: new bootstrap.Modal(document.getElementById('vehicleModal'), {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                }),
                delay: new bootstrap.Modal(document.getElementById('delayAlertModal'), {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                }),
                addOrder: new bootstrap.Modal(document.getElementById('addOrderModal'), {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                }),
                editOrder: new bootstrap.Modal(document.getElementById('editOrderModal'), {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                })
            };

            // Add event listeners to handle modal cleanup
            document.getElementById('addOrderModal').addEventListener('hidden.bs.modal', function () {
                // Clean up any leftover backdrop or body classes
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.parentNode.removeChild(backdrop);
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('padding-right');
                document.body.style.removeProperty('overflow');
            });
        }

        function initEventListeners() {
            document.getElementById('saveVehicleNumberBtn').addEventListener('click', saveVehicleNumber);
            document.getElementById('addOrderForm').addEventListener('submit', handleNewOrder);
            document.getElementById('editOrderForm').addEventListener('submit', handleOrderEdit);
            document.getElementById('editAddOrderItemBtn').addEventListener('click', () => {
                const row = createEditOrderItemRow();
                document.getElementById('editOrderItemsContainer').appendChild(row);
            });

            document.getElementById('editAddCustomOrderItemBtn').addEventListener('click', () => {
                const row = createEditOrderItemRow(null, true);
                document.getElementById('editOrderItemsContainer').appendChild(row);
            });

            // Add a global click handler for document to clear highlights when clicking elsewhere
            document.addEventListener('click', function (event) {
                if (!event.target.closest('.kitchen-badge') &&
                    !event.target.closest('.delay-comparison-row') &&
                    !event.target.closest('.order-card.highlight-danger, .order-card.highlight-warning, .order-card.highlight-info, .order-card.highlight-light')) {
                    clearOrderHighlights();
                }
            });
        }

        // Global variable to store the selected date
        let selectedDate = null;

        // Function to handle date change from date picker
        function handleDateChange(dateValue) {
            if (dateValue) {
                selectedDate = new Date(dateValue);
                // Sync both date pickers
                document.getElementById('orderDatePicker').value = dateValue;
                document.getElementById('orderDatePicker-mobile').value = dateValue;

                // Update URL with the selected date without reloading the page
                const url = new URL(window.location.href);
                url.searchParams.set('date', dateValue);
                window.history.pushState({}, '', url);

                // Update UI to show we're viewing historical data
                document.querySelectorAll('.historical-date-indicator').forEach(el => {
                    const dateText = `Orders for ${selectedDate.toLocaleDateString()}`;
                    el.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-clock-history me-2"></i>${dateText}</span>
                            <button class="btn btn-sm btn-outline-dark" onclick="shareDate('${dateValue}')">
                                <i class="bi bi-share"></i> Share
                            </button>
                        </div>
                    `;
                    el.classList.remove('d-none');
                });

                // Load orders for the selected date
                loadOrders(selectedDate);
            }
        }

        // Function to share a link to a specific date
        function shareDate(dateValue) {
            const url = new URL(window.location.href);
            url.searchParams.set('date', dateValue);

            // Try to use the clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url.toString())
                    .then(() => {
                        alert('Link copied to clipboard! You can share it to view orders for this date.');
                    })
                    .catch(err => {
                        console.error('Could not copy text: ', err);
                        // Fallback - prompt user to copy manually
                        prompt('Copy this link to share orders for this date:', url.toString());
                    });
            } else {
                // Fallback for browsers that don't support clipboard API
                prompt('Copy this link to share orders for this date:', url.toString());
            }
        }

        // Function to reset date to today
        function resetDate() {
            selectedDate = null;
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];

            // Reset date pickers
            document.getElementById('orderDatePicker').value = formattedDate;
            document.getElementById('orderDatePicker-mobile').value = formattedDate;

            // Update URL by removing the date parameter
            const url = new URL(window.location.href);
            url.searchParams.delete('date');
            window.history.pushState({}, '', url);

            // Hide historical data indicators
            document.querySelectorAll('.historical-date-indicator').forEach(el => {
                el.classList.add('d-none');
            });

            // Load today's orders
            loadOrders();
        }

        // Initialize date pickers with today's date in IST
        function initDatePickers() {
            const istDate = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });
            document.getElementById('orderDatePicker').value = istDate;
            document.getElementById('orderDatePicker-mobile').value = istDate;
        }

        async function loadOrders(date = null) {
            // If date is provided, use it; otherwise use today
            const startDate = date || new Date();
            startDate.setHours(0, 0, 0, 0);

            // Calculate end date (end of the selected day)
            const endDate = new Date(startDate);
            endDate.setHours(23, 59, 59, 999);

            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'loadingIndicator';
            loadingIndicator.className = 'alert alert-info text-center';
            loadingIndicator.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Loading orders...';

            const pendingOrdersList = document.getElementById('pendingOrdersList');
            if (pendingOrdersList) {
                pendingOrdersList.innerHTML = '';
                pendingOrdersList.appendChild(loadingIndicator);
            }

            try {
                // Modified approach to avoid composite index requirement
                // Query by cartName only and filter client-side by date
                db.collection('bot_orders')
                    .where('cartName', '==', state.cartName)
                    .get()
                    .then((snapshot) => {
                        // Filter documents client-side for the selected date
                        const filteredDocs = snapshot.docs.filter(doc => {
                            const data = doc.data();

                            // If createdAt is null or undefined, include the order
                            // This handles newly added orders where the server timestamp might not be set yet
                            if (!data.createdAt) {
                                console.log(`Including order ${doc.id} with no timestamp`);
                                return true;
                            }

                            const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
                            return createdAt >= startDate && createdAt <= endDate;
                        });

                        // Sort by createdAt in descending order
                        filteredDocs.sort((a, b) => {
                            const aData = a.data();
                            const bData = b.data();

                            // Handle cases where createdAt might be null or undefined
                            if (!aData.createdAt) return -1; // Place orders with no timestamp at the top
                            if (!bData.createdAt) return 1;

                            const aDate = aData.createdAt?.toDate ? aData.createdAt.toDate() : new Date(aData.createdAt);
                            const bDate = bData.createdAt?.toDate ? bData.createdAt.toDate() : new Date(bData.createdAt);
                            return bDate - aDate; // descending order
                        });

                        // Create a modified snapshot with the filtered and sorted docs
                        const filteredSnapshot = {
                            docs: filteredDocs,
                            size: filteredDocs.length,
                            empty: filteredDocs.length === 0
                        };

                        // Remove loading indicator
                        const loadingIndicator = document.getElementById('loadingIndicator');
                        if (loadingIndicator) {
                            loadingIndicator.remove();
                        }

                        handleOrderSnapshot(filteredSnapshot);
                    })
                    .catch(error => {
                        console.error("Error loading orders:", error);
                        alert("Error loading orders: " + error.message);

                        // Remove loading indicator even on error
                        const loadingIndicator = document.getElementById('loadingIndicator');
                        if (loadingIndicator) {
                            loadingIndicator.remove();
                        }
                    });
            } catch (error) {
                console.error("Error in loadOrders function:", error);
                alert("Error in loadOrders function: " + error.message);

                // Remove loading indicator even on error
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }
        }

        function handleOrderSnapshot(snapshot) {

            // Process orders and update state
            state.currentOrders = snapshot.docs.map(doc => {
                const data = doc.data();
                // Ensure updatedAt is a Date object
                let updatedAtDate = null;
                if (data.updatedAt) {
                    if (typeof data.updatedAt.toDate === 'function') {
                        updatedAtDate = data.updatedAt.toDate();
                    } else if (data.updatedAt instanceof Date) {
                        updatedAtDate = data.updatedAt;
                    } else {
                        console.warn(`Order ${doc.id} has updatedAt in unexpected format:`, data.updatedAt);
                    }
                }

                // Process createdAt to ensure it's a Date object
                let createdAtDate = null;
                if (data.createdAt) {
                    if (typeof data.createdAt.toDate === 'function') {
                        createdAtDate = data.createdAt.toDate();
                    } else if (data.createdAt instanceof Date) {
                        createdAtDate = data.createdAt;
                    }
                } else {
                    // If createdAt is missing, use current time
                    console.log(`Order ${doc.id} has no createdAt timestamp, using current time`);
                    createdAtDate = new Date();
                }

                const order = {
                    docId: doc.id,
                    ...data,
                    createdAt: createdAtDate,
                    updatedAt: updatedAtDate,
                    // Ensure items is always an array with cooked status
                    items: Array.isArray(data.items) ? data.items.map(item => ({
                        ...item,
                        cooked: item.cooked || false // Ensure cooked property exists
                    })) : []
                };

                // Calculate delay level for each order
                order.delayLevel = calculateDelayLevel(order);

                return order;
            });

            // Sort orders by delay level in descending order (most delayed first)
            state.currentOrders.sort((a, b) => {
                // Only apply special sorting to pending/preparing orders
                const aIsPending = a.status === 'preparing' || a.status === 'pending';
                const bIsPending = b.status === 'preparing' || b.status === 'pending';

                // If both are pending/preparing, sort by delay level
                if (aIsPending && bIsPending) {
                    if (b.delayLevel !== a.delayLevel) {
                        return b.delayLevel - a.delayLevel;
                    }
                    // If delay levels are equal, sort by creation time (oldest first)
                    return a.createdAt - b.createdAt;
                }

                // If only one is pending/preparing, prioritize it
                if (aIsPending && !bIsPending) return -1;
                if (!aIsPending && bIsPending) return 1;

                // Otherwise, sort by status and then by creation time
                return a.createdAt - b.createdAt;
            });

            // Initialize filtered orders with all orders
            if (state.searchQuery) {
                // If there's an active search, apply it to the new orders
                searchOrders(state.searchQuery);
            } else {
                state.filteredOrders = [...state.currentOrders];
                document.getElementById('pendingSearchResultsCount').textContent = state.currentOrders.length;
            }

            // Clean up alerts for orders that are no longer active
            state.currentOrders.forEach(order => {
                if (order.status !== 'preparing' && state.alertedOrders.has(order.docId)) {
                    console.log(`Clearing alert for order ${order.docId} as it's now ${order.status}`);
                    state.alertedOrders.delete(order.docId);

                    // If this was the current delay order, close the modal
                    if (state.currentDelayOrder && state.currentDelayOrder.docId === order.docId) {
                        console.log(`Closing delay alert modal for order ${order.docId}`);
                        state.currentDelayOrder = null;
                        const delayAlertModal = bootstrap.Modal.getInstance(document.getElementById('delayAlertModal'));
                        if (delayAlertModal) {
                            delayAlertModal.hide();
                        }
                    }
                }
            });

            updateUI();
            checkDelayedOrders();
        }

        function updateUI() {
            try {
                // Render the orders and kitchen list
                renderOrders();
                renderKitchenList();

                // Always update delay comparison since it's now always visible
                showDelayComparison();

                // Update mobile-specific elements
                if (window.innerWidth < 768) {
                    // Update mobile kitchen list if visible
                    if (document.getElementById('kitchenListMobile')) {
                        const kitchenListContent = document.getElementById('kitchenList').innerHTML;
                        document.getElementById('kitchenListMobile').innerHTML = kitchenListContent;

                        // Ensure event listeners are reattached for mobile kitchen badges
                        setTimeout(() => {
                            document.querySelectorAll('#kitchenListMobile .kitchen-badge').forEach(badge => {
                                badge.addEventListener('click', handleKitchenBadgeClick);
                            });
                        }, 100);
                    }

                    // Update mobile delay comparison if in summary tab
                    if (document.getElementById('summary-content') && document.getElementById('summary-content').style.display === 'block') {
                        if (document.getElementById('delayComparisonTable') && document.getElementById('delayComparisonTableMobile')) {
                            const delayComparisonContent = document.getElementById('delayComparisonTable').innerHTML;
                            document.getElementById('delayComparisonTableMobile').innerHTML = delayComparisonContent;
                        }
                    }

                    // Update mobile badges - check if elements exist before updating
                    if (document.getElementById('pendingOrdersCount-mobile') && document.getElementById('pendingOrdersCount')) {
                        document.getElementById('pendingOrdersCount-mobile').textContent = document.getElementById('pendingOrdersCount').textContent;
                    }
                    if (document.getElementById('paidOrdersCount-badge') && document.getElementById('paidOrdersCount')) {
                        document.getElementById('paidOrdersCount-badge').textContent = document.getElementById('paidOrdersCount').textContent;
                    }
                    if (document.getElementById('deliveredOrdersCount-badge') && document.getElementById('deliveredUnpaidCount')) {
                        document.getElementById('deliveredOrdersCount-badge').textContent = document.getElementById('deliveredUnpaidCount').textContent;
                    }
                }

                console.log("UI updated successfully");
            } catch (error) {
                console.error("Error updating UI:", error);
            }
        }

        function searchOrders(query) {
            const searchCard = document.querySelector('.card:has(#pendingOrdersSearchInput)');

            if (!query || query.trim() === '') {
                state.searchQuery = '';
                state.filteredOrders = [...state.currentOrders];
                document.getElementById('pendingSearchResultsCount').textContent = state.currentOrders.length;

                // Remove active search styling
                if (searchCard) {
                    searchCard.classList.remove('border-primary');
                    searchCard.style.boxShadow = '';
                }
                return;
            }

            query = query.toLowerCase().trim();
            state.searchQuery = query;

            state.filteredOrders = state.currentOrders.filter(order => {
                // Search in phone number
                const phoneMatch = order.customerDetails &&
                    order.customerDetails.phone &&
                    order.customerDetails.phone.toLowerCase().includes(query);

                // Search in comments
                const commentsMatch = order.customerDetails &&
                    order.customerDetails.comments &&
                    order.customerDetails.comments.toLowerCase().includes(query);

                return phoneMatch || commentsMatch;
            });

            // Update the search results count
            document.getElementById('pendingSearchResultsCount').textContent = state.filteredOrders.length;

            // Add active search styling
            if (searchCard) {
                searchCard.classList.add('border-primary');
                searchCard.style.boxShadow = '0 0 0 0.25rem rgba(13, 110, 253, 0.25)';
            }
        }

        function renderOrders() {
            // Use filtered orders if search is active, otherwise use all orders
            const ordersToRender = state.searchQuery ? state.filteredOrders : state.currentOrders;

            // Separate orders by status
            const pendingOrders = ordersToRender.filter(order =>
                order.status === 'preparing' || order.status === 'pending');

            const paidOrders = ordersToRender.filter(order =>
                order.status === 'paid(online)' || order.status === 'paid (cash)');

            const deliveredOrders = ordersToRender.filter(order =>
                order.status === 'delivered');

            // Function to generate order card HTML with modern mobile-first design
            const generateOrderCard = (order, isCompact = false) => {
                // Determine status class for styling
                const statusClass = order.status === 'preparing' || order.status === 'pending'
                    ? 'bg-pending'
                    : order.status === 'delivered'
                        ? 'bg-delivered'
                        : 'bg-paid';

                // Create a more modern card layout
                // Add 'delayed' class if the order is delayed and in pending/preparing status
                const isDelayed = order.delayLevel > 0 && (order.status === 'preparing' || order.status === 'pending');
                const delayedClass = isDelayed ? 'delayed' : '';

                return `
                <div class="${isCompact ? 'col-md-6' : 'col-12 col-md-6 col-lg-4'}">
                    <div id="order-${order.docId}" class="card order-card ${statusClass} ${delayedClass}">
                        <div class="card-body ${isCompact ? 'p-3' : ''}">
                            <div class="order-header">
                                <div>
                                    <span class="order-id">Order #${(order.id ? order.id.toString() : order.docId).slice(-4)}</span>
                                    <span class="badge ${getStatusClass(order.status)} ms-2">${order.status}</span>
                                </div>
                                <div class="order-time">
                                    <i class="bi bi-clock"></i> ${formatElapsedTime(order.createdAt)}
                                    ${isDelayed ?
                        `<span class="badge bg-danger ms-2">Delayed ${order.delayLevel}x</span>` : ''}
                                </div>
                            </div>
                            
                            <div class="order-details">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-phone me-1 text-primary"></i>
                                    <span>${highlightSearchMatch(order.customerDetails.phone, state.searchQuery)}</span>
                                </div>
                                
                                <div class="d-flex align-items-start mb-2">
                                    <i class="bi bi-chat-left-text me-1 text-primary"></i>
                                    <span>${highlightSearchMatch(order.customerDetails.comments || 'No comments', state.searchQuery)}</span>
                                </div>
                                
                                ${order.vehicleNumber ? `
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-truck me-1 text-primary"></i>
                                    <span>${order.vehicleNumber}</span>
                                </div>` : ''}
                            </div>
                            
                            <div class="order-items">
                                ${order.items.map((item, index) => `
                                    <div class="order-item ${item.cooked ? 'bg-light rounded p-1' : ''}" data-dish="${item.name}" data-portion="${item.portion.toLowerCase()}" data-index="${index}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <span class="dish-status-indicator me-1" onclick="toggleDishCookedStatus('${order.docId}', ${index}, ${!item.cooked})">
                                                    ${item.cooked ?
                                '<i class="bi bi-check-all text-success" style="font-size: 1rem;"></i>' :
                                '<i class="bi bi-circle" style="font-size: 1rem;"></i>'}
                                                </span>
                                                <span class="${item.cooked ? 'text-success fw-bold' : ''}">
                                                    ${item.name} (${item.portion}) ${item.quantity}
                                                    ${(item.pieces || item.portionPieces) ? 
                                                        `<small class="text-muted">(${((item.pieces || item.portionPieces || 1) * item.quantity).toFixed(0)} pcs)</small>` : 
                                                        ''}
                                                </span>
                                            </div>
                                            <div class="text-end">
                                                <div class="fw-bold">${(item.price * item.quantity).toFixed(2)}</div>
                                                ${(item.pieces || item.portionPieces) ? 
                                                    `<div class="small text-muted">${(item.price / (item.pieces || item.portionPieces || 1)).toFixed(2)}/pc</div>` : 
                                                    ''}
                                                ${item.cooked ? '<span class="badge bg-success mt-1">Cooked</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-2 mb-2">
                                <span class="fw-bold fs-5">Total:</span>
                                <span class="fw-bold fs-5">${order.total}</span>
                            </div>
                            
                            <div class="order-actions">
                                <div class="mb-2">
                                    <label for="statusSelect-${order.docId}" class="form-label">Update Status</label>
                                    <select id="statusSelect-${order.docId}" class="form-select" onchange="updateOrderStatus('${order.docId}', this.value)">
                                        <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered (Pending)</option>
                                        <option value="paid(online)" ${order.status === 'paid(online)' ? 'selected' : ''}>Paid (Online)</option>
                                        <option value="paid (cash)" ${order.status === 'paid (cash)' ? 'selected' : ''}>Paid (Cash)</option>
                                    </select>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success rounded-circle d-flex align-items-center justify-content-center" 
                                            style="width: 38px; height: 38px; padding: 0;" 
                                            onclick="sendWhatsAppMessage('${order.docId}')" 
                                            title="Send Payment Link">
                                        <i class="bi bi-whatsapp"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="showEditModal('${order.docId}')">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteOrder('${order.docId}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            };

            // Render pending orders
            const pendingOrdersHTML = pendingOrders.length > 0
                ? pendingOrders.map(order => generateOrderCard(order, false)).join('')
                : `<div class="col-12"><div class="alert alert-info">No pending orders at this time.</div></div>`;

            // Render paid orders
            const paidOrdersHTML = paidOrders.length > 0
                ? paidOrders.map(order => generateOrderCard(order, true)).join('')
                : `<div class="col-12"><div class="alert alert-info">No paid orders at this time.</div></div>`;

            // Render delivered orders
            const deliveredOrdersHTML = deliveredOrders.length > 0
                ? deliveredOrders.map(order => generateOrderCard(order, true)).join('')
                : `<div class="col-12"><div class="alert alert-info">No delivered orders at this time.</div></div>`;

            // Update the DOM for both mobile and desktop views
            document.getElementById('pendingOrdersList').innerHTML = pendingOrdersHTML;

            // Update mobile and desktop paid orders lists
            document.getElementById('paidOrdersList').innerHTML = paidOrdersHTML;
            if (document.getElementById('paidOrdersList-desktop')) {
                document.getElementById('paidOrdersList-desktop').innerHTML = paidOrdersHTML;
            }

            // Update mobile and desktop delivered orders lists
            document.getElementById('deliveredOrdersList').innerHTML = deliveredOrdersHTML;
            if (document.getElementById('deliveredOrdersList-desktop')) {
                document.getElementById('deliveredOrdersList-desktop').innerHTML = deliveredOrdersHTML;
            }

            // Update counters in section headers
            updateSectionCounters(pendingOrders.length, paidOrders.length, deliveredOrders.length);
        }

        function updateSectionCounters(pendingCount, paidCount, deliveredCount) {
            // Add count badges to section headers
            const paidHeader = document.querySelector('.card-header:has(+ #paidOrdersSection) h5');
            const deliveredHeader = document.querySelector('.card-header:has(+ #deliveredOrdersSection) h5');

            if (paidHeader) {
                paidHeader.innerHTML = `<i class="bi bi-cash-coin"></i> Paid Orders <span class="badge bg-light text-dark ms-2">${paidCount}</span>`;
            }

            if (deliveredHeader) {
                deliveredHeader.innerHTML = `<i class="bi bi-truck"></i> Delivered Orders (Pending) <span class="badge bg-light text-dark ms-2">${deliveredCount}</span>`;
            }

            // Update summary section
            updateOrdersSummary(pendingCount, paidCount, deliveredCount);
        }

        function updateOrdersSummary(pendingCount, paidCount, deliveredCount) {
            // Get all orders
            const ordersToRender = state.searchQuery ? state.filteredOrders : state.currentOrders;
            const totalCount = pendingCount + paidCount + deliveredCount;

            // Calculate totals
            let pendingTotal = 0;
            let cashPaymentsTotal = 0;
            let onlinePaymentsTotal = 0;
            let deliveredUnpaidTotal = 0;
            let totalSales = 0;

            // Process each order
            ordersToRender.forEach(order => {
                const orderTotal = parseFloat(order.total) || 0;

                // Add to total sales regardless of status
                totalSales += orderTotal;

                if (order.status === 'preparing' || order.status === 'pending') {
                    pendingTotal += orderTotal;
                } else if (order.status === 'paid (cash)') {
                    cashPaymentsTotal += orderTotal;
                } else if (order.status === 'paid(online)') {
                    onlinePaymentsTotal += orderTotal;
                } else if (order.status === 'delivered') {
                    deliveredUnpaidTotal += orderTotal;
                }
            });

            // Update the mobile summary section
            document.getElementById('totalOrdersCount').textContent = totalCount;
            document.getElementById('totalSalesAmount').textContent = totalSales.toFixed(2);
            document.getElementById('pendingOrdersCount').textContent = pendingCount;
            document.getElementById('pendingOrdersTotal').textContent = pendingTotal.toFixed(2);
            document.getElementById('paidOrdersCount').textContent = paidCount;
            document.getElementById('cashPaymentsTotal').textContent = cashPaymentsTotal.toFixed(2);
            document.getElementById('onlinePaymentsTotal').textContent = onlinePaymentsTotal.toFixed(2);
            document.getElementById('deliveredUnpaidCount').textContent = deliveredCount;
            document.getElementById('deliveredUnpaidTotal').textContent = deliveredUnpaidTotal.toFixed(2);

            // Update the desktop summary section
            if (document.getElementById('totalOrdersCount-desktop')) {
                document.getElementById('totalOrdersCount-desktop').textContent = totalCount;
                document.getElementById('totalSalesAmount-desktop').textContent = totalSales.toFixed(2);
                document.getElementById('pendingOrdersCount-desktop').textContent = pendingCount;
                document.getElementById('pendingOrdersTotal-desktop').textContent = pendingTotal.toFixed(2);
                document.getElementById('paidOrdersCount-desktop').textContent = paidCount;
                document.getElementById('cashPaymentsTotal-desktop').textContent = cashPaymentsTotal.toFixed(2);
                document.getElementById('onlinePaymentsTotal-desktop').textContent = onlinePaymentsTotal.toFixed(2);
                document.getElementById('deliveredUnpaidCount-desktop').textContent = deliveredCount;
                document.getElementById('deliveredUnpaidTotal-desktop').textContent = deliveredUnpaidTotal.toFixed(2);
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                console.error(`Section with ID ${sectionId} not found`);
                return;
            }

            let iconId;

            // Determine which icon to toggle based on the section
            // Handle both mobile and desktop versions
            if (sectionId === 'paidOrdersSection' || sectionId === 'paidOrdersSection-desktop') {
                iconId = sectionId === 'paidOrdersSection' ? 'paidOrdersToggleIcon' : 'paidOrdersToggleIcon-desktop';
            } else if (sectionId === 'deliveredOrdersSection' || sectionId === 'deliveredOrdersSection-desktop') {
                iconId = sectionId === 'deliveredOrdersSection' ? 'deliveredOrdersToggleIcon' : 'deliveredOrdersToggleIcon-desktop';
            } else if (sectionId === 'mobileKitchenList') {
                iconId = 'kitchenListToggleIcon';
            } else if (sectionId === 'mobileDelaySection') {
                iconId = 'delayToggleIcon';
            }

            const icon = document.getElementById(iconId);
            if (!icon) {
                console.error(`Icon with ID ${iconId} not found`);
                return;
            }

            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            } else {
                section.style.display = 'none';
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
        }

        // Function to speak the kitchen list items
        function speakKitchenList() {
            // Check if the browser supports speech synthesis
            if ('speechSynthesis' in window) {
                // Get the kitchen items from the DOM - only from the main kitchen list to avoid duplicates
                // In mobile mode, we'll use the mobile kitchen list, otherwise use the desktop one
                const isMobile = window.innerWidth < 768;
                const kitchenListId = isMobile ? 'kitchenListMobile' : 'kitchenList';
                const kitchenItems = document.querySelectorAll(`#${kitchenListId} .kitchen-item`);

                // Get available voices
                let voices = window.speechSynthesis.getVoices();

                // If voices aren't loaded yet, wait for them
                if (voices.length === 0) {
                    window.speechSynthesis.onvoiceschanged = function () {
                        voices = window.speechSynthesis.getVoices();
                        speakWithIndianVoice();
                    };
                } else {
                    speakWithIndianVoice();
                }

                function speakWithIndianVoice() {
                    // Find an Indian English voice or Hindi voice
                    let selectedVoice = null;

                    // First try to find a Hindi voice
                    selectedVoice = voices.find(voice => voice.lang === 'hi-IN');

                    // If no Hindi voice, try to find an Indian English voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice =>
                            voice.lang === 'en-IN' ||
                            voice.name.includes('Indian') ||
                            voice.name.includes('Hindi')
                        );
                    }

                    // If still no voice found, use any available voice
                    if (!selectedVoice && voices.length > 0) {
                        console.log("No Indian voice found, using default voice");
                    }

                    if (kitchenItems.length === 0) {
                        // If no items, speak a simple message
                        const noItemsMsg = new SpeechSynthesisUtterance("  "); // Hindi: "No items"
                        if (selectedVoice) noItemsMsg.voice = selectedVoice;
                        noItemsMsg.lang = 'hi-IN'; // Set language to Hindi
                        window.speechSynthesis.speak(noItemsMsg);
                        return;
                    }

                    // Cancel any ongoing speech
                    window.speechSynthesis.cancel();

                    // Create a visual indicator that speech is active
                    const speakerButtons = document.querySelectorAll('button[onclick="speakKitchenList()"]');
                    speakerButtons.forEach(btn => {
                        const originalIcon = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
                        btn.classList.add('btn-light');
                        btn.classList.remove('btn-outline-light');

                        // Reset the button after speech is done
                        setTimeout(() => {
                            btn.innerHTML = originalIcon;
                            btn.classList.remove('btn-light');
                            btn.classList.add('btn-outline-light');
                        }, kitchenItems.length * 2000); // Estimate speech duration based on number of items
                    });

                    // No introduction message - we'll only narrate the items directly

                    // Create a queue of utterances for each kitchen item
                    kitchenItems.forEach((item, index) => {
                        // Get the dish name
                        const dishName = item.querySelector('h5').textContent;

                        // Get the quantities
                        const halfBadge = item.querySelector('.kitchen-badge[data-portion="half"]');
                        const fullBadge = item.querySelector('.kitchen-badge[data-portion="full"]');

                        let halfQty = 0;
                        let fullQty = 0;

                        if (halfBadge) {
                            halfQty = parseInt(halfBadge.textContent.replace('Half: ', '')) || 0;
                        }

                        if (fullBadge) {
                            fullQty = parseInt(fullBadge.textContent.replace('Full: ', '')) || 0;
                        }

                        // Create the speech text - just dish name and quantities, nothing extra
                        let speechText = `${dishName}`;

                        if (halfQty > 0) {
                            speechText += `, ${halfQty} `; // "half" in Hindi
                        }

                        if (fullQty > 0) {
                            speechText += `, ${fullQty} `; // "full" in Hindi
                        }

                        // Create and queue the utterance with a slight delay between items
                        setTimeout(() => {
                            const utterance = new SpeechSynthesisUtterance(speechText);
                            if (selectedVoice) utterance.voice = selectedVoice;
                            utterance.lang = 'hi-IN'; // Set language to Hindi
                            utterance.rate = 0.9; // Slightly slower for better clarity
                            utterance.pitch = 1.0;
                            utterance.volume = 1.0;

                            // Highlight the current item being spoken
                            const originalBackground = item.style.background;
                            item.style.background = 'rgba(255, 193, 7, 0.2)';

                            utterance.onend = () => {
                                // Reset the highlight after this item is spoken
                                item.style.background = originalBackground;
                            };

                            window.speechSynthesis.speak(utterance);
                        }, index * 1800); // Adequate delay between items for clear separation
                    });

                    // Add a stop button functionality
                    document.addEventListener('click', stopSpeech);

                    // Remove the event listener after speech is likely done
                    setTimeout(() => {
                        document.removeEventListener('click', stopSpeech);
                    }, kitchenItems.length * 2000 + 1000); // Based on item count plus a small buffer
                }
            } else {
                alert("Sorry, your browser does not support speech synthesis. Please try using a modern browser like Chrome, Edge, or Safari.");
            }
        }

        // Function to stop ongoing speech
        function stopSpeech() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();

                // Reset all speaker buttons
                const speakerButtons = document.querySelectorAll('button[onclick="speakKitchenList()"]');
                speakerButtons.forEach(btn => {
                    btn.innerHTML = '<i class="bi bi-volume-up"></i>';
                    btn.classList.remove('btn-light');
                    btn.classList.add('btn-outline-light');
                });

                // Remove the click event listener
                document.removeEventListener('click', stopSpeech);
            }
        }

        function renderKitchenList() {
            console.log("Rendering kitchen list...");

            // Aggregate quantities by dish name and portion
            const kitchenItems = state.currentOrders
                .filter(o => {
                    // Only include orders with 'preparing' or 'pending' status that have items
                    const valid = (o.status === 'preparing' || o.status === 'pending') &&
                        o.items && Array.isArray(o.items) && o.items.length > 0;

                    if (!valid && (o.status === 'preparing' || o.status === 'pending')) {
                        console.warn(`Order ${o.docId} has status ${o.status} but no valid items:`, o.items);
                    }

                    return valid;
                })
                .flatMap(o => {
                    // Add order information to each item for better tracking
                    console.log(`Processing order ${o.docId} with ${o.items.length} items`);
                    return o.items.map(item => ({
                        ...item,
                        orderId: o.docId,
                        orderTime: o.createdAt,
                        delayLevel: o.delayLevel || 0,
                        orderStatus: o.status,
                        cooked: item.cooked || false // Track cooked status
                    }));
                })
                // Filter out cooked dishes
                .filter(item => !item.cooked)
                .reduce((acc, item) => {
                    if (!acc[item.name]) {
                        acc[item.name] = {
                            half: 0,
                            full: 0,
                            delayLevels: [],
                            orderTimes: [],
                            priority: 0,
                            orderIds: new Set(),
                            cookedItems: 0,
                            totalItems: 0
                        };
                    }
                    const portionKey = item.portion.toLowerCase();
                    if (portionKey === 'half' || portionKey === 'full') {
                        acc[item.name][portionKey] += item.quantity;
                    } else {
                        // For other portions, accumulate under 'full' as default
                        acc[item.name].full += item.quantity;
                    }

                    // Track delay level for priority calculation
                    acc[item.name].delayLevels.push(item.delayLevel);

                    // Track order time for sorting by oldest orders
                    if (item.orderTime) {
                        acc[item.name].orderTimes.push(item.orderTime);
                    }

                    // Track unique order IDs
                    acc[item.name].orderIds.add(item.orderId);

                    return acc;
                }, {});

            // Calculate priority score for each dish
            Object.values(kitchenItems).forEach(item => {
                // Priority factors:
                // 1. Maximum delay level (most important)
                // 2. Number of orders containing this dish
                // 3. Age of oldest order containing this dish

                const maxDelay = item.delayLevels.length > 0 ? Math.max(...item.delayLevels) : 0;
                const orderCount = item.orderIds.size;

                // Find oldest order time
                let oldestOrderAge = 0;
                if (item.orderTimes.length > 0) {
                    const oldestTime = new Date(Math.min(...item.orderTimes.map(t => t.getTime())));
                    oldestOrderAge = (new Date() - oldestTime) / 60000; // in minutes
                }

                // Calculate priority score (higher is more urgent)
                // Heavily weight the delay level to ensure most delayed items are prioritized
                item.priority = (maxDelay * 1000) + (orderCount * 10) + Math.min(oldestOrderAge / 5, 20);
            });

            // Generate HTML grouped by dish with priority indicators
            const kitchenHTML = Object.entries(kitchenItems)
                // Sort by priority score (highest first)
                .sort((a, b) => b[1].priority - a[1].priority)
                .map(([name, portions]) => {
                    const halfQty = portions.half;
                    const fullQty = portions.full;
                    const maxDelay = portions.delayLevels.length > 0 ? Math.max(...portions.delayLevels) : 0;
                    const orderCount = portions.orderIds.size;

                    // Determine priority level (0-3)
                    let priorityLevel = 0;
                    if (maxDelay >= 3) priorityLevel = 3;
                    else if (maxDelay >= 1) priorityLevel = 2;
                    else if (orderCount > 1) priorityLevel = 1;

                    // Priority styling
                    let priorityClass = '';
                    let priorityBadge = '';
                    let borderStyle = '';

                    switch (priorityLevel) {
                        case 3: // Critical priority
                            priorityClass = 'bg-danger text-white';
                            priorityBadge = ''; // Removed badge
                            borderStyle = 'border-left: 5px solid #dc3545;';
                            break;
                        case 2: // High priority
                            priorityClass = 'bg-warning';
                            priorityBadge = ''; // Removed badge
                            borderStyle = 'border-left: 5px solid #ffc107;';
                            break;
                        case 1: // Medium priority
                            priorityClass = 'bg-info text-dark';
                            priorityBadge = ''; // Removed badge
                            borderStyle = 'border-left: 5px solid #0dcaf0;';
                            break;
                        default: // Normal priority
                            priorityClass = 'bg-light';
                            borderStyle = '';
                    }

                    // Get status badges for this item
                    const statusCounts = Array.from(portions.orderIds).reduce((acc, orderId) => {
                        const order = state.currentOrders.find(o => o.docId === orderId);
                        if (order) {
                            acc[order.status] = (acc[order.status] || 0) + 1;
                        }
                        return acc;
                    }, {});

                    const statusBadges = Object.entries(statusCounts).map(([status, count]) =>
                        `<span class="badge ${getStatusClass(status)}">${status}: ${count}</span>`
                    ).join(' ');

                    // Add 'delayed' class for critical priority items (maxDelay >= 3)
                    const isDelayed = maxDelay >= 3;
                    const delayedClass = isDelayed ? 'delayed' : '';

                    return `
                    <div class="kitchen-item mb-2 p-2 rounded position-relative ${priorityClass} ${delayedClass}" style="${borderStyle}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" style="font-weight: 600; color: #343a40;">${name}</h5>
                            <span class="badge bg-dark" style="border-radius: 16px;">${orderCount} order${orderCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            ${halfQty > 0 ? `<div class="kitchen-badge badge bg-secondary" data-dish="${name}" data-portion="half" data-orders='${JSON.stringify(Array.from(portions.orderIds))}' data-priority="${priorityLevel}" style="cursor: pointer;" title="Click to highlight related orders">Half: ${halfQty}</div>` : ''}
                            ${fullQty > 0 ? `<div class="kitchen-badge badge bg-secondary" data-dish="${name}" data-portion="full" data-orders='${JSON.stringify(Array.from(portions.orderIds))}' data-priority="${priorityLevel}" style="cursor: pointer;" title="Click to highlight related orders">Full: ${fullQty}</div>` : ''}
                        </div>
                        <div class="mt-2">
                            ${statusBadges}
                        </div>
                        ${priorityLevel >= 2 ? `<div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                        </div>` : ''}
                    </div>
                    `;
                }).join('');

            // Calculate total dishes to prepare
            const totalDishes = Object.values(kitchenItems).reduce((sum, item) => sum + item.half + item.full, 0);

            // Add a header with priority legend and total count
            const legendHTML = `
                <div class="alert alert-dark mb-2 p-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0" style="font-size: 0.9rem;">Priority Legend:</h6>
                        <span class="badge bg-secondary">${totalDishes} dishes</span>
                    </div>
                    <div class="d-flex flex-wrap gap-1" style="font-size: 0.8rem;">
                        <span class="badge bg-danger">URGENT</span>
                        <span class="badge bg-warning">HIGH</span>
                        <span class="badge bg-info text-dark">NEXT</span>
                        <span class="badge bg-light text-dark">Normal</span>
                    </div>
                </div>
            `;

            // Check if there are any items to display
            if (Object.keys(kitchenItems).length === 0) {
                document.getElementById('kitchenList').innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No items to prepare at this time.
                    </div>
                `;
            } else {
                document.getElementById('kitchenList').innerHTML = legendHTML + kitchenHTML;

                // Add event listeners to kitchen badges
                setTimeout(() => {
                    document.querySelectorAll('.kitchen-badge').forEach(badge => {
                        badge.addEventListener('click', handleKitchenBadgeClick);
                    });
                }, 100);
            }
        }

        // Function to handle kitchen badge clicks
        function handleKitchenBadgeClick(event) {
            // Clear any previous highlights
            clearOrderHighlights();

            const badge = event.currentTarget;

            // Remove active class from all badges
            document.querySelectorAll('.kitchen-badge.active').forEach(b => {
                b.classList.remove('active');
            });

            // Add active class to the clicked badge
            badge.classList.add('active');

            const dishName = badge.getAttribute('data-dish');
            const portion = badge.getAttribute('data-portion');
            const orderIds = JSON.parse(badge.getAttribute('data-orders'));
            const priorityLevel = parseInt(badge.getAttribute('data-priority'));

            // Determine highlight class based on priority level
            let highlightClass = 'highlight-light';
            if (priorityLevel === 3) {
                highlightClass = 'highlight-danger';
            } else if (priorityLevel === 2) {
                highlightClass = 'highlight-warning';
            } else if (priorityLevel === 1) {
                highlightClass = 'highlight-info';
            }

            // Highlight the related orders
            orderIds.forEach(orderId => {
                const orderCard = document.getElementById(`order-${orderId}`);
                if (orderCard) {
                    // Add highlight classes to the order card
                    orderCard.classList.add(highlightClass);
                    orderCard.classList.add('highlight-pulse');

                    // Scroll to the first highlighted order
                    if (orderIds.indexOf(orderId) === 0) {
                        orderCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    // Bold the specific dish items within the order
                    const orderItems = orderCard.querySelectorAll(`.order-item[data-dish="${dishName}"]`);
                    orderItems.forEach(item => {
                        // Check if the portion matches or if we should highlight all portions of this dish
                        if (item.getAttribute('data-portion') === portion || portion === 'all') {
                            // Make the text bold and add a background
                            const itemText = item.querySelector('div:first-child');
                            if (itemText) {
                                itemText.style.fontWeight = 'bold';
                                itemText.style.color = '#000';
                                itemText.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
                                itemText.style.padding = '3px 6px';
                                itemText.style.borderRadius = '4px';
                            }
                        }
                    });
                }
            });

            // Set a timeout to clear highlights after 5 seconds
            setTimeout(clearOrderHighlights, 5000);
        }

        // Function to handle delay comparison row clicks
        function handleDelayComparisonRowClick(event) {
            // Clear any previous highlights
            clearOrderHighlights();

            const row = event.currentTarget;

            // Remove active class from all rows
            document.querySelectorAll('.delay-comparison-row.active').forEach(r => {
                r.classList.remove('active');
            });

            // Add active class to the clicked row
            row.classList.add('active');

            const orderId = row.getAttribute('data-order-id');
            const delayLevel = parseInt(row.getAttribute('data-delay-level'));

            // Determine highlight class based on delay level
            let highlightClass = 'highlight-light';
            if (delayLevel >= 3) {
                highlightClass = 'highlight-danger';
            } else if (delayLevel >= 1) {
                highlightClass = 'highlight-warning';
            }

            // Highlight the related order
            const orderCard = document.getElementById(`order-${orderId}`);
            if (orderCard) {
                // Add highlight classes to the order card
                orderCard.classList.add(highlightClass);
                orderCard.classList.add('highlight-pulse');

                // Scroll to the highlighted order
                orderCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Set a timeout to clear highlights after 5 seconds
            setTimeout(clearOrderHighlights, 5000);
        }

        // Function to clear all order highlights
        function clearOrderHighlights() {
            document.querySelectorAll('.order-card.highlight-danger, .order-card.highlight-warning, .order-card.highlight-info, .order-card.highlight-light, .order-card.highlight-pulse').forEach(card => {
                card.classList.remove('highlight-danger', 'highlight-warning', 'highlight-info', 'highlight-light', 'highlight-pulse');
            });

            // Reset any styled text in order items
            document.querySelectorAll('.order-item div').forEach(item => {
                item.style.fontWeight = '';
                item.style.color = '';
                item.style.backgroundColor = '';
                item.style.padding = '';
                item.style.borderRadius = '';
            });

            document.querySelectorAll('.kitchen-badge.active').forEach(badge => {
                badge.classList.remove('active');
            });

            document.querySelectorAll('.delay-comparison-row.active').forEach(row => {
                row.classList.remove('active');
            });
        }

        // Delay Handling Functions
        function checkDelayedOrders() {
            console.log('Checking delayed orders...');

            // Only check active orders (pending or preparing)
            const activeOrders = state.currentOrders.filter(order =>
                ['pending', 'preparing'].includes(order.status)
            );

            activeOrders.forEach(order => {
                // Use the already calculated delay level from handleOrderSnapshot
                // or recalculate if needed
                if (order.delayLevel === undefined) {
                    order.delayLevel = calculateDelayLevel(order);
                }

                console.log(`Order ${order.docId} delayLevel: ${order.delayLevel}`);

                if (order.delayLevel > 0 && !state.alertedOrders.has(order.docId)) {
                    console.log(`Handling delayed order ${order.docId}`);
                    handleDelayedOrder(order);
                }
            });

            // Always update delay comparison since it's now always visible
            showDelayComparison();
        }

        function calculateDelayLevel(order) {
            // Use the new calculateExactDelay function for consistency
            return calculateExactDelay(order).delayLevel;
        }

        function handleDelayedOrder(order) {
            console.log(`Adding order ${order.docId} to alertedOrders and showing delay alert.`);
            state.alertedOrders.add(order.docId);
            showDelayAlert(order);
        }

        function showDelayAlert(order) {
            console.log(`Checking if we should show delay alert for order ${order.docId}`);

            // Only show alerts for preparing orders
            if (order.status !== 'preparing') {
                console.log(`Skipping delay alert for order ${order.docId} with status ${order.status}`);
                return;
            }

            console.log(`Showing delay alert for order ${order.docId}`);
            state.currentDelayOrder = order;
            let delayMinutes = 0;
            if (order.updatedAt instanceof Date) {
                delayMinutes = Math.floor((Date.now() - order.updatedAt.getTime()) / 60000);
            }

            // Update the modal content
            document.getElementById('delayAlertContent').innerHTML = `
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Order #${(order.id ? order.id.toString() : order.docId).slice(-4)} delayed!</h5>
            <p><strong>Status:</strong> ${order.status} for ${delayMinutes} minutes</p>
            <p><strong>Note:</strong> This alert will automatically close if the order is marked as delivered, paid(online), or paid (cash).</p>
        </div>
    `;

            // Show the modal
            try {
                if (state.modals && state.modals.delay) {
                    state.modals.delay.show();
                } else {
                    // Fallback if modal isn't initialized in state
                    const delayModal = new bootstrap.Modal(document.getElementById('delayAlertModal'));
                    delayModal.show();
                }
            } catch (error) {
                console.error('Error showing delay modal:', error);
            }
        }

        // Utility Functions
        function getStatusClass(status, delayLevel = 0) {
            const classes = {
                preparing: 'bg-info',
                pending: 'bg-warning',
                delivered: 'bg-primary',
                'paid(online)': 'bg-success',
                'paid (cash)': 'bg-success'
            };
            return classes[status] || 'bg-secondary';
        }

        function highlightSearchMatch(text, searchQuery) {
            if (!searchQuery || !text) return text;

            searchQuery = searchQuery.toLowerCase().trim();
            if (!searchQuery) return text;

            // Escape special characters in the search query for use in regex
            const escapedQuery = searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

            // Create a regex to find the search query in the text (case insensitive)
            const regex = new RegExp(`(${escapedQuery})`, 'gi');

            // Replace matches with highlighted spans
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function getDelayColor(order) {
            // Only show delay colors for pending or preparing orders
            if (order.status !== 'preparing' && order.status !== 'pending') {
                // Use default colors for delivered or paid orders
                if (order.status === 'delivered') {
                    return '#0dcaf0'; // info color for delivered
                } else if (order.status === 'paid(online)' || order.status === 'paid (cash)') {
                    return '#198754'; // success color for paid
                }
                return '#6c757d'; // default gray
            }

            // Clamp delayLevel between 0 and 5 for color mapping
            const delayLevel = Math.min(Math.max(order.delayLevel || 0, 0), 5);
            // Map delayLevel 0 (green) to 5 (dark red)
            const hue = 120 - (delayLevel * 24); // 120 to 0 hue range
            return `hsl(${hue}, 80%, 50%)`;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Kolkata' });
        }

        function formatElapsedTime(date) {
            if (!date) return "Unknown";

            const now = new Date();
            const elapsedMs = now - date;
            const totalMinutes = Math.floor(elapsedMs / 60000);

            if (totalMinutes < 60) {
                return `${totalMinutes} min ago`;
            } else {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}h ${minutes}m ago`;
            }
        }

        // Delay comparison functions

        function showDelayComparison() {
            const desktopTableContainer = document.getElementById('delayComparisonTable');
            const mobileTableContainer = document.getElementById('delayComparisonTableMobile');

            // Sort orders by delay time (descending)
            const filteredOrders = [...state.currentOrders].filter(order => {
                // Include both 'preparing' and 'pending' orders
                return order.createdAt && (order.status === 'preparing' || order.status === 'pending');
            });

            console.log("Filtered orders:", filteredOrders);

            const sortedOrders = filteredOrders
                .map(order => {
                    const delayInfo = calculateExactDelay(order);
                    return { ...order, delayInfo };
                })
                .sort((a, b) => {
                    // First sort by delay level (most delayed first)
                    if (b.delayInfo.delayLevel !== a.delayInfo.delayLevel) {
                        return b.delayInfo.delayLevel - a.delayInfo.delayLevel;
                    }
                    // If delay levels are equal, sort by total minutes (most time elapsed first)
                    return b.delayInfo.totalMinutes - a.delayInfo.totalMinutes;
                });

            // Handle empty orders case
            if (sortedOrders.length === 0) {
                const emptyMessage = '<p class="text-center">No active orders to compare.</p>';
                if (desktopTableContainer) desktopTableContainer.innerHTML = emptyMessage;
                if (mobileTableContainer) mobileTableContainer.innerHTML = emptyMessage;
                return;
            }

            // Create the desktop comparison table
            let desktopTableHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="min-width: 150px;"><i class="bi bi-chat-left-text"></i> Comment</th>
                                <th><i class="bi bi-flag"></i> Status</th>
                                <th><i class="bi bi-calendar-check"></i> Order Time</th>
                                <th><i class="bi bi-hourglass-split"></i> Time Since</th>
                                <th><i class="bi bi-stopwatch"></i> Expected</th>
                                <th><i class="bi bi-graph-up-arrow"></i> Delay</th>
                                <th><i class="bi bi-thermometer-half"></i> Level</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Create a simplified mobile comparison table
            let mobileTableHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="bi bi-chat-left-text"></i> Order</th>
                                <th><i class="bi bi-hourglass-split"></i> Time</th>
                                <th><i class="bi bi-graph-up-arrow"></i> Delay</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedOrders.forEach(order => {
                const { totalMinutes, hours, minutes, expectedMinutes, delayMinutes, delayLevel } = order.delayInfo;
                const delayClass = delayLevel > 0 ? 'text-danger' : 'text-success';
                const delayText = delayLevel > 0 ? `+${delayMinutes} min` : 'On time';
                const orderNumber = (order.id ? order.id.toString() : order.docId).slice(-4);

                // Desktop table row
                desktopTableHTML += `
                    <tr class="${delayLevel > 2 ? 'table-danger' : delayLevel > 0 ? 'table-warning' : ''} delay-comparison-row"
                        data-order-id="${order.docId}"
                        data-delay-level="${delayLevel}"
                        style="cursor: pointer;"
                        title="Click to highlight this order">
                        <td title="Order #${orderNumber} - ${order.customerDetails && order.customerDetails.comments ? order.customerDetails.comments : 'No comment'}" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${order.customerDetails && order.customerDetails.comments ? order.customerDetails.comments : '<em class="text-muted">No comment</em>'}
                        </td>
                        <td><span class="badge ${getStatusClass(order.status)}">${order.status}</span></td>
                        <td>${formatTime(order.createdAt)}</td>
                        <td><strong>${hours > 0 ? `${hours}h ${minutes}m` : `${totalMinutes}m`}</strong></td>
                        <td>${expectedMinutes}m</td>
                        <td class="${delayClass}"><strong>${delayText}</strong></td>
                        <td>
                            <div class="badge delay-level-${Math.min(delayLevel, 5)}">${delayLevel}</div>
                        </td>
                    </tr>
                `;

                // Mobile table row (simplified)
                mobileTableHTML += `
                    <tr class="${delayLevel > 2 ? 'table-danger' : delayLevel > 0 ? 'table-warning' : ''} delay-comparison-row"
                        data-order-id="${order.docId}"
                        data-delay-level="${delayLevel}"
                        style="cursor: pointer;"
                        title="Click to highlight this order">
                        <td>
                            <strong>#${orderNumber}</strong>
                            <span class="badge ${getStatusClass(order.status)}">${order.status}</span>
                        </td>
                        <td><strong>${hours > 0 ? `${hours}h ${minutes}m` : `${totalMinutes}m`}</strong></td>
                        <td class="${delayClass}"><strong>${delayText}</strong></td>
                    </tr>
                `;
            });

            desktopTableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            mobileTableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            // Add summary statistics
            const delayedOrders = sortedOrders.filter(order => order.delayInfo.delayLevel > 0);
            const criticalOrders = sortedOrders.filter(order => order.delayInfo.delayLevel > 2);

            if (sortedOrders.length > 0) {
                const summaryHTML = `
                <div class="alert ${criticalOrders.length > 0 ? 'alert-danger' : delayedOrders.length > 0 ? 'alert-warning' : 'alert-success'} mt-3">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> Summary</h6>
                    <div class="d-flex justify-content-between">
                        <span><strong>Total:</strong> ${sortedOrders.length}</span>
                        <span><strong>Delayed:</strong> ${delayedOrders.length} (${Math.round(delayedOrders.length / sortedOrders.length * 100)}%)</span>
                        <span><strong>Critical:</strong> ${criticalOrders.length}</span>
                    </div>
                </div>
                `;

                desktopTableHTML += summaryHTML;

                // Simplified summary for mobile
                const mobileSummaryHTML = `
                <div class="alert ${criticalOrders.length > 0 ? 'alert-danger' : delayedOrders.length > 0 ? 'alert-warning' : 'alert-success'} mt-2 p-2">
                    <div class="d-flex justify-content-between">
                        <small><strong>Total:</strong> ${sortedOrders.length}</small>
                        <small><strong>Delayed:</strong> ${delayedOrders.length}</small>
                        <small><strong>Critical:</strong> ${criticalOrders.length}</small>
                    </div>
                </div>
                `;

                mobileTableHTML += mobileSummaryHTML;
            }

            // Update both desktop and mobile containers
            if (desktopTableContainer) desktopTableContainer.innerHTML = desktopTableHTML;
            if (mobileTableContainer) mobileTableContainer.innerHTML = mobileTableHTML;

            // Add event listeners to the delay comparison rows
            setTimeout(() => {
                document.querySelectorAll('.delay-comparison-row').forEach(row => {
                    row.addEventListener('click', handleDelayComparisonRowClick);
                });
            }, 100);
        }

        function calculateExactDelay(order) {
            console.log(`Calculating delay for order ${order.docId} with status ${order.status}`);

            const statusDurations = {
                preparing: 25,
                pending: 15,
                delivered: 0,
                'paid(online)': 0,
                'paid (cash)': 0
            };

            // Calculate elapsed time since order creation
            const now = new Date();
            const createdAt = order.createdAt || now;
            console.log(`Order ${order.docId} createdAt:`, createdAt);

            const elapsedMs = now - createdAt;
            const totalMinutes = Math.floor(elapsedMs / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            console.log(`Order ${order.docId} elapsed time: ${totalMinutes} minutes (${hours}h ${minutes}m)`);

            // Calculate expected time based on status
            const expectedMinutes = statusDurations[order.status] || 15;
            console.log(`Order ${order.docId} expected time: ${expectedMinutes} minutes`);

            // Calculate delay
            const delayMinutes = Math.max(0, totalMinutes - expectedMinutes);
            const delayLevel = delayMinutes > 0 ? Math.floor(delayMinutes / 5) + 1 : 0;
            console.log(`Order ${order.docId} delay: ${delayMinutes} minutes, level: ${delayLevel}`);

            return {
                totalMinutes,
                hours,
                minutes,
                expectedMinutes,
                delayMinutes,
                delayLevel
            };
        }

        // Order Modification Functions
        function createEditOrderItemRow(item, isCustom = false) {
            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            const row = document.createElement('div');
            row.className = 'd-flex gap-2 mb-2 align-items-center';

            // Check if this is a custom item
            isCustom = isCustom || (item && item.isCustom);

            if (isCustom) {
                // Add a data attribute to identify custom items
                row.dataset.customItem = 'true';

                // Create custom item row
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'form-control flex-grow-1';
                nameInput.placeholder = 'Custom Item Name';
                nameInput.required = true;
                nameInput.value = item ? item.name : ''; // Use item name if provided

                const priceInput = document.createElement('input');
                priceInput.type = 'number';
                priceInput.min = '0';
                priceInput.className = 'form-control';
                priceInput.placeholder = 'Price';
                priceInput.style.width = '120px';
                priceInput.required = true;
                priceInput.value = item ? item.price : '';

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.value = item ? item.quantity : 1;
                quantityInput.className = 'form-control';
                quantityInput.style.width = '80px';
                quantityInput.required = true;

                const priceDisplay = document.createElement('div');
                priceDisplay.style.minWidth = '80px';
                priceDisplay.textContent = item ? `${item.price * item.quantity}` : '0';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm';
                removeBtn.textContent = 'Remove';

                row.appendChild(nameInput);
                row.appendChild(priceInput);
                row.appendChild(quantityInput);
                row.appendChild(priceDisplay);
                row.appendChild(removeBtn);

                function updateCustomItemPrice() {
                    const price = parseInt(priceInput.value) || 0;
                    const quantity = parseInt(quantityInput.value) || 0;
                    const totalPrice = price * quantity;
                    priceDisplay.textContent = `${totalPrice}`;
                    updateOrderTotal('orderItemsContainer', 'orderTotal');
                }

                priceInput.addEventListener('input', updateCustomItemPrice);
                quantityInput.addEventListener('input', updateCustomItemPrice);

                removeBtn.addEventListener('click', () => {
                    row.remove();
                    updateTotal();
                });

                // Initialize price display
                updateCustomItemPrice();
            } else {
                // Regular menu item
                const itemSelect = document.createElement('select');
                itemSelect.className = 'form-select flex-grow-1';
                itemSelect.required = true;

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select Item';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                itemSelect.appendChild(defaultOption);

                for (const [id, menuItem] of Object.entries(state.menuItems)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = menuItem.name;
                    if (item && item.id == id) {
                        option.selected = true;
                    }
                    itemSelect.appendChild(option);
                }

                const portionSelect = document.createElement('select');
                portionSelect.className = 'form-select';
                portionSelect.required = true;
                portionSelect.style.width = '120px';

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.value = item ? item.quantity : 1;
                quantityInput.className = 'form-control';
                quantityInput.style.width = '80px';
                quantityInput.required = true;

                const priceDisplay = document.createElement('div');
                priceDisplay.style.minWidth = '80px';
                priceDisplay.textContent = '0';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm';
                removeBtn.textContent = 'Remove';

                row.appendChild(itemSelect);
                row.appendChild(portionSelect);
                row.appendChild(quantityInput);
                row.appendChild(priceDisplay);
                row.appendChild(removeBtn);

                function updatePortions() {
                    const itemId = itemSelect.value;
                    portionSelect.innerHTML = '';
                    if (itemId && state.menuItems[itemId]) {
                        const portions = state.menuItems[itemId].portions;
                        for (const [key, portion] of Object.entries(portions)) {
                            const option = document.createElement('option');
                            option.value = key;
                            // Add pieces information if available (check both pieces and portionPieces)
                            const pieces = portion.pieces || portion.portionPieces || 0;
                            const piecesInfo = pieces > 0 ? ` (${pieces} pcs)` : '';
                            option.textContent = `${portion.name}${piecesInfo} - ${portion.price}`;
                            if (item && item.portion === portion.name) {
                                option.selected = true;
                            }
                            portionSelect.appendChild(option);
                        }
                    }
                    updatePrice();
                }

                function updatePrice() {
                    const itemId = itemSelect.value;
                    const portionKey = portionSelect.value;
                    const quantity = parseInt(quantityInput.value) || 0;
                    
                    if (itemId && portionKey && state.menuItems[itemId]) {
                        const portionData = state.menuItems[itemId].portions[portionKey];
                        const price = portionData.price * quantity;
                        const pieces = portionData.pieces || portionData.portionPieces;
                        
                        if (pieces) {
                            const totalPieces = pieces * quantity;
                            priceDisplay.textContent = `${price} (${totalPieces} pcs)`;
                        } else {
                            priceDisplay.textContent = `${price}`;
                        }
                    } else {
                        priceDisplay.textContent = '0';
                    }
                    updateTotal();
                }

                itemSelect.addEventListener('change', () => {
                    updatePortions();
                });

                portionSelect.addEventListener('change', () => {
                    updatePrice();
                });

                quantityInput.addEventListener('input', () => {
                    updatePrice();
                });

                removeBtn.addEventListener('click', () => {
                    row.remove();
                    updateTotal();
                });

                updatePortions();
            }

            function updateTotal() {
                let total = 0;
                const rows = editOrderItemsContainer.querySelectorAll('div.d-flex');
                rows.forEach(r => {
                    const priceText = r.querySelector('div').textContent;
                    // Extract just the price part, ignoring any pieces information
                    const priceMatch = priceText.match(/(\d+)/);
                    const price = priceMatch ? parseInt(priceMatch[1]) : 0;
                    total += price;
                });
                document.getElementById('editOrderTotal').textContent = total;
            }

            return row;
        }

        async function showEditModal(docId) {
            const order = state.currentOrders.find(o => o.docId === docId);
            state.editingOrderId = docId;

            // Populate edit form with order details
            document.getElementById('editCustomerPhone').value = order.customerDetails.phone || '';
            document.getElementById('editCustomerComments').value = order.customerDetails.comments || '';

            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            editOrderItemsContainer.innerHTML = '';

            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    // Check if this is a custom item
                    const isCustomItem = item.isCustom === true;
                    const row = createEditOrderItemRow(item, isCustomItem);
                    editOrderItemsContainer.appendChild(row);
                });
            } else {
                const row = createEditOrderItemRow();
                editOrderItemsContainer.appendChild(row);
            }

            document.getElementById('editOrderTotal').textContent = order.total || 0;

            state.modals.editOrder.show();
        }

        async function handleOrderEdit(e) {
            e.preventDefault();

            const phone = document.getElementById('editCustomerPhone').value.trim();
            const comments = document.getElementById('editCustomerComments').value.trim();

            // Phone validation removed - now optional

            const items = [];
            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            const rows = editOrderItemsContainer.querySelectorAll('div.d-flex');

            if (rows.length === 0) {
                alert('Please add at least one order item.');
                return;
            }

            for (const row of rows) {
                // Check if this is a custom item
                const isCustomItem = row.dataset.customItem === 'true';

                if (isCustomItem) {
                    // Process custom item
                    const nameInput = row.querySelector('input[type="text"]');
                    const priceInput = row.querySelector('input[type="number"]:not([min="1"])'); // Price input has min="0"
                    const quantityInput = row.querySelector('input[type="number"][min="1"]'); // Quantity input has min="1"

                    const name = nameInput.value.trim();
                    const pricePerUnit = parseInt(priceInput.value) || 0;
                    const quantity = parseInt(quantityInput.value) || 1;

                    // Validate custom item details
                    if (!name || pricePerUnit <= 0) {
                        alert('Please fill all custom item details correctly.');
                        return;
                    }

                    // Create the item object with explicit property names
                    const customItem = {
                        isCustom: true,
                        name: name,
                        quantity: quantity,
                        price: pricePerUnit,
                        portion: 'Custom'
                    };

                    items.push(customItem);
                } else {
                    // Process regular menu item
                    const itemSelect = row.querySelector('select.form-select');
                    const portionSelect = row.querySelectorAll('select.form-select')[1];
                    const quantityInput = row.querySelector('input[type="number"]');
                    const itemId = itemSelect.value;
                    const portionKey = portionSelect.value;
                    const quantity = parseInt(quantityInput.value);

                    if (!itemId || !portionKey || !quantity || quantity <= 0) {
                        alert('Please fill all item details correctly.');
                        return;
                    }

                    const itemData = state.menuItems[itemId];
                    const portionData = itemData.portions[portionKey];

                    items.push({
                        id: itemId,
                        name: itemData.name,
                        portion: portionData.name,
                        quantity,
                        price: portionData.price,
                        pieces: portionData.pieces || null
                    });
                }
            }

            const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);

            try {
                // Prepare update data
                const updateData = {
                    customerDetails: { phone, comments },
                    items,
                    total,
                    cartName: state.cartName, // Ensure cartName is included
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // If we're viewing a historical date, allow updating the createdAt timestamp
                if (selectedDate) {
                    // Confirm if user wants to change the order date
                    const changeDate = confirm('Do you want to update this order\'s date to match the currently selected date?');

                    if (changeDate) {
                        // Use the selected date but keep current time
                        const now = new Date();
                        const historicalDate = new Date(selectedDate);
                        historicalDate.setHours(now.getHours());
                        historicalDate.setMinutes(now.getMinutes());
                        historicalDate.setSeconds(now.getSeconds());

                        updateData.createdAt = historicalDate;
                    }
                }

                await db.collection('bot_orders').doc(state.editingOrderId).update(updateData);
                alert('Order updated successfully.');
                state.modals.editOrder.hide();

                // Refresh the entire page to ensure all data loads properly
                window.location.reload();
            } catch (error) {
                alert('Error updating order: ' + error.message);
            }
        }

        // Existing Functions with Optimizations
        async function deleteOrder(docId) {
            if (confirm('Confirm deletion?')) {
                try {
                    await db.collection('bot_orders').doc(docId).delete();
                    alert('Order deleted successfully.');

                    // Refresh the entire page to ensure all data loads properly
                    window.location.reload();
                } catch (error) {
                    alert('Error deleting order: ' + error.message);
                }
            }
        }

        async function sendWhatsAppMessage(docId) {
    const order = state.currentOrders.find(o => o.docId === docId);
    if (!order) return;

    // Format order items
    const itemsText = order.items.map(item =>
        `${item.quantity}x ${item.name} (${item.portion}) - ${(item.price * item.quantity).toFixed(2)}`
    ).join('\n');

    // Create payment link in the same format as cart.html
    const paymentLink = `https://www.tandoorbaaz.shop/buy/pay.html?orderId=${order.docId}&amount=${order.total}`;
    
    // Create WhatsApp message
    const message = encodeURIComponent(
        `*Order #${(order.id || order.docId).slice(-4)}*\n\n` +
        `*Items:*\n${itemsText}\n\n` +
        `*Total:* ${order.total.toFixed(2)}\n` +
        `*Status:* ${order.status === 'delivered' ? 'Delivered (Pending Payment)' : order.status}\n\n` +
        `*Customer:* ${order.customerDetails.name || 'N/A'}\n` +
        `*Phone:* ${order.customerDetails.phone || 'N/A'}\n\n` +
        `*Payment Link:* ${paymentLink}\n\n` +
        `Please complete your payment of *${order.total.toFixed(2)}* using the link above. Thank you for your order!`
    );

    // Open WhatsApp with the message
    window.open(`https://wa.me/91${order.customerDetails.phone.replace(/\D/g, '')}?text=${message}`, '_blank');
}

async function updateOrderStatus(docId, newStatus) {
            try {
                console.log(`Updating order ${docId} status to ${newStatus}...`);

                await db.collection('bot_orders').doc(docId).update({
                    status: newStatus,
                    cartName: state.cartName, // Ensure cartName is included
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log(`Order ${docId} status updated to ${newStatus}`);

                // Clear alert for this order if it's no longer active
                if (!['pending', 'preparing'].includes(newStatus)) {
                    console.log(`Clearing alert for order ${docId} as it's now ${newStatus}`);
                    state.alertedOrders.delete(docId);

                    // If this was the current delay order, close the modal
                    if (state.currentDelayOrder && state.currentDelayOrder.docId === docId) {
                        console.log(`Closing delay alert modal for order ${docId}`);
                        state.currentDelayOrder = null;
                        const delayAlertModal = bootstrap.Modal.getInstance(document.getElementById('delayAlertModal'));
                        if (delayAlertModal) {
                            delayAlertModal.hide();
                        }
                    }
                }

                // Refresh the entire page to ensure all data loads properly
                window.location.reload();
            } catch (error) {
                alert('Error updating order status: ' + error.message);
            }
        }

        async function sendDelayMessage() {
            const order = state.currentDelayOrder;
            const orderIdStr = order.id ? order.id.toString() : order.docId;
            const message = `Your order #${orderIdStr.slice(-4)} is delayed. New ETA: ${calculateNewETA(order)}`;
            window.open(`https://wa.me/${order.customerDetails.phone}?text=${encodeURIComponent(message)}`, '_blank');

            // Close the modal and move focus to a safe element
            const delayAlertModal = document.getElementById('delayAlertModal');
            const refreshButton = document.querySelector('button.btn-primary[onclick="loadOrders()"]');

            // First hide the modal
            state.modals.delay.hide();

            // Then set focus to the refresh button after the modal is fully hidden
            delayAlertModal.addEventListener('hidden.bs.modal', function onHidden() {
                if (refreshButton) refreshButton.focus();
                // Remove the event listener after it's executed once
                delayAlertModal.removeEventListener('hidden.bs.modal', onHidden);
            }, { once: true });
        }

        function calculateNewETA(order) {
            const buffer = (order.delayLevel * 5) + 10;
            return new Date(Date.now() + buffer * 60000).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        }

        // Helper function to safely parse integers with a minimum value of 1
        function safeParseInt(value) {
            const parsed = parseInt(value);
            return isNaN(parsed) ? 1 : Math.max(1, parsed);
        }

        // Helper function to safely parse floats with a minimum value of 0
        function safeParseFloat(value) {
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : Math.max(0, parsed);
        }

        // Add remaining functions from previous versions with similar optimizations

        function saveVehicleNumber() {
            // Get the vehicle number from the input
            const vehicleNumber = document.getElementById('vehicleNumberInput').value.trim();

            // Save the vehicle number to the order
            if (state.vehicleOrderId && vehicleNumber) {
                db.collection('bot_orders').doc(state.vehicleOrderId).update({
                    vehicleNumber: vehicleNumber,
                    cartName: state.cartName, // Ensure cartName is included
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                    .then(() => {
                        console.log(`Vehicle number ${vehicleNumber} saved for order ${state.vehicleOrderId}`);
                    })
                    .catch(error => {
                        console.error('Error saving vehicle number:', error);
                    });
            }

            // Close the modal and move focus to a safe element
            const vehicleModal = document.getElementById('vehicleModal');
            const refreshButton = document.querySelector('button.btn-primary[onclick="loadOrders()"]');

            // First hide the modal
            state.modals.vehicle.hide();

            // Then set focus to the refresh button after the modal is fully hidden
            vehicleModal.addEventListener('hidden.bs.modal', function onHidden() {
                if (refreshButton) refreshButton.focus();
                // Remove the event listener after it's executed once
                vehicleModal.removeEventListener('hidden.bs.modal', onHidden);
            }, { once: true });
        }

        async function handleNewOrder(e) {
    e.preventDefault();

    // Get form data
    const phone = document.getElementById('customerPhone').value.trim();
    const comments = document.getElementById('customerComments').value.trim();

    // Get order items
    const items = [];
    const orderItemsContainer = document.getElementById('orderItemsContainer');
    const orderTotalElem = document.getElementById('orderTotal');
    const rows = orderItemsContainer.querySelectorAll('div.d-flex');

    // Process each item
    for (const row of rows) {
        // Check if this is a custom item
        const isCustomItem = row.dataset.customItem === 'true';

        if (isCustomItem) {
            // Process custom item
            const nameInput = row.querySelector('input[type="text"]');
            const priceInput = row.querySelector('input[type="number"]:not([min="1"])');
            const quantityInput = row.querySelector('input[type="number"][min="1"]');

            // Skip if no name or price is entered
            if (!nameInput || !priceInput || !nameInput.value.trim() || !priceInput.value) {
                continue;
            }

            const name = nameInput.value.trim();
            const pricePerUnit = parseFloat(priceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 1;

            // Only add if we have valid custom item details
            if (name && pricePerUnit > 0) {
                items.push({
                    isCustom: true,
                    name: name,
                    quantity: quantity,
                    price: pricePerUnit,
                    portion: 'Custom'
                });
            }
        } else {
            // Process regular menu item
            const itemSelect = row.querySelector('select.form-select');
            const portionSelect = row.querySelectorAll('select.form-select')[1];
            const quantityInput = row.querySelector('input[type="number"]');
            
            // Skip if no item is selected
            if (!itemSelect || !itemSelect.value) {
                continue;
            }
            
            const itemId = itemSelect.value;
            const portionKey = portionSelect ? portionSelect.value : null;
            const quantity = parseInt(quantityInput.value) || 1;

            // Only add if we have valid menu item details
            if (itemId && portionKey && quantity > 0) {
                const itemData = state.menuItems[itemId];
                if (itemData && itemData.portions && itemData.portions[portionKey]) {
                    const portionData = itemData.portions[portionKey];
                    items.push({
                        id: itemId,
                        name: itemData.name,
                        portion: portionData.name,
                        quantity: quantity,
                        price: portionData.price,
                        pieces: portionData.pieces || null
                    });
                }
            }
        }
    }

    // Check if we have any valid items
    if (items.length === 0) {
        alert('Please add at least one valid order item.');
        return;
    }

    // Calculate total
    const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);

    try {
        // First close the modal before the async operation
        const modal = bootstrap.Modal.getInstance(document.getElementById('addOrderModal'));
        if (modal) {
            modal.hide();
        }

        // Clean up any modal artifacts
        const modalBackdrops = document.querySelectorAll('.modal-backdrop');
        modalBackdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        document.body.style.removeProperty('overflow');

        // Add order to database with selected date if viewing historical data
        const orderData = {
            customerDetails: { phone, comments },
            items,
            total,
            cartName: state.cartName,
            status: 'pending',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Create a local timestamp to ensure immediate display
        const now = new Date();

        // If we're viewing a historical date, use that date for createdAt
        if (selectedDate) {
            const historicalDate = new Date(selectedDate);
            historicalDate.setHours(now.getHours());
            historicalDate.setMinutes(now.getMinutes());
            historicalDate.setSeconds(now.getSeconds());
            orderData.createdAt = historicalDate;
        } else {
            orderData.createdAt = now;
        }

        // Add the order to the database
        const newOrderRef = await db.collection('bot_orders').add(orderData);

        // Update with server timestamp in the background
        if (!selectedDate) {
            db.collection('bot_orders').doc(newOrderRef.id).update({
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(error => {
                console.warn('Error updating timestamps:', error);
            });
        }

        // Reset form
        e.target.reset();
        orderItemsContainer.innerHTML = '';
        orderTotalElem.textContent = '0';

        // Show success message
        alert('Order added successfully.');

        // Refresh the page
        window.location.reload();

    } catch (error) {
        alert('Error adding order: ' + error.message);
    }
}

        // handleOrderEdit function is already defined above

        // Add order form handling
        // Global function to update order totals
        function updateOrderTotal(containerId, totalElementId) {
            const container = document.getElementById(containerId);
            const totalElement = document.getElementById(totalElementId);
            let total = 0;

            if (container && totalElement) {
                const rows = container.querySelectorAll('div.d-flex');
                rows.forEach(r => {
                    const priceText = r.querySelector('div').textContent;
                    // Extract just the price part, ignoring any pieces information
                    const priceMatch = priceText.match(/(\d+)/);
                    const price = priceMatch ? parseInt(priceMatch[1]) : 0;
                    total += price;
                });
                totalElement.textContent = total;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const addOrderItemBtn = document.getElementById('addOrderItemBtn');
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            const orderTotalElem = document.getElementById('orderTotal');

            // Search functionality for pending orders
            const pendingSearchInput = document.getElementById('pendingOrdersSearchInput');
            const clearPendingSearchBtn = document.getElementById('clearPendingSearchBtn');
            const clearPendingSearchBtnMobile = document.getElementById('clearPendingSearchBtn-mobile');

            // Initialize search results count
            document.getElementById('pendingSearchResultsCount').textContent = state.currentOrders.length;

            // Add event listener for search input
            pendingSearchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                searchOrders(query);
                renderOrders();
            });

            // Add event listener for desktop clear button
            clearPendingSearchBtn.addEventListener('click', () => {
                pendingSearchInput.value = '';
                searchOrders('');
                renderOrders();
            });

            // Add event listener for mobile clear button
            clearPendingSearchBtnMobile.addEventListener('click', () => {
                pendingSearchInput.value = '';
                searchOrders('');
                renderOrders();
            });

            // Add keyboard shortcut (Ctrl+F or Cmd+F) to focus the search input
            document.addEventListener('keydown', (e) => {
                // Check if Ctrl+F or Cmd+F is pressed
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    // Prevent the default browser search
                    e.preventDefault();
                    // Focus the search input
                    pendingSearchInput.focus();
                }
            });

            function createOrderItemRow(item, isCustom = false) {
                const row = document.createElement('div');
                row.className = 'd-flex gap-2 mb-2 align-items-center';

                // Check if this is a custom item
                isCustom = isCustom || (item && item.isCustom);

                if (isCustom) {
                    // Add a data attribute to identify custom items
                    row.dataset.customItem = 'true';

                    // Create custom item row
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.className = 'form-control flex-grow-1';
                    nameInput.placeholder = 'Custom Item Name';
                    nameInput.required = true;
                    nameInput.value = item ? item.name : ''; // Use item name if provided

                    const priceInput = document.createElement('input');
                    priceInput.type = 'number';
                    priceInput.min = '0';
                    priceInput.className = 'form-control';
                    priceInput.placeholder = 'Price';
                    priceInput.style.width = '120px';
                    priceInput.required = true;
                    priceInput.value = item ? item.price : '';

                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.min = '1';
                    quantityInput.value = item ? item.quantity : 1;
                    quantityInput.className = 'form-control';
                    quantityInput.style.width = '80px';
                    quantityInput.required = true;

                    const priceDisplay = document.createElement('div');
                    priceDisplay.style.minWidth = '80px';
                    priceDisplay.textContent = item ? `${item.price * item.quantity}` : '0';

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-danger btn-sm';
                    removeBtn.textContent = 'Remove';

                    row.appendChild(nameInput);
                    row.appendChild(priceInput);
                    row.appendChild(quantityInput);
                    row.appendChild(priceDisplay);
                    row.appendChild(removeBtn);

                    function updateCustomItemPrice() {
                        const price = parseInt(priceInput.value) || 0;
                        const quantity = parseInt(quantityInput.value) || 0;
                        const totalPrice = price * quantity;
                        priceDisplay.textContent = `${totalPrice}`;
                        updateOrderTotal('orderItemsContainer', 'orderTotal');
                    }

                    priceInput.addEventListener('input', updateCustomItemPrice);
                    quantityInput.addEventListener('input', updateCustomItemPrice);

                    removeBtn.addEventListener('click', () => {
                        row.remove();
                        updateOrderTotal('orderItemsContainer', 'orderTotal');
                    });

                    // Initialize price display
                    updateCustomItemPrice();
                } else {
                    // Regular menu item
                    const itemSelect = document.createElement('select');
                    itemSelect.className = 'form-select flex-grow-1';
                    itemSelect.required = true;

                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Item';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    itemSelect.appendChild(defaultOption);

                    for (const [id, menuItem] of Object.entries(state.menuItems)) {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = menuItem.name;
                        if (item && item.id == id) {
                            option.selected = true;
                        }
                        itemSelect.appendChild(option);
                    }

                    const portionSelect = document.createElement('select');
                    portionSelect.className = 'form-select';
                    portionSelect.required = true;
                    portionSelect.style.width = '120px';

                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.min = '1';
                    quantityInput.value = item ? item.quantity : 1;
                    quantityInput.className = 'form-control';
                    quantityInput.style.width = '80px';
                    quantityInput.required = true;

                    const priceDisplay = document.createElement('div');
                    priceDisplay.style.minWidth = '80px';
                    priceDisplay.textContent = '0';

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-danger btn-sm';
                    removeBtn.textContent = 'Remove';

                    row.appendChild(itemSelect);
                    row.appendChild(portionSelect);
                    row.appendChild(quantityInput);
                    row.appendChild(priceDisplay);
                    row.appendChild(removeBtn);

                    function updatePortions() {
                        const itemId = itemSelect.value;
                        portionSelect.innerHTML = '';
                        if (itemId && state.menuItems[itemId]) {
                            const portions = state.menuItems[itemId].portions;
                            for (const [key, portion] of Object.entries(portions)) {
                                const option = document.createElement('option');
                                option.value = key;
                                // Add pieces information if available (check both pieces and portionPieces)
                                const pieces = portion.pieces || portion.portionPieces || 0;
                                const piecesInfo = pieces > 0 ? ` (${pieces} pcs)` : '';
                                option.textContent = `${portion.name}${piecesInfo} - ${portion.price}`;
                                portionSelect.appendChild(option);
                            }
                        }
                        updateOrderItemPrice();
                    }

                    function updateOrderItemPrice() {
                        const itemId = itemSelect.value;
                        const portionKey = portionSelect.value;
                        const quantity = parseInt(quantityInput.value) || 0;
                        if (itemId && portionKey && state.menuItems[itemId]) {
                            const portionData = state.menuItems[itemId].portions[portionKey];
                            const price = portionData.price * quantity;
                            
                            // Add pieces information to the price display if available (check both pieces and portionPieces)
                            const pieces = portionData.pieces || portionData.portionPieces;
                            if (pieces) {
                                const totalPieces = pieces * quantity;
                                priceDisplay.textContent = `${price} (${totalPieces} pcs)`;
                            } else {
                                priceDisplay.textContent = `${price}`;
                            }
                        } else {
                            priceDisplay.textContent = '0';
                        }
                        updateOrderTotal('orderItemsContainer', 'orderTotal');
                    }

                    function updateTotal() {
                        let total = 0;
                        const rows = orderItemsContainer.querySelectorAll('div.d-flex');
                        rows.forEach(r => {
                            const priceText = r.querySelector('div').textContent;
                            // Extract just the price part, ignoring any pieces information
                            const priceMatch = priceText.match(/(\d+)/);
                            const price = priceMatch ? parseInt(priceMatch[1]) : 0;
                            total += price;
                        });
                        orderTotalElem.textContent = total;
                    }

                    itemSelect.addEventListener('change', () => {
                        updatePortions();
                    });

                    portionSelect.addEventListener('change', () => {
                        updateOrderItemPrice();
                    });

                    quantityInput.addEventListener('input', () => {
                        updateOrderItemPrice();
                    });

                    removeBtn.addEventListener('click', () => {
                        row.remove();
                        updateOrderTotal('orderItemsContainer', 'orderTotal');
                    });

                    updatePortions();
                }

                return row;
            }

            addOrderItemBtn.addEventListener('click', () => {
                const row = createOrderItemRow();
                orderItemsContainer.appendChild(row);
            });

            // Add custom item button
            document.getElementById('addCustomOrderItemBtn').addEventListener('click', () => {
                const row = createOrderItemRow(null, true);
                orderItemsContainer.appendChild(row);
            });

            // Add an initial row when the modal is shown
            document.getElementById('addOrderModal').addEventListener('shown.bs.modal', () => {
                // Clear any existing items
                orderItemsContainer.innerHTML = '';
                // Add a fresh row
                const row = createOrderItemRow();
                orderItemsContainer.appendChild(row);
            });

            // Function to toggle dish cooked status
            window.toggleDishCookedStatus = async function (orderId, itemIndex, cookedStatus) {
                try {
                    console.log(`Toggling dish cooked status for order ${orderId}, item index ${itemIndex} to ${cookedStatus}`);

                    // First, get the current order to access the items array
                    const orderDoc = await db.collection('bot_orders').doc(orderId).get();
                    if (!orderDoc.exists) {
                        console.error(`Order ${orderId} not found`);
                        return;
                    }

                    const orderData = orderDoc.data();
                    if (!orderData.items || !Array.isArray(orderData.items) || itemIndex >= orderData.items.length) {
                        console.error(`Invalid items array or item index for order ${orderId}`);
                        return;
                    }

                    // Create a copy of the items array
                    const updatedItems = [...orderData.items];

                    // Update the cooked status of the specific item
                    updatedItems[itemIndex] = {
                        ...updatedItems[itemIndex],
                        cooked: cookedStatus
                    };

                    // Update the order in Firestore
                    await db.collection('bot_orders').doc(orderId).update({
                        items: updatedItems,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log(`Dish cooked status updated for order ${orderId}, item index ${itemIndex}`);

                    // Refresh the entire page to ensure all data loads properly
                    window.location.reload();
                } catch (error) {
                    console.error(`Error updating dish cooked status:`, error);
                    alert(`Error updating dish status: ${error.message}`);
                }
            };
        });

        // Initialize store selector and update store name in header
        document.addEventListener('DOMContentLoaded', function () {
            // Set the current store in the dropdown and enhance the selected option
            const storeSelectors = ['storeSelector-mobile', 'storeSelector-desktop'];
            storeSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    // Set the current value
                    selector.value = cartName;

                    // Enhance the dropdown options to show the current store more clearly
                    Array.from(selector.options).forEach(option => {
                        if (option.value === cartName) {
                            option.textContent = ` ${option.textContent} (Current)`;
                            option.style.fontWeight = 'bold';
                            option.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
                        }
                    });

                    // Add a title attribute for better UX
                    selector.title = `Currently viewing: ${getStoreName(cartName)}`;
                }
            });

            // Update store name in the header with enhanced styling
            const storeDisplayName = getStoreName(cartName);
            const storeNameElements = ['storeName-mobile', 'storeName-desktop'];
            storeNameElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = storeDisplayName;

                    // Add a tooltip for clarity
                    element.title = `Currently viewing orders for ${storeDisplayName}`;
                }
            });

            // Add a visual indicator of current store in the page
            const currentStoreIndicator = document.createElement('div');
            currentStoreIndicator.className = 'alert alert-info alert-dismissible fade show mb-3';
            currentStoreIndicator.innerHTML = `
                <strong><i class="bi bi-info-circle-fill me-2"></i>Currently viewing:</strong> 
                <span class="badge bg-primary ms-2 p-2">${storeDisplayName}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            // Insert the indicator at the top of the content area
            const contentArea = document.querySelector('.container-fluid');
            if (contentArea) {
                contentArea.insertBefore(currentStoreIndicator, contentArea.firstChild);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(currentStoreIndicator);
                    bsAlert.close();
                }, 5000);
            }
        });
    </script>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-bottom-nav d-md-none">
        <a href="#" class="nav-item" id="nav-home" onclick="switchTab('home'); return false;">
            <i class="bi bi-house-door"></i>
            <span>Orders</span>
        </a>
        <a href="#" class="nav-item" id="nav-summary" onclick="switchTab('summary'); return false;">
            <i class="bi bi-graph-up"></i>
            <span>Summary</span>
        </a>
        <a href="#" class="nav-item" id="nav-completed" onclick="switchTab('completed'); return false;">
            <i class="bi bi-check-circle"></i>
            <span>Completed</span>
        </a>
        <a href="#" class="nav-item" data-bs-toggle="modal" data-bs-target="#qrCodeModal">
            <i class="bi bi-qr-code-scan"></i>
            <span>QR</span>
        </a>
        <a href="#" class="nav-item" onclick="document.getElementById('newOrderBtn').click(); return false;">
            <i class="bi bi-plus-circle"></i>
            <span>New</span>
        </a>
    </div>

    <!-- Mobile Floating Action Button -->
    <button class="mobile-fab d-md-none" onclick="document.getElementById('newOrderBtn').click();">
        <i class="bi bi-plus-lg"></i>
    </button>

    <script>
        // Tab switching functionality for mobile
        function switchTab(tabName) {
            // Hide all content sections first
            document.getElementById('home-content').style.display = 'none';
            document.getElementById('summary-content').style.display = 'none';
            document.getElementById('completed-content').style.display = 'none';

            // Remove active class from all nav items
            document.querySelectorAll('.mobile-bottom-nav .nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show the selected content and mark nav item as active
            document.getElementById(`${tabName}-content`).style.display = 'block';
            document.getElementById(`nav-${tabName}`).classList.add('active');

            // Refresh data if needed
            if (tabName === 'summary') {
                // Update the delay comparison data
                showDelayComparison();

                // Keep the delay section collapsed by default on mobile
                if (window.innerWidth < 768) {
                    const mobileDelaySection = document.getElementById('mobileDelaySection');
                    if (mobileDelaySection) {
                        mobileDelaySection.style.display = 'none';
                    }

                    const delayToggleIcon = document.getElementById('delayToggleIcon');
                    if (delayToggleIcon) {
                        delayToggleIcon.classList.remove('bi-chevron-up');
                        delayToggleIcon.classList.add('bi-chevron-down');
                    }
                }
            } else if (tabName === 'completed') {
                // Keep completed orders sections collapsed by default
                document.getElementById('paidOrdersSection').style.display = 'none';
                document.getElementById('deliveredOrdersSection').style.display = 'none';

                // Update toggle icons to show collapsed state
                document.getElementById('paidOrdersToggleIcon').classList.remove('bi-chevron-up');
                document.getElementById('paidOrdersToggleIcon').classList.add('bi-chevron-down');
                document.getElementById('deliveredOrdersToggleIcon').classList.remove('bi-chevron-up');
                document.getElementById('deliveredOrdersToggleIcon').classList.add('bi-chevron-down');
            }

            // Scroll to top for better UX
            window.scrollTo(0, 0);
        }

        // Initialize the tabs on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Set home tab as active by default
            setTimeout(() => {
                switchTab('home');
            }, 100);
        });
    </script>
</body>

</html>