<!DOCTYPE html>
<html lang="en">

<head>
    <title>TandoorBaaz - Dish Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            height: 100vh;
            overflow-x: hidden;
        }

        .container-fluid {
            padding: 0.125rem;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 0.125rem;
            flex-shrink: 0;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #6610f2 100%);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            border: none;
            padding: 0.5rem;
        }

        .header-card {
            flex-shrink: 0;
            margin-bottom: 0.25rem;
        }

        /* Enhanced Tabs Styling */
        .header-card #menuTabs.nav-tabs {
            --tb-tab-active-bg: #ffffff;
            --tb-tab-active-color: #0d6efd;
            --tb-tab-inactive-color: #0b5ed7; /* brand blue for visibility */
            --tb-tab-border: rgba(13, 110, 253, 0.25);
            border-bottom: none;
            gap: 0.5rem;
        }
        .header-card #menuTabs .nav-link {
            color: var(--tb-tab-inactive-color);
            background: rgba(13, 110, 253, 0.06);
            border: 1px solid var(--tb-tab-border);
            border-radius: 999px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .header-card #menuTabs .nav-link:hover {
            color: #0d6efd;
            background: rgba(13, 110, 253, 0.08);
            border-color: rgba(13, 110, 253, 0.2);
        }
        .header-card #menuTabs .nav-link:focus-visible {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }
        .header-card #menuTabs .nav-link.active {
            color: var(--tb-tab-active-color);
            background: var(--tb-tab-active-bg);
            border-color: var(--tb-tab-active-bg);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.25);
            position: relative;
        }
        .header-card #menuTabs .nav-link.active::after {
            content: '';
            position: absolute;
            left: 10%;
            right: 10%;
            bottom: -6px;
            height: 4px;
            border-radius: 4px;
            background: linear-gradient(90deg, #0d6efd, #6610f2);
        }
        .header-card #menuTabs .nav-link i { color: inherit; }

        /* Dishes and Ingredients Containers */
        /* Main content area */
        .tab-content {
            flex: 1;
            min-height: 0;
            background: #f8f9fa;
        }

        /* Dishes and Ingredients Containers */
        .dishes-list,
        .ingredients-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        /* Dish item styling */
        .dish-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .dish-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .dish-item {
            background: white;
            border: none;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            margin-bottom: 0.75rem;
            padding: 1rem;
            transition: all 0.2s ease;
            border-left: 4px solid var(--primary-color);
        }

        .dish-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .dish-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .dish-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            margin: 0;
            flex-grow: 1;
        }

        .dish-status {
            margin-left: 0.5rem;
        }

        .dish-info {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .dish-category {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .dish-pricing {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .price-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .price-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .cost-price {
            color: #dc3545;
        }

        .selling-price {
            color: #198754;
        }

        .profit-margin {
            color: #0d6efd;
        }

        .dish-ingredients {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .ingredient-tag {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 0.2rem 0.4rem;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #495057;
        }

        .dish-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Pagination styling */
        .pagination-container {
            flex-shrink: 0;
            padding: 1rem;
            text-align: center;
            background: white;
            border-top: 1px solid #dee2e6;
            position: sticky;
            bottom: 0;
            z-index: 10;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: block !important; /* Force display */
            visibility: visible !important; /* Force visibility */
            opacity: 1 !important; /* Force opacity */
            min-height: 60px; /* Ensure minimum height */
        }

        .pagination {
            justify-content: center;
            margin: 0 0 0.5rem 0;
        }
        
        .pagination .page-item {
            margin: 0 2px;
        }
        
        .pagination .page-link {
            min-width: 36px;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            color: #0d6efd;
            transition: all 0.2s ease;
        }
        
        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        
        .pagination .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #fff;
            border-color: #dee2e6;
        }
        
        .pagination .page-link:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
        }
        
        .pagination .page-item.active .page-link:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        
        .pagination-info {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        /* Ensure content doesn't overflow */
        .container-fluid {
            min-height: 0;
            overflow: hidden;
        }
        
        /* Ensure pagination is visible */
        .pagination {
            margin: 0;
        }
        
        /* Fix for tab content height */
        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .tab-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .ingredients-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Responsive vendor grid to utilize full width */
        .vendor-grid {
            display: grid;
        }

        .ingredient-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .ingredient-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .ingredient-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            margin: 0;
        }

        /* Vendor Header (Ingredients grouping) */
        .vendor-header {
            background: rgba(13, 110, 253, 0.06);
            border: 1px solid rgba(13, 110, 253, 0.15);
            border-radius: 8px;
            padding: 0.35rem 0.5rem;
        }

        .vendor-group {
            background: #ffffff;
            border: 1px solid #e7eaf0;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            padding: 0.5rem;
        }

        .vendor-items {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ingredient-info {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .ingredient-pricing {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-info {
            text-align: left;
        }

        .ingredient-actions {
            display: flex;
            gap: 0.5rem;
        }

        .cost-info {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .profit-margin-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .table-responsive {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0.5rem;
            }

            .header-card {
                padding: 0.75rem !important;
            }

            .dish-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .dish-status {
                margin-left: 0;
                margin-top: 0.25rem;
            }

            .dish-pricing {
                flex-wrap: wrap;
                gap: 0.75rem;
            }

            .dish-actions {
                justify-content: stretch;
            }

            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table {
                min-width: 600px;
            }

            .ingredients-list {
                grid-template-columns: 1fr;
            }

            .ingredient-pricing {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .ingredient-actions {
                align-self: flex-end;
            }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .selected-ingredient {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-ingredient .btn {
            padding: 0.25rem 0.5rem;
        }

        .dish-description {
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }
        
        .dish-image-container {
            height: 180px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .dish-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .dish-card:hover .dish-image {
            transform: scale(1.05);
        }
        
        /* Ingredients section styling */
        .ingredients-list {
            flex: 1;
            overflow-y: auto;
            max-height: 60vh;
            padding: 1rem;
        }
        
        /* Expand columns to show more items */
        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Vendor group headers */
        .vendor-group {
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .vendor-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            padding: 0.75rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        
        .vendor-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .vendor-actions .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        /* Ingredient cards */
        .ingredient-card {
            height: 100%;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .ingredient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .ingredient-card .card-body {
            padding: 1rem;
        }
        
        .ingredient-card .card-title {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .ingredient-card .card-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.75rem;
        }
        
        .ingredient-card .ingredient-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f1f1f1;
        }
        
        .ingredient-card .price {
            font-weight: 600;
            color: #198754;
        }
        
        .ingredient-card .stock-status {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .stock-in {
            color: #198754;
        }
        
        .stock-low {
            color: #fd7e14;
        }
        
        .stock-out {
            color: #dc3545;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Compact Header with All Controls in Single Line -->
        <div class="card header-card p-2">
            <div class="d-flex justify-content-between align-items-center gap-3 flex-wrap">
                <!-- Title -->
                <div class="d-flex align-items-center gap-2 flex-shrink-0">
                    <h5 class="mb-0"><i class="bi bi-shop"></i> Menu</h5>
                </div>

                <!-- Filters -->
                <div class="flex-shrink-0"><!-- Filters removed --></div>

                <!-- Search -->
                <div class="d-flex align-items-center gap-2 flex-grow-1" style="max-width: 250px;">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search...">
                    </div>
                </div>

                <!-- Actions -->
                <div class="nav nav-tabs border-0 flex-shrink-0" id="menuTabs" role="tablist">
                    <button class="nav-link active px-3" id="dishes-tab" data-bs-toggle="tab"
                        data-bs-target="#dishes-section" type="button" role="tab">
                        <i class="bi bi-egg-fried"></i> Dishes
                    </button>
                    <button class="nav-link px-3" id="ingredients-tab" data-bs-toggle="tab"
                        data-bs-target="#ingredients-section" type="button" role="tab">
                        <i class="bi bi-basket"></i> Ingredients
                    </button>
                    <button id="addNewItemBtn" class="btn btn-primary btn-sm" title="Add New Item">
                        <i class="bi bi-plus"></i> <span id="addButtonText">Add Dish</span>
                    </button>
                </div>

                </div>
                
                <div class="tab-content flex-grow-1 d-flex flex-column overflow-hidden" id="menuTabsContent">
                    <!-- Dishes Tab -->
                    <div class="tab-pane fade show active h-100" id="dishes-section" role="tabpanel" aria-labelledby="dishes-tab">
                        <div class="d-flex flex-column h-100">
                            <div id="menuListContainer" class="dishes-list flex-grow-1 overflow-auto p-3">
                                <!-- Dishes will be rendered here -->
                            </div>
                            <div id="dishesPagination" class="d-flex justify-content-center p-2 border-top">
                                <!-- Dishes pagination will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ingredients Tab -->
                    <div class="tab-pane fade h-100" id="ingredients-section" role="tabpanel" aria-labelledby="ingredients-tab">
                        <div class="d-flex flex-column h-100">
                            <div id="ingredientsListContainer" class="ingredients-list flex-grow-1 overflow-auto p-3">
                                <!-- Ingredients will be rendered here -->
                            </div>
                            <div id="ingredientsPagination" class="d-flex justify-content-center p-2 border-top">
                                <!-- Ingredients pagination will be rendered here -->
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Add/Edit Dish Modal -->
    <div class="modal fade" id="dishModal" tabindex="-1" aria-labelledby="dishModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold" id="dishModalLabel">Add New Dish</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dishForm">
                        <input type="hidden" id="dishId" value="">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dishName" class="form-label">Dish Name *</label>
                                    <input type="text" class="form-control" id="dishName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="dishPhotoUrl" class="form-label">Photo URL</label>
                                    <input type="url" class="form-control" id="dishPhotoUrl" placeholder="https://example.com/image.jpg">
                                    <div class="form-text">Paste a direct image URL for this dish</div>
                                </div>

                                <div class="mb-3">
                                    <!-- Category removed -->
                                </div>

                                <div class="mb-3">
                                    <label for="dishDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="dishDescription" rows="3"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label for="dishCostPrice" class="form-label">Cost Price *</label>
                                            <input type="number" class="form-control" id="dishCostPrice" step="0.01" readonly>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label class="form-label" for="portionModeSelect">Portion</label>
                                            <select id="portionModeSelect" class="form-select mb-2">
                                                <option value="full" selected>FULL (default)</option>
                                                <option value="half">HALF</option>
                                            </select>
                                            <div id="sellingPriceGroup">
                                                <label for="dishSellingPrice" class="form-label">Selling Price *</label>
                                                <input type="number" class="form-control" id="dishSellingPrice" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Calculated Portions (noise removed) -->
                                <div class="mb-3">
                                    <label class="form-label">Calculated Portions</label>
                                    <div class="row g-2 align-items-end" style="display:none">
                                        <!-- Hidden manual editor to reduce noise but keep DOM stable -->
                                        <div class="col-4">
                                            <label class="form-label">Portion Name</label>
                                            <input type="text" class="form-control" id="portionNameInput" placeholder="HALF">
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">Price (₹)</label>
                                            <input type="number" class="form-control" id="portionPriceInput" min="0" step="1" placeholder="149" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label">Pieces</label>
                                            <input type="number" class="form-control" id="portionPiecesInput" min="0" step="1" placeholder="optional" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                                        </div>
                                        <div class="col-1 d-grid">
                                            <button type="button" id="addPortionBtn" class="btn btn-primary"><i class="bi bi-plus"></i></button>
                                        </div>
                                    </div>
                                    <div class="mt-2 d-flex gap-2" style="display:none">
                                        <button type="button" id="quickAddHalfBtn" class="btn btn-outline-secondary btn-sm">Add HALF</button>
                                        <button type="button" id="quickAddFullBtn" class="btn btn-outline-secondary btn-sm" disabled title="FULL is default via Selling Price">Add FULL (default via Selling Price)</button>
                                    </div>
                                    <div id="portionsListContainer" class="mt-2"></div>
                                </div>
                                <div class="mb-3 form-check">
                                    <!-- Active flag removed -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Add Ingredient</label>
                                    <div class="input-group mb-2">
                                        <select class="form-select" id="ingredientSelect">
                                            <option value="">Select Ingredient</option>
                                        </select>
                                        <input type="number" class="form-control" id="ingredientQuantity" placeholder="Qty" step="1" min="1" value="1" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                                        <select class="form-select" id="dishIngredientUnit" style="max-width: 140px;">
                                            <option value="">Select unit</option>
                                        </select>
                                        <button id="addIngredientBtn" class="btn btn-primary" type="button">
                                            <i class="bi bi-plus"></i> Add
                                        </button>
                                    </div>
                                    <div id="ingredientDetails" class="d-flex justify-content-between align-items-center p-2 bg-light rounded" style="display: none !important;">
                                        <div class="text-muted">Cost per unit: <strong>₹<span id="ingredientCost">0</span>/<span id="ingredientUnit">unit</span></strong></div>
                                        <div>Total: <strong>₹<span id="ingredientTotalCost">0</span></strong></div>
                                    </div>
                                    </div>
                                    <div id="selectedIngredients" class="mt-2">
                                        <!-- Selected ingredients will be added here -->
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                                        <button type="button" class="btn btn-outline-secondary" id="cancelDishBtn">
                                            <i class="bi bi-x-lg me-1"></i> Cancel
                                        </button>
                                        <button id="saveDishBtn" type="button" class="btn btn-primary">
                                            <i class="bi bi-save me-1"></i> Save Dish
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Ingredient Modal -->
    <div class="modal fade" id="ingredientModal" tabindex="-1" aria-labelledby="ingredientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ingredientModalLabel">Add New Ingredient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="ingredientForm">
                        <input type="hidden" id="ingredientId" value="">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ingredientName" class="form-label">Ingredient Name *</label>
                                    <input type="text" class="form-control" id="ingredientName" required>
                                </div>

                                <div class="mb-3">
                                    <!-- Category removed -->
                                </div>

                                <div class="mb-3">
                                    <label for="ingredientUnitType" class="form-label">Unit Type</label>
                                    <select class="form-select" id="ingredientUnitType" required>
                                        <option value="">Select unit type</option>
                                        <option value="weight">Weight (g, kg, oz, lb)</option>
                                        <option value="volume">Volume (ml, l, tsp, tbsp, cup)</option>
                                        <option value="piece">Piece (pc, doz, pk)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="ingredientUnit" class="form-label">Unit</label>
                                    <select class="form-select" id="ingredientUnit" required>
                                        <option value="">Select unit type first</option>
                                    </select>
                                </div>
                                <div id="densityContainer" class="mb-3" style="display: none;">
                                    <label for="ingredientDensity" class="form-label">Density (g/ml)</label>
                                    <input type="number" step="0.01" min="0.1" class="form-control" id="ingredientDensity" value="1">
                                    <div class="form-text">Weight in grams per milliliter of volume</div>
                                </div>
                                <div id="pieceWeightContainer" class="mb-3" style="display: none;">
                                    <label for="ingredientPieceWeight" class="form-label">Average Weight per Piece (g)</label>
                                    <input type="number" step="0.1" min="0.1" class="form-control" id="ingredientPieceWeight">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ingredientCostPerUnit" class="form-label">Cost per Unit *</label>
                                    <input type="number" class="form-control" id="ingredientCostPerUnit" step="0.01" required>
                                </div>
                                <div class="mb-3 form-check">
                                    <!-- Active flag removed -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success">Save Ingredient</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Vendor Modal -->
    <div class="modal fade" id="vendorModal" tabindex="-1" aria-labelledby="vendorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vendorModalLabel">Add New Vendor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="vendorForm">
                        <input type="hidden" id="vendorId" value="">
                        <div class="mb-3">
                            <label for="vendorName" class="form-label">Vendor Name *</label>
                            <input type="text" class="form-control" id="vendorName" required>
                        </div>
                        <div class="mb-3">
                            <label for="vendorDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="vendorDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="vendorContact" class="form-label">Contact Information</label>
                            <input type="text" class="form-control" id="vendorContact">
                        </div>
                        <div class="mb-3">
                            <label for="vendorAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="vendorAddress" rows="2"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="vendorActive" checked>
                            <label class="form-check-label" for="vendorActive">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveVendorBtn">Save Vendor</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            UNITS: {
                weight: [
                    { name: 'mg', toBase: 0.001, displayName: 'Milligram (mg)' },
                    { name: 'g', toBase: 1, displayName: 'Gram (g)' },
                    { name: 'kg', toBase: 1000, displayName: 'Kilogram (kg)' },
                    { name: 'oz', toBase: 28.35, displayName: 'Ounce (oz)' },
                    { name: 'lb', toBase: 453.592, displayName: 'Pound (lb)' },
                ],
                volume: [
                    { name: 'ml', toBase: 1, displayName: 'Milliliter (ml)' },
                    { name: 'l', toBase: 1000, displayName: 'Liter (l)' },
                    { name: 'tsp', toBase: 5, displayName: 'Teaspoon (tsp)' },
                    { name: 'tbsp', toBase: 15, displayName: 'Tablespoon (tbsp)' },
                    { name: 'fl-oz', toBase: 29.574, displayName: 'Fluid Ounce (fl oz)' },
                    { name: 'cup', toBase: 240, displayName: 'Cup (cup)' },
                    { name: 'pt', toBase: 473.176, displayName: 'Pint (pt)' },
                    { name: 'qt', toBase: 946.353, displayName: 'Quart (qt)' },
                    { name: 'gal', toBase: 3785.41, displayName: 'Gallon (gal)' },
                ],
                piece: [
                    { name: 'pc', toBase: 1, displayName: 'Piece (pc)' },
                    { name: 'doz', toBase: 12, displayName: 'Dozen (doz)' },
                    { name: 'pk', toBase: 24, displayName: 'Pack (pk)' }
                ]
            },
            CATEGORIES: [
                { id: 'starters', name: 'Starters', description: 'Appetizers and small dishes' },
                { id: 'main-course', name: 'Main Course', description: 'Main dishes' },
                { id: 'breads', name: 'Breads', description: 'Various types of breads' },
                { id: 'rice', name: 'Rice Dishes', description: 'Biryani and other rice preparations' },
                { id: 'desserts', name: 'Desserts', description: 'Sweet dishes' },
                { id: 'beverages', name: 'Beverages', description: 'Drinks and beverages' },
                { id: 'combos', name: 'Combos', description: 'Meal combos' }
            ],
            INGREDIENT_CATEGORIES: [
                { id: 'vegetables', name: 'Vegetables', description: 'Fresh vegetables' },
                { id: 'meat', name: 'Meat', description: 'Chicken, mutton, and other meats' },
                { id: 'dairy', name: 'Dairy', description: 'Milk, cheese, and other dairy products' },
                { id: 'spices', name: 'Spices', description: 'Herbs and spices' },
                { id: 'grains', name: 'Grains', description: 'Rice, wheat, and other grains' },
                { id: 'oils', name: 'Oils & Fats', description: 'Cooking oils and fats' },
                { id: 'others', name: 'Others', description: 'Miscellaneous ingredients' },
            ],
            SETTINGS: {
                version: '1.0.0',
                currency: 'INR',
                defaultProfitMargin: 100,
                defaultPortions: {
                    full: { name: 'Full', multiplier: 1 },
                    half: { name: 'Half', multiplier: 0.5 },
                    mini: { name: 'Mini', multiplier: 0.3 }
                },
            }
        };

        // Application State
        let menuData = {
            ...CONFIG.SETTINGS,
            lastUpdated: new Date().toISOString(),
            categories: [...CONFIG.CATEGORIES],
            ingredientCategories: [...CONFIG.INGREDIENT_CATEGORIES],
            units: { ...CONFIG.UNITS },
            ingredients: [],
            dishes: [],
            inventory: []
        };

        let currentTab = 'dishes';
        let editingDishId = null;
        let editingIngredientId = null;
        let selectedIngredients = [];
        let dishPortions = {}; // key -> { name, price, pieces }
        let filteredDishes = [];
        let filteredIngredients = [];
        let sellingPriceTouched = false; // track manual edits to selling price
        

        // Utility function to round numbers to whole numbers
        function roundToWholeNumber(value) {
            return Math.round(Number(value) || 0);
        }

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Update add button text based on active tab
            function updateAddButtonText() {
                const addButtonText = document.getElementById('addButtonText');
                if (!addButtonText) return;
                
                if (currentTab === 'dishes') {
                    addButtonText.textContent = 'Add Dish';
                } else if (currentTab === 'ingredients') {
                    addButtonText.textContent = 'Add Ingredient';
                }
            }

            // Update button text when tab changes
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    if (targetId === '#dishes-section') {
                        currentTab = 'dishes';
                        renderDishes();
                    } else if (targetId === '#ingredients-section') {
                        currentTab = 'ingredients';
                        renderIngredients();
                    }
                    
                    updateAddButtonText();
                });
            });
            
            // Initial button text setup
            updateAddButtonText();
        });

        // Initialize the application
        async function init() {
            console.debug('[Menu] init: starting');
            // Set up event listeners
            setupEventListeners();
            
            // Load data
            await loadData();
            
            // Initialize UI post data load
            updateCategoryFilter();
            populateIngredientSelect();
            console.debug('[Menu] init: finished');
        }

        // Set up event listeners
        function setupEventListeners() {
            console.debug('[Event Listeners] Setting up event listeners');
            
            // Safe event listener helper function
            const safeAddEventListener = (selector, event, callback, parent = document) => {
                const element = parent.querySelector(selector);
                if (element) {
                    element.addEventListener(event, callback);
                    console.debug(`[Event Listeners] Added ${event} listener to ${selector}`);
                } else {
                    console.warn(`[Event Listeners] Element not found: ${selector}`);
                }
            };

            // Tab switching
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    console.debug(`[Tab Change] Switched to tab: ${targetId}`);
                    
                    if (targetId === '#dishes-section') {
                        currentTab = 'dishes';
                        renderDishes();
                    } else if (targetId === '#ingredients-section') {
                        currentTab = 'ingredients';
                        renderIngredients();
                    }
                    
                    updateCategoryFilter();
                    updateAddButtonText();
                });
            });

            // Search input
            safeAddEventListener('#searchInput', 'input', applyFilters);
            
            // Reset filters button - only add if element exists
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetFilters);
                console.debug('[Event Listeners] Added click listener to reset button');
            }
            
            // Export data button - only add if element exists
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', downloadMenuData);
                console.debug('[Event Listeners] Added click listener to export button');
            }
            
            // Add dish button
            safeAddEventListener('#addNewItemBtn', 'click', openDishModal);
            
            // Add ingredient to dish button - only add if element exists
            const addIngredientBtn = document.getElementById('addIngredientBtn');
            if (addIngredientBtn) {
                addIngredientBtn.addEventListener('click', addIngredientToDish);
                console.debug('[Event Listeners] Added click listener to add ingredient button');
            }
            
            // Handle Enter key in quantity field
            document.getElementById('ingredientQuantity').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addIngredientToDish();
                }
            });
            
            // Add event listeners for ingredient selection and quantity changes
            const ingredientSelectEl = document.getElementById('ingredientSelect');
            const ingredientQuantityEl = document.getElementById('ingredientQuantity');
            const dishIngredientUnitEl = document.getElementById('dishIngredientUnit');
            
            if (ingredientSelectEl) {
                ingredientSelectEl.addEventListener('change', updateDishIngredientUnitOptions);
            }
            
            if (ingredientQuantityEl) {
                ingredientQuantityEl.addEventListener('input', updateIngredientCost);
                ingredientQuantityEl.addEventListener('change', updateIngredientCost);
            }
            
            if (dishIngredientUnitEl) {
                dishIngredientUnitEl.addEventListener('change', updateIngredientCost);
            }
            
            // Initialize modals
            const dishModal = new bootstrap.Modal(document.getElementById('dishModal'));
            
            // Save dish button with enhanced validation
            document.getElementById('saveDishBtn').addEventListener('click', async function() {
                const saveBtn = document.getElementById('saveDishBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Saving...';
                
                try {
                    // Validate form
                    const name = document.getElementById('dishName').value.trim();
                    const sellingPrice = parseFloat(document.getElementById('dishSellingPrice').value);
                    
                    if (!name) {
                        showToast('Error', 'Please enter a dish name', 'danger');
                        document.getElementById('dishName').focus();
                        return;
                    }
                    
                    if (isNaN(sellingPrice) || sellingPrice <= 0) {
                        showToast('Error', 'Please enter a valid selling price', 'danger');
                        document.getElementById('dishSellingPrice').focus();
                        return;
                    }
                    
                    if (selectedIngredients.length === 0) {
                        showToast('Error', 'Please add at least one ingredient', 'danger');
                        return;
                    }
                    
                    await saveDish();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('dishModal'));
                    if (modal) modal.hide();
                    resetDishForm();
                    showToast('Success', 'Dish saved successfully!', 'success');
                } catch (e) {
                    console.error('[Menu] Error saving dish:', e);
                    showToast('Error', 'Failed to save dish. ' + (e.message || 'Please try again.'), 'danger');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            });
            
            // Cancel dish button
            document.getElementById('cancelDishBtn').addEventListener('click', function() {
                dishModal.hide();
                resetDishForm();
            });
            
            // Reset form when modal is closed
            document.getElementById('dishModal').addEventListener('hidden.bs.modal', function() {
                resetDishForm();
            });
            
            
            // Save ingredient button
            document.querySelector('#ingredientModal .btn-success').addEventListener('click', saveIngredient);
            
            // Unit type change
            document.getElementById('ingredientUnitType').addEventListener('change', function() {
                updateUnitSelectForType(this.value);
                toggleIngredientFields(this.value);
            });
            
            // Portion mode behavior
            const portionModeSelect = document.getElementById('portionModeSelect');
            const sellingPriceInput = document.getElementById('dishSellingPrice');
            if (portionModeSelect && sellingPriceInput) {
                portionModeSelect.addEventListener('change', () => {
                    const mode = portionModeSelect.value;
                    if (mode === 'half') {
                        sellingPriceInput.disabled = true;
                        showToast('Info', 'FULL is set via Selling Price. To price HALF, use Add Portion and set HALF price.', 'info');
                    } else {
                        sellingPriceInput.disabled = false;
                    }
                });
                // Update FULL display live when selling price changes
                sellingPriceInput.addEventListener('input', () => {
                    sellingPriceTouched = true;
                    renderPortionsList();
                });
            }

            // Portions: add button handler
            const addPortionBtn = document.getElementById('addPortionBtn');
            if (addPortionBtn) {
                addPortionBtn.addEventListener('click', () => {
                    const nameEl = document.getElementById('portionNameInput');
                    const priceEl = document.getElementById('portionPriceInput');
                    const piecesEl = document.getElementById('portionPiecesInput');
                    const name = (nameEl?.value || '').trim();
                    const price = Number(priceEl?.value || 0);
                    const pieces = Number(piecesEl?.value || 0);
                    if (!name || !(price >= 0)) {
                        showToast('Error', 'Please enter a portion name and a valid price', 'danger');
                        return;
                    }
                    const key = normalizePortionKey(name);
                    if (key === 'full') {
                        showToast('Info', 'FULL is the default portion — set its price via Selling Price field.', 'info');
                        return;
                    }
                    if (!dishPortions) dishPortions = {};
                    dishPortions[key] = { name, price, pieces };
                    if (nameEl) nameEl.value = '';
                    if (priceEl) priceEl.value = '';
                    if (piecesEl) piecesEl.value = '';
                    renderPortionsList();
                });
            }

            const quickAddHalfBtn = document.getElementById('quickAddHalfBtn');
            if (quickAddHalfBtn) {
                quickAddHalfBtn.addEventListener('click', () => {
                    const key = 'half';
                    if (!dishPortions[key]) dishPortions[key] = { name: 'HALF', price: 0, pieces: 1 };
                    renderPortionsList();
                });
            }
            const quickAddFullBtn = document.getElementById('quickAddFullBtn');
            if (quickAddFullBtn) {
                quickAddFullBtn.addEventListener('click', () => {
                    showToast('Info', 'FULL is the default portion — set its price via Selling Price field.', 'info');
                });
            }
        }

        // Load data from menu.json
        async function loadData() {
            console.debug('[Menu] loadData: starting');
            
            try {
                // Fetch data from menu.json
                const response = await fetch('menu.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Fetched data:', data);
                
                // Update the application state with the fetched data
                menuData = {
                    ...data,
                    lastUpdated: new Date().toISOString()
                };
                
                // Initialize filtered lists with all items
                filteredDishes = [...(menuData.dishes || [])];
                filteredIngredients = [...(menuData.ingredients || [])];
                
                // Debug: log loaded dishes
                console.debug('[Menu] loaded dishes:', (menuData.dishes || []).map(d => `${d.id}:${d.name}`));
                
                // Render UI
                renderDishes();
                renderIngredients();
                
                console.debug('[Menu] loadData: completed');
            } catch (error) {
                console.error('[Menu] Error loading menu data:', error);
                
                // Reset to empty state on error
                filteredDishes = [];
                filteredIngredients = [];
                
                // Render empty state
                renderDishes();
                renderIngredients();
                
                showToast('Error', 'Failed to load menu data. Please try again.', 'error');
            }
        }

        // Normalize incoming menu data for compatibility and safety
        function normalizeMenuData(data) {
            const safe = data || {};
            const units = safe.units || CONFIG.UNITS;
            const cats = safe.categories || CONFIG.CATEGORIES;
            const ingCats = safe.ingredientCategories || CONFIG.INGREDIENT_CATEGORIES;
            const dishes = Array.isArray(safe.dishes) ? safe.dishes : [];
            const ingredients = Array.isArray(safe.ingredients) ? safe.ingredients : [];

            // Coerce IDs to strings and ensure required fields exist
            const normIngredients = ingredients.map(i => ({
                ...i,
                id: String(i.id),
                unitType: i.unitType || 'weight',
                unit: i.unit || (CONFIG.UNITS[(i.unitType || 'weight')]?.[0]?.name || 'g'),
                costPerUnit: Number(i.costPerUnit || 0),
                minStockLevel: i.minStockLevel != null ? Number(i.minStockLevel) : undefined,
                currentStock: i.currentStock != null ? Number(i.currentStock) : undefined,
            }));

            // Build a fast lookup for base ingredient attributes
            const ingById = new Map(normIngredients.map(i => [String(i.id), i]));

            const normDishes = dishes.map(d => ({
                ...d,
                id: String(d.id ?? d.id),
                costPrice: Number.isFinite(Number(d.costPrice)) ? Number(d.costPrice) : 0,
                sellingPrice: Number.isFinite(Number(d.sellingPrice)) ? Number(d.sellingPrice) : 0,
                ingredients: Array.isArray(d.ingredients) ? d.ingredients.map(ing => {
                    const src = ing || {};
                    const base = ingById.get(String(src.ingredientId)) || {};
                    const quantity = Number(src.quantity);
                    const qty = Number.isFinite(quantity) ? quantity : 0;
                    const unit = src.unit || base.unit || '';
                    const name = src.name || base.name || '';
                    const unitType = src.unitType || base.unitType || 'weight';
                    const ingredientUnit = src.ingredientUnit || base.unit || unit;
                    const cpuNum = Number(src.costPerUnit != null ? src.costPerUnit : base.costPerUnit);
                    const costPerUnit = Number.isFinite(cpuNum) ? cpuNum : 0;
                    return {
                        ...src,
                        ingredientId: String(src.ingredientId),
                        name,
                        quantity: qty,
                        unit,
                        unitType,
                        ingredientUnit,
                        costPerUnit,
                    };
                }) : []
            }));

            return {
                ...menuData, // retain defaults/settings
                ...safe,
                units,
                categories: cats,
                ingredientCategories: ingCats,
                ingredients: normIngredients,
                dishes: normDishes,
            };
        }

        // Save data to server (/api/menu)
        async function saveData() {
            try {
                menuData.lastUpdated = new Date().toISOString();
                const res = await fetch('/api/menu', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(menuData)
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                console.debug('[Menu] saveData: saved to /api/menu at', menuData.lastUpdated);
                return true;
            } catch (e) {
                console.error('[Menu] saveData: failed to save to /api/menu', e);
                showToast('Error', 'Failed to save menu to server', 'danger');
                return false;
            }
        }

        // Show toast notification
        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.id = toastId;
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong><br>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Initialize and show the toast
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();
            
            // Remove toast from DOM after it's hidden
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }

        // Categories removed - keep no-op for compatibility
        function updateCategoryFilter() { /* no-op: categories removed */ }

        // Populate ingredient select dropdown
        function populateIngredientSelect() {
            const select = document.getElementById('ingredientSelect');
            select.innerHTML = '<option value="">Select Ingredient</option>';
            
            menuData.ingredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient.id;
                const stockInfo = (typeof ingredient.currentStock === 'number') ? ` • Stock: ${ingredient.currentStock}${ingredient.unit}` : '';
                option.textContent = `${ingredient.name} (₹${ingredient.costPerUnit}/${ingredient.unit})${stockInfo}`;
                select.appendChild(option);
            });
        }

        // Apply filters based on search
        function applyFilters() {
            const searchTerm = document.getElementById(currentTab === 'dishes' ? 'searchDishes' : 'searchIngredients')?.value?.toLowerCase() || '';
            
            if (currentTab === 'dishes') {
                if (!menuData.dishes) {
                    console.error('No dishes data available');
                    filteredDishes = [];
                    renderDishes();
                    return;
                }

                filteredDishes = menuData.dishes.filter(item => {
                    if (!item) return false;
                    
                    // Check name
                    if (item.name && item.name.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Check description
                    if (item.description && item.description.toLowerCase().includes(searchTerm)) {
                        return true;
                    }
                    
                    // Check ingredients
                    if (item.ingredients && item.ingredients.some(ing => 
                        ing && ing.name && ing.name.toLowerCase().includes(searchTerm)
                    )) {
                        return true;
                    }
                    
                    return false;
                });
                
                // Debug: log filtered dishes
                console.debug('[Menu] applyFilters (dishes) term=', searchTerm, 'matched=', filteredDishes.map(d => `${d.id}:${d.name}`));
                
                renderDishes();
            } else {
                if (!menuData.ingredients) {
                    console.error('No ingredients data available');
                    filteredIngredients = [];
                    renderIngredients();
                    return;
                }

                filteredIngredients = menuData.ingredients.filter(item => {
                    if (!item) return false;
                    
                    const nameHit = item.name && item.name.toLowerCase().includes(searchTerm);
                    const supplierHit = item.supplier && item.supplier.toLowerCase().includes(searchTerm);
                    
                    return nameHit || supplierHit;
                });
                
                renderIngredients();
            }
        }

        // Reset search only (filters removed)
        function resetFilters() {
            const searchInput = document.getElementById(currentTab === 'dishes' ? 'searchDishes' : 'searchIngredients');
            if (searchInput) {
                searchInput.value = '';
            }
            applyFilters();
        }

        // Render dishes
        function renderDishes() {
            console.debug('[Menu] renderDishes: starting');
            const container = document.getElementById('menuListContainer');
            if (!container) {
                console.error('[Menu] Error: Could not find menuListContainer element');
                return;
            }

            // Debug: log the current state of filteredDishes
            console.log('Filtered Dishes:', filteredDishes);

            // Clear container
            container.innerHTML = '';

            if (!filteredDishes || filteredDishes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-emoji-frown fs-1 text-muted"></i>
                        <p class="mt-2 mb-0">No dishes found. Try adjusting your search or add a new dish.</p>
                        <p class="text-muted">Debug: Dishes array is ${filteredDishes ? 'empty' : 'not defined'}</p>
                    </div>`;
                return;
            }
            
            // Render all dishes (no pagination)
            renderDishesList(filteredDishes);
        }

        // Helper function to render dishes list
        function renderDishesList(dishes) {
            console.log('Rendering dishes list:', dishes);
            const container = document.getElementById('menuListContainer');
            if (!container) return;

            // Add CSS for dish images
            const style = document.createElement('style');
            style.textContent = `
                .dish-image {
                    height: 200px;
                    object-fit: cover;
                    width: 100%;
                    border-top-left-radius: var(--bs-border-radius);
                    border-top-right-radius: var(--bs-border-radius);
                }
                .dish-item {
                    transition: transform 0.2s;
                }
                .dish-item:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
                }
                .dish-price {
                    font-size: 1.1rem;
                    font-weight: 600;
                }
                .dish-ingredients {
                    max-height: 100px;
                    overflow-y: auto;
                }
            `;
            document.head.appendChild(style);

            // Clear existing content
            container.innerHTML = '';

            dishes.forEach(dish => {
                console.log('Rendering dish:', dish);
                const dishElement = document.createElement('div');
                dishElement.className = 'dish-item card mb-4 h-100';
                
                // Create image element with fallback
                const imageUrl = dish.photoUrl || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzZDN0Q4RCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMiAxNnYyYTIgMiAwIDAgMS0yIDJINGEyIDIgMCAwIDEtMi0ydi03bDIuNjctMS4zNGExIDAgMCAwIDAgMC0xLjMyTDIgNi41Ii8+PHBvbHlsaW5lIHBvaW50cz0iMi41MiAxMS41IDggMTQuMzMgMTMuNTggOS4zMyAxOCA2LjY3IDIyIDkuMzMgMjIuNSA5LjY3Ii8+PHBhdGggZD0iTTE1LjUgOS4zNGwtMy4wOCAxLjg1TDEwIDEyLjMzIi8+PGNpcmNsZSBjeD0iNSIgY3k9IjUiIHI9IjEiLz48L3N2Zz4=';
                
                dishElement.innerHTML = `
                    <div class="position-relative">
                        <img src="${imageUrl}" class="dish-image" alt="${dish.name || 'Dish image'}" 
                             onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzZDN0Q4RCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMiAxNnYyYTIgMiAwIDAgMS0yIDJINGEyIDIgMCAwIDEtMi0ydi03bDIuNjctMS4zNGExIDAgMCAwIDAgMC0xLjNMMiA2LjUiLz48cG9seWxpbmUgcG9pbnRzPSIyLjUyIDExLjUgOCAxNC4zMyAxMy41OCA5LjMzIDE4IDYuNjcgMjIgOS4zMyAyMi41IDkuNjciLz48cGF0aCBkPSJNMTUuNSA5LjM0bC0zLjA4IDEuODVMMTAgMTIuMzMiLz48Y2lyY2xlIGN4PSI1IiBjeT0iNSIgcj0iMSIvPjwvc3ZnPg==';"
                        >
                        <span class="position-absolute top-0 end-0 m-2 badge bg-success dish-price">₹${dish.sellingPrice || '0'}</span>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">${dish.name || 'Unnamed Dish'}</h5>
                        ${dish.description ? `<p class="card-text text-muted small">${dish.description}</p>` : ''}
                        ${dish.ingredients && dish.ingredients.length > 0 ? `
                            <div class="ingredients mt-2">
                                <span class="badge bg-light text-dark me-1 mb-1">
                                    <i class="bi bi-list-ul me-1"></i>${dish.ingredients.length} ingredients
                                </span>
                            </div>` : ''
                        }
                    </div>
                `;
                container.appendChild(dishElement);
            });
        }

        // Render ingredients grouped by vendor
        function renderIngredients() {
            const container = document.getElementById('ingredientsListContainer');
            if (!container) return;

            // Get all ingredients and filter them
            const allIngredients = [...menuData.ingredients];
            const searchTerm = document.getElementById('searchIngredients')?.value?.toLowerCase() || '';
            
            // Apply search filter
            const filteredItems = searchTerm 
                ? allIngredients.filter(ing => 
                    (ing.name && ing.name.toLowerCase().includes(searchTerm)) ||
                    (ing.description && ing.description.toLowerCase().includes(searchTerm)) ||
                    (ing.category && ing.category.toLowerCase().includes(searchTerm))
                )
                : allIngredients;
                
            container.innerHTML = '';
            
            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-basket" style="font-size: 2rem; color: #ccc;"></i>
                        <p class="mt-2 text-muted">No ingredients found</p>
                    </div>
                `;
                return;
            }

            // Group by vendor
            const vendorGroups = filteredItems.reduce((acc, ingredient) => {
                const vendorId = ingredient.vendorId || 'other';
                const vendor = menuData.vendors?.find(v => v.id === vendorId) || {
                    id: vendorId,
                    name: 'Other Vendors',
                    description: 'Ingredients without a specific vendor'
                };
                
                if (!acc[vendorId]) {
                    acc[vendorId] = {
                        ...vendor,
                        ingredients: []
                    };
                }
                acc[vendorId].ingredients.push(ingredient);
                return acc;
            }, {});

            // Create vendor grid container
            const vendorGrid = document.createElement('div');
            vendorGrid.className = 'vendor-grid';
            container.appendChild(vendorGrid);

            // Sort vendors by name and render
            Object.values(vendorGroups)
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(vendor => {
                    // Create vendor group
                    const group = document.createElement('div');
                    group.className = 'vendor-group mb-4';
                    
                    // Vendor header
                    const header = document.createElement('div');
                    header.className = 'vendor-header mb-3';
                    header.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-shop me-2"></i>
                                ${vendor.name}
                                <small class="text-muted ms-2">${vendor.ingredients.length} items</small>
                            </h5>
                            <small class="text-muted">${vendor.description}</small>
                        </div>
                    `;
                    group.appendChild(header);

                    // Items container
                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'row row-cols-1 row-cols-md-2 g-3';
                    
                    // Add each ingredient
                    vendor.ingredients.forEach(ingredient => {
                        const col = document.createElement('div');
                        col.className = 'col';
                        
                        const card = document.createElement('div');
                        card.className = `ingredient-item h-100 ${!ingredient.active ? 'opacity-75' : ''}`;
                        
                        // Compute stock status
                        const hasStock = typeof ingredient.currentStock === 'number' || typeof ingredient.minStockLevel === 'number';
                        const current = typeof ingredient.currentStock === 'number' ? ingredient.currentStock : null;
                        const min = typeof ingredient.minStockLevel === 'number' ? ingredient.minStockLevel : null;
                        
                        let stockStatus = '';
                        if (hasStock && current != null) {
                            let statusClass = 'stock-ok';
                            if (current <= 0) statusClass = 'stock-out';
                            else if (min != null && current < min) statusClass = 'stock-low';
                            
                            stockStatus = `
                                <div class="mt-2">
                                    <span class="stock-badge ${statusClass} me-2">
                                        <i class="bi ${current <= 0 ? 'bi-x-circle' : current < min ? 'bi-exclamation-triangle' : 'bi-check-circle'}"></i>
                                        ${current <= 0 ? 'Out of Stock' : current < min ? 'Low Stock' : 'In Stock'}
                                    </span>
                                    <small class="text-muted">${current} ${ingredient.unit || ''} available</small>
                                </div>
                            `;
                        }

                        card.innerHTML = `
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">${ingredient.name}</h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="openIngredientModal('${ingredient.id}')">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteIngredient('${ingredient.id}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    ${ingredient.description ? `
                                        <p class="card-text text-muted small mb-2">${ingredient.description}</p>
                                    ` : ''}
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="badge bg-light text-dark border me-2">
                                                <i class="bi bi-tag me-1"></i> ${ingredient.category || 'No Category'}
                                            </span>
                                            <span class="badge bg-light text-dark border">
                                                <i class="bi bi-box-seam me-1"></i> ${ingredient.unit || 'N/A'}
                                            </span>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold text-success">₹${(ingredient.costPerUnit || 0).toFixed(2)}</div>
                                            <small class="text-muted">per ${ingredient.unit || 'unit'}</small>
                                        </div>
                                    </div>
                                    
                                    ${stockStatus}
                                </div>
                            </div>
                        `;
                        
                        itemsContainer.appendChild(col);
                        col.appendChild(card);
                    });

                    group.appendChild(itemsContainer);
                    vendorGrid.appendChild(group);
                });

            console.debug('[Menu] renderIngredients: Rendered', { 
                totalIngredients: allIngredients.length,
                filtered: filteredItems.length,
                showing: paginatedItems.length,
                vendorGroups: Object.keys(vendorGroups).length
            });
        }

        // Render pagination for ingredients
        function renderIngredientsPagination() {
            console.debug('[Menu] renderIngredientsPagination: Starting');
            
            // Safely get the container
            const paginationContainer = document.getElementById('ingredientsPagination');
            if (!paginationContainer) {
                console.error('[Menu] Error: Could not find ingredientsPagination element');
                return;
            }
            
            try {
                // Safely get pagination data with defaults
                const paginationData = pagination?.ingredients || {
                    currentPage: 1,
                    itemsPerPage: 10,
                    totalItems: 0,
                    totalPages: () => 1
                };
                
                // Get current page and total pages
                const currentPage = Number.isInteger(paginationData.currentPage) ? paginationData.currentPage : 1;
                const totalPages = typeof paginationData.totalPages === 'function' ? 
                    Math.max(1, paginationData.totalPages()) : 1;
                
                console.debug('[Menu] renderIngredientsPagination:', { currentPage, totalPages });
                
                // If only one page or less, don't show pagination
                if (totalPages <= 1) {
                    paginationContainer.innerHTML = '';
                    console.debug('[Menu] renderIngredientsPagination: Only one page, hiding pagination');
                    return;
                }
                
                // Build pagination HTML
                let paginationHTML = '';
                
                // Previous button
                paginationHTML += `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>`;
                
                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                        paginationHTML += `
                            <li class="page-item ${i === currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>`;
                    } else if (i === currentPage - 2 || i === currentPage + 2) {
                        paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                    }
                }
                
                // Next button
                paginationHTML += `
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>`;
                
                // Update the DOM
                paginationContainer.innerHTML = `
                    <nav aria-label="Ingredients pagination">
                        <ul class="pagination pagination-sm justify-content-center">
                            ${paginationHTML}
                        </ul>
                    </nav>`;
                
                // Add event listeners to pagination links
                const pageLinks = paginationContainer.querySelectorAll('.page-link[data-page]');
                pageLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = parseInt(this.getAttribute('data-page'));
                        if (!isNaN(page) && page >= 1 && page <= totalPages) {
                            console.debug('[Menu] renderIngredientsPagination: Page link clicked:', page);
                            goToIngredientsPage(page);
                        }
                    });
                });
                
            } catch (error) {
                console.error('[Menu] Error in renderIngredientsPagination:', error);
                // Clear the container to prevent UI glitches
                if (paginationContainer) {
                    paginationContainer.innerHTML = '';
                }
            }
        }

        // Function to reset dish form with additional cleanup
        function resetDishForm() {
            const form = document.getElementById('dishForm');
            if (form) {
                form.reset();
            }
            document.getElementById('dishId').value = '';
            document.getElementById('dishModalLabel').textContent = 'Add New Dish';
            
            const selectedIngredientsEl = document.getElementById('selectedIngredients');
            if (selectedIngredientsEl) {
                selectedIngredientsEl.innerHTML = '';
            }
            
            // Reset select elements
            const ingredientSelect = document.getElementById('ingredientSelect');
            if (ingredientSelect) {
                ingredientSelect.value = '';
            }
            
            const unitSelect = document.getElementById('dishIngredientUnit');
            if (unitSelect) {
                unitSelect.innerHTML = '<option value="">Select unit</option>';
            }
            
            // Reset ingredient details
            const ingredientDetails = document.getElementById('ingredientDetails');
            if (ingredientDetails) {
                ingredientDetails.style.display = 'none';
            }
            
            selectedIngredients = [];
            updateCostPrice();
            
            // Reset any validation states
            const formInputs = form?.querySelectorAll('.is-invalid');
            formInputs?.forEach(input => input.classList.remove('is-invalid'));
        }

        // Open dish modal for adding/editing with enhanced initialization
        function openDishModal(dishId = null) {
            editingDishId = dishId;
            const modalEl = document.getElementById('dishModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            const modalTitle = document.getElementById('dishModalLabel');
            
            // Reset form and state
            resetDishForm();
            
            if (dishId) {
                // Edit mode
                const dish = menuData.dishes.find(d => d.id === dishId);
                if (!dish) {
                    showToast('Error', 'Dish not found!', 'danger');
                    return;
                }
                
                modalTitle.textContent = 'Edit Dish: ' + dish.name;
                document.getElementById('dishId').value = dish.id;
                document.getElementById('dishName').value = dish.name || '';
                document.getElementById('dishPhotoUrl').value = dish.photoUrl || '';
                document.getElementById('dishDescription').value = dish.description || '';
                document.getElementById('dishCostPrice').value = dish.costPrice?.toFixed(2) || '0.00';
                
                // Set selling price with validation
                const sellingPrice = parseFloat(dish.sellingPrice);
                if (!isNaN(sellingPrice) && sellingPrice > 0) {
                    document.getElementById('dishSellingPrice').value = sellingPrice.toFixed(2);
                } else {
                    document.getElementById('dishSellingPrice').value = '';
                }
                
                // Set portions if they exist
                if (dish.portions) {
                    if (dish.portions.full) {
                        document.getElementById('portionPieces-full').value = dish.portions.full.portionPieces || 1;
                    }
                    if (dish.portions.half) {
                        document.getElementById('portionPieces-half').value = dish.portions.half.portionPieces || 1;
                    }
                }
                
                // Add ingredients with validation
                if (Array.isArray(dish.ingredients) && dish.ingredients.length > 0) {
                    selectedIngredients = dish.ingredients.map(ing => ({
                        ...ing,
                        // Ensure all required fields exist
                        ingredientId: ing.ingredientId || '',
                        name: ing.name || '',
                        quantity: parseFloat(ing.quantity) || 0,
                        unit: ing.unit || '',
                        costPerUnit: parseFloat(ing.costPerUnit) || 0,
                        unitType: ing.unitType || 'weight'
                    }));
                    renderSelectedIngredients();
                }
                
                // Update cost price display
                updateCostPrice();
            } else {
                // Add mode
                modalTitle.textContent = 'Add New Dish';
                document.getElementById('dishSellingPrice').value = '';
                updateCostPrice();
            }
            
            // Show the modal after a small delay to ensure DOM updates
            setTimeout(() => {
                modal.show();
                // Focus on the first input field
                document.getElementById('dishName')?.focus();
            }, 50);
        }

        // Add ingredient to dish
        function addIngredientToDish() {
            const ingredientSelect = document.getElementById('ingredientSelect');
            const quantityInput = document.getElementById('ingredientQuantity');
            const unitSelect = document.getElementById('dishIngredientUnit');
            
            const ingredientId = ingredientSelect.value;
            const quantity = roundToWholeNumber(parseFloat(quantityInput.value));
            const unit = unitSelect.value;
            
            if (!ingredientId || isNaN(quantity) || quantity <= 0 || !unit) {
                showToast('Error', 'Please select an ingredient, enter a valid quantity, and select a unit', 'danger');
                return;
            }
            
            const ingredient = menuData.ingredients.find(i => String(i.id) === String(ingredientId));
            if (!ingredient) {
                showToast('Error', 'Selected ingredient not found', 'danger');
                return;
            }
            
            // Check if ingredient already exists
            const existingIndex = selectedIngredients.findIndex(i => String(i.ingredientId) === String(ingredientId) && i.unit === unit);
            
            if (existingIndex >= 0) {
                // Update existing ingredient
                const prevQty = Number(selectedIngredients[existingIndex].quantity) || 0;
                selectedIngredients[existingIndex].quantity = Math.round(prevQty + quantity);
                // Normalize fields to ensure persistence is consistent
                selectedIngredients[existingIndex].name = selectedIngredients[existingIndex].name || ingredient.name;
                selectedIngredients[existingIndex].unitType = selectedIngredients[existingIndex].unitType || ingredient.unitType;
                selectedIngredients[existingIndex].ingredientUnit = selectedIngredients[existingIndex].ingredientUnit || ingredient.unit;
                const cpuNum = Number(selectedIngredients[existingIndex].costPerUnit != null ? selectedIngredients[existingIndex].costPerUnit : ingredient.costPerUnit);
                selectedIngredients[existingIndex].costPerUnit = Number.isFinite(cpuNum) ? cpuNum : 0;
            } else {
                // Add new ingredient
                selectedIngredients.push({
                    ingredientId: String(ingredient.id),
                    name: ingredient.name,
                    quantity: Number(quantity),
                    unit: unit,
                    costPerUnit: Number(ingredient.costPerUnit) || 0,
                    ingredientUnit: ingredient.unit, // the unit that costPerUnit refers to
                    unitType: ingredient.unitType
                });
            }
            console.debug('[Menu] addIngredientToDish:', { ingredientId, unit, quantity, selectedIngredients });
            
            // Reset form
            ingredientSelect.value = '';
            quantityInput.value = '';
            unitSelect.innerHTML = '<option value="">Select unit</option>';
            
            // Update UI
            renderSelectedIngredients();
            updateCostPrice();
            
            showToast('Success', 'Ingredient added successfully', 'success');
        }

        // Render selected ingredients
        function renderSelectedIngredients() {
            const container = document.getElementById('selectedIngredients');
            if (!container) return;
            
            container.innerHTML = '';
            
            selectedIngredients.forEach((ing, index) => {
                const ingElement = document.createElement('div');
                ingElement.className = 'selected-ingredient mb-2 p-2 border rounded d-flex justify-content-between align-items-center';
                const itemCost = computeIngredientCost(ing) || 0;
                ingElement.innerHTML = `
                    <div>
                        <strong>${ing.name}</strong>: ${Math.round(ing.quantity)} ${ing.unit}
                        <br><small>Cost: ₹${Math.round(itemCost)}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeIngredient(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                container.appendChild(ingElement);
            });
        }

        // Remove ingredient from selected list
        function removeIngredient(index) {
            if (index >= 0 && index < selectedIngredients.length) {
                selectedIngredients.splice(index, 1);
                renderSelectedIngredients();
                updateCostPrice();
            }
        }

        // Portions helpers and rendering (ensure defined before any usage)
        function normalizePortionKey(name) {
            return String(name || '').toLowerCase().trim().replace(/\s+/g, '-');
        }

        function updatePricingSectionVisibility() {
            // Always show single selling price; HALF uses this as default
            const sellingGroup = document.getElementById('sellingPriceGroup');
            if (sellingGroup) sellingGroup.style.display = 'block';
        }

        function renderPortionsList() {
            const container = document.getElementById('portionsListContainer');
            if (!container) return;
            const sellingInput = document.getElementById('dishSellingPrice');
            const fullPrice = Number(sellingInput && sellingInput.value ? sellingInput.value : 0) || 0;
            const halfPrice = Math.round(((fullPrice / 2) || 0) * 100) / 100;
            container.innerHTML = '';

            // Get the current dish being edited
            const dishId = document.getElementById('dishId').value;
            const dish = menuData.dishes.find(d => d.id === dishId) || {};
            const portions = dish.portions || {};

            // FULL (from Selling Price)
            const fullRow = document.createElement('div');
            fullRow.className = 'd-flex align-items-center justify-content-between border rounded p-2 mb-2';
            fullRow.innerHTML = `
                <div class="d-flex align-items-center">
                    <strong class="me-2">FULL</strong>
                    <span>— ₹${fullPrice.toFixed(2)}</span>
                </div>
                <div class="d-flex align-items-center">
                    <select class="form-select form-select-sm ms-2" id="portionPieces-full" 
                            style="width: 100px;" data-portion="full">
                        <option value="1" ${(portions.full?.portionPieces || 1) === 1 ? 'selected' : ''}>1 piece</option>
                        <option value="2" ${(portions.full?.portionPieces || 1) === 2 ? 'selected' : ''}>2 pieces</option>
                        <option value="4" ${(portions.full?.portionPieces || 1) === 4 ? 'selected' : ''}>4 pieces</option>
                        <option value="8" ${(portions.full?.portionPieces || 1) === 8 ? 'selected' : ''}>8 pieces</option>
                        <option value="16" ${(portions.full?.portionPieces || 1) === 16 ? 'selected' : ''}>16 pieces</option>
                    </select>
                    <span class="text-muted small ms-2">Default via Selling Price</span>
                </div>
            `;
            container.appendChild(fullRow);

            // HALF (calculated from Selling Price)
            const halfRow = document.createElement('div');
            halfRow.className = 'd-flex align-items-center justify-content-between border rounded p-2 mb-2';
            halfRow.innerHTML = `
                <div class="d-flex align-items-center">
                    <strong class="me-2">HALF</strong>
                    <span>— ₹${halfPrice.toFixed(2)}</span>
                </div>
                <div class="d-flex align-items-center">
                    <select class="form-select form-select-sm ms-2" id="portionPieces-half" 
                            style="width: 100px;" data-portion="half">
                        <option value="1" ${(portions.half?.portionPieces || 1) === 1 ? 'selected' : ''}>1 piece</option>
                        <option value="2" ${(portions.half?.portionPieces || 1) === 2 ? 'selected' : ''}>2 pieces</option>
                        <option value="4" ${(portions.half?.portionPieces || 1) === 4 ? 'selected' : ''}>4 pieces</option>
                        <option value="8" ${(portions.half?.portionPieces || 1) === 8 ? 'selected' : ''}>8 pieces</option>
                        <option value="16" ${(portions.half?.portionPieces || 1) === 16 ? 'selected' : ''}>16 pieces</option>
                    </select>
                    <span class="text-muted small ms-2">Calculated</span>
                </div>
            `;
            container.appendChild(halfRow);

            // Add event listeners to the new selects
            document.querySelectorAll('.form-select.portion-pieces').forEach(select => {
                select.addEventListener('change', function() {
                    const portionKey = this.dataset.portion;
                    const pieces = parseInt(this.value) || 1;
                    
                    // Update the dish object
                    const dishId = document.getElementById('dishId').value;
                    const dishIndex = appData.dishes.findIndex(d => d.id === dishId);
                    
                    if (dishIndex !== -1) {
                        if (!appData.dishes[dishIndex].portions) {
                            appData.dishes[dishIndex].portions = {};
                        }
                        if (!appData.dishes[dishIndex].portions[portionKey]) {
                            appData.dishes[dishIndex].portions[portionKey] = {};
                        }
                        appData.dishes[dishIndex].portions[portionKey].portionPieces = pieces;
                    }
                });
            });

            updatePricingSectionVisibility();
        }

        // Update cost price based on selected ingredients
        function updateCostPrice() {
            let totalCost = 0;
            selectedIngredients.forEach(ing => {
                totalCost += computeIngredientCost(ing);
            });
            if (!isFinite(totalCost)) {
                console.debug('[Menu] updateCostPrice computed non-finite totalCost; resetting to 0', { selectedIngredients, totalCost });
                totalCost = 0;
            }
            const roundedCost = roundToWholeNumber(totalCost);
            document.getElementById('dishCostPrice').value = roundedCost;

            // Auto-set selling price from cost with 30% margin only if user hasn't edited it
            const sellingPriceInput = document.getElementById('dishSellingPrice');
            if (!sellingPriceTouched) {
                const sp = totalCost * 1.3;
                const spFinal = isFinite(sp) ? roundToWholeNumber(sp) : 0;
                sellingPriceInput.value = spFinal;
            }

            // Update calculated portions (FULL/HALF)
            renderPortionsList();
        }

        // Utility: get toBase factor for a unit
        function getUnitToBase(unitType, unitName) {
            const list = (menuData.units && menuData.units[unitType]) || CONFIG.UNITS[unitType] || [];
            const found = list.find(u => u.name === unitName);
            return found ? Number(found.toBase) : 1;
        }

        // Utility: compute ingredient cost considering unit conversion
        function computeIngredientCost(selIng) {
            try {
                const unitType = selIng.unitType || 'weight';
                const selectedUnit = selIng.unit; // unit used in the dish
                const ingredientUnit = selIng.ingredientUnit || selectedUnit; // unit of costPerUnit
                const qty = Number(selIng.quantity || 0);
                const cpu = Number(selIng.costPerUnit || 0);
                
                // Guard: invalid qty/cpu
                if (!qty || !cpu || !isFinite(qty) || !isFinite(cpu)) return 0;
                
                // If units are the same, simple multiplication
                if (selectedUnit === ingredientUnit) {
                    return Math.round(qty * cpu);
                }
                
                // Get conversion factors for both units
                const selectedToBase = Number(getUnitToBase(unitType, selectedUnit) || 1);
                const ingredientToBase = Number(getUnitToBase(unitType, ingredientUnit) || 1);
                
                // Calculate the conversion factor from selected unit to ingredient unit
                // Example: selected = kg (1000g), ingredient = g (1g) => 1kg = 1000g
                const conversionFactor = selectedToBase / ingredientToBase;
                
                // Calculate total cost: quantity * (conversion to ingredient unit) * cost per unit
                const result = qty * conversionFactor * cpu;
                
                // Debug log for cost calculation
                console.debug('[Menu] computeIngredientCost calculation:', {
                    qty,
                    cpu,
                    unitType,
                    selectedUnit,
                    ingredientUnit,
                    selectedToBase,
                    ingredientToBase,
                    conversionFactor,
                    result,
                    rounded: Math.round(result)
                });
                
                // Guard: ensure finite result
                if (!isFinite(result)) {
                    console.debug('[Menu] computeIngredientCost produced non-finite value', { 
                        selIng, 
                        unitType, 
                        selectedUnit, 
                        ingredientUnit, 
                        qty, 
                        cpu, 
                        selectedToBase, 
                        ingredientToBase, 
                        conversionFactor, 
                        result 
                    });
                    return 0;
                }
                
                // Round to nearest whole number for currency
                return Math.round(result);
            } catch (e) {
                console.error('[Menu] computeIngredientCost error', e, selIng);
                return 0;
            }
        }

        // Update the price input fields to ensure they only accept whole numbers
        function setupPriceInputs() {
            // Update all number inputs to use step="1" for whole numbers
            const priceInputs = document.querySelectorAll('input[type="number"]');
            priceInputs.forEach(input => {
                // Change step to 1 to only allow whole numbers
                input.step = '1';
                input.min = '0';
                
                // Add event listener to round the value when it changes
                input.addEventListener('input', function() {
                    if (this.value !== '' && this.value !== null) {
                        // Remove any non-digit characters
                        this.value = this.value.replace(/[^0-9]/g, '');
                        // Ensure value is a valid number
                        const numValue = parseInt(this.value) || 0;
                        this.value = numValue;
                    }
                });
                
                // Also round the current value if it exists
                if (input.value) {
                    input.value = roundToWholeNumber(input.value);
                }
            });
        }

        // Compute basic availability of a dish based on ingredient stock
        function computeDishAvailability(dish) {
            if (!dish || !Array.isArray(dish.ingredients)) return 'available';
            let low = false;
            for (const req of dish.ingredients) {
                const ing = menuData.ingredients.find(i => String(i.id) === String(req.ingredientId));
                if (!ing) continue;
                const current = typeof ing.currentStock === 'number' ? ing.currentStock : null;
                const min = typeof ing.minStockLevel === 'number' ? ing.minStockLevel : null;
                if (current != null && current <= 0) return 'out';
                if (current != null && min != null && current < min) low = true;
            }
            return low ? 'low' : 'available';
        }

        // Save dish
async function saveDish() {
    const saveBtn = document.getElementById('saveDishBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    
    try {
        const form = document.getElementById('dishForm');
        const name = document.getElementById('dishName').value.trim();
        const photoUrl = document.getElementById('dishPhotoUrl').value.trim();
        // Category removed
        // Recompute costPrice from selectedIngredients to ensure correctness
        let recomputedCost = 0;
        try {
            for (const ing of selectedIngredients) {
                recomputedCost += computeIngredientCost(ing);
            }
        } catch (e) {
            console.error('[Menu] saveDish: error computing cost', e, selectedIngredients);
        }
        // Ensure cost price is a whole number
        const costPrice = Number.isFinite(recomputedCost) ? Math.round(Number(recomputedCost)) : 0;
        // Ensure selling price is a whole number
        const sellingPrice = Math.round(Number(document.getElementById('dishSellingPrice').value) || 0);
        // Active removed
        
        if (!name || isNaN(costPrice) || isNaN(sellingPrice)) {
            showToast('Error', 'Please fill in all required fields', 'danger');
            return;
        }
        
        if (selectedIngredients.length === 0) {
            showToast('Error', 'Please add at least one ingredient', 'danger');
            return;
        }
        
        // Normalize ingredients for persistence
        const persistedIngredients = selectedIngredients.map(src => {
            const ingredient = menuData.ingredients.find(i => String(i.id) === String(src.ingredientId));
            const baseUnit = ingredient ? ingredient.unit : src.ingredientUnit || src.unit;
            const unitType = src.unitType || (ingredient ? ingredient.unitType : 'weight');
            const cpuNum = Number(src.costPerUnit != null ? src.costPerUnit : (ingredient ? ingredient.costPerUnit : 0));
            const qtyNum = Number(src.quantity);
            return {
                ...src,
                ingredientId: String(src.ingredientId || (ingredient ? ingredient.id : '')),
                name: src.name || (ingredient ? ingredient.name : ''),
                quantity: Number.isFinite(qtyNum) && qtyNum > 0 ? qtyNum : 0,
                unit: src.unit || baseUnit || '',
                costPerUnit: Number.isFinite(cpuNum) ? cpuNum : 0,
                ingredientUnit: src.ingredientUnit || baseUnit || (src.unit || ''),
                unitType,
            };
        });

        // Resolve persisted id from hidden input if present
        const hiddenId = (document.getElementById('dishId').value || '').trim();
        const resolvedId = hiddenId || ('dish-' + Date.now());
        
        // Get portion pieces from the form
        const fullPieces = parseInt(document.getElementById('portionPieces-full')?.value) || 1;
        const halfPieces = parseInt(document.getElementById('portionPieces-half')?.value) || 1;
        
        const dish = {
            id: resolvedId,
            name,
            photoUrl,
            description: document.getElementById('dishDescription').value.trim(),
            costPrice,
            sellingPrice,
            ingredients: persistedIngredients,
            portions: {
                full: {
                    name: 'FULL',
                    price: roundToWholeNumber(sellingPrice),
                    multiplier: 1,
                    portionPieces: fullPieces
                },
                half: {
                    name: 'HALF',
                    price: roundToWholeNumber(sellingPrice / 2),
                    multiplier: 0.5,
                    portionPieces: halfPieces
                }
            },
            lastUpdated: new Date().toISOString()
        };
        console.debug('[Menu] saveDish: persisting dish', {
            id: dish.id,
            name: dish.name,
            costPrice: dish.costPrice,
            sellingPrice: dish.sellingPrice,
            persistedCount: dish.ingredients.length,
            selectedCount: selectedIngredients ? selectedIngredients.length : 0,
            sample: dish.ingredients[0] || null
        });

        // Update or add dish in local state
        const existingIndex = menuData.dishes.findIndex(d => String(d.id) === String(dish.id));
        if (existingIndex >= 0) {
            menuData.dishes[existingIndex] = dish;
        } else {
            menuData.dishes.push(dish);
        }
        
        // Save data and update UI: re-fetch latest and broadcast change for other tabs/pages
        if (await saveData()) {
            try { localStorage.setItem('menuUpdated', String(Date.now())); } catch (e) {}
            await loadData();
            const modal = bootstrap.Modal.getInstance(document.getElementById('dishModal'));
            if (modal) modal.hide();
            showToast('Success', 'Dish saved successfully', 'success');
        }
    } catch (e) {
        console.error('[Menu] saveDish: error', e);
        showToast('Error', 'Failed to save dish. Please try again.', 'danger');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

        // Delete dish
        async function deleteDish(dishId) {
            if (!confirm('Are you sure you want to delete this dish?')) return;
            
            const index = menuData.dishes.findIndex(d => d.id === dishId);
            if (index !== -1) {
                menuData.dishes.splice(index, 1);
                
                if (await saveData()) {
                    filteredDishes = [...menuData.dishes];
                    applyFilters();
                    showToast('Success', 'Dish deleted successfully', 'success');
                }
            }
        }

        // Open ingredient modal for adding/editing
        function openIngredientModal(ingredientId = null) {
            editingIngredientId = ingredientId;
            const modal = new bootstrap.Modal(document.getElementById('ingredientModal'));
            const modalTitle = document.getElementById('ingredientModalLabel');
            const form = document.getElementById('ingredientForm');
            
            // Reset form
            form.reset();
            document.getElementById('densityContainer').style.display = 'none';
            document.getElementById('pieceWeightContainer').style.display = 'none';
            
            if (ingredientId) {
                // Edit mode
                const ingredient = menuData.ingredients.find(i => i.id === ingredientId);
                if (!ingredient) {
                    showToast('Error', 'Ingredient not found!', 'danger');
                    return;
                }
                
                modalTitle.textContent = 'Edit Ingredient';
                document.getElementById('ingredientId').value = ingredient.id;
                document.getElementById('ingredientName').value = ingredient.name;
                // Category removed
                document.getElementById('ingredientUnitType').value = ingredient.unitType || 'weight';
                document.getElementById('ingredientCostPerUnit').value = ingredient.costPerUnit;
                // Active removed
                
                // Update unit select and show/hide fields
                updateUnitSelectForType(ingredient.unitType || 'weight', ingredient.unit);
                toggleIngredientFields(ingredient.unitType || 'weight');
                
                // Set density or piece weight if applicable
                if (ingredient.unitType === 'volume' && ingredient.density) {
                    document.getElementById('ingredientDensity').value = ingredient.density;
                } else if (ingredient.unitType === 'piece' && ingredient.avgWeightPerPiece) {
                    document.getElementById('ingredientPieceWeight').value = ingredient.avgWeightPerPiece;
                }
            } else {
                // Add mode
                modalTitle.textContent = 'Add New Ingredient';
                document.getElementById('ingredientId').value = '';
                // Active removed
                document.getElementById('ingredientUnitType').value = 'weight';
                updateUnitSelectForType('weight');
            }
            
            modal.show();
        }

        // Update unit select options based on unit type
        function updateUnitSelectForType(unitType, selectedUnit = '') {
            const unitSelect = document.getElementById('ingredientUnit');
            unitSelect.innerHTML = '<option value="">Select unit</option>';
            
            if (!unitType) return;
            
            const units = (menuData.units && menuData.units[unitType]) || CONFIG.UNITS[unitType] || [];
            
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.name;
                option.textContent = unit.displayName;
                if (unit.name === selectedUnit) {
                    option.selected = true;
                }
                unitSelect.appendChild(option);
            });
        }

        // Populate the unit options in Add Ingredient (Dish Modal) based on selected ingredient
        // Calculate and update ingredient cost
        function updateIngredientCost() {
            try {
                const ingredientId = document.getElementById('ingredientSelect').value;
                const quantity = parseFloat(document.getElementById('ingredientQuantity').value) || 0;
                const unitSelect = document.getElementById('dishIngredientUnit');
                const selectedUnit = unitSelect ? unitSelect.value : '';
                const ingredientDetails = document.getElementById('ingredientDetails');
                const ingredientCostEl = document.getElementById('ingredientCost');
                const ingredientUnitEl = document.getElementById('ingredientUnit');
                const ingredientTotalCostEl = document.getElementById('ingredientTotalCost');

                if (!ingredientId) {
                    ingredientDetails.style.display = 'none';
                    return;
                }

                const ingredient = menuData.ingredients.find(i => i.id === ingredientId);
                if (!ingredient) {
                    ingredientDetails.style.display = 'none';
                    return;
                }

                // Show ingredient details
                ingredientDetails.style.display = 'flex';
                
                // Get the base cost per unit and base unit from the ingredient
                let costPerUnit = Number(ingredient.costPerUnit);
                if (isNaN(costPerUnit)) {
                    console.warn(`[Menu] Invalid costPerUnit for ${ingredient.name}:`, ingredient.costPerUnit);
                    costPerUnit = 0;
                }
                
                const baseUnit = (ingredient.unit || '').trim();
                const displayUnit = (selectedUnit || baseUnit || 'unit').trim();
                
                // If the selected unit is different from the base unit, convert the cost
                if (selectedUnit && selectedUnit !== baseUnit) {
                    const unitType = ingredient.unitType || 'weight';
                    const units = (menuData.units && menuData.units[unitType]) || CONFIG.UNITS[unitType] || [];
                    const baseUnitInfo = units.find(u => u.name === baseUnit);
                    const selectedUnitInfo = units.find(u => u.name === selectedUnit);
                    
                    if (baseUnitInfo && selectedUnitInfo && baseUnitInfo.toBase && selectedUnitInfo.toBase) {
                        // Convert cost from base unit to selected unit
                        // Example: If base is g (1g) and selected is kg (1000g), then 1kg = 1000g
                        // So cost per kg = cost per g * 1000
                        costPerUnit = costPerUnit * (selectedUnitInfo.toBase / baseUnitInfo.toBase);
                        
                        console.debug(`[Menu] Converted cost: ${ingredient.costPerUnit} ${baseUnit} -> ${costPerUnit.toFixed(4)} ${selectedUnit}`, 
                            {baseUnitInfo, selectedUnitInfo, conversionFactor: selectedUnitInfo.toBase / baseUnitInfo.toBase});
                    } else {
                        console.warn(`[Menu] Missing unit conversion info`, {baseUnit, selectedUnit, baseUnitInfo, selectedUnitInfo});
                    }
                }
                
                const totalCost = costPerUnit * quantity;
                
                // Update the display with 2 decimal places for monetary values
                ingredientCostEl.textContent = costPerUnit.toFixed(2);
                ingredientUnitEl.textContent = displayUnit;
                ingredientTotalCostEl.textContent = totalCost.toFixed(2);
                
                console.debug('[Menu] updateIngredientCost:', {
                    ingredient: ingredient.name,
                    baseCost: ingredient.costPerUnit,
                    baseUnit: baseUnit,
                    selectedUnit: selectedUnit,
                    costPerUnit: costPerUnit,
                    quantity: quantity,
                    totalCost: totalCost
                });
                
            } catch (e) {
                console.error('[Menu] updateIngredientCost error', e);
                // Ensure the details are hidden on error
                const ingredientDetails = document.getElementById('ingredientDetails');
                if (ingredientDetails) {
                    ingredientDetails.style.display = 'none';
                }
            }
        }

        // Populate the unit options in Add Ingredient (Dish Modal) based on selected ingredient
        function updateDishIngredientUnitOptions() {
            try {
                const ingredientSelect = document.getElementById('ingredientSelect');
                const ingredientId = ingredientSelect.value;
                const unitSelect = document.getElementById('dishIngredientUnit');
                
                if (!unitSelect) {
                    console.warn('[Menu] updateDishIngredientUnitOptions: dishIngredientUnit element not found');
                    return;
                }
                
                unitSelect.innerHTML = '<option value="">Select unit</option>';
                
                if (!ingredientId) {
                    document.getElementById('ingredientDetails').style.display = 'none';
                    return;
                }
                
                const ingredient = menuData.ingredients.find(i => i.id === ingredientId);
                if (!ingredient) {
                    document.getElementById('ingredientDetails').style.display = 'none';
                    return;
                }
                
                // Update unit options
                const unitType = ingredient.unitType || 'weight';
                const units = (menuData.units && menuData.units[unitType]) || CONFIG.UNITS[unitType] || [];
                units.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.name;
                    opt.textContent = u.displayName;
                    if (u.name === ingredient.unit) opt.selected = true;
                    unitSelect.appendChild(opt);
                });
                
                // Update cost display after units are populated
                setTimeout(() => {
                    updateIngredientCost();
                    // Ensure the cost is rounded in the UI
                    const costInput = document.getElementById('ingredientCost');
                    if (costInput && costInput.value) {
                        costInput.value = roundToWholeNumber(costInput.value);
                    }
                }, 0);
                
                console.debug('[Menu] updateDishIngredientUnitOptions:', { ingredientId, unitType });
            } catch (e) {
                console.error('[Menu] updateDishIngredientUnitOptions error', e);
            }
        }

        // Download current menu data as JSON file
        function downloadMenuData() {
            try {
                const dataStr = JSON.stringify({
                    units: menuData.units,
                    ingredients: menuData.ingredients,
                    dishes: menuData.dishes
                }, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'menu.json';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showToast('Success', 'Exported menu.json', 'success');
            } catch (e) {
                console.error('[Menu] downloadMenuData error', e);
                showToast('Error', 'Failed to export data', 'danger');
            }
        }

        // Toggle ingredient fields based on unit type
        function toggleIngredientFields(unitType) {
            document.getElementById('densityContainer').style.display = unitType === 'volume' ? 'block' : 'none';
            document.getElementById('pieceWeightContainer').style.display = unitType === 'piece' ? 'block' : 'none';
        }

        // Save ingredient
        async function saveIngredient() {
            const name = document.getElementById('dishName').value.trim();
            const description = document.getElementById('dishDescription').value.trim();
            const photoUrl = document.getElementById('dishPhotoUrl').value.trim();
            // Category removed
            const unitType = document.getElementById('ingredientUnitType').value;
            const unit = document.getElementById('ingredientUnit').value;
            const costPerUnit = roundToWholeNumber(parseFloat(document.getElementById('ingredientCostPerUnit').value));
            // Active removed
            
            if (!name || !unitType || !unit || isNaN(costPerUnit)) {
                showToast('Error', 'Please fill in all required fields', 'danger');
                return;
            }
            
            const ingredient = {
                id: dishId || 'dish_' + Date.now(),
                name,
                description,
                photoUrl: photoUrl || null,
                unit,
                costPerUnit,
                lastUpdated: new Date().toISOString()
            };
            
            // Set optional properties based on unit type
            if (unitType === 'volume') {
                ingredient.density = parseFloat(document.getElementById('ingredientDensity').value) || 1;
            }
            
            // Add average weight for piece units
            if (unitType === 'piece') {
                ingredient.avgWeightPerPiece = parseFloat(document.getElementById('ingredientPieceWeight').value) || 0;
            }
            
            if (editingIngredientId) {
                // Update existing ingredient
                const index = menuData.ingredients.findIndex(i => i.id === editingIngredientId);
                if (index !== -1) {
                    menuData.ingredients[index] = ingredient;
                }
            } else {
                // Add new ingredient
                ingredient.createdAt = new Date().toISOString();
                menuData.ingredients.push(ingredient);
            }
            
            // Save data and update UI
            if (await saveData()) {
                filteredIngredients = [...menuData.ingredients];
                applyFilters();
                populateIngredientSelect();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('ingredientModal'));
                modal.hide();
                
                showToast('Success', 'Ingredient saved successfully', 'success');
            }
        }

        // Delete ingredient
        async function deleteIngredient(ingredientId) {
            if (!confirm('Are you sure you want to delete this ingredient?')) return;
            
            // Check if ingredient is used in any dishes
            const usedInDishes = menuData.dishes.filter(dish => 
                dish.ingredients && dish.ingredients.some(ing => ing.ingredientId === ingredientId)
            );
            
            if (usedInDishes.length > 0) {
                showToast('Error', 'Cannot delete ingredient as it is used in one or more dishes', 'danger');
                return;
            }
            
            const index = menuData.ingredients.findIndex(i => i.id === ingredientId);
            if (index !== -1) {
                menuData.ingredients.splice(index, 1);
                
                if (await saveData()) {
                    filteredIngredients = [...menuData.ingredients];
                    applyFilters();
                    populateIngredientSelect();
                    showToast('Success', 'Ingredient deleted successfully', 'success');
                }
            }
        }
        // Vendor Management Functions
        
        // Open vendor modal for adding/editing
        function openVendorModal(vendorId = null) {
            const modal = new bootstrap.Modal(document.getElementById('vendorModal'));
            const form = document.getElementById('vendorForm');
            
            // Reset form
            form.reset();
            document.getElementById('vendorId').value = '';
            
            // If editing, populate form with vendor data
            if (vendorId) {
                const vendor = menuData.vendors.find(v => v.id === vendorId);
                if (vendor) {
                    document.getElementById('vendorId').value = vendor.id;
                    document.getElementById('vendorName').value = vendor.name || '';
                    document.getElementById('vendorDescription').value = vendor.description || '';
                    document.getElementById('vendorContact').value = vendor.contact || '';
                    document.getElementById('vendorAddress').value = vendor.address || '';
                    document.getElementById('vendorActive').checked = vendor.active !== false;
                    document.getElementById('vendorModalLabel').textContent = 'Edit Vendor';
                }
            } else {
                document.getElementById('vendorModalLabel').textContent = 'Add New Vendor';
            }
            
            modal.show();
        }
        
        // Save vendor
        async function saveVendor() {
            try {
                const id = document.getElementById('vendorId').value || 'vendor_' + Date.now();
                const name = document.getElementById('vendorName').value.trim();
                const description = document.getElementById('vendorDescription').value.trim();
                const contact = document.getElementById('vendorContact').value.trim();
                const address = document.getElementById('vendorAddress').value.trim();
                const active = document.getElementById('vendorActive').checked;
                
                if (!name) {
                    showToast('Error', 'Vendor name is required', 'danger');
                    return;
                }
                
                const vendor = {
                    id,
                    name,
                    description,
                    contact,
                    address,
                    active,
                    updatedAt: new Date().toISOString()
                };
                
                // Check if this is a new vendor
                const existingIndex = menuData.vendors.findIndex(v => v.id === id);
                
                if (existingIndex >= 0) {
                    // Update existing vendor
                    menuData.vendors[existingIndex] = {
                        ...menuData.vendors[existingIndex],
                        ...vendor
                    };
                } else {
                    // Add new vendor
                    vendor.createdAt = new Date().toISOString();
                    menuData.vendors.push(vendor);
                }
                
                // Save data
                if (await saveData()) {
                    showToast('Success', `Vendor ${existingIndex >= 0 ? 'updated' : 'added'} successfully`, 'success');
                    renderVendorsList();
                    renderVendorTabs();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('vendorModal'));
                    if (modal) modal.hide();
                }
            } catch (error) {
                console.error('[Menu] saveVendor error', error);
                showToast('Error', 'Failed to save vendor', 'danger');
            }
        }
        
        // Delete vendor
        async function deleteVendor(vendorId) {
            if (!confirm('Are you sure you want to delete this vendor? This action cannot be undone.')) {
                return;
            }
            
            try {
                // Check if any ingredients are using this vendor
                const ingredientsUsingVendor = menuData.ingredients.filter(ing => ing.vendorId === vendorId);
                
                if (ingredientsUsingVendor.length > 0) {
                    showToast('Cannot Delete', `This vendor is being used by ${ingredientsUsingVendor.length} ingredient(s). Please update those ingredients first.`, 'warning');
                    return;
                }
                
                // Remove vendor
                menuData.vendors = menuData.vendors.filter(v => v.id !== vendorId);
                
                // Save data
                if (await saveData()) {
                    showToast('Success', 'Vendor deleted successfully', 'success');
                    renderVendorsList();
                    renderVendorTabs();
                }
            } catch (error) {
                console.error('[Menu] deleteVendor error', error);
                showToast('Error', 'Failed to delete vendor', 'danger');
            }
        }
        
        // Render vendors list in the vendors tab
        function renderVendorsList() {
            const vendorsList = document.getElementById('vendorsList');
            if (!vendorsList) return;
            
            if (!menuData.vendors || menuData.vendors.length === 0) {
                vendorsList.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            <i class="bi bi-shop fs-1 d-block mb-2"></i>
                            No vendors found. Click "Add Vendor" to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            vendorsList.innerHTML = menuData.vendors.map(vendor => {
                const ingredientsCount = menuData.ingredients.filter(ing => ing.vendorId === vendor.id).length;
                
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-shop fs-5"></i>
                                </div>
                                <div>
                                    <div class="fw-medium">${vendor.name}</div>
                                    <small class="text-muted">${vendor.contact || 'No contact'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${vendor.description || '-'}</td>
                        <td>${ingredientsCount} ingredient(s)</td>
                        <td>
                            <span class="badge ${vendor.active !== false ? 'bg-success' : 'bg-secondary'}">
                                ${vendor.active !== false ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openVendorModal('${vendor.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteVendor('${vendor.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Render vendor tabs in the ingredients section
        function renderVendorTabs() {
            const vendorTabsContainer = document.getElementById('vendorTabs');
            const vendorTabsContent = document.getElementById('vendorTabsContent');
            
            if (!vendorTabsContainer || !vendorTabsContent) return;
            
            // Clear existing vendor tabs (except the first one)
            const allVendorsTab = vendorTabsContainer.querySelector('li:first-child');
            vendorTabsContainer.innerHTML = '';
            vendorTabsContainer.appendChild(allVendorsTab);
            
            // Clear existing vendor tab panes (except the first one)
            const allVendorsPane = vendorTabsContent.querySelector('#all-vendors').parentNode;
            vendorTabsContent.innerHTML = '';
            vendorTabsContent.appendChild(allVendorsPane);
            
            // Add tabs for each vendor
            menuData.vendors.forEach(vendor => {
                if (vendor.active === false) return; // Skip inactive vendors
                
                const tabId = `vendor-${vendor.id}`;
                
                // Add tab
                const tab = document.createElement('li');
                tab.className = 'nav-item';
                tab.role = 'presentation';
                tab.innerHTML = `
                    <button class="nav-link" id="${tabId}-tab" data-bs-toggle="tab" 
                        data-bs-target="#${tabId}" type="button" role="tab" 
                        aria-controls="${tabId}" aria-selected="false">
                        ${vendor.name}
                    </button>
                `;
                vendorTabsContainer.appendChild(tab);
                
                // Add tab pane
                const pane = document.createElement('div');
                pane.className = 'tab-pane fade';
                pane.id = tabId;
                pane.role = 'tabpanel';
                pane.setAttribute('aria-labelledby', `${tabId}-tab`);
                pane.innerHTML = `
                    <div class="ingredients-list" id="ingredientsList-${vendor.id}"></div>
                `;
                vendorTabsContent.appendChild(pane);
            });
            
            // Initialize the first tab as active if no tab is active
            if (!vendorTabsContainer.querySelector('.active')) {
                const firstTab = vendorTabsContainer.querySelector('button.nav-link');
                if (firstTab) firstTab.classList.add('active');
                
                const firstPane = vendorTabsContent.querySelector('.tab-pane');
                if (firstPane) firstPane.classList.add('show', 'active');
            }
        }
        
        // Update the renderIngredients function to support vendor filtering
        function renderIngredients(vendorId = null) {
            const container = vendorId 
                ? document.getElementById(`ingredientsList-${vendorId}`) 
                : document.getElementById('ingredientsListContainer');
                
            if (!container) return;
            
            // Filter ingredients by vendor if specified
            let filteredIngredients = [...menuData.ingredients];
            if (vendorId) {
                filteredIngredients = filteredIngredients.filter(ing => ing.vendorId === vendorId);
            }
            
            if (filteredIngredients.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="bi bi-basket" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mt-2">No ingredients found</p>
                    </div>
                `;
                return;
            }
            
            // Render ingredients in a grid
            container.innerHTML = `
                <div class="row row-cols-1 row-cols-md-2 g-3">
                    ${filteredIngredients.map(ingredient => {
                        const stockStatus = getStockStatus(ingredient);
                        return `
                            <div class="col">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 class="card-title mb-1">${ingredient.name}</h6>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="openIngredientModal('${ingredient.id}')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteIngredient('${ingredient.id}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        ${ingredient.description ? `
                                            <p class="card-text text-muted small mb-2">${ingredient.description}</p>
                                        ` : ''}
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <div>
                                                <span class="badge bg-light text-dark border me-2">
                                                    <i class="bi bi-box-seam me-1"></i> ${ingredient.unit || 'N/A'}
                                                </span>
                                            </div>
                                            <div class="text-end">
                                                <div class="fw-bold text-success">₹${(ingredient.costPerUnit || 0).toFixed(2)}</div>
                                                <small class="text-muted">per ${ingredient.unit || 'unit'}</small>
                                            </div>
                                        </div>
                                        ${stockStatus ? `
                                            <div class="mt-2">
                                                <span class="badge ${stockStatus.class}">
                                                    <i class="bi ${stockStatus.icon}"></i> ${stockStatus.text}
                                                </span>
                                                <small class="text-muted ms-2">${ingredient.currentStock} ${ingredient.unit || ''} available</small>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // Helper function to get stock status for an ingredient
        function getStockStatus(ingredient) {
            if (typeof ingredient.currentStock === 'undefined' || ingredient.currentStock === null) {
                return null;
            }
            
            if (ingredient.currentStock <= 0) {
                return {
                    text: 'Out of Stock',
                    class: 'bg-danger',
                    icon: 'bi-x-circle'
                };
            } else if (ingredient.minStockLevel && ingredient.currentStock < ingredient.minStockLevel) {
                return {
                    text: 'Low Stock',
                    class: 'bg-warning text-dark',
                    icon: 'bi-exclamation-triangle'
                };
            } else {
                return {
                    text: 'In Stock',
                    class: 'bg-success',
                    icon: 'bi-check-circle'
                };
            }
        }
        
        // Initialize vendor management
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for save vendor button
            document.getElementById('saveVendorBtn')?.addEventListener('click', saveVendor);
            
            // Initialize vendor tabs
            if (menuData.vendors) {
                renderVendorsList();
                renderVendorTabs();
            }
            
            // Handle tab change to render ingredients for the selected vendor
            document.getElementById('vendorTabs')?.addEventListener('shown.bs.tab', function(event) {
                const target = event.target;
                const targetId = target.getAttribute('data-bs-target');
                
                if (targetId === '#all-vendors') {
                    renderIngredients();
                } else {
                    const vendorId = targetId.replace('#vendor-', '');
                    renderIngredients(vendorId);
                }
            });
        });
    </script>
</body>

</html>