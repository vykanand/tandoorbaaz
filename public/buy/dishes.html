<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dishes Management - TandoorBaaz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
        }
        
        .dish-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .dish-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .profit-positive {
            color: var(--success-color);
        }
        
        .profit-negative {
            color: var(--danger-color);
        }
        
        .ingredient-tag {
            display: inline-block;
            background-color: #e9ecef;
            border-radius: 15px;
            padding: 2px 10px;
            margin: 2px;
            font-size: 0.8rem;
        }
        
        .status-badge {
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shop me-2"></i>TandoorBaaz
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">Orders</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ingredients.html">Ingredients</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="dishes.html">Dishes</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-egg-fried me-2"></i>Dishes Management</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDishModal">
                <i class="bi bi-plus-lg me-1"></i> Add Dish
            </button>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h3 class="mb-0" id="totalDishes">0</h3>
                        <p class="text-muted mb-0">Total Dishes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h3 class="mb-0" id="avgCost">₹0.00</h3>
                        <p class="text-muted mb-0">Avg. Cost Price</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h3 class="mb-0" id="avgProfit">0%</h3>
                        <p class="text-muted mb-0">Avg. Profit Margin</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Dishes List</span>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchDishInput" class="form-control" placeholder="Search dishes...">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Dish Name</th>
                                <th>Category</th>
                                <th>Ingredients</th>
                                <th>Cost Price</th>
                                <th>Selling Price</th>
                                <th>Profit</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dishesTable">
                            <!-- Dishes will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Dish Modal -->
    <div class="modal fade" id="dishModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dishModalTitle">Add New Dish</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="dishForm">
                    <input type="hidden" id="dishId">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dishName" class="form-label">Dish Name</label>
                                <input type="text" class="form-control" id="dishName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dishCategory" class="form-label">Category</label>
                                <select class="form-select" id="dishCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="starters">Starters</option>
                                    <option value="main-course">Main Course</option>
                                    <option value="breads">Breads</option>
                                    <option value="rice">Rice & Biryani</option>
                                    <option value="desserts">Desserts</option>
                                    <option value="beverages">Beverages</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ingredients</label>
                            <div id="ingredientsContainer">
                                <!-- Ingredient rows will be added here -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addIngredientBtn">
                                <i class="bi bi-plus-lg me-1"></i> Add Ingredient
                            </button>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="costPrice" class="form-label">Cost Price (₹)</label>
                                <input type="number" class="form-control" id="costPrice" min="0" step="0.01" readonly>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="sellingPrice" class="form-label">Selling Price (₹)</label>
                                <input type="number" class="form-control" id="sellingPrice" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="profitMargin" class="form-label">Profit Margin</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="profitMargin" min="0" max="1000" step="0.1" value="30" required>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dishDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="dishDescription" rows="2"></textarea>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="dishActive" checked>
                            <label class="form-check-label" for="dishActive">Active (Available for Ordering)</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Dish</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sample data - in a real app, this would come from a database
        let dishes = JSON.parse(localStorage.getItem('dishes')) || [];
        let ingredients = [];
        
        // DOM Elements
        const dishesTable = document.getElementById('dishesTable');
        const searchDishInput = document.getElementById('searchDishInput');
        const dishForm = document.getElementById('dishForm');
        const ingredientsContainer = document.getElementById('ingredientsContainer');
        const addIngredientBtn = document.getElementById('addIngredientBtn');
        const costPriceInput = document.getElementById('costPrice');
        const sellingPriceInput = document.getElementById('sellingPrice');
        const profitMarginInput = document.getElementById('profitMargin');
        const dishModal = new bootstrap.Modal(document.getElementById('dishModal'));
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // In a real app, we would fetch ingredients from the server
            ingredients = JSON.parse(localStorage.getItem('ingredients')) || [];
            
            renderDishes();
            updateStats();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Search functionality
            searchDishInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderDishes(searchTerm);
            });
            
            // Dish form submission
            dishForm.addEventListener('submit', handleDishSubmit);
            
            // Add ingredient button
            addIngredientBtn.addEventListener('click', addIngredientRow);
            
            // Price calculation
            sellingPriceInput.addEventListener('input', calculateProfitMargin);
            profitMarginInput.addEventListener('input', calculateSellingPrice);
            
            // Initialize the "Add Dish" button
            document.querySelector('[data-bs-target="#dishModal"]').addEventListener('click', () => {
                document.getElementById('dishModalTitle').textContent = 'Add New Dish';
                document.getElementById('dishForm').reset();
                document.getElementById('dishId').value = '';
                ingredientsContainer.innerHTML = '';
                addIngredientRow(); // Add one empty ingredient row by default
                calculateCostPrice();
            });
        }
        
        // Render dishes table
        function renderDishes(searchTerm = '') {
            let filteredDishes = [...dishes];
            
            if (searchTerm) {
                filteredDishes = dishes.filter(dish => 
                    dish.name.toLowerCase().includes(searchTerm) ||
                    (dish.category && dish.category.toLowerCase().includes(searchTerm))
                );
            }
            
            dishesTable.innerHTML = '';
            
            if (filteredDishes.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" class="text-center py-4 text-muted">
                        No dishes found. Click "Add Dish" to create a new one.
                    </td>
                `;
                dishesTable.appendChild(row);
                return;
            }
            
            filteredDishes.forEach(dish => {
                const costPrice = parseFloat(dish.costPrice) || 0;
                const sellingPrice = parseFloat(dish.sellingPrice) || 0;
                const profit = sellingPrice - costPrice;
                const profitMargin = costPrice > 0 ? (profit / costPrice) * 100 : 0;
                
                // Get ingredient names for display
                const ingredientNames = dish.ingredients?.map(ing => {
                    const ingredient = ingredients.find(i => i.id === ing.ingredientId);
                    return ingredient ? `${ing.quantity} ${ing.unit} ${ingredient.name}` : '';
                }).filter(Boolean);
                
                const row = document.createElement('tr');
                row.className = 'align-middle';
                row.innerHTML = `
                    <td>${dish.name}</td>
                    <td>${formatCategory(dish.category)}</td>
                    <td>
                        <div class="d-flex flex-wrap" style="max-width: 250px;">
                            ${ingredientNames.slice(0, 3).map(name => 
                                `<span class="ingredient-tag" title="${name}">${name.split(' ')[0]}...</span>`
                            ).join('')}
                            ${ingredientNames.length > 3 ? 
                                `<span class="ingredient-tag">+${ingredientNames.length - 3} more</span>` : ''}
                        </div>
                    </td>
                    <td>₹${costPrice.toFixed(2)}</td>
                    <td>₹${sellingPrice.toFixed(2)}</td>
                    <td class="${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                        ${profit >= 0 ? '+' : ''}₹${Math.abs(profit).toFixed(2)} (${profitMargin.toFixed(1)}%)
                    </td>
                    <td>
                        <span class="badge ${dish.active ? 'bg-success' : 'bg-secondary'} status-badge">
                            ${dish.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editDish('${dish.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteDish('${dish.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                dishesTable.appendChild(row);
            });
        }
        
        // Add a new ingredient row to the form
        function addIngredientRow(ingredientData = {}) {
            const row = document.createElement('div');
            row.className = 'row g-2 mb-2 ingredient-row';
            row.innerHTML = `
                <div class="col-md-5">
                    <select class="form-select ingredient-select" required>
                        <option value="">Select Ingredient</option>
                        ${ingredients.map(ing => 
                            `<option value="${ing.id}" 
                                    data-unit="${ing.unit || 'g'}"
                                    data-price="${ing.unitPrice || 0}"
                                    ${ingredientData.ingredientId === ing.id ? 'selected' : ''}>
                                ${ing.name} (${ing.unit || 'g'})
                            </option>`
                        ).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control quantity" 
                           min="0.001" step="0.001" 
                           value="${ingredientData.quantity || ''}" required>
                </div>
                <div class="col-md-3">
                    <select class="form-select unit" ${ingredientData.ingredientId ? 'disabled' : ''}>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">L</option>
                        <option value="pcs">pcs</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-ingredient">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            // Set unit if provided
            if (ingredientData.unit) {
                row.querySelector('.unit').value = ingredientData.unit;
            }
            
            // Add event listeners
            const select = row.querySelector('.ingredient-select');
            select.addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const unit = selectedOption.dataset.unit || 'g';
                row.querySelector('.unit').value = unit;
                calculateCostPrice();
            });
            
            row.querySelector('.quantity').addEventListener('input', calculateCostPrice);
            row.querySelector('.remove-ingredient').addEventListener('click', () => {
                row.remove();
                calculateCostPrice();
            });
            
            ingredientsContainer.appendChild(row);
            return row;
        }
        
        // Calculate total cost price based on ingredients
        function calculateCostPrice() {
            let totalCost = 0;
            const rows = document.querySelectorAll('.ingredient-row');
            
            rows.forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const quantityInput = row.querySelector('.quantity');
                const unitSelect = row.querySelector('.unit');
                
                if (!select.value || !quantityInput.value) return;
                
                const ingredient = ingredients.find(i => i.id === select.value);
                if (!ingredient) return;
                
                let quantity = parseFloat(quantityInput.value) || 0;
                let unit = unitSelect.value;
                
                // Convert to base unit for calculation (g, ml, pcs)
                let baseQuantity = quantity;
                if ((unit === 'kg' || unit === 'l') && ingredient.unit === 'g') {
                    baseQuantity = quantity * 1000; // Convert kg to g or L to ml
                }
                
                // Calculate cost for this ingredient
                if (ingredient.unitPrice) {
                    // In a real app, this would handle different units and conversions
                    totalCost += (baseQuantity / 1000) * ingredient.unitPrice; // Assuming unitPrice is per kg/L
                }
            });
            
            // Update the cost price field
            costPriceInput.value = totalCost.toFixed(2);
            
            // Recalculate selling price based on profit margin
            calculateSellingPrice();
            
            return totalCost;
        }
        
        // Calculate selling price based on cost price and profit margin
        function calculateSellingPrice() {
            const costPrice = parseFloat(costPriceInput.value) || 0;
            const profitMargin = parseFloat(profitMarginInput.value) || 0;
            
            if (costPrice > 0 && profitMargin >= 0) {
                const sellingPrice = costPrice * (1 + (profitMargin / 100));
                sellingPriceInput.value = sellingPrice.toFixed(2);
            }
        }
        
        // Calculate profit margin based on cost and selling price
        function calculateProfitMargin() {
            const costPrice = parseFloat(costPriceInput.value) || 0;
            const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
            
            if (costPrice > 0 && sellingPrice > 0) {
                const profitMargin = ((sellingPrice - costPrice) / costPrice) * 100;
                profitMarginInput.value = profitMargin.toFixed(1);
            } else {
                profitMarginInput.value = '0';
            }
        }
        
        // Handle dish form submission
        function handleDishSubmit(e) {
            e.preventDefault();
            
            const id = document.getElementById('dishId').value;
            const name = document.getElementById('dishName').value;
            const category = document.getElementById('dishCategory').value;
            const costPrice = parseFloat(costPriceInput.value) || 0;
            const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
            const description = document.getElementById('dishDescription').value;
            const active = document.getElementById('dishActive').checked;
            
            // Collect ingredients
            const dishIngredients = [];
            document.querySelectorAll('.ingredient-row').forEach(row => {
                const select = row.querySelector('.ingredient-select');
                const quantity = row.querySelector('.quantity').value;
                const unit = row.querySelector('.unit').value;
                
                if (select.value && quantity) {
                    dishIngredients.push({
                        ingredientId: select.value,
                        name: select.options[select.selectedIndex].text.split(' (')[0],
                        quantity: parseFloat(quantity),
                        unit: unit
                    });
                }
            });
            
            if (dishIngredients.length === 0) {
                alert('Please add at least one ingredient to the dish.');
                return;
            }
            
            const dishData = {
                id: id || generateId(),
                name,
                category,
                ingredients: dishIngredients,
                costPrice,
                sellingPrice,
                description,
                active,
                updatedAt: new Date().toISOString()
            };
            
            if (id) {
                // Update existing dish
                const index = dishes.findIndex(d => d.id === id);
                if (index !== -1) {
                    dishes[index] = { ...dishes[index], ...dishData };
                }
            } else {
                // Add new dish
                dishData.createdAt = new Date().toISOString();
                dishes.push(dishData);
            }
            
            saveDishes();
            renderDishes();
            updateStats();
            dishModal.hide();
            dishForm.reset();
        }
        
        // Edit dish
        window.editDish = function(id) {
            const dish = dishes.find(d => d.id === id);
            if (!dish) return;
            
            document.getElementById('dishModalTitle').textContent = 'Edit Dish';
            document.getElementById('dishId').value = dish.id;
            document.getElementById('dishName').value = dish.name;
            document.getElementById('dishCategory').value = dish.category || '';
            document.getElementById('dishDescription').value = dish.description || '';
            document.getElementById('dishActive').checked = dish.active !== false; // Default to true if not set
            
            // Clear existing ingredient rows
            ingredientsContainer.innerHTML = '';
            
            // Add ingredient rows
            if (dish.ingredients && dish.ingredients.length > 0) {
                dish.ingredients.forEach(ing => {
                    addIngredientRow(ing);
                });
            } else {
                addIngredientRow();
            }
            
            // Set prices
            costPriceInput.value = (dish.costPrice || 0).toFixed(2);
            sellingPriceInput.value = (dish.sellingPrice || 0).toFixed(2);
            
            // Calculate and set profit margin
            const cost = parseFloat(dish.costPrice) || 0;
            const selling = parseFloat(dish.sellingPrice) || 0;
            const margin = cost > 0 ? ((selling - cost) / cost) * 100 : 0;
            profitMarginInput.value = margin.toFixed(1);
            
            dishModal.show();
        };
        
        // Delete dish
        window.deleteDish = function(id) {
            if (!confirm('Are you sure you want to delete this dish? This action cannot be undone.')) {
                return;
            }
            
            dishes = dishes.filter(d => d.id !== id);
            saveDishes();
            renderDishes();
            updateStats();
        };
        
        // Update statistics
        function updateStats() {
            // Total dishes
            document.getElementById('totalDishes').textContent = dishes.length;
            
            // Average cost price
            const totalCost = dishes.reduce((sum, dish) => sum + (parseFloat(dish.costPrice) || 0), 0);
            const avgCost = dishes.length > 0 ? totalCost / dishes.length : 0;
            document.getElementById('avgCost').textContent = `₹${avgCost.toFixed(2)}`;
            
            // Average profit margin
            const totalMargin = dishes.reduce((sum, dish) => {
                const cost = parseFloat(dish.costPrice) || 0;
                const selling = parseFloat(dish.sellingPrice) || 0;
                if (cost > 0) {
                    return sum + ((selling - cost) / cost) * 100;
                }
                return sum;
            }, 0);
            
            const avgMargin = dishes.length > 0 ? totalMargin / dishes.length : 0;
            document.getElementById('avgProfit').textContent = `${avgMargin.toFixed(1)}%`;
        }
        
        // Helper functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function saveDishes() {
            localStorage.setItem('dishes', JSON.stringify(dishes));
        }
        
        function formatCategory(category) {
            if (!category) return 'Uncategorized';
            return category.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
    </script>
</body>
</html>
