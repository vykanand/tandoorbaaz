<!DOCTYPE html>
<html lang="en">

<head>
    <title>TandoorBaaz Accounting</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --light-color: #f8f9fa;
            --background-color: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --card-border-radius: 12px;
            --transition-speed: 0.3s;
            --ease-out: cubic-bezier(0.25, 0.1, 0.25, 1);
            --ease-in: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Global Styles */
        body {
            background-color: var(--background-color);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .container-fluid {
            padding: 1rem;
        }

        /* Card Styles */
        .card {
            border: none;
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            transition: all var(--transition-speed) var(--ease-out);
            background: white;
            backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.95);
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: none;
            border-bottom: none;
            padding: 1rem;
        }

        .card-header h5 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Summary section styles */
        .summary-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .summary-card h3 {
            font-size: 2.2rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .summary-card .card-body {
            padding: 1.5rem;
            border-radius: 15px;
        }

        .summary-card .card-title {
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .summary-card .badge {
            border-radius: 20px;
            padding: 0.5rem 0.8rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Table Styles */
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }

        /* Status Badges */
        .badge-paid-cash {
            background-color: var(--success-color);
        }

        .badge-paid-online {
            background-color: #6f42c1;
        }

        .badge-pending {
            background-color: var(--warning-color);
            color: #212529;
        }

        .badge-delivered {
            background-color: var(--info-color);
        }

        /* Date Range Picker */
        .date-range-picker {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .date-range-picker .form-control {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-controls .form-select,
        .filter-controls .form-control {
            min-width: 150px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0.5rem;
            }

            .card {
                margin-bottom: 0.75rem;
                border-radius: 10px;
            }

            .summary-card h3 {
                font-size: 1.5rem;
            }

            .date-range-picker,
            .filter-controls {
                flex-direction: column;
                gap: 0.5rem;
            }

            .table-responsive {
                border-radius: 10px;
                overflow: hidden;
            }
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            border-bottom: 2px solid var(--light-color);
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 2px solid var(--light-color);
            padding: 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-4">
        <!-- Accounting Summary Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-white d-flex justify-content-between align-items-center"
                        style="background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);">
                        <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Accounting Summary</h5>
                        <div class="d-flex align-items-center">
                            <div id="networkStatus" class="me-3">
                                <span class="badge bg-success">Online</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-light me-2" onclick="exportToCSV()"
                                    style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <i class="bi bi-file-earmark-excel"></i> Export
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="loadOrders()"
                                    style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Date Range Picker -->
                        <div class="date-range-picker">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="date" id="startDate" class="form-control" onchange="applyDateFilter()">
                            </div>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="date" id="endDate" class="form-control" onchange="applyDateFilter()">
                            </div>
                            <button class="btn btn-primary" onclick="resetDateFilter()">
                                <i class="bi bi-calendar-check"></i> Today
                            </button>
                            <button class="btn btn-outline-secondary" onclick="setLastWeek()">
                                Last Week
                            </button>
                            <button class="btn btn-outline-secondary" onclick="setLastMonth()">
                                Last Month
                            </button>
                            <button class="btn btn-outline-secondary" onclick="loadAllOrders()">
                                All Orders
                            </button>
                        </div>

                        <!-- Summary Cards -->
                        <div class="row">
                            <div class="col-md-3 mb-3 mb-md-0">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title"><i class="bi bi-calendar-check"></i> Total Orders</h6>
                                        <h3 id="totalOrdersCount" class="mb-0">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge bg-primary">Total Sale: â‚¹<span
                                                    id="totalSalesAmount">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #d1e7dd 0%, #a3cfbb 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-cash"></i> Cash Payments</h6>
                                        <h3 id="cashPaymentsCount" class="mb-0 text-dark">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge bg-success">Value: â‚¹<span
                                                    id="cashPaymentsTotal">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #e2d9f3 0%, #c5b3e6 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-credit-card"></i> Online
                                            Payments</h6>
                                        <h3 id="onlinePaymentsCount" class="mb-0 text-dark">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge" style="background-color: #6f42c1;">Value: â‚¹<span
                                                    id="onlinePaymentsTotal">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <div class="card summary-card h-100"
                                    style="background: linear-gradient(135deg, #fff3cd 0%, #ffda6a 100%);">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-dark"><i class="bi bi-hourglass-split"></i> Pending
                                            Orders</h6>
                                        <h3 id="pendingOrdersCount" class="mb-0 text-dark">0</h3>
                                        <div class="d-flex justify-content-center align-items-center mt-3">
                                            <span class="badge" style="background-color: #fd7e14;">Value: â‚¹<span
                                                    id="pendingOrdersTotal">0</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-table"></i> Orders List</h5>
                        <div class="filter-controls">
                            <select id="statusFilter" class="form-select" onchange="applyFilters()">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="paid(online)">Paid (Online)</option>
                                <option value="paid (cash)">Paid (Cash)</option>
                                <option value="delivered">Delivered</option>
                            </select>
                            <input type="text" id="searchInput" class="form-control" placeholder="Search orders..."
                                onkeyup="applyFilters()">
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable('id')" style="cursor: pointer;">
                                            Order ID <i id="sortIcon-id" class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th onclick="sortTable('date')" style="cursor: pointer;">
                                            Date <i id="sortIcon-date" class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th onclick="sortTable('customer')" style="cursor: pointer;">
                                            Customer <i id="sortIcon-customer" class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th onclick="sortTable('total')" style="cursor: pointer;">
                                            Total <i id="sortIcon-total" class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th onclick="sortTable('status')" style="cursor: pointer;">
                                            Status <i id="sortIcon-status" class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th onclick="sortTable('comments')" style="cursor: pointer;">
                                            Comments <i id="sortIcon-comments" class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <!-- Orders will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrderModalLabel">Edit Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <input type="hidden" id="editOrderId">
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">Customer Phone</label>
                            <input type="text" class="form-control" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerComments" class="form-label">Customer Comments</label>
                            <textarea class="form-control" id="editCustomerComments" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editOrderStatus" class="form-label">Status</label>
                            <select class="form-select" id="editOrderStatus">
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="paid(online)">Paid (Online)</option>
                                <option value="paid (cash)">Paid (Cash)</option>
                                <option value="delivered">Delivered</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Order Items</label>
                            <div id="editOrderItems" class="list-group mb-3">
                                <!-- Order items will be populated here -->
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <strong>Total:</strong>
                                <h5 class="mb-0">â‚¹<span id="editOrderTotal">0</span></h5>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrderChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Order ID:</strong> <span id="detailsOrderId"></span></p>
                            <p><strong>Date:</strong> <span id="detailsOrderDate"></span></p>
                            <p><strong>Status:</strong> <span id="detailsOrderStatus"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Customer Phone:</strong> <span id="detailsCustomerPhone"></span></p>
                            <p><strong>Comments:</strong> <span id="detailsCustomerComments"></span></p>
                            <p><strong>Total:</strong> â‚¹<span id="detailsOrderTotal"></span></p>
                        </div>
                    </div>
                    <h6>Order Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Portion</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="detailsOrderItems">
                                <!-- Order items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="openEditModal(currentOrderId)">Edit
                        Order</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEKHWdRyzI8WyBeGeesjDrM-nEzOXCuNk",
            authDomain: "billion1-a9324.firebaseapp.com",
            projectId: "billion1-a9324",
            storageBucket: "billion1-a9324.appspot.com",
            messagingSenderId: "443716692865",
            appId: "1:443716692865:web:96813fe32a44f8342cd680",
            measurementId: "G-FE7NFHY5PG"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence({synchronizeTabs: true})
          .catch(function(err) {
              if (err.code == 'failed-precondition') {
                  // Multiple tabs open, persistence can only be enabled in one tab at a time
                  console.warn('Firebase persistence could not be enabled: Multiple tabs open');
              } else if (err.code == 'unimplemented') {
                  // The current browser does not support all of the features required for persistence
                  console.warn('Firebase persistence not supported in this browser');
              }
          });

        // Application State
        let state = {
            allOrders: [],
            filteredOrders: [],
            sortField: 'date',
            sortDirection: 'desc',
            startDate: null,
            endDate: null,
            statusFilter: 'all',
            searchQuery: '',
            isOffline: false,
            retryCount: 0
        };
        
        // Network status monitoring
        function updateNetworkStatus() {
            const isOnline = navigator.onLine;
            const networkStatusElement = document.getElementById('networkStatus');
            
            if (isOnline) {
                if (networkStatusElement) {
                    networkStatusElement.innerHTML = '<span class="badge bg-success">Online</span>';
                }
                if (state.isOffline) {
                    // We were offline but now we're back online, try to reload data
                    state.isOffline = false;
                    loadOrders();
                }
            } else {
                if (networkStatusElement) {
                    networkStatusElement.innerHTML = '<span class="badge bg-danger">Offline</span>';
                }
                state.isOffline = true;
            }
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);

        let currentOrderId = null;
        let editOrderModal = null;
        let orderDetailsModal = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize modals
            editOrderModal = new bootstrap.Modal(document.getElementById('editOrderModal'));
            orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));

            // Check network status
            updateNetworkStatus();

            // Set default date range to today
            resetDateFilter();

            // Load orders
            loadOrders();
        });

        // Load orders from Firestore
        async function loadOrders() {
            // Show loading indicator
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading orders...</p></td></tr>';
            
            try {
                // Update network status first
                updateNetworkStatus();
                
                // If we're offline, show cached data with a message
                if (state.isOffline && state.allOrders.length > 0) {
                    // We have cached data to show
                    showOfflineAlert("You're currently offline. Showing cached data.");
                    applyFilters();
                    return;
                } else if (state.isOffline && state.allOrders.length === 0) {
                    // We're offline with no cached data
                    showOfflineAlert("You're currently offline. No cached data available.");
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="alert alert-warning"><i class="bi bi-wifi-off"></i> You are offline. Please check your internet connection and try again.</div></td></tr>';
                    return;
                }
                
                let query = db.collection('bot_orders');

                try {
                    // Apply date filters if set
                    if (state.startDate) {
                        console.log("Start date filter:", state.startDate);
                        query = query.where('createdAt', '>=', state.startDate);
                    }
                    if (state.endDate) {
                        // Add one day to include the end date fully
                        const endDatePlusOne = new Date(state.endDate);
                        endDatePlusOne.setDate(endDatePlusOne.getDate() + 1);
                        console.log("End date filter:", endDatePlusOne);
                        query = query.where('createdAt', '<', endDatePlusOne);
                    }
                } catch (dateError) {
                    console.error("Error applying date filters:", dateError);
                    // If date filtering fails, try without filters
                    query = db.collection('bot_orders');
                }

                // Order by creation date
                query = query.orderBy('createdAt', 'desc');

                console.log("Fetching orders with query:", query);
                // Get the snapshot
                const snapshot = await query.get();
                console.log("Fetched orders:", snapshot.size);
                
                // Reset retry count on success
                state.retryCount = 0;
                
                // Hide any offline alerts
                hideOfflineAlert();
                
                // Process orders
                state.allOrders = snapshot.docs.map(doc => {
                    const data = doc.data();
                    
                    // Process createdAt to ensure it's a Date object
                    let createdAtDate = null;
                    if (data.createdAt) {
                        if (typeof data.createdAt.toDate === 'function') {
                            createdAtDate = data.createdAt.toDate();
                        } else if (data.createdAt instanceof Date) {
                            createdAtDate = data.createdAt;
                        }
                    }

                    return {
                        docId: doc.id,
                        ...data,
                        createdAt: createdAtDate,
                        // Ensure items is always an array
                        items: Array.isArray(data.items) ? data.items : []
                    };
                });

                // Apply filters and update UI
                applyFilters();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                
                // Update offline status
                state.isOffline = navigator.onLine ? false : true;
                updateNetworkStatus();
                
                // Show error in the table
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Error loading orders: ${error.message}
                    </div>
                    <button class="btn btn-primary mt-3" onclick="loadOrders()">
                        <i class="bi bi-arrow-clockwise"></i> Try Again
                    </button>
                </td></tr>`;
                
                // Show error alert
                showOfflineAlert(`Error loading orders: ${error.message}`);
                
                // If we have cached data, still show it
                if (state.allOrders.length > 0) {
                    showOfflineAlert("Showing previously loaded orders.");
                    applyFilters();
                }
            }
        }
        
        // Show offline alert
        function showOfflineAlert(message) {
            // Remove any existing alerts
            hideOfflineAlert();
            
            // Create new alert
            const alertDiv = document.createElement('div');
            alertDiv.id = 'offlineAlert';
            alertDiv.className = 'alert alert-warning alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-wifi-off me-2"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert at the top of the page
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
        }
        
        // Hide offline alert
        function hideOfflineAlert() {
            const existingAlert = document.getElementById('offlineAlert');
            if (existingAlert) {
                existingAlert.remove();
            }
        }

        // Apply filters to orders
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();

            state.statusFilter = statusFilter;
            state.searchQuery = searchQuery;

            // Filter orders
            state.filteredOrders = state.allOrders.filter(order => {
                // Status filter
                if (statusFilter !== 'all' && order.status !== statusFilter) {
                    return false;
                }

                // Search query
                if (searchQuery) {
                    const orderIdMatch = order.id && order.id.toString().includes(searchQuery);
                    const phoneMatch = order.customerDetails && order.customerDetails.phone && 
                                      order.customerDetails.phone.toLowerCase().includes(searchQuery);
                    const commentsMatch = order.customerDetails && order.customerDetails.comments && 
                                         order.customerDetails.comments.toLowerCase().includes(searchQuery);
                    
                    if (!orderIdMatch && !phoneMatch && !commentsMatch) {
                        return false;
                    }
                }

                return true;
            });

            // Sort orders
            sortOrders();

            // Update UI
            updateSummaryStats();
            renderOrdersTable();
        }

        // Sort orders based on current sort field and direction
        function sortOrders() {
            state.filteredOrders.sort((a, b) => {
                let valueA, valueB;

                switch (state.sortField) {
                    case 'id':
                        valueA = a.id ? a.id.toString() : a.docId;
                        valueB = b.id ? b.id.toString() : b.docId;
                        break;
                    case 'date':
                        valueA = a.createdAt ? a.createdAt.getTime() : 0;
                        valueB = b.createdAt ? b.createdAt.getTime() : 0;
                        break;
                    case 'customer':
                        valueA = a.customerDetails && a.customerDetails.phone ? a.customerDetails.phone : '';
                        valueB = b.customerDetails && b.customerDetails.phone ? b.customerDetails.phone : '';
                        break;
                    case 'total':
                        valueA = parseFloat(a.total || 0);
                        valueB = parseFloat(b.total || 0);
                        break;
                    case 'status':
                        valueA = a.status || '';
                        valueB = b.status || '';
                        break;
                    case 'comments':
                        valueA = a.customerDetails && a.customerDetails.comments ? a.customerDetails.comments : '';
                        valueB = b.customerDetails && b.customerDetails.comments ? b.customerDetails.comments : '';
                        break;
                    default:
                        valueA = a.createdAt ? a.createdAt.getTime() : 0;
                        valueB = b.createdAt ? b.createdAt.getTime() : 0;
                }

                // Compare values based on sort direction
                if (state.sortDirection === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
        }

        // Sort table by column
        function sortTable(field) {
            // If clicking the same field, toggle direction
            if (state.sortField === field) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortField = field;
                state.sortDirection = 'asc';
            }

            // Reset all sort icons
            document.querySelectorAll('[id^="sortIcon-"]').forEach(icon => {
                icon.className = 'bi bi-arrow-down-up';
            });

            // Update the clicked column's icon
            const sortIcon = document.getElementById(`sortIcon-${field}`);
            sortIcon.className = state.sortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down';

            // Sort and render
            sortOrders();
            renderOrdersTable();
        }

        // Render orders table
        function renderOrdersTable() {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';

            if (state.filteredOrders.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="text-center">No orders found</td>`;
                tableBody.appendChild(row);
                return;
            }

            state.filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                
                // Format date
                const orderDate = order.createdAt ? formatDate(order.createdAt) : 'N/A';
                
                // Format status badge
                let statusBadgeClass = '';
                switch (order.status) {
                    case 'paid (cash)':
                        statusBadgeClass = 'badge-paid-cash';
                        break;
                    case 'paid(online)':
                        statusBadgeClass = 'badge-paid-online';
                        break;
                    case 'pending':
                    case 'preparing':
                        statusBadgeClass = 'badge-pending';
                        break;
                    case 'delivered':
                        statusBadgeClass = 'badge-delivered';
                        break;
                    default:
                        statusBadgeClass = 'bg-secondary';
                }

                row.innerHTML = `
                    <td>${(order.id ? order.id.toString() : order.docId.slice(-4))}</td>
                    <td>${orderDate}</td>
                    <td>${order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A'}</td>
                    <td>â‚¹${parseFloat(order.total || 0).toFixed(2)}</td>
                    <td><span class="badge ${statusBadgeClass}">${order.status || 'N/A'}</span></td>
                    <td>${order.customerDetails && order.customerDetails.comments ? order.customerDetails.comments : 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="showOrderDetails('${order.docId}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary me-1" onclick="openEditModal('${order.docId}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteOrder('${order.docId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Update summary statistics
        function updateSummaryStats() {
            let totalCount = state.filteredOrders.length;
            let totalSales = 0;
            let pendingCount = 0;
            let pendingTotal = 0;
            let cashPaymentsCount = 0;
            let cashPaymentsTotal = 0;
            let onlinePaymentsCount = 0;
            let onlinePaymentsTotal = 0;

            state.filteredOrders.forEach(order => {
                const orderTotal = parseFloat(order.total || 0);
                totalSales += orderTotal;

                if (order.status === 'pending' || order.status === 'preparing') {
                    pendingCount++;
                    pendingTotal += orderTotal;
                } else if (order.status === 'paid (cash)') {
                    cashPaymentsCount++;
                    cashPaymentsTotal += orderTotal;
                } else if (order.status === 'paid(online)') {
                    onlinePaymentsCount++;
                    onlinePaymentsTotal += orderTotal;
                }
            });

            // Update the summary section
            document.getElementById('totalOrdersCount').textContent = totalCount;
            document.getElementById('totalSalesAmount').textContent = totalSales.toFixed(2);
            document.getElementById('pendingOrdersCount').textContent = pendingCount;
            document.getElementById('pendingOrdersTotal').textContent = pendingTotal.toFixed(2);
            document.getElementById('cashPaymentsCount').textContent = cashPaymentsCount;
            document.getElementById('cashPaymentsTotal').textContent = cashPaymentsTotal.toFixed(2);
            document.getElementById('onlinePaymentsCount').textContent = onlinePaymentsCount;
            document.getElementById('onlinePaymentsTotal').textContent = onlinePaymentsTotal.toFixed(2);
        }

        // Show order details
        function showOrderDetails(orderId) {
            const order = state.allOrders.find(o => o.docId === orderId);
            if (!order) return;

            currentOrderId = orderId;

            // Populate modal with order details
            document.getElementById('detailsOrderId').textContent = order.id ? order.id.toString() : order.docId.slice(-4);
            document.getElementById('detailsOrderDate').textContent = order.createdAt ? formatDate(order.createdAt) : 'N/A';
            document.getElementById('detailsOrderStatus').textContent = order.status || 'N/A';
            document.getElementById('detailsCustomerPhone').textContent = order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A';
            document.getElementById('detailsCustomerComments').textContent = order.customerDetails && order.customerDetails.comments ? order.customerDetails.comments : 'N/A';
            document.getElementById('detailsOrderTotal').textContent = parseFloat(order.total || 0).toFixed(2);

            // Populate order items
            const itemsContainer = document.getElementById('detailsOrderItems');
            itemsContainer.innerHTML = '';

            if (Array.isArray(order.items) && order.items.length > 0) {
                order.items.forEach(item => {
                    const row = document.createElement('tr');
                    const itemTotal = (parseFloat(item.price) * parseInt(item.quantity)).toFixed(2);
                    
                    row.innerHTML = `
                        <td>${item.name || 'N/A'}</td>
                        <td>${item.portion || 'N/A'}</td>
                        <td>${item.quantity || '1'}</td>
                        <td>â‚¹${parseFloat(item.price).toFixed(2)}</td>
                        <td>â‚¹${itemTotal}</td>
                    `;
                    
                    itemsContainer.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No items found</td>';
                itemsContainer.appendChild(row);
            }

            // Show the modal
            orderDetailsModal.show();
        }

        // Open edit modal
        function openEditModal(orderId) {
            const order = state.allOrders.find(o => o.docId === orderId);
            if (!order) return;

            // Hide details modal if open
            orderDetailsModal.hide();

            // Populate edit form
            document.getElementById('editOrderId').value = orderId;
            document.getElementById('editCustomerPhone').value = order.customerDetails ? order.customerDetails.phone || '' : '';
            document.getElementById('editCustomerComments').value = order.customerDetails && order.customerDetails.comments ? order.customerDetails.comments : '';
            document.getElementById('editOrderStatus').value = order.status || 'pending';
            document.getElementById('editOrderTotal').textContent = parseFloat(order.total || 0).toFixed(2);

            // Populate order items
            const itemsContainer = document.getElementById('editOrderItems');
            itemsContainer.innerHTML = '';

            if (Array.isArray(order.items) && order.items.length > 0) {
                order.items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-group-item';
                    const itemTotal = (parseFloat(item.price) * parseInt(item.quantity)).toFixed(2);
                    
                    itemDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.name || 'N/A'}</strong> (${item.portion || 'N/A'})
                                <div class="small text-muted">
                                    Quantity: ${item.quantity || '1'} Ã— â‚¹${parseFloat(item.price).toFixed(2)} = â‚¹${itemTotal}
                                </div>
                            </div>
                            <div class="input-group input-group-sm" style="max-width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateItemQuantity(${index}, -1)">-</button>
                                <input type="number" class="form-control text-center" id="itemQuantity-${index}" value="${item.quantity}" min="1" onchange="updateItemQuantity(${index}, 0)">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateItemQuantity(${index}, 1)">+</button>
                            </div>
                        </div>
                    `;
                    
                    itemsContainer.appendChild(itemDiv);
                });
            } else {
                itemsContainer.innerHTML = '<div class="list-group-item text-center">No items found</div>';
            }

            // Show the modal
            editOrderModal.show();
        }

        // Update item quantity in edit modal
        function updateItemQuantity(itemIndex, change) {
            const orderId = document.getElementById('editOrderId').value;
            const order = state.allOrders.find(o => o.docId === orderId);
            if (!order || !Array.isArray(order.items) || !order.items[itemIndex]) return;

            const inputElement = document.getElementById(`itemQuantity-${itemIndex}`);
            let newQuantity = parseInt(inputElement.value) + change;
            
            // Ensure quantity is at least 1
            newQuantity = Math.max(1, newQuantity);
            inputElement.value = newQuantity;
            
            // Update the order object
            order.items[itemIndex].quantity = newQuantity;
            
            // Recalculate total
            let newTotal = 0;
            order.items.forEach(item => {
                newTotal += parseFloat(item.price) * parseInt(item.quantity);
            });
            
            // Update total display
            document.getElementById('editOrderTotal').textContent = newTotal.toFixed(2);
        }

        // Save order changes
        async function saveOrderChanges() {
            const orderId = document.getElementById('editOrderId').value;
            const order = state.allOrders.find(o => o.docId === orderId);
            if (!order) return;

            // Get form values
            const customerPhone = document.getElementById('editCustomerPhone').value;
            const customerComments = document.getElementById('editCustomerComments').value;
            const status = document.getElementById('editOrderStatus').value;

            // Update quantities from inputs
            if (Array.isArray(order.items)) {
                order.items.forEach((item, index) => {
                    const quantityInput = document.getElementById(`itemQuantity-${index}`);
                    if (quantityInput) {
                        item.quantity = parseInt(quantityInput.value) || 1;
                    }
                });
            }

            // Recalculate total
            let newTotal = 0;
            if (Array.isArray(order.items)) {
                order.items.forEach(item => {
                    newTotal += parseFloat(item.price) * parseInt(item.quantity);
                });
            }

            try {
                // Prepare update data
                const updateData = {
                    status: status,
                    total: newTotal,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    customerDetails: {
                        ...order.customerDetails,
                        phone: customerPhone,
                        comments: customerComments
                    },
                    items: order.items
                };

                // Update in Firestore
                await db.collection('bot_orders').doc(orderId).update(updateData);
                
                // Hide modal
                editOrderModal.hide();
                
                // Reload orders
                loadOrders();
                
                // Show success message
                alert('Order updated successfully');
                
            } catch (error) {
                console.error('Error updating order:', error);
                alert('Error updating order: ' + error.message);
            }
        }

        // Confirm and delete order
        function confirmDeleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                deleteOrder(orderId);
            }
        }

        // Delete order
        async function deleteOrder(orderId) {
            try {
                await db.collection('bot_orders').doc(orderId).delete();
                
                // Reload orders
                loadOrders();
                
                // Show success message
                alert('Order deleted successfully');
                
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Error deleting order: ' + error.message);
            }
        }

        // Apply date filter
        function applyDateFilter() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput.value) {
                state.startDate = new Date(startDateInput.value);
                state.startDate.setHours(0, 0, 0, 0);
            } else {
                state.startDate = null;
            }
            
            if (endDateInput.value) {
                state.endDate = new Date(endDateInput.value);
                state.endDate.setHours(23, 59, 59, 999);
            } else {
                state.endDate = null;
            }
            
            loadOrders();
        }

        // Reset date filter to today
        function resetDateFilter() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayStr = formatDateForInput(today);
            
            document.getElementById('startDate').value = todayStr;
            document.getElementById('endDate').value = todayStr;
            
            state.startDate = today;
            state.endDate = new Date(today);
            state.endDate.setHours(23, 59, 59, 999);
            
            loadOrders();
        }
        
        // Load all orders without date filtering
        function loadAllOrders() {
            // Clear date filters
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            state.startDate = null;
            state.endDate = null;
            
            loadOrders();
        }

        // Set date range to last week
        function setLastWeek() {
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').value = formatDateForInput(lastWeek);
            document.getElementById('endDate').value = formatDateForInput(today);
            
            state.startDate = lastWeek;
            state.endDate = new Date(today);
            state.endDate.setHours(23, 59, 59, 999);
            
            loadOrders();
        }

        // Set date range to last month
        function setLastMonth() {
            const today = new Date();
            const lastMonth = new Date(today);
            lastMonth.setMonth(today.getMonth() - 1);
            
            document.getElementById('startDate').value = formatDateForInput(lastMonth);
            document.getElementById('endDate').value = formatDateForInput(today);
            
            state.startDate = lastMonth;
            state.endDate = new Date(today);
            state.endDate.setHours(23, 59, 59, 999);
            
            loadOrders();
        }

        // Export to CSV
        function exportToCSV() {
            if (state.filteredOrders.length === 0) {
                alert('No orders to export');
                return;
            }

            // Prepare CSV content
            let csvContent = 'Order ID,Date,Customer Phone,Comments,Status,Total,Items\n';
            
            state.filteredOrders.forEach(order => {
                const orderId = order.id ? order.id.toString() : order.docId;
                const date = order.createdAt ? formatDate(order.createdAt) : 'N/A';
                const phone = order.customerDetails ? order.customerDetails.phone || 'N/A' : 'N/A';
                const comments = order.customerDetails && order.customerDetails.comments ? 
                                 order.customerDetails.comments.replace(/,/g, ' ').replace(/\n/g, ' ') : 'N/A';
                const status = order.status || 'N/A';
                const total = parseFloat(order.total || 0).toFixed(2);
                
                // Format items as a string
                let itemsStr = '';
                if (Array.isArray(order.items) && order.items.length > 0) {
                    itemsStr = order.items.map(item => 
                        `${item.name} (${item.portion}) x${item.quantity} - â‚¹${parseFloat(item.price).toFixed(2)}`
                    ).join('; ');
                } else {
                    itemsStr = 'No items';
                }
                
                // Add row to CSV
                csvContent += `"${orderId}","${date}","${phone}","${comments}","${status}","${total}","${itemsStr}"\n`;
            });
            
            // Create download link
            const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            
            // Generate filename with date range
            let filename = 'TandoorBaaz_Orders_';
            if (state.startDate && state.endDate) {
                filename += formatDateForFilename(state.startDate) + '_to_' + formatDateForFilename(state.endDate);
            } else {
                filename += formatDateForFilename(new Date());
            }
            filename += '.csv';
            
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Helper function to format date
        function formatDate(date) {
            if (!date) return 'N/A';
            
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            return date.toLocaleDateString('en-IN', options);
        }

        // Helper function to format date for input fields
        function formatDateForInput(date) {
            if (!date) return '';
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // Helper function to format date for filenames
        function formatDateForFilename(date) {
            if (!date) return 'unknown_date';
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}${month}${day}`;
        }
    </script>
</body>

</html>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                