<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TandoorBaaz Orders Management</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order-card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .order-card:hover {
            transform: translateY(-5px);
        }

        .order-actions {
            display: flex;
            gap: 10px;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .delay-badge {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .kitchen-item {
            transition: all 0.3s;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .alert-pulse {
            animation: pulse 1s infinite;
        }
    </style>
    <style>
        @media (max-width: 767.98px) {
            .sticky-top {
                position: static !important;
                top: auto !important;
                margin-top: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Orders Management</h2>
                    <div>
                        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                            <i class="bi bi-plus-circle"></i> Add Order
                        </button>
                        <button class="btn btn-primary" onclick="loadOrders()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                <div id="ordersList" class="row"></div>
            </div>

            <div class="col-md-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">Kitchen Preparation List</h5>
                    </div>
                    <div class="card-body" id="kitchenList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content">
                <form id="addOrderForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Customer Phone</label>
                            <input type="tel" class="form-control" id="customerPhone" placeholder="Enter phone number" required>
                        </div>
                        <div class="mb-3">
                            <label for="customerComments" class="form-label">Customer Comments</label>
                            <textarea class="form-control" id="customerComments" placeholder="Enter vehicle or house info"></textarea>
                        </div>
                        <div id="orderItemsContainer">
                            <!-- Order items will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary mb-3" id="addOrderItemBtn">Add Item</button>
                        <div class="mb-3">
                            <strong>Total: ₹<span id="orderTotal">0</span></strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Order</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content">
                <form id="editOrderForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                    <div class="mb-3">
                        <label for="editCustomerPhone" class="form-label">Customer Phone</label>
                        <input type="tel" class="form-control" id="editCustomerPhone" placeholder="Enter phone number" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerComments" class="form-label">Customer Comments</label>
                        <textarea class="form-control" id="editCustomerComments" placeholder="Enter vehicle or house info"></textarea>
                    </div>
                    <div id="editOrderItemsContainer">
                        <!-- Edit order items will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary mb-3" id="editAddOrderItemBtn">Add Item</button>
                    <div class="mb-3">
                        <strong>Total: ₹<span id="editOrderTotal">0</span></strong>
                    </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Update Order</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="vehicleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vehicle Number</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="vehicleNumberInput" class="form-control" placeholder="Enter vehicle number">
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveVehicleNumberBtn" class="btn btn-primary">Save Vehicle Number</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="delayAlertModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delay Alert</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="delayAlertContent">
                    <!-- Delay alert content will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="sendDelayMessage()">Send WhatsApp Message</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Firebase Configuration and Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyAEKHWdRyzI8WyBeGeesjDrM-nEzOXCuNk",
            authDomain: "billion1-a9324.firebaseapp.com",
            projectId: "billion1-a9324",
            storageBucket: "billion1-a9324.appspot.com",
            messagingSenderId: "443716692865",
            appId: "1:443716692865:web:96813fe32a44f8342cd680",
            measurementId: "G-FE7NFHY5PG"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Application State
        let state = {
            currentOrders: [],
            editingOrderId: null,
            vehicleOrderId: null,
            alertedOrders: new Set(),
            currentDelayOrder: null,
            menuItems: {
                1: {
                    name: "Seekh Kebab",
                    portions: {
                        half: { name: "HALF", price: 109 },
                        full: { name: "FULL", price: 209 },
                    },
                },
                2: {
                    name: "Chicken Tikka",
                    portions: {
                        half: { name: "HALF", price: 149 },
                        full: { name: "FULL", price: 289 },
                    },
                },
                3: {
                    name: "Afghani Chicken Tikka",
                    portions: {
                        half: { name: "HALF", price: 169 },
                        full: { name: "FULL", price: 329 },
                    },
                },
                4: {
                    name: "Tandoori Chicken",
                    portions: {
                        half: { name: "HALF", price: 169 },
                        full: { name: "FULL", price: 329 },
                    },
                },
                5: {
                    name: "Afghani Chicken",
                    portions: {
                        half: { name: "HALF", price: 199 },
                        full: { name: "FULL", price: 389 },
                    },
                },
                6: {
                    name: "Chicken Wings",
                    portions: {
                        half: { name: "HALF", price: 129 },
                        full: { name: "FULL", price: 249 },
                    },
                },
                7: {
                    name: "Chicken Tangdi",
                    portions: {
                        half: { name: "HALF", price: 99 },
                        full: { name: "FULL", price: 189 },
                    },
                },
                8: {
                    name: "Afghani Tangdi",
                    portions: {
                        half: { name: "HALF", price: 119 },
                        full: { name: "FULL", price: 229 },
                    },
                },
                9: {
                    name: "Masala Chaap",
                    portions: {
                        half: { name: "HALF", price: 69 },
                        full: { name: "FULL", price: 129 },
                    },
                },
                10: {
                    name: "Malai Chaap",
                    portions: {
                        half: { name: "HALF", price: 79 },
                        full: { name: "FULL", price: 149 },
                    },
                },
                11: {
                    name: "Afghani Chaap",
                    portions: {
                        half: { name: "HALF", price: 89 },
                        full: { name: "FULL", price: 169 },
                    },
                },
                12: {
                    name: "Paneer Tikka",
                    portions: {
                        half: { name: "HALF", price: 79 },
                        full: { name: "FULL", price: 149 },
                    },
                },
                13: {
                    name: "Romali Roti",
                    portions: {
                        piece: { name: "PER PIECE", price: 10 },
                    },
                },
            }
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            initModals();
            initEventListeners();
            initOrderForms();
            loadOrders();
            setInterval(checkDelayedOrders, 300000); // 5 minute checks
        });

        function initModals() {
            state.modals = {
                edit: new bootstrap.Modal('#editOrderModal'),
                vehicle: new bootstrap.Modal('#vehicleModal'),
                delay: new bootstrap.Modal('#delayAlertModal'),
                addOrder: new bootstrap.Modal('#addOrderModal'),
                editOrder: new bootstrap.Modal('#editOrderModal')
            };
        }

        function initEventListeners() {
            document.getElementById('saveVehicleNumberBtn').addEventListener('click', saveVehicleNumber);
            document.getElementById('addOrderForm').addEventListener('submit', handleNewOrder);
            document.getElementById('editOrderForm').addEventListener('submit', handleOrderEdit);
            document.getElementById('addOrderItemBtn').addEventListener('click', () => {
                const row = createOrderItemRow();
                document.getElementById('orderItemsContainer').appendChild(row);
            });
            document.getElementById('editAddOrderItemBtn').addEventListener('click', () => {
                const row = createEditOrderItemRow();
                document.getElementById('editOrderItemsContainer').appendChild(row);
            });
        }

        function initOrderForms() {
            // Initialize the add order form with one item row
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            if (orderItemsContainer.children.length === 0) {
                const row = createOrderItemRow();
                orderItemsContainer.appendChild(row);
            }
        }

        async function loadOrders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            db.collection('bot_orders')
                .where('createdAt', '>=', today)
                .orderBy('createdAt', 'desc')
                .onSnapshot(handleOrderSnapshot);
        }

        function handleOrderSnapshot(snapshot) {
            state.currentOrders = snapshot.docs.map(doc => {
                const data = doc.data();
                console.log(`Order ${doc.id} updatedAt raw:`, data.updatedAt);
                return {
                    docId: doc.id,
                    ...data,
                    createdAt: data.createdAt ? data.createdAt.toDate() : null,
                    updatedAt: data.updatedAt ? data.updatedAt.toDate() : null
                };
            });

            updateUI();
            checkDelayedOrders();
        }

        function updateUI() {
            renderOrders();
            renderKitchenList();
        }

        function renderOrders() {
            const ordersHTML = state.currentOrders.map(order => {
                // Add a thicker border for severely delayed orders
                const borderStyle = order.delayLevel >= 3 
                    ? `border-left: 8px solid ${getDelayColor(order)}` 
                    : `border-left: 5px solid ${getDelayColor(order)}`;
            
                return `
        <div class="col-md-6 col-lg-4">
            <div class="card order-card" style="${borderStyle}">
                <div class="card-body">
                    <span class="badge ${getStatusClass(order.status)} status-badge">${order.status}</span>
                    ${order.delayLevel > 0 ? `<span class="badge bg-danger delay-badge">Delayed ${order.delayLevel}x</span>` : ''}
                    <h5 class="card-title">Order #${(order.id ? order.id.toString() : order.docId).slice(-4)}</h5>
                    <p class="mb-1"><i class="bi bi-phone"></i> ${order.customerDetails.phone}</p>
                    <p class="mb-1"><i class="bi bi-chat-left-text"></i> ${order.customerDetails.comments || ''}</p>
                    <p class="mb-1"><i class="bi bi-clock"></i> ${formatTime(order.createdAt)}</p>
                    ${order.vehicleNumber ? `<p class="mb-1"><i class="bi bi-truck"></i> ${order.vehicleNumber}</p>` : ''}
                    <hr>
${order.items.map(item => `
    <div class="d-flex justify-content-between mb-2">
        <div>${item.name} (${item.portion.toUpperCase()}) ×${item.quantity}</div>
        <div>₹${item.price * item.quantity}</div>
    </div>
`).join('')}
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <strong>Total:</strong>
                        <h5 class="mb-0">₹${order.total}</h5>
                    </div>
                    <div class="order-actions d-flex flex-column gap-2">
                        <div>
                            <label for="statusSelect-${order.docId}" class="form-label visually-hidden">Status</label>
                            <select id="statusSelect-${order.docId}" class="form-select form-select-sm" onchange="updateOrderStatus('${order.docId}', this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEditModal('${order.docId}')">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.docId}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    }).join('');

            document.getElementById('ordersList').innerHTML = ordersHTML;
        }

        function renderKitchenList() {
            // First, let's log the items to see what we're working with
            console.log("Items for kitchen list:", state.currentOrders
                .filter(o => ['pending', 'preparing'].includes(o.status))
                .flatMap(o => o.items));
            
            const kitchenItems = state.currentOrders
                .filter(o => ['pending', 'preparing'].includes(o.status))
                .flatMap(o => o.items)
                .reduce((acc, item) => {
                    // Make sure we're using the complete name property
                    // Log each item to verify what we're working with
                    console.log("Processing kitchen item:", item);
                    
                    // Use the complete name as the key
                    const key = item.name;
                    
                    if (!acc[key]) {
                        acc[key] = 0;
                    }
                    acc[key] += item.quantity;
                    return acc;
                }, {});

            console.log("Aggregated kitchen items:", kitchenItems);

            const kitchenHTML = Object.entries(kitchenItems)
                .sort((a, b) => b[1] - a[1])
                .map(([name, qty]) => `
            <div class="kitchen-item mb-2 p-2 bg-light rounded">
                <div class="d-flex justify-content-between">
                    <strong>${name}</strong>
                    <span class="badge bg-primary">${qty} Qty</span>
                </div>
            </div>
        `).join('');

            document.getElementById('kitchenList').innerHTML = kitchenHTML;
        }

        // Delay Handling Functions
        function checkDelayedOrders() {
            console.log('Checking delayed orders...');
            state.currentOrders.forEach(order => {
                const delayLevel = calculateDelayLevel(order);
                console.log(`Order ${order.docId} delayLevel: ${delayLevel}`);
                order.delayLevel = delayLevel;
                if (order.delayLevel > 0 && !state.alertedOrders.has(order.docId)) {
                    console.log(`Handling delayed order ${order.docId}`);
                    handleDelayedOrder(order);
                }
            });
        }

        function calculateDelayLevel(order) {
            const statusDurations = {
                pending: 15, preparing: 25, ready: 45
            };
            if (!order.updatedAt) {
                console.log(`Order ${order.docId} has no updatedAt timestamp.`);
                return 0;
            }
            let elapsed = (Date.now() - order.updatedAt) / 60000;
            if (elapsed < 0) {
                console.warn(`Order ${order.docId} has future updatedAt timestamp. Clamping elapsed time to 0.`);
                elapsed = 0;
            }
            console.log(`Order ${order.docId} elapsed minutes since update: ${elapsed}`);
            return elapsed > statusDurations[order.status] ? Math.floor((elapsed - statusDurations[order.status]) / 5) + 1 : 0;
        }

        function handleDelayedOrder(order) {
            console.log(`Adding order ${order.docId} to alertedOrders and showing delay alert.`);
            state.alertedOrders.add(order.docId);
            showDelayAlert(order);
        }

        function showDelayAlert(order) {
            console.log(`Showing delay alert for order ${order.docId}`);
            state.currentDelayOrder = order;
            let delayMinutes = 0;
            if (order.updatedAt instanceof Date) {
                delayMinutes = Math.floor((Date.now() - order.updatedAt.getTime()) / 60000);
            }
            document.getElementById('delayAlertContent').innerHTML = `
        <p>Order #${(order.id ? order.id.toString() : order.docId).slice(-4)} delayed!</p>
        <p>Status: ${order.status} for ${delayMinutes} minutes</p>
    `;
            state.modals.delay.show();
        }

        // Utility Functions
        function getStatusClass(status) {
            const classes = {
                pending: 'bg-warning',
                preparing: 'bg-info',
                ready: 'bg-success',
                delivered: 'bg-primary',
                cancelled: 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }

        function getDelayColor(order) {
            // If there's no delay, return a green color
            if (!order.delayLevel || order.delayLevel <= 0) {
                return 'hsl(120, 80%, 40%)'; // Green for on-time orders
            }
            
            // Calculate a color from green (hue 120) to red (hue 0)
            // The higher the delay level, the closer to red
            // Cap at delay level 5 (which will be dark red)
            const maxDelayLevel = 5;
            const delayLevel = Math.min(order.delayLevel, maxDelayLevel);
            
            // Calculate hue: 120 (green) to 0 (red)
            const hue = Math.max(120 - (delayLevel * 24), 0);
            
            // Reduce saturation and lightness for higher delay levels to make colors more intense
            const saturation = 80 - (delayLevel * 5);
            const lightness = 40 - (delayLevel * 3);
            
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        }

        // Order Item Row Creation Functions
        function createOrderItemRow() {
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            const orderTotalElem = document.getElementById('orderTotal');
            
            const row = document.createElement('div');
            row.className = 'd-flex gap-2 mb-2 align-items-center';

            const itemSelect = document.createElement('select');
            itemSelect.className = 'form-select flex-grow-1';
            itemSelect.required = true;

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Item';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            itemSelect.appendChild(defaultOption);

            for (const [id, menuItem] of Object.entries(state.menuItems)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = menuItem.name;
                itemSelect.appendChild(option);
            }

            const portionSelect = document.createElement('select');
            portionSelect.className = 'form-select';
            portionSelect.required = true;
            portionSelect.style.width = '120px';

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.min = '1';
            quantityInput.value = '1';
            quantityInput.className = 'form-control';
            quantityInput.style.width = '80px';
            quantityInput.required = true;

            const priceDisplay = document.createElement('div');
            priceDisplay.style.minWidth = '80px';
            priceDisplay.textContent = '₹0';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-sm';
            removeBtn.textContent = 'Remove';

            row.appendChild(itemSelect);
            row.appendChild(portionSelect);
            row.appendChild(quantityInput);
            row.appendChild(priceDisplay);
            row.appendChild(removeBtn);

            function updatePortions() {
                const itemId = itemSelect.value;
                portionSelect.innerHTML = '';
                if (itemId && state.menuItems[itemId]) {
                    const portions = state.menuItems[itemId].portions;
                    for (const [key, portion] of Object.entries(portions)) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${portion.name} - ₹${portion.price}`;
                        portionSelect.appendChild(option);
                    }
                }
                updatePrice();
            }

            function updatePrice() {
                const itemId = itemSelect.value;
                const portionKey = portionSelect.value;
                const quantity = parseInt(quantityInput.value) || 0;
                if (itemId && portionKey && state.menuItems[itemId]) {
                    const price = state.menuItems[itemId].portions[portionKey].price * quantity;
                    priceDisplay.textContent = `₹${price}`;
                } else {
                    priceDisplay.textContent = '₹0';
                }
                updateTotal();
            }

            function updateTotal() {
                let total = 0;
                const rows = orderItemsContainer.querySelectorAll('div.d-flex');
                rows.forEach(r => {
                    const priceText = r.querySelector('div').textContent;
                    const price = parseInt(priceText.replace('₹', '')) || 0;
                    total += price;
                });
                orderTotalElem.textContent = total;
            }

            itemSelect.addEventListener('change', () => {
                updatePortions();
            });

            portionSelect.addEventListener('change', () => {
                updatePrice();
            });

            quantityInput.addEventListener('input', () => {
                updatePrice();
            });

            removeBtn.addEventListener('click', () => {
                row.remove();
                updateTotal();
            });

            updatePortions();

            return row;
        }

        function createEditOrderItemRow(item) {
            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            const row = document.createElement('div');
            row.className = 'd-flex gap-2 mb-2 align-items-center';

            const itemSelect = document.createElement('select');
            itemSelect.className = 'form-select flex-grow-1';
            itemSelect.required = true;

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Item';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            itemSelect.appendChild(defaultOption);

            for (const [id, menuItem] of Object.entries(state.menuItems)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = menuItem.name;
                if (item && item.id == id) {
                    option.selected = true;
                }
                itemSelect.appendChild(option);
            }

            const portionSelect = document.createElement('select');
            portionSelect.className = 'form-select';
            portionSelect.required = true;
            portionSelect.style.width = '120px';

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.min = '1';
            quantityInput.value = item ? item.quantity : 1;
            quantityInput.className = 'form-control';
            quantityInput.style.width = '80px';
            quantityInput.required = true;

            const priceDisplay = document.createElement('div');
            priceDisplay.style.minWidth = '80px';
            priceDisplay.textContent = '₹0';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-sm';
            removeBtn.textContent = 'Remove';

            row.appendChild(itemSelect);
            row.appendChild(portionSelect);
            row.appendChild(quantityInput);
            row.appendChild(priceDisplay);
            row.appendChild(removeBtn);

            function updatePortions() {
                const itemId = itemSelect.value;
                portionSelect.innerHTML = '';
                if (itemId && state.menuItems[itemId]) {
                    const portions = state.menuItems[itemId].portions;
                    for (const [key, portion] of Object.entries(portions)) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${portion.name} - ₹${portion.price}`;
                        if (item && item.portion === portion.name) {
                            option.selected = true;
                        }
                        portionSelect.appendChild(option);
                    }
                }
                updatePrice();
            }

            function updatePrice() {
                const itemId = itemSelect.value;
                const portionKey = portionSelect.value;
                const quantity = parseInt(quantityInput.value) || 0;
                if (itemId && portionKey && state.menuItems[itemId]) {
                    const price = state.menuItems[itemId].portions[portionKey].price * quantity;
                    priceDisplay.textContent = `₹${price}`;
                } else {
                    priceDisplay.textContent = '₹0';
                }
                updateTotal();
            }

            function updateTotal() {
                let total = 0;
                const rows = editOrderItemsContainer.querySelectorAll('div.d-flex');
                rows.forEach(r => {
                    const priceText = r.querySelector('div').textContent;
                    const price = parseInt(priceText.replace('₹', '')) || 0;
                    total += price;
                });
                document.getElementById('editOrderTotal').textContent = total;
            }

            itemSelect.addEventListener('change', () => {
                updatePortions();
            });

            portionSelect.addEventListener('change', () => {
                updatePrice();
            });

            quantityInput.addEventListener('input', () => {
                updatePrice();
            });

            removeBtn.addEventListener('click', () => {
                row.remove();
                updateTotal();
            });

            updatePortions();

            return row;
        }

        async function showEditModal(docId) {
            const order = state.currentOrders.find(o => o.docId === docId);
            state.editingOrderId = docId;

            // Populate edit form with order details
            document.getElementById('editCustomerPhone').value = order.customerDetails.phone || '';
            document.getElementById('editCustomerComments').value = order.customerDetails.comments || '';

            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            editOrderItemsContainer.innerHTML = '';

            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const row = createEditOrderItemRow(item);
                    editOrderItemsContainer.appendChild(row);
                });
            } else {
                const row = createEditOrderItemRow();
                editOrderItemsContainer.appendChild(row);
            }

            document.getElementById('editOrderTotal').textContent = order.total || 0;

            state.modals.editOrder.show();
        }

        // Consolidated handleNewOrder function - merged with the inline async function
        async function handleNewOrder(e) {
            e.preventDefault();
            
            const phone = document.getElementById('customerPhone').value.trim();
            const comments = document.getElementById('customerComments').value.trim();
            
            if (!phone) {
                alert('Please enter customer phone number.');
                return;
            }
            
            const items = [];
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            const rows = orderItemsContainer.querySelectorAll('div.d-flex');
            
            if (rows.length === 0) {
                alert('Please add at least one order item.');
                return;
            }
            
            for (const row of rows) {
                const itemSelect = row.querySelector('select.form-select');
                const portionSelect = row.querySelectorAll('select.form-select')[1];
                const quantityInput = row.querySelector('input[type="number"]');
                const itemId = itemSelect.value;
                const portionKey = portionSelect.value;
                const quantity = parseInt(quantityInput.value);
                
                if (!itemId || !portionKey || !quantity || quantity <= 0) {
                    alert('Please fill all item details correctly.');
                    return;
                }
                
                const itemData = state.menuItems[itemId];
                const portionData = itemData.portions[portionKey];
                
                items.push({
                    id: itemId,
                    name: itemData.name,
                    portion: portionData.name,
                    quantity,
                    price: portionData.price
                });
            }
            
            const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);
            
            try {
                await db.collection('bot_orders').add({
                    customerDetails: { phone, comments },
                    items,
                    total,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Order added successfully.');
                
                // Reset form
                document.getElementById('addOrderForm').reset();
                orderItemsContainer.innerHTML = '';
                document.getElementById('orderTotal').textContent = '0';
                
                // Add initial row
                const row = createOrderItemRow();
                orderItemsContainer.appendChild(row);
                
                state.modals.addOrder.hide();
            } catch (error) {
                alert('Error adding order: ' + error.message);
            }
        }

        // Consolidated handleOrderEdit function
        async function handleOrderEdit(e) {
            e.preventDefault();

            const phone = document.getElementById('editCustomerPhone').value.trim();
            const comments = document.getElementById('editCustomerComments').value.trim();
            
            if (!phone) {
                alert('Please enter customer phone number.');
                return;
            }
            
            const items = [];
            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            const rows = editOrderItemsContainer.querySelectorAll('div.d-flex');
            
            if (rows.length === 0) {
                alert('Please add at least one order item.');
                return;
            }
            
            for (const row of rows) {
                const itemSelect = row.querySelector('select.form-select');
                const portionSelect = row.querySelectorAll('select.form-select')[1];
                const quantityInput = row.querySelector('input[type="number"]');
                const itemId = itemSelect.value;
                const portionKey = portionSelect.value;
                const quantity = parseInt(quantityInput.value);
                
                if (!itemId || !portionKey || !quantity || quantity <= 0) {
                    alert('Please fill all item details correctly.');
                    return;
                }
                
                const itemData = state.menuItems[itemId];
                const portionData = itemData.portions[portionKey];
                
                items.push({
                    id: itemId,
                    name: itemData.name,
                    portion: portionData.name,
                    quantity,
                    price: portionData.price
                });
            }
            
            const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);
            
            try {
                await db.collection('bot_orders').doc(state.editingOrderId).update({
                    customerDetails: { phone, comments },
                    items,
                    total,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Order updated successfully.');
                state.modals.editOrder.hide();
            } catch (error) {
                alert('Error updating order: ' + error.message);
            }
        }

        // Other functions
        async function deleteOrder(docId) {
            if (confirm('Confirm deletion?')) {
                await db.collection('bot_orders').doc(docId).delete();
            }
        }

        async function updateOrderStatus(docId, newStatus) {
            try {
                console.log(`Updating order ${docId} status to ${newStatus}...`);
                await db.collection('bot_orders').doc(docId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`Order ${docId} status updated to ${newStatus}`);
                // Refresh UI and check delays after status update
                loadOrders();
            } catch (error) {
                alert('Error updating order status: ' + error.message);
            }
        }

        async function sendDelayMessage() {
            const order = state.currentDelayOrder;
            const orderIdStr = order.id ? order.id.toString() : order.docId;
            const message = `Your order #${orderIdStr.slice(-4)} is delayed. New ETA: ${calculateNewETA(order)}`;
            window.open(`https://wa.me/${order.customerDetails.phone}?text=${encodeURIComponent(message)}`, '_blank');
            state.modals.delay.hide();
        }

        function calculateNewETA(order) {
            const buffer = (order.delayLevel * 5) + 10;
            return new Date(Date.now() + buffer * 60000).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        }

        function saveVehicleNumber() {
            const vehicleNumber = document.getElementById('vehicleNumberInput').value.trim();
            if (vehicleNumber && state.vehicleOrderId) {
                db.collection('bot_orders').doc(state.vehicleOrderId).update({
                    vehicleNumber: vehicleNumber,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('Vehicle number saved successfully.');
                    state.modals.vehicle.hide();
                }).catch(error => {
                    alert('Error saving vehicle number: ' + error.message);
                });
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</body>

</html>