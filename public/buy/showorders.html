<!DOCTYPE html>
<html>

<head>
    <title>TandoorBaaz Orders Management</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .order-card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .order-card:hover {
            transform: translateY(-5px);
        }

        .order-actions {
            display: flex;
            gap: 10px;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .delay-badge {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .kitchen-item {
            transition: all 0.3s;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .kitchen-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .kitchen-item.bg-danger {
            animation: pulse-urgent 1.5s infinite;
        }

        @keyframes pulse-urgent {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                opacity: 1;
            }
        }

        /* Delay level badge colors for pending status */
        .delay-level-0 {
            background-color: hsl(120, 80%, 50%);
            color: white;
        }

        .delay-level-1 {
            background-color: hsl(96, 80%, 50%);
            color: white;
        }

        .delay-level-2 {
            background-color: hsl(72, 80%, 50%);
            color: white;
        }

        .delay-level-3 {
            background-color: hsl(48, 80%, 50%);
            color: white;
        }

        .delay-level-4 {
            background-color: hsl(24, 80%, 50%);
            color: white;
        }

        .delay-level-5 {
            background-color: hsl(0, 80%, 50%);
            color: white;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .alert-pulse {
            animation: pulse 1s infinite;
        }

        /* Delay comparison table styles */
        #delayComparisonTable table {
            font-size: 0.9rem;
        }

        #delayComparisonTable .badge {
            font-size: 0.8rem;
            padding: 0.35em 0.65em;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Orders Management</h2>
                    <div>
                        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                            <i class="bi bi-plus-circle"></i> Add Order
                        </button>
                        <button class="btn btn-primary me-2" onclick="loadOrders()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-info" id="toggleDelayComparisonBtn">
                            <i class="bi bi-clock-history"></i> Delay Comparison
                        </button>
                    </div>
                </div>
                <div id="delayComparisonContainer" class="mb-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Order Delay Comparison</h5>
                            <button class="btn btn-sm btn-light" onclick="showDelayComparison()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="delayComparisonTable"></div>
                        </div>
                    </div>
                </div>
                <div id="ordersList" class="row"></div>
            </div>

            <div class="col-md-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-fire"></i> Priority Cooking List</h5>
                        <div>
                            <span class="badge bg-danger me-2">Cook in Order</span>
                            <button class="btn btn-sm btn-outline-light" onclick="renderKitchenList()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="kitchenList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addOrderForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Customer Phone</label>
                            <input type="tel" class="form-control" id="customerPhone" placeholder="Enter phone number"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="customerComments" class="form-label">Customer Comments</label>
                            <textarea class="form-control" id="customerComments"
                                placeholder="Enter vehicle or house info"></textarea>
                        </div>
                        <div id="orderItemsContainer">
                            <!-- Order items will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary mb-3" id="addOrderItemBtn">Add Item</button>
                        <div class="mb-3">
                            <strong>Total: ₹<span id="orderTotal">0</span></strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Order</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editOrderForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">Customer Phone</label>
                            <input type="tel" class="form-control" id="editCustomerPhone"
                                placeholder="Enter phone number" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerComments" class="form-label">Customer Comments</label>
                            <textarea class="form-control" id="editCustomerComments"
                                placeholder="Enter vehicle or house info"></textarea>
                        </div>
                        <div id="editOrderItemsContainer">
                            <!-- Edit order items will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary mb-3" id="editAddOrderItemBtn">Add Item</button>
                        <div class="mb-3">
                            <strong>Total: ₹<span id="editOrderTotal">0</span></strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Update Order</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="vehicleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vehicle Number</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="vehicleNumberInput" class="form-control" placeholder="Enter vehicle number">
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveVehicleNumberBtn" class="btn btn-primary">Save Vehicle Number</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="delayAlertModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delay Alert</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body" id="delayAlertContent">
                    <!-- Delay alert content will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="sendDelayMessage()">Send WhatsApp
                        Message</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration and Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyAEKHWdRyzI8WyBeGeesjDrM-nEzOXCuNk",
            authDomain: "billion1-a9324.firebaseapp.com",
            projectId: "billion1-a9324",
            storageBucket: "billion1-a9324.appspot.com",
            messagingSenderId: "443716692865",
            appId: "1:443716692865:web:96813fe32a44f8342cd680",
            measurementId: "G-FE7NFHY5PG"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Application State
        let state = {
            currentOrders: [],
            editingOrderId: null,
            vehicleOrderId: null,
            alertedOrders: new Set(),
            currentDelayOrder: null,
            menuItems: {
                1: {
                    name: "Seekh Kebab",
                    portions: {
                        half: { name: "HALF", price: 109 },
                        full: { name: "FULL", price: 209 },
                    },
                },
                2: {
                    name: "Chicken Tikka",
                    portions: {
                        half: { name: "HALF", price: 149 },
                        full: { name: "FULL", price: 289 },
                    },
                },
                3: {
                    name: "Afghani Chicken Tikka",
                    portions: {
                        half: { name: "HALF", price: 169 },
                        full: { name: "FULL", price: 329 },
                    },
                },
                4: {
                    name: "Tandoori Chicken",
                    portions: {
                        half: { name: "HALF", price: 169 },
                        full: { name: "FULL", price: 329 },
                    },
                },
                5: {
                    name: "Afghani Chicken",
                    portions: {
                        half: { name: "HALF", price: 199 },
                        full: { name: "FULL", price: 389 },
                    },
                },
                6: {
                    name: "Chicken Wings",
                    portions: {
                        half: { name: "HALF", price: 129 },
                        full: { name: "FULL", price: 249 },
                    },
                },
                7: {
                    name: "Chicken Tangdi",
                    portions: {
                        half: { name: "HALF", price: 99 },
                        full: { name: "FULL", price: 189 },
                    },
                },
                8: {
                    name: "Afghani Tangdi",
                    portions: {
                        half: { name: "HALF", price: 119 },
                        full: { name: "FULL", price: 229 },
                    },
                },
                9: {
                    name: "Masala Chaap",
                    portions: {
                        half: { name: "HALF", price: 69 },
                        full: { name: "FULL", price: 129 },
                    },
                },
                10: {
                    name: "Malai Chaap",
                    portions: {
                        half: { name: "HALF", price: 79 },
                        full: { name: "FULL", price: 149 },
                    },
                },
                11: {
                    name: "Afghani Chaap",
                    portions: {
                        half: { name: "HALF", price: 89 },
                        full: { name: "FULL", price: 169 },
                    },
                },
                12: {
                    name: "Paneer Tikka",
                    portions: {
                        half: { name: "HALF", price: 79 },
                        full: { name: "FULL", price: 149 },
                    },
                },
                13: {
                    name: "Romali Roti",
                    portions: {
                        piece: { name: "PER PIECE", price: 10 },
                    },
                },
            }
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            initModals();
            initEventListeners();
            loadOrders();
            setInterval(checkDelayedOrders, 300000); // 5 minute checks

            // Update elapsed times every minute
            setInterval(() => {
                updateUI();
            }, 60000);

            // Show delay comparison on page load
            setTimeout(() => {
                document.getElementById('delayComparisonContainer').style.display = 'block';
                showDelayComparison();
            }, 1000); // Small delay to ensure orders are loaded
        });

        function initModals() {
            state.modals = {
                edit: new bootstrap.Modal('#editOrderModal'),
                vehicle: new bootstrap.Modal('#vehicleModal'),
                delay: new bootstrap.Modal('#delayAlertModal'),
                addOrder: new bootstrap.Modal('#addOrderModal'),
                editOrder: new bootstrap.Modal('#editOrderModal')
            };
        }

        function initEventListeners() {
            document.getElementById('saveVehicleNumberBtn').addEventListener('click', saveVehicleNumber);
            document.getElementById('addOrderForm').addEventListener('submit', handleNewOrder);
            document.getElementById('editOrderForm').addEventListener('submit', handleOrderEdit);
            document.getElementById('editAddOrderItemBtn').addEventListener('click', () => {
                const row = createEditOrderItemRow();
                document.getElementById('editOrderItemsContainer').appendChild(row);
            });
            document.getElementById('toggleDelayComparisonBtn').addEventListener('click', toggleDelayComparison);
        }

        async function loadOrders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            db.collection('bot_orders')
                .where('createdAt', '>=', today)
                .orderBy('createdAt', 'desc')
                .onSnapshot(handleOrderSnapshot);
        }

        function handleOrderSnapshot(snapshot) {
            // Process orders and update state
            state.currentOrders = snapshot.docs.map(doc => {
                const data = doc.data();
                console.log(`Order ${doc.id} updatedAt raw:`, data.updatedAt);
                // Ensure updatedAt is a Date object
                let updatedAtDate = null;
                if (data.updatedAt) {
                    if (typeof data.updatedAt.toDate === 'function') {
                        updatedAtDate = data.updatedAt.toDate();
                    } else if (data.updatedAt instanceof Date) {
                        updatedAtDate = data.updatedAt;
                    } else {
                        console.warn(`Order ${doc.id} has updatedAt in unexpected format:`, data.updatedAt);
                        updatedAtDate = null;
                    }
                }

                const order = {
                    docId: doc.id,
                    ...data,
                    createdAt: data.createdAt ? (typeof data.createdAt.toDate === 'function' ? data.createdAt.toDate() : data.createdAt) : null,
                    updatedAt: updatedAtDate
                };

                // Calculate delay level for each order
                order.delayLevel = calculateDelayLevel(order);

                return order;
            });

            // Clean up alerts for orders that are no longer active
            state.currentOrders.forEach(order => {
                if (!['pending', 'preparing'].includes(order.status) && state.alertedOrders.has(order.docId)) {
                    console.log(`Clearing alert for order ${order.docId} as it's now ${order.status}`);
                    state.alertedOrders.delete(order.docId);

                    // If this was the current delay order, close the modal
                    if (state.currentDelayOrder && state.currentDelayOrder.docId === order.docId) {
                        console.log(`Closing delay alert modal for order ${order.docId}`);
                        state.currentDelayOrder = null;
                        const delayAlertModal = bootstrap.Modal.getInstance(document.getElementById('delayAlertModal'));
                        if (delayAlertModal) {
                            delayAlertModal.hide();
                        }
                    }
                }
            });

            updateUI();
            checkDelayedOrders();
        }

        function updateUI() {
            renderOrders();
            renderKitchenList();

            // Update delay comparison if it's visible
            if (document.getElementById('delayComparisonContainer').style.display !== 'none') {
                showDelayComparison();
            }
        }

        function renderOrders() {
            const ordersHTML = state.currentOrders.map(order => `
        <div class="col-md-6 col-lg-4">
            <div class="card order-card" style="border-left: 5px solid ${getDelayColor(order)}">
                <div class="card-body">
                    <span class="badge ${getStatusClass(order.status)} status-badge">${order.status}</span>
                    ${order.delayLevel > 0 ? `<span class="badge bg-danger delay-badge">Delayed ${order.delayLevel}x</span>` : ''}
                    <h5 class="card-title">Order #${(order.id ? order.id.toString() : order.docId).slice(-4)}</h5>
                    <p class="mb-1"><i class="bi bi-phone"></i> ${order.customerDetails.phone}</p>
                    <p class="mb-1"><i class="bi bi-chat-left-text"></i> ${order.customerDetails.comments || ''}</p>
                    <p class="mb-1" title="Order time: ${formatTime(order.createdAt)}"><i class="bi bi-hourglass-split"></i> <strong>${formatElapsedTime(order.createdAt)}</strong></p>
                    ${order.vehicleNumber ? `<p class="mb-1"><i class="bi bi-truck"></i> ${order.vehicleNumber}</p>` : ''}
                    <hr>
${order.items.map(item => `
                        <div class="d-flex justify-content-between mb-2">
                            <div>${item.name} (${item.portion}) ×${item.quantity}</div>
                            <div>₹${item.price * item.quantity}</div>
                        </div>
                    `).join('')}
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <strong>Total:</strong>
                        <h5 class="mb-0">₹${order.total}</h5>
                    </div>
                    <div class="order-actions d-flex flex-column gap-2">
                        <div>
                            <label for="statusSelect-${order.docId}" class="form-label visually-hidden">Status</label>
                            <select id="statusSelect-${order.docId}" class="form-select form-select-sm" onchange="updateOrderStatus('${order.docId}', this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEditModal('${order.docId}')">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.docId}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

            document.getElementById('ordersList').innerHTML = ordersHTML;
        }

        function renderKitchenList() {
            // Aggregate quantities by dish name and portion
            const kitchenItems = state.currentOrders
                .filter(o => ['pending', 'preparing'].includes(o.status))
                .flatMap(o => {
                    // Add order information to each item for better tracking
                    return o.items.map(item => ({
                        ...item,
                        orderId: o.docId,
                        orderTime: o.createdAt,
                        delayLevel: o.delayLevel || 0,
                        orderStatus: o.status
                    }));
                })
                .reduce((acc, item) => {
                    if (!acc[item.name]) {
                        acc[item.name] = {
                            half: 0,
                            full: 0,
                            delayLevels: [],
                            orderTimes: [],
                            priority: 0,
                            orderIds: new Set()
                        };
                    }
                    const portionKey = item.portion.toLowerCase();
                    if (portionKey === 'half' || portionKey === 'full') {
                        acc[item.name][portionKey] += item.quantity;
                    } else {
                        // For other portions, accumulate under 'full' as default
                        acc[item.name].full += item.quantity;
                    }

                    // Track delay level for priority calculation
                    acc[item.name].delayLevels.push(item.delayLevel);

                    // Track order time for sorting by oldest orders
                    if (item.orderTime) {
                        acc[item.name].orderTimes.push(item.orderTime);
                    }

                    // Track unique order IDs
                    acc[item.name].orderIds.add(item.orderId);

                    return acc;
                }, {});

            // Calculate priority score for each dish
            Object.values(kitchenItems).forEach(item => {
                // Priority factors:
                // 1. Maximum delay level (most important)
                // 2. Number of orders containing this dish
                // 3. Age of oldest order containing this dish

                const maxDelay = item.delayLevels.length > 0 ? Math.max(...item.delayLevels) : 0;
                const orderCount = item.orderIds.size;

                // Find oldest order time
                let oldestOrderAge = 0;
                if (item.orderTimes.length > 0) {
                    const oldestTime = new Date(Math.min(...item.orderTimes.map(t => t.getTime())));
                    oldestOrderAge = (new Date() - oldestTime) / 60000; // in minutes
                }

                // Calculate priority score (higher is more urgent)
                item.priority = (maxDelay * 100) + (orderCount * 10) + Math.min(oldestOrderAge / 5, 20);
            });

            // Generate HTML grouped by dish with priority indicators
            const kitchenHTML = Object.entries(kitchenItems)
                // Sort by priority score (highest first)
                .sort((a, b) => b[1].priority - a[1].priority)
                .map(([name, portions]) => {
                    const halfQty = portions.half;
                    const fullQty = portions.full;
                    const maxDelay = portions.delayLevels.length > 0 ? Math.max(...portions.delayLevels) : 0;
                    const orderCount = portions.orderIds.size;

                    // Determine priority level (0-3)
                    let priorityLevel = 0;
                    if (maxDelay >= 3) priorityLevel = 3;
                    else if (maxDelay >= 1) priorityLevel = 2;
                    else if (orderCount > 1) priorityLevel = 1;

                    // Priority styling
                    let priorityClass = '';
                    let priorityBadge = '';
                    let borderStyle = '';

                    switch (priorityLevel) {
                        case 3: // Critical priority
                            priorityClass = 'bg-danger text-white';
                            priorityBadge = ''; // Removed badge
                            borderStyle = 'border-left: 5px solid #dc3545;';
                            break;
                        case 2: // High priority
                            priorityClass = 'bg-warning';
                            priorityBadge = ''; // Removed badge
                            borderStyle = 'border-left: 5px solid #ffc107;';
                            break;
                        case 1: // Medium priority
                            priorityClass = 'bg-info text-dark';
                            priorityBadge = ''; // Removed badge
                            borderStyle = 'border-left: 5px solid #0dcaf0;';
                            break;
                        default: // Normal priority
                            priorityClass = 'bg-light';
                            borderStyle = '';
                    }

                    return `
                    <div class="kitchen-item mb-3 p-2 rounded position-relative ${priorityClass}" style="${borderStyle}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${name}</h5>
                            <span class="badge bg-dark">${orderCount} order${orderCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            ${halfQty > 0 ? `<div class="badge bg-secondary p-2">Half: ${halfQty}</div>` : ''}
                            ${fullQty > 0 ? `<div class="badge bg-secondary p-2">Full: ${fullQty}</div>` : ''}
                        </div>
                        ${priorityLevel >= 2 ? `<div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                        </div>` : ''}
                    </div>
                    `;
                }).join('');

            // Calculate total dishes to prepare
            const totalDishes = Object.values(kitchenItems).reduce((sum, item) => sum + item.half + item.full, 0);

            // Add a header with priority legend and total count
            const legendHTML = `
                <div class="alert alert-dark mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Priority Legend:</h6>
                        <span class="badge bg-secondary">${totalDishes} dishes to prepare</span>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-danger">URGENT - Cook First</span>
                        <span class="badge bg-warning">HIGH - Cook Next</span>
                        <span class="badge bg-info text-dark">NEXT - Prepare Soon</span>
                        <span class="badge bg-light text-dark">Normal</span>
                    </div>
                </div>
            `;

            document.getElementById('kitchenList').innerHTML = legendHTML + kitchenHTML;
        }

        // Delay Handling Functions
        function checkDelayedOrders() {
            console.log('Checking delayed orders...');

            // Only check active orders (pending or preparing)
            const activeOrders = state.currentOrders.filter(order =>
                ['pending', 'preparing'].includes(order.status)
            );

            activeOrders.forEach(order => {
                // Use the already calculated delay level from handleOrderSnapshot
                // or recalculate if needed
                if (order.delayLevel === undefined) {
                    order.delayLevel = calculateDelayLevel(order);
                }

                console.log(`Order ${order.docId} delayLevel: ${order.delayLevel}`);

                if (order.delayLevel > 0 && !state.alertedOrders.has(order.docId)) {
                    console.log(`Handling delayed order ${order.docId}`);
                    handleDelayedOrder(order);
                }
            });

            // Update the delay comparison if it's visible
            if (document.getElementById('delayComparisonContainer').style.display !== 'none') {
                showDelayComparison();
            }
        }

        function calculateDelayLevel(order) {
            // Use the new calculateExactDelay function for consistency
            return calculateExactDelay(order).delayLevel;
        }

        function handleDelayedOrder(order) {
            console.log(`Adding order ${order.docId} to alertedOrders and showing delay alert.`);
            state.alertedOrders.add(order.docId);
            showDelayAlert(order);
        }

        function showDelayAlert(order) {
            console.log(`Checking if we should show delay alert for order ${order.docId}`);

            // Only show alerts for active orders (pending or preparing)
            if (!['pending', 'preparing'].includes(order.status)) {
                console.log(`Skipping delay alert for order ${order.docId} with status ${order.status}`);
                return;
            }

            console.log(`Showing delay alert for order ${order.docId}`);
            state.currentDelayOrder = order;
            let delayMinutes = 0;
            if (order.updatedAt instanceof Date) {
                delayMinutes = Math.floor((Date.now() - order.updatedAt.getTime()) / 60000);
            }

            // Update the modal content
            document.getElementById('delayAlertContent').innerHTML = `
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Order #${(order.id ? order.id.toString() : order.docId).slice(-4)} delayed!</h5>
            <p><strong>Status:</strong> ${order.status} for ${delayMinutes} minutes</p>
            <p><strong>Note:</strong> This alert will automatically close if the order is marked as ready, delivered, or cancelled.</p>
        </div>
    `;

            // Show the modal
            try {
                if (state.modals && state.modals.delay) {
                    state.modals.delay.show();
                } else {
                    // Fallback if modal isn't initialized in state
                    const delayModal = new bootstrap.Modal(document.getElementById('delayAlertModal'));
                    delayModal.show();
                }
            } catch (error) {
                console.error('Error showing delay modal:', error);
            }
        }

        // Utility Functions
        function getStatusClass(status, delayLevel = 0) {
            if (status === 'pending') {
                // Clamp delayLevel between 0 and 5
                const level = Math.min(Math.max(delayLevel, 0), 5);
                return `delay-level-${level}`;
            }
            const classes = {
                preparing: 'bg-info',
                ready: 'bg-success',
                delivered: 'bg-primary',
                cancelled: 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }

        function getDelayColor(order) {
            // Clamp delayLevel between 0 and 5 for color mapping
            const delayLevel = Math.min(Math.max(order.delayLevel || 0, 0), 5);
            // Map delayLevel 0 (green) to 5 (dark red)
            const hue = 120 - (delayLevel * 24); // 120 to 0 hue range
            return `hsl(${hue}, 80%, 50%)`;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        }

        function formatElapsedTime(date) {
            if (!date) return "Unknown";

            const now = new Date();
            const elapsedMs = now - date;
            const totalMinutes = Math.floor(elapsedMs / 60000);

            if (totalMinutes < 60) {
                return `${totalMinutes} min ago`;
            } else {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}h ${minutes}m ago`;
            }
        }

        // Delay comparison functions
        function toggleDelayComparison() {
            const container = document.getElementById('delayComparisonContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                showDelayComparison();
            } else {
                container.style.display = 'none';
            }
        }

        function showDelayComparison() {
            const tableContainer = document.getElementById('delayComparisonTable');

            // Sort orders by delay time (descending)
            const sortedOrders = [...state.currentOrders]
                .filter(order => order.createdAt && order.status !== 'delivered' && order.status !== 'cancelled')
                .map(order => {
                    const delayInfo = calculateExactDelay(order);
                    return { ...order, delayInfo };
                })
                .sort((a, b) => b.delayInfo.totalMinutes - a.delayInfo.totalMinutes);

            if (sortedOrders.length === 0) {
                tableContainer.innerHTML = '<p class="text-center">No active orders to compare.</p>';
                return;
            }

            // Create the comparison table
            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="bi bi-hash"></i> Order #</th>
                                <th><i class="bi bi-flag"></i> Status</th>
                                <th><i class="bi bi-calendar-check"></i> Order Time</th>
                                <th><i class="bi bi-hourglass-split"></i> Time Since</th>
                                <th><i class="bi bi-stopwatch"></i> Expected</th>
                                <th><i class="bi bi-graph-up-arrow"></i> Delay</th>
                                <th><i class="bi bi-thermometer-half"></i> Level</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedOrders.forEach(order => {
                const { totalMinutes, hours, minutes, expectedMinutes, delayMinutes, delayLevel } = order.delayInfo;
                const delayClass = delayLevel > 0 ? 'text-danger' : 'text-success';
                const delayText = delayLevel > 0 ? `+${delayMinutes} min` : 'On time';

                tableHTML += `
                    <tr class="${delayLevel > 2 ? 'table-danger' : delayLevel > 0 ? 'table-warning' : ''}">
                        <td><strong>${(order.id ? order.id.toString() : order.docId).slice(-4)}</strong></td>
                        <td><span class="badge ${getStatusClass(order.status)}">${order.status}</span></td>
                        <td>${formatTime(order.createdAt)}</td>
                        <td><strong>${hours > 0 ? `${hours}h ${minutes}m` : `${totalMinutes}m`}</strong></td>
                        <td>${expectedMinutes}m</td>
                        <td class="${delayClass}"><strong>${delayText}</strong></td>
                        <td>
                            <div class="badge delay-level-${Math.min(delayLevel, 5)}">${delayLevel}</div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            // Add summary statistics
            const delayedOrders = sortedOrders.filter(order => order.delayInfo.delayLevel > 0);
            const criticalOrders = sortedOrders.filter(order => order.delayInfo.delayLevel > 2);

            if (sortedOrders.length > 0) {
                tableHTML += `
                <div class="alert ${criticalOrders.length > 0 ? 'alert-danger' : delayedOrders.length > 0 ? 'alert-warning' : 'alert-success'} mt-3">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> Summary</h6>
                    <div class="d-flex justify-content-between">
                        <span><strong>Total Orders:</strong> ${sortedOrders.length}</span>
                        <span><strong>Delayed Orders:</strong> ${delayedOrders.length} (${Math.round(delayedOrders.length / sortedOrders.length * 100)}%)</span>
                        <span><strong>Critical Delays:</strong> ${criticalOrders.length} (${Math.round(criticalOrders.length / sortedOrders.length * 100)}%)</span>
                    </div>
                </div>
                `;
            }

            tableContainer.innerHTML = tableHTML;
        }

        function calculateExactDelay(order) {
            const statusDurations = {
                pending: 15,
                preparing: 25,
                ready: 45,
                delivered: 0,
                cancelled: 0
            };

            // Calculate elapsed time since order creation
            const now = new Date();
            const createdAt = order.createdAt || now;
            const elapsedMs = now - createdAt;
            const totalMinutes = Math.floor(elapsedMs / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            // Calculate expected time based on status
            const expectedMinutes = statusDurations[order.status] || 15;

            // Calculate delay
            const delayMinutes = Math.max(0, totalMinutes - expectedMinutes);
            const delayLevel = delayMinutes > 0 ? Math.floor(delayMinutes / 5) + 1 : 0;

            return {
                totalMinutes,
                hours,
                minutes,
                expectedMinutes,
                delayMinutes,
                delayLevel
            };
        }

        // Order Modification Functions
        function createEditOrderItemRow(item) {
            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            const row = document.createElement('div');
            row.className = 'd-flex gap-2 mb-2 align-items-center';

            const itemSelect = document.createElement('select');
            itemSelect.className = 'form-select flex-grow-1';
            itemSelect.required = true;

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Item';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            itemSelect.appendChild(defaultOption);

            for (const [id, menuItem] of Object.entries(state.menuItems)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = menuItem.name;
                if (item && item.id == id) {
                    option.selected = true;
                }
                itemSelect.appendChild(option);
            }

            const portionSelect = document.createElement('select');
            portionSelect.className = 'form-select';
            portionSelect.required = true;
            portionSelect.style.width = '120px';

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.min = '1';
            quantityInput.value = item ? item.quantity : 1;
            quantityInput.className = 'form-control';
            quantityInput.style.width = '80px';
            quantityInput.required = true;

            const priceDisplay = document.createElement('div');
            priceDisplay.style.minWidth = '80px';
            priceDisplay.textContent = '₹0';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-sm';
            removeBtn.textContent = 'Remove';

            row.appendChild(itemSelect);
            row.appendChild(portionSelect);
            row.appendChild(quantityInput);
            row.appendChild(priceDisplay);
            row.appendChild(removeBtn);

            function updatePortions() {
                const itemId = itemSelect.value;
                portionSelect.innerHTML = '';
                if (itemId && state.menuItems[itemId]) {
                    const portions = state.menuItems[itemId].portions;
                    for (const [key, portion] of Object.entries(portions)) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${portion.name} - ₹${portion.price}`;
                        if (item && item.portion === portion.name) {
                            option.selected = true;
                        }
                        portionSelect.appendChild(option);
                    }
                }
                updatePrice();
            }

            function updatePrice() {
                const itemId = itemSelect.value;
                const portionKey = portionSelect.value;
                const quantity = parseInt(quantityInput.value) || 0;
                if (itemId && portionKey && state.menuItems[itemId]) {
                    const price = state.menuItems[itemId].portions[portionKey].price * quantity;
                    priceDisplay.textContent = `₹${price}`;
                } else {
                    priceDisplay.textContent = '₹0';
                }
                updateTotal();
            }

            function updateTotal() {
                let total = 0;
                const rows = editOrderItemsContainer.querySelectorAll('div.d-flex');
                rows.forEach(r => {
                    const priceText = r.querySelector('div').textContent;
                    const price = parseInt(priceText.replace('₹', '')) || 0;
                    total += price;
                });
                document.getElementById('editOrderTotal').textContent = total;
            }

            itemSelect.addEventListener('change', () => {
                updatePortions();
            });

            portionSelect.addEventListener('change', () => {
                updatePrice();
            });

            quantityInput.addEventListener('input', () => {
                updatePrice();
            });

            removeBtn.addEventListener('click', () => {
                row.remove();
                updateTotal();
            });

            updatePortions();

            return row;
        }

        async function showEditModal(docId) {
            const order = state.currentOrders.find(o => o.docId === docId);
            state.editingOrderId = docId;

            // Populate edit form with order details
            document.getElementById('editCustomerPhone').value = order.customerDetails.phone || '';
            document.getElementById('editCustomerComments').value = order.customerDetails.comments || '';

            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            editOrderItemsContainer.innerHTML = '';

            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const row = createEditOrderItemRow(item);
                    editOrderItemsContainer.appendChild(row);
                });
            } else {
                const row = createEditOrderItemRow();
                editOrderItemsContainer.appendChild(row);
            }

            document.getElementById('editOrderTotal').textContent = order.total || 0;

            state.modals.editOrder.show();
        }

        async function handleOrderEdit(e) {
            e.preventDefault();

            const phone = document.getElementById('editCustomerPhone').value.trim();
            const comments = document.getElementById('editCustomerComments').value.trim();

            if (!phone) {
                alert('Please enter customer phone number.');
                return;
            }

            const items = [];
            const editOrderItemsContainer = document.getElementById('editOrderItemsContainer');
            const rows = editOrderItemsContainer.querySelectorAll('div.d-flex');

            if (rows.length === 0) {
                alert('Please add at least one order item.');
                return;
            }

            for (const row of rows) {
                const itemSelect = row.querySelector('select.form-select');
                const portionSelect = row.querySelectorAll('select.form-select')[1];
                const quantityInput = row.querySelector('input[type="number"]');
                const itemId = itemSelect.value;
                const portionKey = portionSelect.value;
                const quantity = parseInt(quantityInput.value);

                if (!itemId || !portionKey || !quantity || quantity <= 0) {
                    alert('Please fill all item details correctly.');
                    return;
                }

                const itemData = state.menuItems[itemId];
                const portionData = itemData.portions[portionKey];

                items.push({
                    id: itemId,
                    name: itemData.name,
                    portion: portionData.name,
                    quantity,
                    price: portionData.price
                });
            }

            const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);

            try {
                await db.collection('bot_orders').doc(state.editingOrderId).update({
                    customerDetails: { phone, comments },
                    items,
                    total,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Order updated successfully.');
                state.modals.editOrder.hide();
            } catch (error) {
                alert('Error updating order: ' + error.message);
            }
        }

        // Existing Functions with Optimizations
        async function deleteOrder(docId) {
            if (confirm('Confirm deletion?')) await db.collection('bot_orders').doc(docId).delete();
        }

        async function updateOrderStatus(docId, newStatus) {
            try {
                console.log(`Updating order ${docId} status to ${newStatus}...`);
                await db.collection('bot_orders').doc(docId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`Order ${docId} status updated to ${newStatus}`);

                // Clear alert for this order if it's no longer active
                if (!['pending', 'preparing'].includes(newStatus)) {
                    console.log(`Clearing alert for order ${docId} as it's now ${newStatus}`);
                    state.alertedOrders.delete(docId);

                    // If this was the current delay order, close the modal
                    if (state.currentDelayOrder && state.currentDelayOrder.docId === docId) {
                        console.log(`Closing delay alert modal for order ${docId}`);
                        state.currentDelayOrder = null;
                        const delayAlertModal = bootstrap.Modal.getInstance(document.getElementById('delayAlertModal'));
                        if (delayAlertModal) {
                            delayAlertModal.hide();
                        }
                    }
                }

                // Refresh UI and check delays after status update
                loadOrders();
            } catch (error) {
                alert('Error updating order status: ' + error.message);
            }
        }

        async function sendDelayMessage() {
            const order = state.currentDelayOrder;
            const orderIdStr = order.id ? order.id.toString() : order.docId;
            const message = `Your order #${orderIdStr.slice(-4)} is delayed. New ETA: ${calculateNewETA(order)}`;
            window.open(`https://wa.me/${order.customerDetails.phone}?text=${encodeURIComponent(message)}`, '_blank');
            state.modals.delay.hide();
        }

        function calculateNewETA(order) {
            const buffer = (order.delayLevel * 5) + 10;
            return new Date(Date.now() + buffer * 60000).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        }

        // Add remaining functions from previous versions with similar optimizations

        function saveVehicleNumber() {
            // TODO: Implement save vehicle number logic
            console.log('saveVehicleNumber called');
        }

        async function handleNewOrder(e) {
            e.preventDefault();
            const phone = document.getElementById('customerPhone').value.trim();
            const comments = document.getElementById('customerComments').value.trim();
            if (!phone) {
                alert('Please enter customer phone number.');
                return;
            }
            const items = [];
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            const orderTotalElem = document.getElementById('orderTotal');
            const rows = orderItemsContainer.querySelectorAll('div.d-flex');
            if (rows.length === 0) {
                alert('Please add at least one order item.');
                return;
            }
            for (const row of rows) {
                const itemSelect = row.querySelector('select.form-select');
                const portionSelect = row.querySelectorAll('select.form-select')[1];
                const quantityInput = row.querySelector('input[type="number"]');
                const itemId = itemSelect.value;
                const portionKey = portionSelect.value;
                const quantity = parseInt(quantityInput.value);
                if (!itemId || !portionKey || !quantity || quantity <= 0) {
                    alert('Please fill all item details correctly.');
                    return;
                }
                const itemData = state.menuItems[itemId];
                const portionData = itemData.portions[portionKey];
                items.push({
                    id: itemId,
                    name: itemData.name,
                    portion: portionData.name,
                    quantity,
                    price: portionData.price
                });
            }
            const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);
            try {
                await db.collection('bot_orders').add({
                    customerDetails: { phone, comments },
                    items,
                    total,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Order added successfully.');
                e.target.reset();
                orderItemsContainer.innerHTML = '';
                orderTotalElem.textContent = '0';
                state.modals.addOrder.hide();
            } catch (error) {
                alert('Error adding order: ' + error.message);
            }
        }

        async function handleOrderEdit(e) {
            e.preventDefault();

            const phone = document.getElementById('editCustomerPhone').value.trim();
            const comments = document.getElementById('editCustomerComments').value.trim();
            if (!phone) {
                alert('Please enter customer phone number.');
                return;
            }
            const items = [];
            const orderItemsContainer = document.getElementById('editOrderItemsContainer');
            const orderTotalElem = document.getElementById('editOrderTotal');
            const rows = orderItemsContainer.querySelectorAll('div.d-flex');
            if (rows.length === 0) {
                alert('Please add at least one order item.');
                return;
            }
            for (const row of rows) {
                const itemSelect = row.querySelector('select.form-select');
                const portionSelect = row.querySelectorAll('select.form-select')[1];
                const quantityInput = row.querySelector('input[type="number"]');
                const itemId = itemSelect.value;
                const portionKey = portionSelect.value;
                const quantity = parseInt(quantityInput.value);
                if (!itemId || !portionKey || !quantity || quantity <= 0) {
                    alert('Please fill all item details correctly.');
                    return;
                }
                const itemData = state.menuItems[itemId];
                const portionData = itemData.portions[portionKey];
                items.push({
                    id: itemId,
                    name: itemData.name,
                    portion: portionData.name,
                    quantity,
                    price: portionData.price
                });
            }
            const total = items.reduce((sum, i) => sum + i.price * i.quantity, 0);
            try {
                await db.collection('bot_orders').doc(state.editingOrderId).update({
                    customerDetails: { phone, comments },
                    items,
                    total,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Order updated successfully.');
                e.target.reset();
                orderItemsContainer.innerHTML = '';
                orderTotalElem.textContent = '0';
                state.modals.editOrder.hide();
            } catch (error) {
                alert('Error updating order: ' + error.message);
            }
        }

        // Add order form handling
        document.addEventListener('DOMContentLoaded', () => {
            const addOrderItemBtn = document.getElementById('addOrderItemBtn');
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            const orderTotalElem = document.getElementById('orderTotal');
            const addOrderForm = document.getElementById('addOrderForm');

            function createOrderItemRow() {
                const row = document.createElement('div');
                row.className = 'd-flex gap-2 mb-2 align-items-center';

                const itemSelect = document.createElement('select');
                itemSelect.className = 'form-select flex-grow-1';
                itemSelect.required = true;

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select Item';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                itemSelect.appendChild(defaultOption);

                for (const [id, item] of Object.entries(state.menuItems)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = item.name;
                    itemSelect.appendChild(option);
                }

                const portionSelect = document.createElement('select');
                portionSelect.className = 'form-select';
                portionSelect.required = true;
                portionSelect.style.width = '120px';

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.value = '1';
                quantityInput.className = 'form-control';
                quantityInput.style.width = '80px';
                quantityInput.required = true;

                const priceDisplay = document.createElement('div');
                priceDisplay.style.minWidth = '80px';
                priceDisplay.textContent = '₹0';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm';
                removeBtn.textContent = 'Remove';

                row.appendChild(itemSelect);
                row.appendChild(portionSelect);
                row.appendChild(quantityInput);
                row.appendChild(priceDisplay);
                row.appendChild(removeBtn);

                function updatePortions() {
                    const itemId = itemSelect.value;
                    portionSelect.innerHTML = '';
                    if (itemId && state.menuItems[itemId]) {
                        const portions = state.menuItems[itemId].portions;
                        for (const [key, portion] of Object.entries(portions)) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = `${portion.name} - ₹${portion.price}`;
                            portionSelect.appendChild(option);
                        }
                    }
                    updatePrice();
                }

                function updatePrice() {
                    const itemId = itemSelect.value;
                    const portionKey = portionSelect.value;
                    const quantity = parseInt(quantityInput.value) || 0;
                    if (itemId && portionKey && state.menuItems[itemId]) {
                        const price = state.menuItems[itemId].portions[portionKey].price * quantity;
                        priceDisplay.textContent = `₹${price}`;
                    } else {
                        priceDisplay.textContent = '₹0';
                    }
                    updateTotal();
                }

                function updateTotal() {
                    let total = 0;
                    const rows = orderItemsContainer.querySelectorAll('div.d-flex');
                    rows.forEach(r => {
                        const priceText = r.querySelector('div').textContent;
                        const price = parseInt(priceText.replace('₹', '')) || 0;
                        total += price;
                    });
                    orderTotalElem.textContent = total;
                }

                itemSelect.addEventListener('change', () => {
                    updatePortions();
                });

                portionSelect.addEventListener('change', () => {
                    updatePrice();
                });

                quantityInput.addEventListener('input', () => {
                    updatePrice();
                });

                removeBtn.addEventListener('click', () => {
                    row.remove();
                    updateTotal();
                });

                return row;
            }

            addOrderItemBtn.addEventListener('click', () => {
                const row = createOrderItemRow();
                orderItemsContainer.appendChild(row);
            });

        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</body>

</html>